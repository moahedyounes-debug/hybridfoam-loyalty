<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>تسجيل زيارة</title>
<style>
    body { font-family: sans-serif; padding: 20px; background:#f5f5f5; }
    .box { background:white; padding:20px; border-radius:10px; margin-bottom:20px; }
    label { display:block; margin-top:10px; }
    select, input { width:100%; padding:10px; margin-top:5px; }
    button { width:100%; padding:12px; background:#000; color:white; border:none; margin-top:20px; border-radius:8px; }
    .car-item { padding:10px; border:1px solid #ccc; border-radius:8px; margin-top:10px; cursor:pointer; }
    .car-item.selected { border-color:#000; background:#eee; }
</style>
<script src="api.js"></script>
</head>
<body>

<h2>تسجيل زيارة للعميل</h2>

<div class="box">
    <label>رقم الجوال</label>
    <input type="text" id="phone" placeholder="05xxxxxxxx">
    <button onclick="searchCustomer()">بحث</button>
</div>

<div id="carsBox" class="box" style="display:none;">
    <h3>اختر السيارة</h3>
    <div id="carsList"></div>
</div>

<div id="visitBox" class="box" style="display:none;">
    <h3>تفاصيل الزيارة</h3>

    <label>الخدمة</label>
    <input type="text" id="service">

    <label>السعر</label>
    <input type="number" id="price">

    <label>النقاط</label>
    <input type="number" id="points">

    <label>اسم الموظف</label>
    <input type="text" id="employee">

    <label>الفرع</label>
    <input type="text" id="branch">

    <button onclick="submitVisit()">تسجيل الزيارة</button>
</div>

<script>
let selectedMembership = null;

// -----------------------------
// البحث عن سيارات العميل
// -----------------------------
async function searchCustomer() {
    const phone = document.getElementById("phone").value.trim();
    if (!phone) return alert("أدخل رقم الجوال");

    const res = await apiGet({
        action: "getCarsByPhone",
        phone
    });

    if (!res.success || res.cars.length === 0) {
        alert("لا يوجد سيارات لهذا العميل");
        return;
    }

    document.getElementById("carsBox").style.display = "block";

    const list = document.getElementById("carsList");
    list.innerHTML = "";

    res.cars.forEach(car => {
        const div = document.createElement("div");
        div.className = "car-item";
        div.innerHTML = `
            <b>${car.car}</b> — ${car.plate_letters} ${car.plate_numbers}
            <br>عضوية: ${car.membership}
        `;
        div.onclick = () => selectCar(div, car.membership);
        list.appendChild(div);
    });
}

// -----------------------------
// اختيار السيارة (العضوية)
// -----------------------------
function selectCar(element, membership) {
    selectedMembership = membership;

    document.querySelectorAll(".car-item").forEach(el => el.classList.remove("selected"));
    element.classList.add("selected");

    document.getElementById("visitBox").style.display = "block";
}

// -----------------------------
// إرسال الزيارة
// -----------------------------
async function submitVisit() {
    if (!selectedMembership) return alert("اختر السيارة أولاً");

    const service  = document.getElementById("service").value;
    const price    = document.getElementById("price").value;
    const points   = document.getElementById("points").value;
    const employee = document.getElementById("employee").value;
    const branch   = document.getElementById("branch").value;

    const res = await apiPost({
        action: "addVisit",
        membership: selectedMembership,
        service,
        price,
        points,
        employee,
        branch
    });

    if (res.success) {
        alert("تم تسجيل الزيارة بنجاح");
        location.reload();
    } else {
        alert("خطأ في التسجيل");
    }
}
</script>

</body>
</html>
