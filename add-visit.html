<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>تسجيل زيارة</title>

<style>
    body {
        font-family: sans-serif;
        padding: 20px;
        background: #f5f5f5;
        max-width: 600px;
        margin: auto;
    }

    .box {
        background: white;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    label {
        display: block;
        margin-top: 10px;
        font-weight: bold;
    }

    select, input {
        width: 100%;
        padding: 12px;
        margin-top: 5px;
        border-radius: 8px;
        border: 1px solid #ccc;
        font-size: 16px;
    }

    button {
        width: 100%;
        padding: 14px;
        background: #000;
        color: white;
        border: none;
        margin-top: 20px;
        border-radius: 8px;
        font-size: 16px;
        cursor: pointer;
        transition: 0.2s;
    }

    button.loading {
        background: #444;
        cursor: wait;
    }

    .car-item {
        padding: 12px;
        border: 1px solid #ccc;
        border-radius: 8px;
        margin-top: 10px;
        cursor: pointer;
        transition: 0.2s;
    }

    .car-item.selected {
        border-color: #000;
        background: #e8e8e8;
    }
</style>

<script src="api.js?v=3"></script>
</head>
<body>

<h2>تسجيل زيارة للعميل</h2>

<!-- البحث -->
<div class="box">
    <label>رقم الجوال</label>
    <input type="text" id="phone" placeholder="05xxxxxxxx" oninput="this.value=this.value.replace(/[^0-9]/g,'')">

    <button id="searchBtn" onclick="searchCustomer()">بحث</button>
</div>

<!-- اختيار السيارة -->
<div id="carsBox" class="box" style="display:none;">
    <h3>اختر السيارة</h3>
    <div id="carsList"></div>
</div>

<!-- تفاصيل الزيارة -->
<div id="visitBox" class="box" style="display:none;">
    <h3>تفاصيل الزيارة</h3>

    <!-- نوع الخدمة -->
    <label>نوع الخدمة</label>
    <select id="service_type" onchange="filterServiceDetails()"></select>

    <!-- تفاصيل الخدمة -->
    <label>تفاصيل الخدمة</label>
    <select id="service_detail" onchange="updatePrice()"></select>

    <label>السعر</label>
    <input type="number" id="price" onchange="updatePoints()">

    <label>النقاط</label>
    <input type="number" id="points">

    <!-- الموظفين -->
    <label>اسم الموظف</label>
    <select id="employee"></select>

    <!-- الفروع -->
    <label>الفرع</label>
    <select id="branch"></select>

    <!-- حالة الدفع -->
    <label>حالة الدفع</label>
    <select id="payment_status">
        <option value="Paid">مدفوع</option>
        <option value="Unpaid">غير مدفوع</option>
    </select>

    <!-- رقم الموقف -->
    <label>رقم الموقف</label>
    <input type="number" id="parking_slot" min="1" max="50" placeholder="مثال: 3">

    <button id="submitBtn" onclick="submitVisit()">تسجيل الزيارة</button>
</div>

<script>
let selectedMembership = null;
let commissions = [];
let employees = [];
let branches = [];

// تحميل الخدمات
async function loadServices() {
    const res = await apiGet({ action: "getCommissions" });
    if (!res.success) return alert("خطأ في تحميل الخدمات");

    commissions = res.commissions;

    const types = [...new Set(commissions.map(r => r.type))];

    const typeSelect = document.getElementById("service_type");
    typeSelect.innerHTML = "";

    types.forEach(t => {
        const opt = document.createElement("option");
        opt.value = t;
        opt.textContent = t;
        typeSelect.appendChild(opt);
    });

    filterServiceDetails();
}

// تصفية تفاصيل الخدمة حسب النوع
function filterServiceDetails() {
    const type = document.getElementById("service_type").value;
    const detailSelect = document.getElementById("service_detail");

    detailSelect.innerHTML = "";

    commissions
        .filter(r => r.type === type)
        .forEach(r => {
            const opt = document.createElement("option");
            opt.value = r.detail;
            opt.textContent = r.detail;
            detailSelect.appendChild(opt);
        });

    updatePrice();
}

// تحديث السعر
function updatePrice() {
    const detail = document.getElementById("service_detail").value;
    const row = commissions.find(r => r.detail === detail);

    document.getElementById("price").value = row ? row.price : 0;
    updatePoints();
}

// النقاط
function updatePoints() {
    const price = Number(document.getElementById("price").value || 0);
    document.getElementById("points").value = Math.floor(price / 5);
}

// تحميل الموظفين
async function loadEmployees() {
    const res = await apiGet({ action: "getEmployees" });
    if (!res.success) return;

    const select = document.getElementById("employee");
    select.innerHTML = "";

    res.employees.forEach(e => {
        const opt = document.createElement("option");
        opt.value = e.name;
        opt.textContent = e.name;
        select.appendChild(opt);
    });
}

// تحميل الفروع
async function loadBranches() {
    const res = await apiGet({ action: "getBranches" });
    if (!res.success) return;

    const select = document.getElementById("branch");
    select.innerHTML = "";

    res.branches.forEach(b => {
        const opt = document.createElement("option");
        opt.value = b.name;
        opt.textContent = b.name;
        select.appendChild(opt);
    });
}

// البحث عن سيارات العميل
async function searchCustomer() {
    const phone = document.getElementById("phone").value.trim();
    if (!phone) return alert("أدخل رقم الجوال");

    const btn = document.getElementById("searchBtn");
    btn.classList.add("loading");
    btn.textContent = "جاري البحث...";

    const res = await apiGet({ action: "getCarsByPhone", phone });

    btn.classList.remove("loading");
    btn.textContent = "بحث";

    if (!res.success || res.cars.length === 0) {
        alert("لا يوجد سيارات لهذا العميل");
        return;
    }

    document.getElementById("carsBox").style.display = "block";

    const list = document.getElementById("carsList");
    list.innerHTML = "";

    res.cars.forEach(car => {
        const div = document.createElement("div");
        div.className = "car-item";
        div.innerHTML = `
            <b>${car.car}</b> — ${car.plate_letters} ${car.plate_numbers}
            <br>عضوية: ${car.membership}
        `;
        div.onclick = () => selectCar(div, car.membership);
        list.appendChild(div);
    });
}

// اختيار السيارة
function selectCar(element, membership) {
    selectedMembership = membership;

    document.querySelectorAll(".car-item").forEach(el => el.classList.remove("selected"));
    element.classList.add("selected");

    document.getElementById("visitBox").style.display = "block";
}

// إرسال الزيارة
async function submitVisit() {
    if (!selectedMembership) return alert("اختر السيارة أولاً");

    const btn = document.getElementById("submitBtn");
    btn.classList.add("loading");
    btn.textContent = "جاري التسجيل...";

    const res = await apiPost({
        action: "addVisit",
        membership: selectedMembership,
        service_type: document.getElementById("service_type").value,
        service_detail: document.getElementById("service_detail").value,
        price: document.getElementById("price").value,
        points: document.getElementById("points").value,
        employee: document.getElementById("employee").value,
        branch: document.getElementById("branch").value,
        payment_status: document.getElementById("payment_status").value,
        parking_slot: document.getElementById("parking_slot").value
    });

    btn.classList.remove("loading");
    btn.textContent = "تسجيل الزيارة";

    if (res.success) {
        alert("تم تسجيل الزيارة بنجاح");
        location.reload();
    } else {
        alert("خطأ في التسجيل");
    }
}

// تحميل البيانات عند فتح الصفحة
loadServices();
loadEmployees();
loadBranches();
</script>

</body>
</html>
