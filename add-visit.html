<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>تسجيل زيارة</title>

<style>
    body {
        font-family: sans-serif;
        padding: 20px;
        background: #f5f5f5;
        max-width: 600px;
        margin: auto;
    }

    .box {
        background: white;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    label {
        display: block;
        margin-top: 10px;
        font-weight: bold;
    }

    select, input {
        width: 100%;
        padding: 12px;
        margin-top: 5px;
        border-radius: 8px;
        border: 1px solid #ccc;
        font-size: 16px;
    }

    button {
        width: 100%;
        padding: 14px;
        background: #000;
        color: white;
        border: none;
        margin-top: 20px;
        border-radius: 8px;
        font-size: 16px;
        cursor: pointer;
        transition: 0.2s;
    }

    button.loading {
        background: #444;
        cursor: wait;
    }

    .car-item {
        padding: 12px;
        border: 1px solid #ccc;
        border-radius: 8px;
        margin-top: 10px;
        cursor: pointer;
        transition: 0.2s;
    }

    .car-item:hover {
        background: #f0f0f0;
    }

    .car-item.selected {
        border-color: #000;
        background: #e8e8e8;
    }
</style>

<script src="api.js?v=3"></script>
</head>
<body>

<h2>تسجيل زيارة للعميل</h2>

<!-- البحث -->
<div class="box">
    <label>رقم الجوال</label>
    <input type="text" id="phone" placeholder="05xxxxxxxx" oninput="this.value=this.value.replace(/[^0-9]/g,'')">

    <button id="searchBtn" onclick="searchCustomer()">بحث</button>
</div>

<!-- اختيار السيارة -->
<div id="carsBox" class="box" style="display:none;">
    <h3>اختر السيارة</h3>
    <div id="carsList"></div>
</div>

<!-- تفاصيل الزيارة -->
<div id="visitBox" class="box" style="display:none;">
    <h3>تفاصيل الزيارة</h3>

    <label>الخدمة</label>
    <select id="service" onchange="updatePriceAndPoints()"></select>

    <label>السعر</label>
    <input type="number" id="price" onchange="updatePoints()">

    <label>النقاط</label>
    <input type="number" id="points">

    <label>اسم الموظف (اختياري)</label>
    <input type="text" id="employee">

    <label>الفرع</label>
    <select id="branch">
        <option value="مكة">مكة</option>
    </select>

    <button id="submitBtn" onclick="submitVisit()">تسجيل الزيارة</button>
</div>

<script>
let selectedMembership = null;
let servicesData = {}; // { serviceName: price }

// -----------------------------
// تحميل قائمة الخدمات من API
// -----------------------------
async function loadServices() {
    const res = await apiGet({ action: "getCommissions" });

    if (!res.success) return alert("خطأ في تحميل الخدمات");

    const serviceSelect = document.getElementById("service");
    serviceSelect.innerHTML = "";

    // ترتيب الخدمات أبجديًا
    res.commissions.sort((a, b) => a.service.localeCompare(b.service));

    res.commissions.forEach(row => {
        const name = row.service;
        const price = Number(row.price || 0);

        servicesData[name] = price;

        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        serviceSelect.appendChild(opt);
    });

    updatePriceAndPoints();
}

// -----------------------------
// تحديث السعر والنقاط تلقائيًا
// -----------------------------
function updatePriceAndPoints() {
    const service = document.getElementById("service").value;
    const price = servicesData[service] || 0;

    document.getElementById("price").value = price;
    updatePoints();
}

function updatePoints() {
    const price = Number(document.getElementById("price").value || 0);
    const points = Math.floor(price / 5); // كل 5 ريال = نقطة

    document.getElementById("points").value = points;
}

// -----------------------------
// البحث عن سيارات العميل
// -----------------------------
async function searchCustomer() {
    const phone = document.getElementById("phone").value.trim();
    if (!phone) return alert("أدخل رقم الجوال");

    const btn = document.getElementById("searchBtn");
    btn.classList.add("loading");
    btn.textContent = "جاري البحث...";

    const res = await apiGet({
        action: "getCarsByPhone",
        phone
    });

    btn.classList.remove("loading");
    btn.textContent = "بحث";

    if (!res.success || res.cars.length === 0) {
        alert("لا يوجد سيارات لهذا العميل");
        return;
    }

    document.getElementById("carsBox").style.display = "block";

    const list = document.getElementById("carsList");
    list.innerHTML = "";

    res.cars.forEach(car => {
        const div = document.createElement("div");
        div.className = "car-item";
        div.innerHTML = `
            <b>${car.car}</b> — ${car.plate_letters} ${car.plate_numbers}
            <br>عضوية: ${car.membership}
        `;
        div.onclick = () => selectCar(div, car.membership);
        list.appendChild(div);
    });
}

// -----------------------------
// اختيار السيارة (العضوية)
// -----------------------------
function selectCar(element, membership) {
    selectedMembership = membership;

    document.querySelectorAll(".car-item").forEach(el => el.classList.remove("selected"));
    element.classList.add("selected");

    document.getElementById("visitBox").style.display = "block";
}

// -----------------------------
// إرسال الزيارة
// -----------------------------
async function submitVisit() {
    if (!selectedMembership) return alert("اختر السيارة أولاً");

    const btn = document.getElementById("submitBtn");
    btn.classList.add("loading");
    btn.textContent = "جاري التسجيل...";

    const service  = document.getElementById("service").value;
    const price    = document.getElementById("price").value;
    const points   = document.getElementById("points").value;
    const employee = document.getElementById("employee").value;
    const branch   = document.getElementById("branch").value;

    const res = await apiPost({
        action: "addVisit",
        membership: selectedMembership,
        service,
        price,
        points,
        employee,
        branch
    });

    btn.classList.remove("loading");
    btn.textContent = "تسجيل الزيارة";

    if (res.success) {
        alert("تم تسجيل الزيارة بنجاح");
        location.reload();
    } else {
        alert("خطأ في التسجيل");
    }
}

// تحميل الخدمات عند فتح الصفحة
loadServices();
</script>

</body>
</html>
