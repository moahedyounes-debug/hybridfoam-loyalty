<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>الإشعارات</title>

<style>
    body {
        font-family: sans-serif;
        padding: 20px;
        background: #f5f5f5;
        max-width: 600px;
        margin: auto;
    }

    h2 {
        text-align: center;
        margin-bottom: 20px;
    }

    .notif {
        background: white;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 12px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        cursor: pointer;
        transition: 0.2s;
    }

    .notif.unread {
        border-right: 6px solid #000;
        background: #f0f0f0;
    }

    .notif:hover {
        background: #e9e9e9;
    }

    .msg {
        font-size: 16px;
        margin-bottom: 5px;
    }

    .date {
        font-size: 13px;
        color: #666;
    }

    #loading {
        text-align: center;
        padding: 20px;
        font-size: 16px;
        color: #555;
    }
</style>

<script src="api.js"></script>
</head>
<body>

<h2>الإشعارات</h2>

<div id="loading">جاري تحميل الإشعارات...</div>
<div id="list"></div>

<script>
const phone = localStorage.getItem("customer_phone"); 
// ⚠️ مهم: لازم نخزن رقم الجوال في localStorage عند تسجيل الدخول

if (!phone) {
    document.getElementById("loading").innerHTML = "لا يوجد رقم جوال — يرجى تسجيل الدخول";
}

// -----------------------------
// تحميل الإشعارات
// -----------------------------
async function loadNotifications() {
    const res = await apiGet({
        action: "getNotifications",
        phone
    });

    const loading = document.getElementById("loading");
    const list = document.getElementById("list");

    loading.style.display = "none";

    if (!res.success || res.notifications.length === 0) {
        list.innerHTML = "<p style='text-align:center;color:#777;'>لا توجد إشعارات</p>";
        return;
    }

    list.innerHTML = "";

    res.notifications.forEach(n => {
        const div = document.createElement("div");
        div.className = "notif " + (n.read == 0 ? "unread" : "");

        const date = new Date(n.created_at);
        const formatted = date.toLocaleString("ar-SA");

        div.innerHTML = `
            <div class="msg">${n.message}</div>
            <div class="date">${formatted}</div>
        `;

        div.onclick = () => markAsRead(n.row, div);

        list.appendChild(div);
    });
}

// -----------------------------
// تعليم الإشعار كمقروء
// -----------------------------
async function markAsRead(row, element) {
    element.classList.remove("unread");

    await apiGet({
        action: "markNotificationRead",
        row
    });
}

loadNotifications();
</script>

</body>
</html>
