<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>نقاطي</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
    body {
        font-family: "Tajawal", sans-serif;
        background: #f5f5f5;
        padding: 20px;
        margin: 0;
        max-width: 700px;
        margin: auto;
    }

    .back-btn {
        background: #000;
        color: white;
        padding: 12px 18px;
        border-radius: 10px;
        display: inline-block;
        margin-bottom: 20px;
        cursor: pointer;
        font-size: 16px;
    }

    h2 {
        text-align: center;
        margin-bottom: 20px;
        font-size: 24px;
    }

    .card {
        background: white;
        padding: 22px;
        border-radius: 16px;
        margin-bottom: 20px;
        box-shadow: 0 3px 10px rgba(0,0,0,0.08);
    }

    .card h3 {
        margin: 0 0 12px 0;
        font-size: 18px;
    }

    .points {
        font-size: 32px;
        font-weight: bold;
        color: #000;
        margin-top: 10px;
    }

    .level {
        font-size: 18px;
        margin-top: 5px;
        font-weight: 600;
    }

    .progress-box {
        margin-top: 18px;
    }

    .progress-bar {
        width: 100%;
        height: 14px;
        background: #ddd;
        border-radius: 10px;
        overflow: hidden;
    }

    .progress-fill {
        height: 100%;
        background: #000;
        width: 0%;
        transition: width 0.6s ease;
    }

    .history-item {
        background: #fafafa;
        padding: 14px;
        border-radius: 12px;
        margin-bottom: 12px;
        border: 1px solid #eee;
        font-size: 15px;
    }

    .row {
        margin-bottom: 6px;
    }

    @media (max-width: 480px) {
        .points { font-size: 28px; }
        .card { padding: 18px; }
        h2 { font-size: 22px; }
    }
</style>

<script src="api.js"></script>
</head>
<body>

<div class="back-btn" onclick="goBack()">رجوع</div>

<h2>نقاطي</h2>

<div class="card">
    <h3>إجمالي النقاط</h3>
    <div class="points" id="custPoints">...</div>
    <div class="level" id="custLevel">...</div>

    <div class="progress-box">
        <div class="row" id="nextLevelText"></div>
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
    </div>
</div>

<div class="card">
    <h3>سجل اكتساب النقاط</h3>
    <div id="historyList"></div>
</div>

<script>
let phone = localStorage.getItem("customer_phone");

if (!phone) {
    alert("يرجى تسجيل الدخول أولاً");
    window.location.href = "login.html";
}

async function loadLoyalty() {
    const res = await apiGet({ action: "getByPhone", phone });

    if (!res.success) {
        alert("خطأ في تحميل البيانات");
        return;
    }

    const c = res.customer;

    document.getElementById("custPoints").textContent = c.points + " نقطة";

    let levelColor = "#000";
    if (c.level === "Bronze") levelColor = "#cd7f32";
    if (c.level === "Silver") levelColor = "#c0c0c0";
    if (c.level === "Gold") levelColor = "#d4af37";
    if (c.level === "Platinum") levelColor = "#e5e4e2";

    const levelEl = document.getElementById("custLevel");
    levelEl.textContent = "المستوى: " + c.level;
    levelEl.style.color = levelColor;

    let current = Number(c.points);
    let nextLevel = 0;

    if (c.level === "Bronze") nextLevel = 200;
    else if (c.level === "Silver") nextLevel = 500;
    else if (c.level === "Gold") nextLevel = 1000;
    else nextLevel = current;

    let percent = Math.min((current / nextLevel) * 100, 100);

    document.getElementById("nextLevelText").textContent =
        "النقاط المطلوبة للترقية: " + (nextLevel - current);

    document.getElementById("progressFill").style.width = percent + "%";

    loadHistory();
}

async function loadHistory() {
    const res = await apiGet({ action: "getVisitsByPhone", phone });

    const list = document.getElementById("historyList");
    list.innerHTML = "";

    if (!res.success || res.visits.length === 0) {
        list.innerHTML = "<p style='color:#777;'>لا يوجد سجل نقاط</p>";
        return;
    }

    res.visits.reverse().forEach(v => {
        const div = document.createElement("div");
        div.className = "history-item";

        div.innerHTML = `
            <div class="row"><b>الخدمة:</b> ${v.service}</div>
            <div class="row"><b>النقاط المكتسبة:</b> ${v.points}</div>
            <div class="row"><b>التاريخ:</b> ${v.date}</div>
        `;

        list.appendChild(div);
    });
}

function goBack() {
    window.location.href = "customer-home.html";
}

loadLoyalty();
</script>

</body>
</html>
