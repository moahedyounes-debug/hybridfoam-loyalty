<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
<meta charset="UTF-8">
<title>رغوة الهجين - إدارة الزيارات</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- CSS -->
<style>
/* ============================
   RESET + الخط
============================ */
* {
  box-sizing: border-box;
  font-family: "Tajawal", sans-serif;
}

body {
  margin: 0;
  padding: 0;
  background: #f3f6fa;
  min-height: 100vh;
  position: relative;
  overflow-x: hidden;
}

/* خلفية الشعار */
body::before {
  content: "";
  position: fixed;
  inset: 0;
  background: url("logo.png") no-repeat center center;
  background-size: 420px;
  opacity: 0.05;
  pointer-events: none;
  z-index: -1;
}

/* ============================
   العنوان
============================ */
.page-title {
  text-align: center;
  padding: 20px 10px 10px;
}

.page-title h1 {
  margin: 0;
  font-size: 28px;
  color: #0d47a1;
  font-weight: 700;
}

.page-title h2 {
  margin: 0;
  font-size: 18px;
  color: #374151;
}

/* ============================
   الأقسام
============================ */
.section {
  background: white;
  margin: 14px;
  padding: 18px;
  border-radius: 14px;
  box-shadow: 0 3px 10px rgba(0,0,0,0.06);
}

.section-title {
  margin: 0 0 14px;
  font-size: 18px;
  font-weight: 700;
  color: #0d47a1;
}

/* ============================
   الإدخالات
============================ */
label {
  font-size: 14px;
  color: #374151;
  font-weight: 600;
}

input, select {
  width: 100%;
  padding: 12px;
  margin-top: 4px;
  margin-bottom: 14px;
  border: 1px solid #d1d5db;
  border-radius: 10px;
  font-size: 15px;
  background: #f9fafb;
  transition: 0.2s;
}

input:focus, select:focus {
  border-color: #0d47a1;
  outline: none;
  background: #fff;
}

/* ============================
   الأزرار
============================ */
.btn-primary {
  background: #0d47a1;
  color: white;
  padding: 14px;
  border: none;
  border-radius: 12px;
  font-size: 17px;
  width: 100%;
  cursor: pointer;
  font-weight: 600;
  transition: 0.2s;
}

.btn-primary:hover {
  background: #09367a;
}

.btn-primary:disabled {
  background: #9ca3af;
  cursor: not-allowed;
}

.btn-secondary {
  background: #f97316;
  color: white;
  padding: 14px;
  border: none;
  border-radius: 12px;
  font-size: 17px;
  cursor: pointer;
  font-weight: 600;
  transition: 0.2s;
}

.btn-secondary:hover {
  background: #dd5f0b;
}

.full {
  width: 100%;
}

/* زر التحميل */
.btn-loading {
  opacity: 0.7;
  pointer-events: none;
  position: relative;
}

.btn-loading::after {
  content: " ...";
  animation: dots 1s infinite;
}

@keyframes dots {
  0% { content: " ."; }
  33% { content: " .."; }
  66% { content: " ..."; }
  100% { content: " ."; }
}

/* ============================
   بطاقات السيارات
============================ */
.cards {
  display: flex;
  flex-direction: column;
  gap: 14px;
}

.car-card {
  background: white;
  border: 1px solid #e5e7eb;
  border-radius: 14px;
  padding: 16px;
  font-size: 15px;
  box-shadow: 0 3px 10px rgba(0,0,0,0.05);
  line-height: 1.7;
  transition: 0.2s;
}

.car-card:hover {
  transform: scale(1.01);
}

.car-card h4 {
  margin: 0 0 10px;
  font-size: 20px;
  font-weight: 700;
  color: #0d47a1;
}

.car-card p {
  margin: 4px 0;
  font-size: 15px;
}

.car-card ul {
  margin: 10px 0 0;
  padding-left: 20px;
}

.car-card ul li {
  margin-bottom: 5px;
  font-size: 14px;
}

/* ============================
   الخدمات المختارة
============================ */
.services-box {
  background: #f3f4f6;
  padding: 14px;
  border-radius: 12px;
  font-size: 14px;
}

.total {
  font-size: 20px;
  font-weight: 700;
  color: #0d47a1;
  margin-top: 10px;
}

/* ============================
   Toast Notifications
============================ */
#toast-container {
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 99999;
}

.toast {
  background: #333;
  color: white;
  padding: 14px 20px;
  border-radius: 12px;
  margin-top: 12px;
  opacity: 0;
  transform: translateY(20px);
  transition: 0.3s;
  font-size: 15px;
  box-shadow: 0 3px 8px rgba(0,0,0,0.2);
}

.toast.show {
  opacity: 1;
  transform: translateY(0);
}

.toast.success { background: #16a34a; }
.toast.error { background: #dc2626; }
.toast.info { background: #2563eb; }

/* ============================
   صفوف الإدخال
============================ */
.row {
  display: flex;
  gap: 14px;
}

.row > div {
  flex: 1;
}

/* ============================
   Responsive
============================ */
@media (max-width: 768px) {
  .row {
    flex-direction: column;
  }

  .section {
    padding: 14px;
  }

  .car-card {
    font-size: 14px;
  }

  body::before {
    background-size: 300px;
  }
}

@media (max-width: 480px) {
  .page-title h1 {
    font-size: 22px;
  }

  .page-title h2 {
    font-size: 16px;
  }

  input, select {
    font-size: 14px;
    padding: 10px;
  }

  .btn-primary, .btn-secondary {
    font-size: 15px;
    padding: 12px;
  }
}
</style>

<!-- API -->
<script src="api.js"></script>

<!-- ============================
     visit-manager.js (كامل)
============================ -->
<script>
let currentMembership = "";
let selectedServices = [];
let carTypesData = [];
let servicesData = [];

const el = id => document.getElementById(id);

function showToast(msg, type = "info") {
  const container = el("toast-container");
  const div = document.createElement("div");
  div.className = "toast " + type;
  div.textContent = msg;
  container.appendChild(div);
  setTimeout(() => div.classList.add("show"), 10);
  setTimeout(() => div.remove(), 3000);
}

/* ===========================
   تحميل الزيارات النشطة
=========================== */
async function loadActiveVisits() {
  const list = el("activeVisitsList");
  list.innerHTML = "جارِ التحميل...";

  try {
    const res = await apiGetActiveVisits();
    const rows = res.rows || [];

    list.innerHTML = "";

    if (!rows.length) {
      list.innerHTML = "<p>لا توجد زيارات حالياً.</p>";
      return;
    }

    const cars = {};

    rows.forEach(r => {
      const plate = r[1];

      if (!cars[plate]) {
        cars[plate] = {
          plate,
          membership: r[0],
          services: [],
          totalPrice: 0,
          checkIn: r[13],
          parking: r[17]
        };
      }

      cars[plate].services.push({
        name: r[6],
        price: r[7]
      });

      cars[plate].totalPrice += Number(r[7] || 0);
    });

    Object.values(cars).forEach(car => {
      const card = document.createElement("div");
      card.className = "car-card";

      const servicesHTML = car.services
        .map(s => `<li>${s.name} — ${s.price} ريال</li>`)
        .join("");

      card.innerHTML = `
        <h4>لوحة: ${car.plate}</h4>
        <p><b>رقم العضوية:</b> ${car.membership}</p>
        <p><b>الإجمالي:</b> ${car.totalPrice} ريال</p>
        <p><b>الدخول:</b> ${car.checkIn}</p>
        <p><b>رقم الموقف:</b> ${car.parking}</p>

        <p><b>الخدمات:</b></p>
        <ul>${servicesHTML}</ul>
      `;

      list.appendChild(card);
    });

  } catch (err) {
    console.error(err);
    showToast("خطأ في تحميل الزيارات", "error");
  }
}

/* ===========================
   تحميل أنواع السيارات
=========================== */
async function loadCarTypes() {
  try {
    const res = await apiGetCarTypes();
    carTypesData = res.rows || [];

    const brandSelect = el("car_type");
    const modelSelect = el("car_model");
    const sizeInput = el("car_size");

    brandSelect.innerHTML = '<option value="">— اختر البراند —</option>';
    modelSelect.innerHTML = '<option value="">— اختر الموديل —</option>';
    sizeInput.value = "";

    const brands = [...new Set(carTypesData.map(r => r[0]))];

    brands.forEach(b => {
      const opt = document.createElement("option");
      opt.value = b;
      opt.textContent = b;
      brandSelect.appendChild(opt);
    });

    brandSelect.addEventListener("change", () => {
      const brand = brandSelect.value;
      modelSelect.innerHTML = '<option value="">— اختر الموديل —</option>';
      sizeInput.value = "";

      if (!brand) return;

      const models = carTypesData.filter(r => r[0] === brand);
      const uniqueModels = [...new Set(models.map(r => r[1]))];

      uniqueModels.forEach(m => {
        const opt = document.createElement("option");
        opt.value = m;
        opt.textContent = m;
        modelSelect.appendChild(opt);
      });
    });

    modelSelect.addEventListener("change", () => {
      const brand = brandSelect.value;
      const model = modelSelect.value;
      const row = carTypesData.find(r => r[0] === brand && r[1] === model);
      sizeInput.value = row ? row[2] : "";
    });

  } catch (err) {
    console.error(err);
    showToast("خطأ في تحميل أنواع السيارات", "error");
  }
}

/* ===========================
   التعرف التلقائي من اللوحة
=========================== */
async function autoDetectCar() {
  const plate = el("plate_numbers").value.trim();
  if (!plate) return;

  try {
    const res = await apiPost({
      action: "detectCarByPlate",
      plate_numbers: plate
    });

    if (!res.success) return;

    currentMembership = res.membership || "";
    el("car_type").value = res.brand || "";
    el("car_model").value = res.model || "";
    el("car_size").value = res.size || "";

    showToast("تم التعرف على السيارة", "success");

  } catch (err) {
    currentMembership = "";
  }
}

/* ===========================
   تحميل الخدمات
=========================== */
async function loadServices() {
  try {
    const res = await apiGetServices();
    servicesData = res.services || [];

    const typeSelect = el("service_type");
    const detailSelect = el("service_detail");

    typeSelect.innerHTML = '<option value="">— اختر نوع الخدمة —</option>';
    detailSelect.innerHTML = '<option value="">— اختر الخدمة —</option>';

    const categories = [...new Set(servicesData.map(s => s.category))];

    categories.forEach(c => {
      const opt = document.createElement("option");
      opt.value = c;
      opt.textContent = c;
      typeSelect.appendChild(opt);
    });

    typeSelect.addEventListener("change", () => {
      const cat = typeSelect.value;
      detailSelect.innerHTML = '<option value="">— اختر الخدمة —</option>';

      const filtered = servicesData.filter(s => s.category === cat);

      filtered.forEach(s => {
        const opt = document.createElement("option");
        opt.value = s.service;
        opt.textContent = s.service;
        detailSelect.appendChild(opt);
      });
    });

    detailSelect.addEventListener("change", () => {
      const name = detailSelect.value;
      const row = servicesData.find(s => s.service === name);

      el("price").value = row ? row.price : 0;
      el("points").value = row ? row.commission : 0;
    });

  } catch (err) {
    console.error(err);
    showToast("خطأ في تحميل الخدمات", "error");
  }
}

/* ===========================
   تحميل الموظفين
=========================== */
async function loadEmployees() {
  try {
    const res = await apiGetEmployees();
    const employees = res.rows || [];

    const sel = el("employee_in");
    sel.innerHTML = '<option value="">— اختر الموظف —</option>';

    employees.forEach(e => {
      const opt = document.createElement("option");
      opt.value = e[0];
      opt.textContent = e[0];
      sel.appendChild(opt);
    });

  } catch (err) {
    console.error(err);
    showToast("خطأ في تحميل الموظفين", "error");
  }
}

/* ===========================
   إضافة خدمة
=========================== */
function addServiceToList() {
  const detail = el("service_detail").value;
  const price = Number(el("price").value || 0);
  const points = Number(el("points").value || 0);

  if (!detail) {
    showToast("اختر خدمة", "error");
    return;
  }

  selectedServices.push({ name: detail, price, points });
  renderServicesList();
  recalcTotal();
}

function renderServicesList() {
  const box = el("servicesList");
  box.innerHTML = "";

  selectedServices.forEach((s, i) => {
    const div = document.createElement("div");
    div.className = "service-item";
    div.innerHTML = `
      <span>${s.name} - ${s.price} ريال</span>
      <button class="btn-remove" data-i="${i}">حذف</button>
    `;
    box.appendChild(div);
  });

  box.querySelectorAll(".btn-remove").forEach(btn => {
    btn.addEventListener("click", () => {
      const i = btn.getAttribute("data-i");
      selectedServices.splice(i, 1);
      renderServicesList();
      recalcTotal();
    });
  });
}

/* ===========================
   حساب الإجمالي
=========================== */
function recalcTotal() {
  const total = selectedServices.reduce((sum, s) => sum + s.price, 0);
  const discount = Number(el("discount").value || 0);
  el("totalPrice").textContent = Math.max(0, total - discount);
}

/* ===========================
   الدفع الجزئي
=========================== */
function setupPaymentStatus() {
  const statusSel = el("payment_status");
  const methodSel = el("payment_method");
  const methodWrapper = el("payment_method_wrapper");
  const partialBox = el("partial_payment_box");

  statusSel.addEventListener("change", () => {
    if (statusSel.value === "مدفوع") {
      methodWrapper.style.display = "block";
    } else {
      methodWrapper.style.display = "none";
      partialBox.style.display = "none";
    }
  });

  methodSel.addEventListener("change", () => {
    if (methodSel.value === "جزئي") {
      partialBox.style.display = "block";
    } else {
      partialBox.style.display = "none";
    }
  });

  ["cash_amount", "card_amount"].forEach(id => {
    el(id).addEventListener("input", () => {
      const cash = Number(el("cash_amount").value || 0);
      const card = Number(el("card_amount").value || 0);
      el("paid_total").textContent = cash + card;
    });
  });
}

/* ===========================
   إرسال الزيارة (مع زر منع الضغط)
=========================== */
async function submitVisit() {
  const btn = el("btnSubmitVisit");

  btn.classList.add("btn-loading");
  btn.textContent = "جاري تسجيل الزيارة...";
  btn.disabled = true
  } finally {
    resetButton();
  }

  function resetButton() {
    btn.classList.remove("btn-loading");
    btn.textContent = "تسجيل الزيارة";
    btn.disabled = false;
  }
}

/* ===========================
   إعادة تعيين النموذج
=========================== */
function resetForm() {
  el("plate_numbers").value = "";
  el("plate_letters").value = "";
  el("car_type").value = "";
  el("car_model").innerHTML = '<option value="">— اختر الموديل —</option>';
  el("car_size").value = "";
  el("service_type").value = "";
  el("service_detail").innerHTML = '<option value="">— اختر الخدمة —</option>';
  el("price").value = "";
  el("points").value = "";
  el("discount").value = "";
  el("parking_slot").value = "";
  el("payment_status").value = "";
  el("payment_method").value = "";
  el("payment_method_wrapper").style.display = "none";
  el("partial_payment_box").style.display = "none";

  selectedServices = [];
  renderServicesList();
  recalcTotal();
  currentMembership = "";
}

/* ===========================
   INIT
=========================== */
document.addEventListener("DOMContentLoaded", () => {
  loadActiveVisits();
  loadCarTypes();
  loadServices();
  loadEmployees();
  setupPaymentStatus();

  el("btnRefreshActive").addEventListener("click", loadActiveVisits);
  el("btnAddService").addEventListener("click", addServiceToList);
  el("discount").addEventListener("input", recalcTotal);
  el("plate_numbers").addEventListener("blur", autoDetectCar);
  el("btnSubmitVisit").addEventListener("click", submitVisit);
});
</script>

</head>

<body>

<!-- Toast -->
<div id="toast-container"></div>

</body>
</html>
