<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>حجز موعد</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        body{font-family:"Tajawal",sans-serif;background:#f5f5f5;padding:25px;}
        .container{max-width:480px;margin:auto;background:white;padding:25px;border-radius:12px;box-shadow:0 4px 12px #0002;}
        label{margin-top:10px;display:block;}
        input,select{width:100%;padding:12px;margin-top:6px;border-radius:8px;border:1px solid #ccc;}
        button{width:100%;padding:14px;margin-top:18px;border:none;border-radius:8px;background:#007bff;color:white;font-size:17px;cursor:pointer;}
        .service-item{background:#f0f0f0;padding:10px;border-radius:8px;margin-top:10px;display:flex;justify-content:space-between;}
        .remove-btn{background:red;color:white;border:none;padding:5px 10px;border-radius:6px;cursor:pointer;}
    </style>
</head>

<body>

<div class="container">
    <h2>حجز موعد جديد</h2>

    <label>اختر السيارة</label>
    <select id="carSelect"></select>

    <label>الخدمة</label>
    <select id="categorySelect" onchange="loadServiceTypes()"></select>

    <label>نوع الخدمة</label>
    <select id="serviceSelect" onchange="updatePrice()"></select>

    <label>السعر</label>
    <input id="price" type="text" readonly>

    <button onclick="addService()">إضافة الخدمة</button>

    <h3>الخدمات المختارة</h3>
    <div id="selectedServices"></div>

    <h3>المجموع: <span id="totalPrice">0</span> ريال</h3>

    <label>التاريخ</label>
    <input id="date" type="date">

    <label>الوقت</label>
    <input id="time" type="time">

    <button onclick="book()">حجز الموعد</button>
</div>

<script src="api.js"></script>

<script>
let CUSTOMER = JSON.parse(localStorage.getItem("customer"));
let PHONE = CUSTOMER.phone;

let SERVICES = [];
let COMMISSION = [];
let SELECTED = [];

window.onload = async function(){
    await loadCars();
    await loadCategories();
    await loadServices();
};

async function loadCars(){
    const carSelect=document.getElementById("carSelect");
    const res=await apiGet({ action:"getCarsByPhone", phone:PHONE });

    carSelect.innerHTML='<option value="">اختر السيارة</option>';

    if(res.success){
        res.cars.forEach(c=>{
            const opt=document.createElement("option");
            opt.value=c[0];
            opt.innerText=`${c[2]} • ${c[3]} • ${c[5]} ${c[4]}`;
            carSelect.appendChild(opt);
        });
    }
}

async function loadCategories(){
    const categorySelect=document.getElementById("categorySelect");
    const res=await apiGet({ action:"getAll", sheet:"Commission" });

    categorySelect.innerHTML='<option value="">اختر الخدمة</option>';

    if(res.success){
        COMMISSION=res.rows;
        COMMISSION.forEach(r=>{
            if(r[4]){
                const opt=document.createElement("option");
                opt.value=r[4];
                opt.innerText=r[4];
                categorySelect.appendChild(opt);
            }
        });
    }
}

async function loadServices(){
    const res=await apiGet({ action:"getAll", sheet:"Services" });
    if(res.success) SERVICES=res.rows;
}

function loadServiceTypes(){
    const category=document.getElementById("categorySelect").value;
    const serviceSelect=document.getElementById("serviceSelect");
    const priceInput=document.getElementById("price");

    priceInput.value="";
    serviceSelect.innerHTML='<option value="">اختر نوع الخدمة</option>';

    SERVICES.filter(s=>s[0]===category).forEach(row=>{
        const opt=document.createElement("option");
        opt.value=row[1];
        opt.innerText=row[1];
        opt.setAttribute("data-price",row[2]);
        serviceSelect.appendChild(opt);
    });
}

function updatePrice(){
    const serviceSelect=document.getElementById("serviceSelect");
    const selected=serviceSelect.options[serviceSelect.selectedIndex];
    document.getElementById("price").value = selected.getAttribute("data-price") || "";
}

function addService(){
    const category=document.getElementById("categorySelect").value;
    const service=document.getElementById("serviceSelect").value;
    const price=document.getElementById("price").value;

    if(!category || !service || !price){
        alert("اختر الخدمة أولاً");
        return;
    }

    SELECTED.push({ category, service, price });
    renderSelectedServices();
    updateTotal();
}

function renderSelectedServices(){
    const container=document.getElementById("selectedServices");
    container.innerHTML="";

    SELECTED.forEach((s,i)=>{
        const div=document.createElement("div");
        div.className="service-item";
        div.innerHTML=`
            <span>${s.category} - ${s.service} (${s.price} ريال)</span>
            <button class="remove-btn" onclick="removeService(${i})">حذف</button>
        `;
        container.appendChild(div);
    });
}

function removeService(i){
    SELECTED.splice(i,1);
    renderSelectedServices();
    updateTotal();
}

function updateTotal(){
    const total=SELECTED.reduce((sum,s)=>sum+Number(s.price),0);
    document.getElementById("totalPrice").innerText=total;
}

async function book(){
    const carMembership=document.getElementById("carSelect").value;
    const date=document.getElementById("date").value;
    const time=document.getElementById("time").value;

    if(!carMembership || !date || !time || SELECTED.length===0){
        alert("الرجاء تعبئة جميع الحقول");
        return;
    }

    const servicesString=SELECTED.map(s=>`${s.category} - ${s.service}`).join(" | ");
    const totalPrice=SELECTED.reduce((sum,s)=>sum+Number(s.price),0);

    await apiPost({
        action:"addRow",
        sheet:"Bookings",
        values:JSON.stringify([
            carMembership,
            "=\"" + PHONE + "\"",
            servicesString,
            date,
            time,
            "قيد الانتظار",
            totalPrice,
            new Date().toISOString()
        ])
    });

    alert("تم الحجز بنجاح");
    window.location.href="customer-bookings.html";
}
</script>

</body>
</html>
