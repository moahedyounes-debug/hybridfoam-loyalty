<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø§Ù„Ùƒ - Owner Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

<style>
:root {
    --bg: #020617;
    --card: #020617;
    --border: #1f2937;
    --accent: #2563eb;
    --accent-soft: #1d4ed8;
    --danger: #dc2626;
    --success: #16a34a;
    --text-main: #f9fafb;
    --text-muted: #9ca3af;
    --radius-lg: 16px;
    --radius-md: 12px;
    --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.7);
}

*,
*::before,
*::after {
    box-sizing: border-box;
}

body {
    margin: 0;
    font-family: "Tajawal", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    background: radial-gradient(circle at top, #1e293b 0, #020617 45%, #000 100%);
    color: var(--text-main);
    direction: rtl;
}

/* Layout */
.layout {
    display: flex;
    min-height: 100vh;
}

/* Sidebar */
.sidebar {
    width: 260px;
    background: rgba(15, 23, 42, 0.96);
    border-left: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    padding: 18px 14px;
    gap: 10px;
}

.brand {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 16px;
}

.brand-logo {
    width: 40px;
    height: 40px;
    border-radius: 14px;
    background: conic-gradient(from 180deg, #2563eb, #4f46e5, #22c55e, #2563eb);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 18px;
    color: #e5e7eb;
}

.brand-text {
    font-size: 18px;
    font-weight: 600;
}

.nav-section-title {
    font-size: 11px;
    color: var(--text-muted);
    margin: 10px 4px 4px;
}

.nav {
    display: flex;
    flex-direction: column;
    gap: 6px;
    margin-bottom: 6px;
}

.nav-btn {
    width: 100%;
    text-align: right;
    padding: 9px 11px;
    border-radius: 10px;
    border: none;
    background: transparent;
    color: var(--text-muted);
    font-size: 14px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: space-between;
    transition: 0.15s ease-out;
}

.nav-btn span {
    display: inline-flex;
    align-items: center;
    gap: 6px;
}

.nav-btn.active {
    background: rgba(37, 99, 235, 0.22);
    color: var(--text-main);
}

.nav-btn:hover {
    background: rgba(15, 23, 42, 0.9);
    color: var(--text-main);
}

/* Main */
.main {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-width: 0;
}

/* Topbar */
.topbar {
    padding: 12px 18px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: rgba(15, 23, 42, 0.9);
    backdrop-filter: blur(10px);
    position: sticky;
    top: 0;
    z-index: 10;
}

.topbar-left {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.topbar-title {
    font-size: 16px;
    font-weight: 500;
}

.topbar-sub {
    font-size: 12px;
    color: var(--text-muted);
}

.stats-bar {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    justify-content: flex-end;
}

.pill {
    padding: 4px 10px;
    border-radius: 999px;
    background: rgba(15, 23, 42, 0.9);
    border: 1px solid var(--border);
    font-size: 12px;
    color: var(--text-muted);
    display: inline-flex;
    align-items: center;
    gap: 4px;
}

/* Content */
.content {
    padding: 18px;
    display: flex;
    flex-direction: column;
    gap: 18px;
}

.section {
    display: none;
}
.section.active {
    display: block;
}

.card {
    background: var(--card);
    border-radius: var(--radius-lg);
    padding: 16px;
    border: 1px solid var(--border);
    box-shadow: var(--shadow-soft);
}

.card-header {
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 10px;
}

.card-header h2,
.card-header h3 {
    margin: 0;
    text-align: center;
}

h2, h3 {
    text-align: center;
    margin: 0 0 10px;
}

p {
    text-align: center;
}

/* Inputs */
label {
    display: block;
    font-size: 13px;
    color: var(--text-muted);
    margin-top: 8px;
    margin-bottom: 3px;
}

input, select, textarea {
    width: 100%;
    padding: 10px 11px;
    border-radius: var(--radius-md);
    border: 1px solid var(--border);
    background: #020617;
    color: var(--text-main);
    font-size: 14px;
    margin-bottom: 6px;
    outline: none;
    transition: 0.15s ease-out;
}

input:focus,
select:focus,
textarea:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.4);
}

textarea {
    min-height: 90px;
    resize: vertical;
}

/* Buttons */
button {
    padding: 10px 12px;
    border-radius: var(--radius-md);
    border: none;
    background: var(--accent);
    color: white;
    font-size: 14px;
    cursor: pointer;
    margin-top: 8px;
    position: relative;
    transition: 0.15s ease-out;
}

button.loading {
    color: transparent !important;
    cursor: not-allowed;
    background: #6b7280 !important;
}

button.loading::after {
    content: "";
    position: absolute;
    top: 50%;
    left: 50%;
    width: 20px;
    height: 20px;
    margin-top: -10px;
    margin-left: -10px;
    border: 3px solid white;
    border-top-color: transparent;
    border-radius: 50%;
    animation: spin 0.7s linear infinite;
}

button:active {
    transform: scale(0.97);
}

button.secondary {
    background: #111827;
    color: var(--text-main);
}

button.danger {
    background: var(--danger);
}

/* Loader keyframes */
@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Lists */
.list {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

/* Grid */
.grid {
    display: grid;
    gap: 10px;
}
.grid-2 {
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
}

/* Status text */
.status-text {
    font-size: 12px;
    color: var(--text-muted);
    margin-top: 6px;
    text-align: center;
}

/* Responsive */
@media (max-width: 900px) {
    .layout {
        flex-direction: column;
    }
    .sidebar {
        width: 100%;
        flex-direction: row;
        overflow-x: auto;
        border-left: none;
        border-bottom: 1px solid var(--border);
    }
    .nav {
        flex-direction: row;
        flex-wrap: nowrap;
    }
    .nav-btn {
        white-space: nowrap;
    }
    .topbar {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
    }
    .stats-bar {
        justify-content: flex-start;
    }
}
</style>
</head>
<body>

<div class="layout">

    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="brand">
            <div class="brand-logo">OD</div>
            <div class="brand-text">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø§Ù„Ùƒ</div>
        </div>

        <div class="nav-section-title">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
        <div class="nav">
            <button class="nav-btn active" data-target="dashboard"><span>Dashboard</span></button>
        </div>

        <div class="nav-section-title">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</div>
        <div class="nav">
            <button class="nav-btn" data-target="services"><span>Ø§Ù„Ø®Ø¯Ù…Ø§Øª</span></button>
            <button class="nav-btn" data-target="visits"><span>Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª</span></button>
            <button class="nav-btn" data-target="bookings"><span>Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</span></button>
            <button class="nav-btn" data-target="employees"><span>Ø§Ù„Ù…ÙˆØ¸ÙÙˆÙ† ÙˆØ§Ù„Ø±ÙˆØ§ØªØ¨</span></button>
            <button class="nav-btn" data-target="branches"><span>Ø§Ù„ÙØ±ÙˆØ¹</span></button>
            <button class="nav-btn" data-target="notifications"><span>Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</span></button>
            <button class="nav-btn" data-target="reports"><span>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</span></button>
        </div>
    </aside>

    <!-- Main -->
    <main class="main">
        <div class="topbar">
            <div class="topbar-left">
                <div class="topbar-title">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø§Ù„Ùƒ</div>
                <div class="topbar-sub">Ù†Ø¸Ø±Ø© Ø´Ø§Ù…Ù„Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¯Ø§Ø¡ØŒ Ø§Ù„Ø®Ø¯Ù…Ø§ØªØŒ Ø§Ù„Ø²ÙŠØ§Ø±Ø§ØªØŒ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª ÙˆØ§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</div>
            </div>
            <div class="stats-bar">
                <div class="pill">ğŸ‘¥ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡: <span id="sCustomers">0</span></div>
                <div class="pill">ğŸš— Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª: <span id="sCars">0</span></div>
                <div class="pill">ğŸ§¾ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª: <span id="sVisits">0</span></div>
                <div class="pill">ğŸ’° Ø§Ù„Ù…Ø¨Ø§Ù„Øº: <span id="sAmount">0</span></div>
            </div>
        </div>

        <div class="content">

            <!-- Dashboard -->
            <section id="dashboard" class="section active">
                <div class="grid grid-2">
                    <div class="card">
                        <div class="card-header"><h2>Ù…Ù„Ø®Øµ Ø¹Ø§Ù…</h2></div>
                        <p id="stats">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
                    </div>

                    <div class="card">
                        <div class="card-header"><h2>Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h2></div>
                        <div id="levelsBox" class="list"></div>
                    </div>
                </div>

                <div class="grid grid-2">
                    <div class="card">
                        <div class="card-header"><h3>Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø£ÙƒØ«Ø± Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‹Ø§</h3></div>
                        <div id="servicesBreakdown" class="list"></div>
                    </div>
                    <div class="card">
                        <div class="card-header"><h3>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</h3></div>
                        <div id="carsStats" class="list"></div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header"><h3>ØµØ­Ø© Ø§Ù„Ø¹Ù…Ù„</h3></div>
                    <p id="businessHealth"></p>
                </div>
            </section>

            <!-- Services -->
            <section id="services" class="section">
                <div class="card">
                    <div class="card-header"><h2>Ø§Ù„Ø®Ø¯Ù…Ø§Øª (Commissions)</h2></div>
                    <div id="servicesListFull" class="list"></div>
                </div>
            </section>

            <!-- Visits -->
            <section id="visits" class="section">
                <div class="card">
                    <div class="card-header"><h2>Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®</h2></div>

                    <label>Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
                    <input id="visitsFrom" class="datePicker" placeholder="YYYY-MM-DD">

                    <label>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
                    <input id="visitsTo" class="datePicker" placeholder="YYYY-MM-DD">

                    <button id="visitsOwnerBtn">Ø¹Ø±Ø¶ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª</button>

                    <div id="visitsOwnerList" class="list" style="margin-top:10px;"></div>
                </div>
            </section>

            <!-- Bookings -->
            <section id="bookings" class="section">
                <div class="card">
                    <div class="card-header"><h2>Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</h2></div>

                    <label>Ø§Ø®ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ® (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                    <input id="bookingsDateOwner" class="datePicker" placeholder="YYYY-MM-DD">

                    <div id="bookingsListOwner" class="list" style="margin-top:10px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
                </div>
            </section>

            <!-- Employees / Payroll -->
            <section id="employees" class="section">
                <div class="card">
                    <div class="card-header"><h2>Ø§Ù„Ù…ÙˆØ¸ÙÙˆÙ† ÙˆØ§Ù„Ø±ÙˆØ§ØªØ¨</h2></div>

                    <div class="grid grid-2">
                        <div>
                            <h3>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h3>
                            <div id="employeesList" class="list"></div>
                        </div>
                        <div>
                            <h3>Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±ÙˆØ§ØªØ¨</h3>
                            <label>Ø§Ù„Ù…ÙˆØ¸Ù</label>
                            <select id="payrollEmployee"></select>

                            <label>Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
                            <input id="payrollFrom" class="datePicker" placeholder="YYYY-MM-DD">

                            <label>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
                            <input id="payrollTo" class="datePicker" placeholder="YYYY-MM-DD">

                            <button id="payrollBtn">Ø­Ø³Ø§Ø¨</button>

                            <div id="payrollResult" class="status-text" style="margin-top:10px;"></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Branches -->
            <section id="branches" class="section">
                <div class="card">
                    <div class="card-header"><h2>Ø§Ù„ÙØ±ÙˆØ¹</h2></div>
                    <div id="branchesList" class="list"></div>
                </div>
            </section>

            <!-- Notifications -->
            <section id="notifications" class="section">
                <div class="card">
                    <div class="card-header"><h2>Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</h2></div>

                    <label>Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</label>
                    <input id="notifPhone" placeholder="05xxxxxxxx">

                    <button id="notifLoadBtn">Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</button>

                    <div id="notifList" class="list" style="margin-top:10px;"></div>
                </div>
            </section>

            <!-- Reports -->
            <section id="reports" class="section">
                <div class="card">
                    <div class="card-header"><h2>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</h2></div>

                    <label>Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
                    <input id="reportsFrom" class="datePicker" placeholder="YYYY-MM-DD">

                    <label>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
                    <input id="reportsTo" class="datePicker" placeholder="YYYY-MM-DD">

                    <button id="reportsOwnerBtn">Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>

                    <div id="reportsOwnerList" class="list" style="margin-top:10px;"></div>
                </div>
            </section>

        </div>
    </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="api.js?v=3"></script>

<script>
/* ========== Helpers ========== */
const $ = (id) => document.getElementById(id);

function setLoading(btn, state = true) {
    if (!btn) return;
    if (state) {
        btn.classList.add("loading");
        btn.disabled = true;
    } else {
        btn.classList.remove("loading");
        btn.disabled = false;
    }
}

function createCard(html) {
    const div = document.createElement("div");
    div.className = "card";
    div.innerHTML = html;
    return div;
}

function clear(el) {
    if (el) el.innerHTML = "";
}

/* ========== Tabs ========== */
function initTabs() {
    const sections = document.querySelectorAll(".section");
    const navButtons = document.querySelectorAll(".nav-btn");

    navButtons.forEach(btn => {
        btn.addEventListener("click", () => {
            const target = btn.dataset.target;

            sections.forEach(s => s.classList.remove("active"));
            $(target).classList.add("active");

            navButtons.forEach(b => b.classList.remove("active"));
            btn.classList.add("active");
        });
    });
}

/* ========== Date Pickers ========== */
function initDatePickers() {
    const options = { dateFormat: "Y-m-d", allowInput: true };
    flatpickr("#visitsFrom", options);
    flatpickr("#visitsTo", options);
    flatpickr("#bookingsDateOwner", options);
    flatpickr("#payrollFrom", options);
    flatpickr("#payrollTo", options);
    flatpickr("#reportsFrom", options);
    flatpickr("#reportsTo", options);
}

/* ========== Dashboard ========== */
async function loadDashboard() {
    const res = await apiGet({ action: "getOwnersDashboard" });

    $("stats").innerHTML = `
        Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡: ${res.totals.customers}<br>
        Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª: ${res.totals.cars}<br>
        Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª: ${res.totals.visits}<br>
        Ø§Ù„Ù…Ø¨Ø§Ù„Øº: ${res.totals.amount}
    `;

    $("sCustomers").innerText = res.totals.customers;
    $("sCars").innerText = res.totals.cars;
    $("sVisits").innerText = res.totals.visits;
    $("sAmount").innerText = res.totals.amount;

    // Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
    const levelsBox = $("levelsBox");
    clear(levelsBox);
    Object.entries(res.levels).forEach(([level, count]) => {
        levelsBox.appendChild(createCard(`${level}: ${count}`));
    });

    // Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø£ÙƒØ«Ø± Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‹Ø§
    const servicesBox = $("servicesBreakdown");
    clear(servicesBox);
    res.services_breakdown
        .sort((a, b) => b.count - a.count)
        .slice(0, 5)
        .forEach(s => {
            servicesBox.appendChild(createCard(`
                Ø§Ù„Ø®Ø¯Ù…Ø©: ${s.service}<br>
                Ø¹Ø¯Ø¯ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª: ${s.count}<br>
                Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ø§Ù„Øº: ${s.amount}
            `));
        });

    // Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª
    const carsBox = $("carsStats");
    clear(carsBox);
    carsBox.appendChild(createCard(
        "<b>Ø£ÙƒØ«Ø± Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª:</b><br>" +
        res.cars_stats.top_car_types
            .slice(0, 5)
            .map(c => `${c.car}: ${c.count}`)
            .join("<br>")
    ));
    carsBox.appendChild(createCard(
        "<b>Ø£ÙƒØ«Ø± Ø§Ù„Ø£Ø­Ø¬Ø§Ù…:</b><br>" +
        res.cars_stats.top_sizes
            .map(c => `${c.size}: ${c.count}`)
            .join("<br>")
    ));
    carsBox.appendChild(createCard(
        "<b>Ø£ÙƒØ«Ø± Ø§Ù„Ù…Ø¯Ù†:</b><br>" +
        res.cars_stats.top_cities
            .map(c => `${c.city}: ${c.count}`)
            .join("<br>")
    ));

    // ØµØ­Ø© Ø§Ù„Ø¹Ù…Ù„
    $("businessHealth").innerHTML = `
        Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ø§Ù…: ${res.business_health.score} / 100<br>
        Ø§Ù„Ø­Ø§Ù„Ø©: ${res.business_health.status}<br>
        Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡: ${res.totals.retention_rate.toFixed(1)}%<br>
        Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¥Ù†ÙØ§Ù‚ Ù„ÙƒÙ„ Ø¹Ù…ÙŠÙ„: ${res.totals.avg_spend_per_customer.toFixed(1)}<br>
        Ù…ØªÙˆØ³Ø· Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ù„ÙƒÙ„ Ø¹Ù…ÙŠÙ„: ${res.totals.avg_visits_per_customer.toFixed(1)}
    `;
}

/* ========== Services (Commissions) ========== */
async function loadServicesFull() {
    const res = await apiGet({ action: "getCommissions" });
    const list = $("servicesListFull");
    clear(list);

    if (!res.commissions || !res.commissions.length) {
        list.innerHTML = "<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø®Ø¯Ù…Ø§Øª Ù…Ø³Ø¬Ù„Ø©</p>";
        return;
    }

    res.commissions.forEach(s => {
        list.appendChild(createCard(`
            Ø§Ù„Ø®Ø¯Ù…Ø©: ${s.service}<br>
            Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©: ${s.commission}<br>
            Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ: ${s.price || 0}<br>
            Ø§Ù„Ù…Ø¯Ø©: ${s.duration || 30} Ø¯Ù‚ÙŠÙ‚Ø©
        `));
    });
}

/* ========== Visits (owner) ========== */
async function loadVisitsOwner() {
    const btn = $("visitsOwnerBtn");
    const from = $("visitsFrom").value.trim();
    const to = $("visitsTo").value.trim();

    if (!from || !to) return alert("Ø§Ø®ØªØ± Ù…Ù† ÙˆØ¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®");

    setLoading(btn, true);

    const res = await apiGet({
        action: "getVisitsByDate",
        from,
        to
    });

    setLoading(btn, false);

    const list = $("visitsOwnerList");
    clear(list);

    if (!res.visits.length) {
        list.innerHTML = "<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø²ÙŠØ§Ø±Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©</p>";
        return;
    }

    res.visits.forEach(v => {
        list.appendChild(createCard(`
            Ø§Ù„ØªØ§Ø±ÙŠØ®: ${v.date}<br>
            Ø§Ù„Ø®Ø¯Ù…Ø©: ${v.service}<br>
            Ø§Ù„Ø³Ø¹Ø±: ${v.price}<br>
            Ø§Ù„Ù†Ù‚Ø§Ø·: ${v.points}<br>
            Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©: ${v.membership}<br>
            Ø§Ù„Ù…ÙˆØ¸Ù: ${v.employee || "-"}<br>
            Ø§Ù„ÙØ±Ø¹: ${v.branch || "-"}
        `));
    });
}

/* ========== Bookings (owner) ========== */
async function loadBookingsOwner() {
    const date = $("bookingsDateOwner").value.trim();

    const res = await apiGet({
        action: "getBookings",
        date
    });

    const list = $("bookingsListOwner");
    clear(list);

    if (!res.bookings.length) {
        list.innerHTML = "<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª</p>";
        return;
    }

    res.bookings.forEach(b => {
        const div = createCard(`
            Ø§Ù„Ø¬ÙˆØ§Ù„: ${b.phone}<br>
            Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©: ${b.membership}<br>
            Ø§Ù„Ø®Ø¯Ù…Ø©: ${b.service}<br>
            Ø§Ù„ØªØ§Ø±ÙŠØ®: ${b.date} ${b.time}<br>
            Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: <b>${b.status}</b><br><br>
            <button class="secondary" onclick="confirmBookingOwner(this, ${b.row})">ØªØ£ÙƒÙŠØ¯</button>
            <button class="danger" onclick="cancelBookingOwner(this, ${b.row})">Ø¥Ù„ØºØ§Ø¡</button>
        `);
        list.appendChild(div);
    });
}

async function confirmBookingOwner(btn, row) {
    setLoading(btn, true);
    await apiPost({ action: "updateBookingStatus", row, status: "Approved" });
    setLoading(btn, false);
    loadBookingsOwner();
}

async function cancelBookingOwner(btn, row) {
    setLoading(btn, true);
    await apiPost({ action: "updateBookingStatus", row, status: "Cancelled" });
    setLoading(btn, false);
    loadBookingsOwner();
}

/* ========== Employees & Payroll ========== */
async function loadEmployees() {
    const res = await apiGet({ action: "getEmployees" });

    const list = $("employeesList");
    clear(list);

    const select = $("payrollEmployee");
    select.innerHTML = "";

    if (!res.employees || !res.employees.length) {
        list.innerHTML = "<p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ¸ÙÙˆÙ†</p>";
        return;
    }

    res.employees.forEach(e => {
        list.appendChild(createCard(`
            Ø§Ù„Ø§Ø³Ù…: ${e.employee}<br>
            Ø§Ù„Ø­Ø§Ù„Ø©: ${e.status}<br>
            Ø§Ù„Ø¬ÙˆØ§Ù„: ${e.phone || "-"}<br>
            Ø§Ù„ÙØ±Ø¹: ${e.branch || "-"}
        `));

        const opt = document.createElement("option");
        opt.value = e.employee;
        opt.textContent = e.employee;
        select.appendChild(opt);
    });
}

async function loadPayroll() {
    const btn = $("payrollBtn");
    const employee = $("payrollEmployee").value;
    const from = $("payrollFrom").value.trim();
    const to = $("payrollTo").value.trim();

    if (!employee || !from || !to) return alert("Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¸Ù ÙˆØ§Ù„ÙØªØ±Ø©");

    setLoading(btn, true);

    const res = await apiGet({
        action: "getPayroll",
        employee,
        from,
        to
    });

    setLoading(btn, false);

    $("payrollResult").innerHTML = `
        Ø§Ù„Ù…ÙˆØ¸Ù: ${res.employee}<br>
        Ø¹Ø¯Ø¯ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª: ${res.total_visits}<br>
        Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©: ${res.total_commission}<br>
        Ø¹Ø¯Ø¯ Ø§Ù„ØºØ³Ù„Ø§Øª: ${res.total_washes}
    `;
}

/* ========== Branches ========== */
async function loadBranches() {
    const res = await apiGet({ action: "getBranches" });
    const list = $("branchesList");
    clear(list);

    if (!res.branches || !res.branches.length) {
        list.innerHTML = "<p>Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØ±ÙˆØ¹</p>";
        return;
    }

    res.branches.forEach(b => {
        list.appendChild(createCard(`
            Ø§Ù„ÙØ±Ø¹: ${b.branch}<br>
            Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©: ${b.city}<br>
            Ø§Ù„Ù…Ø¯ÙŠØ±: ${b.manager || "-"}
        `));
    });
}

/* ========== Notifications ========== */
async function loadNotifications() {
    const btn = $("notifLoadBtn");
    const phone = $("notifPhone").value.trim();

    if (!phone) return alert("Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„");

    setLoading(btn, true);

    const res = await apiGet({
        action: "getNotifications",
        phone
    });

    setLoading(btn, false);

    const list = $("notifList");
    clear(list);

    if (!res.notifications || !res.notifications.length) {
        list.innerHTML = "<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù…</p>";
        return;
    }

    res.notifications.forEach(n => {
        const div = createCard(`
            Ø§Ù„Ø±Ø³Ø§Ù„Ø©: ${n.message}<br>
            Ø§Ù„Ù†ÙˆØ¹: ${n.type}<br>
            Ø§Ù„ØªØ§Ø±ÙŠØ®: ${n.created_at}<br>
            Ù…Ù‚Ø±ÙˆØ¡: ${n.read ? "Ù†Ø¹Ù…" : "Ù„Ø§"}<br><br>
            ${n.read ? "" : `<button class="secondary" onclick="markNotifRead(this, ${n.row})">ØªØ­Ø¯ÙŠØ¯ ÙƒÙ…Ù‚Ø±ÙˆØ¡</button>`}
        `);
        list.appendChild(div);
    });
}

async function markNotifRead(btn, row) {
    setLoading(btn, true);
    await apiGet({ action: "markNotificationRead", row });
    setLoading(btn, false);
    $("notifLoadBtn").click();
}

/* ========== Reports (owner) ========== */
async function loadReportsOwner() {
    const btn = $("reportsOwnerBtn");
    const from = $("reportsFrom").value.trim();
    const to = $("reportsTo").value.trim();

    if (!from || !to) return alert("Ø§Ø®ØªØ± Ù…Ù† ÙˆØ¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®");

    setLoading(btn, true);

    const res = await apiGet({
        action: "getVisitsByDate",
        from,
        to
    });

    setLoading(btn, false);

    const list = $("reportsOwnerList");
    clear(list);

    if (!res.visits.length) {
        list.innerHTML = "<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</p>";
        return;
    }

    res.visits.forEach(v => {
        list.appendChild(createCard(`
            Ø§Ù„ØªØ§Ø±ÙŠØ®: ${v.date}<br>
            Ø§Ù„Ø®Ø¯Ù…Ø©: ${v.service}<br>
            Ø§Ù„Ø³Ø¹Ø±: ${v.price}<br>
            Ø§Ù„Ù†Ù‚Ø§Ø·: ${v.points}<br>
            Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©: ${v.membership}<br>
            Ø§Ù„Ù…ÙˆØ¸Ù: ${v.employee || "-"}<br>
            Ø§Ù„ÙØ±Ø¹: ${v.branch || "-"}
        `));
    });
}

/* ========== Events & Init ========== */
function initEvents() {
    $("visitsOwnerBtn").onclick = loadVisitsOwner;
    $("bookingsDateOwner").onchange = loadBookingsOwner;
    $("payrollBtn").onclick = loadPayroll;
    $("notifLoadBtn").onclick = loadNotifications;
    $("reportsOwnerBtn").onclick = loadReportsOwner;
}

initTabs();
initDatePickers();
initEvents();
loadDashboard();
loadServicesFull();
loadBookingsOwner();
loadEmployees();
loadBranches();
</script>

</body>
</html>
