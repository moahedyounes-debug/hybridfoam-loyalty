<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ููุญุฉ ุงููุงูู โ Hybrid Foam</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="api.js"></script>
  <style>
    body{
      font-family:"Tajawal",sans-serif;
      background:#F4FAFF;
      color:#0D47A1;
      padding:16px;
      margin:0;
    }
    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:16px;
    }
    header .brand{
      display:flex;
      align-items:center;
      gap:10px;
    }
    header img{
      height:40px;
    }
    header h1{
      font-size:20px;
      margin:0;
    }
    .tabs{
      display:flex;
      gap:8px;
      margin-bottom:16px;
      overflow-x:auto;
    }
    .tab-btn{
      padding:10px 16px;
      border-radius:999px;
      background:#E3F2FD;
      color:#0D47A1;
      border:none;
      cursor:pointer;
      font-size:14px;
      white-space:nowrap;
    }
    .tab-btn.active{
      background:#0D47A1;
      color:white;
    }
    .tab-content{display:none;}
    .tab-content.active{display:block;}
    .card{
      background:white;
      padding:16px;
      border-radius:16px;
      margin-bottom:16px;
      box-shadow:0 4px 12px rgba(0,0,0,0.08);
      border:1px solid #E3F2FD;
    }
    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      gap:12px;
    }
    .kpi{
      background:#F9FBFF;
      border-radius:14px;
      padding:10px 12px;
      border:1px solid #E3F2FD;
    }
    .kpi-title{
      font-size:13px;
      color:#64748B;
    }
    .kpi-value{
      font-size:20px;
      font-weight:700;
      margin-top:4px;
    }
    .kpi-sub{
      font-size:11px;
      color:#94A3B8;
      margin-top:2px;
    }
    input,select{
      width:100%;
      padding:8px;
      border-radius:8px;
      border:1px solid #D1D5DB;
      margin-bottom:8px;
      font-size:14px;
      box-sizing:border-box;
    }
    .btn{
      padding:10px 16px;
      border:none;
      border-radius:999px;
      background:#0D47A1;
      color:white;
      cursor:pointer;
      font-size:14px;
      margin-top:4px;
    }
    .btn-outline{
      padding:10px 16px;
      border-radius:999px;
      background:white;
      border:1px solid #0D47A1;
      color:#0D47A1;
      cursor:pointer;
      font-size:14px;
      margin-top:4px;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    th,td{
      border-bottom:1px solid #E5E7EB;
      padding:6px;
      text-align:right;
    }
    th{
      background:#F3F4F6;
      font-weight:600;
    }
    .tag{
      background:#E3F2FD;
      padding:2px 6px;
      border-radius:999px;
      font-size:11px;
      color:#0D47A1;
    }
    .section-title{
      margin-bottom:8px;
      font-size:15px;
      font-weight:600;
    }
    .flex{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .flex > div{
      flex:1;
      min-width:160px;
    }
    @media (max-width:600px){
      header{
        flex-direction:column;
        align-items:flex-start;
        gap:8px;
      }
    }
  </style>
</head>
<body>

<header>
  <div class="brand">
    <img src="https://raw.githubusercontent.com/moahedyounes-debug/hybridfoam-loyalty/main/logo.png" alt="Hybrid Foam Logo">
    <h1>ููุญุฉ ุงููุงูู โ Hybrid Foam</h1>
  </div>
  <div style="font-size:12px;color:#64748B;">
    ูุธุงู ุชูุงุฑูุฑ ูุฅุฏุงุฑุฉ ูุชูุฏู
  </div>
</header>

<div class="tabs">
  <button class="tab-btn active" data-tab="dashboard">๐ ุงูุฑุฆูุณูุฉ</button>
  <button class="tab-btn" data-tab="daily">๐ ุชูุงุฑูุฑ ููููุฉ / ุฃุณุจูุนูุฉ / ุดูุฑูุฉ / ุณูููุฉ</button>
  <button class="tab-btn" data-tab="payroll">๐ผ ุฑูุงุชุจ ุงูููุธููู (ุนูููุงุช)</button>
  <button class="tab-btn" data-tab="decision">๐ง ุชูุงุฑูุฑ ุงุชุฎุงุฐ ุงููุฑุงุฑ</button>
  <button class="tab-btn" data-tab="customers">๐ฅ ุงูุนููุงุก</button>
  <button class="tab-btn" data-tab="bookings">๐ ุงูุญุฌูุฒุงุช</button>
  <button class="tab-btn" data-tab="costs">๐ธ ุงููุตุงุฑูู</button>
</div>

<!-- DASHBOARD -->
<div id="dashboard" class="tab-content active">
  <div class="card">
    <div class="section-title">๐ ููุชุฑ ุงูุชุงุฑูุฎ (ุงุฎุชูุงุฑู)</div>
    <div class="flex">
      <div>
        <label>ูู ุชุงุฑูุฎ</label>
        <input type="date" id="dashFrom">
      </div>
      <div>
        <label>ุฅูู ุชุงุฑูุฎ</label>
        <input type="date" id="dashTo">
      </div>
    </div>
    <button class="btn" onclick="loadDashboard()">ุชุญุฏูุซ ุงูููุฎุต</button>
    <button class="btn-outline" onclick="resetDashboardDates()">ุนุฑุถ ูู ุงููุชุฑุงุช</button>
  </div>

  <div class="card">
    <div class="section-title">๐ ููุฎุต ุฅุฏุงุฑู ุนุงูู ุงููุณุชูู</div>
    <div id="dashboardKpis">ุฌุงุฑู ุงูุชุญููู...</div>
  </div>

  <div class="card">
    <div class="section-title">๐ ุดุงุฑุช ุงูุฏุฎู ุงููููู</div>
    <canvas id="chartRevenueDaily"></canvas>
  </div>

  <div class="card">
    <div class="section-title">๐ ุดุงุฑุช ุตุงูู ุงูุฑุจุญ ุงููููู</div>
    <canvas id="chartProfitDaily"></canvas>
  </div>

  <div class="card">
    <div class="section-title">๐ผ ุดุงุฑุช ุนูููุงุช ุงูููุธููู</div>
    <canvas id="chartCommissionEmployees"></canvas>
  </div>
</div>

<!-- DAILY / WEEKLY / MONTHLY / YEARLY REPORTS -->
<div id="daily" class="tab-content">
  <div class="card">
    <div class="section-title">๐ ููุน ุงูุชูุฑูุฑ</div>
    <select id="reportType">
      <option value="daily">ูููู</option>
      <option value="weekly">ุฃุณุจูุนู (ุงูุฃุฑุจุนุงุก โ ุงูุฃุฑุจุนุงุก)</option>
      <option value="monthly">ุดูุฑู</option>
      <option value="yearly">ุณููู</option>
    </select>
    <div id="reportFilters" class="flex">
      <div id="dailyFilter">
        <label>ุชุงุฑูุฎ ุงูููู</label>
        <input type="date" id="dailyDate">
      </div>
      <div id="weeklyFilter" style="display:none;">
        <label>ุงุฎุชุฑ ุฃู ููู ุฏุงุฎู ุงูุฃุณุจูุน ุงููุทููุจ</label>
        <input type="date" id="weeklyAnyDate">
      </div>
      <div id="monthlyFilter" style="display:none;">
        <label>ุงูุณูุฉ</label>
        <input type="number" id="monthlyYear" placeholder="ูุซุงู: 2026">
        <label>ุงูุดูุฑ</label>
        <input type="number" id="monthlyMonth" placeholder="1 - 12">
      </div>
      <div id="yearlyFilter" style="display:none;">
        <label>ุงูุณูุฉ</label>
        <input type="number" id="yearlyYear" placeholder="ูุซุงู: 2026">
      </div>
    </div>
    <button class="btn" onclick="loadPeriodReport()">ุนุฑุถ ุงูุชูุฑูุฑ</button>
  </div>

  <div class="card">
    <div class="section-title">๐ ููุฎุต ุงููุชุฑุฉ</div>
    <div id="periodSummary">ุงุฎุชุฑ ููุน ุงูุชูุฑูุฑ ุซู ุงุถุบุท ุนุฑุถ.</div>
  </div>

  <div class="card">
    <div class="section-title">๐ ุดุงุฑุช ุงูุฏุฎู ูุตุงูู ุงูุฑุจุญ ูููุชุฑุฉ</div>
    <canvas id="chartPeriodRevenue"></canvas>
  </div>
</div>

<!-- PAYROLL -->
<div id="payroll" class="tab-content">
  <div class="card">
    <div class="section-title">๐ผ ุญุณุงุจ ุฑูุงุชุจ ุงูููุธููู (ุนูููุงุช)</div>
    <div class="flex">
      <div>
        <label>ูู ุชุงุฑูุฎ</label>
        <input type="date" id="payFrom">
      </div>
      <div>
        <label>ุฅูู ุชุงุฑูุฎ</label>
        <input type="date" id="payTo">
      </div>
    </div>
    <button class="btn" onclick="loadPayroll()">ุญุณุงุจ ุงูุฑูุงุชุจ</button>
    <button class="btn-outline" onclick="setDefaultPayrollWeek()">ุฃุณุจูุน ูู ุงูุฃุฑุจุนุงุก ุฅูู ุงูุฃุฑุจุนุงุก</button>
  </div>

  <div class="card">
    <div class="section-title">๐ ุชูุงุตูู ุงูุฑูุงุชุจ</div>
    <div id="payrollTable">ุงุฎุชุฑ ุงููุชุฑุฉ ุซู ุงุถุบุท ุญุณุงุจ.</div>
  </div>
</div>

<!-- DECISION REPORTS -->
<div id="decision" class="tab-content">
  <div class="card">
    <div class="section-title">๐ง ุชูุงุฑูุฑ ุชุณุงุนุฏู ูู ุงุชุฎุงุฐ ุงููุฑุงุฑ</div>
    <div id="decisionContent">ุฌุงุฑู ุงูุชุญููู...</div>
  </div>
</div>

<!-- CUSTOMERS -->
<div id="customers" class="tab-content">
  <div class="card">
    <div class="section-title">๐ฅ ุงูุนููุงุก</div>
    <input id="customerSearch" placeholder="ุจุญุซ ุจุงูุงุณู / ุงูุฌูุงู / ุงูุนุถููุฉ">
    <button class="btn" onclick="loadCustomers()">ุจุญุซ</button>
  </div>
  <div class="card">
    <div id="customersTable">ุฌุงุฑู ุงูุชุญููู...</div>
  </div>
</div>

<!-- BOOKINGS -->
<div id="bookings" class="tab-content">
  <div class="card">
    <div class="section-title">๐ ุงูุญุฌูุฒุงุช</div>
    <div id="bookingsList">ุฌุงุฑู ุงูุชุญููู...</div>
  </div>
</div>

<!-- COSTS -->
<div id="costs" class="tab-content">
  <div class="card">
    <div class="section-title">๐ธ ููุฎุต ุงููุตุงุฑูู</div>
    <div id="costSummary">ุฌุงุฑู ุงูุชุญููู...</div>
  </div>
  <div class="card">
    <div class="section-title">๐ ุชูุงุตูู ุงููุตุงุฑูู (ูู ุดูุช Cost)</div>
    <div id="costTable">ุฌุงุฑู ุงูุชุญููู...</div>
  </div>
</div>

<script>
  // ===========================
  // GLOBAL DATA CACHE
  // ===========================
  let allVisits = [];
  let allCustomers = [];
  let allServices = [];
  let allEmployees = [];
  let allBookings = [];
  let allCosts = [];
  let commissionMap = {};
  let charts = {};

  // ===========================
  // TABS
  // ===========================
  document.querySelectorAll(".tab-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
      document.querySelectorAll(".tab-content").forEach(t => t.classList.remove("active"));
      btn.classList.add("active");
      const id = btn.getAttribute("data-tab");
      document.getElementById(id).classList.add("active");

      if (id === "dashboard") loadDashboard();
      if (id === "daily") initPeriodTab();
      if (id === "payroll") {/* ูุง ุดูุก ุชููุงุฆู */ }
      if (id === "decision") loadDecisionReports();
      if (id === "customers") loadCustomers();
      if (id === "bookings") loadBookings();
      if (id === "costs") loadCosts();
    });
  });

  // ===========================
  // INIT
  // ===========================
  async function initData() {
    const [vRes, cRes, sRes, eRes, bRes, costRes] = await Promise.all([
      apiGetAll("Visits"),
      apiGetAll("Customers"),
      apiGetAll("Commissions"),
      apiGetAll("Employees"),
      apiGetAll("Bookings"),
      apiGetAll("Cost")
    ]);

    if (vRes.success) allVisits = vRes.rows || [];
    if (cRes.success) allCustomers = cRes.rows || [];
    if (sRes.success) allServices = sRes.rows || [];
    if (eRes.success) allEmployees = eRes.rows || [];
    if (bRes.success) allBookings = bRes.rows || [];
    if (costRes.success) allCosts = costRes.rows || [];

    commissionMap = {};
    allServices.forEach(r => {
      const service = r[0];
      const comm = Number(r[1] || 0);
      commissionMap[service] = comm;
    });

    loadDashboard();
    loadDecisionReports();
    loadCosts();
  }

  // ===========================
  // HELPERS
  // ===========================
  function parseDateFromVisit(v) {
    const raw = String(v[8] || "");
    if (!raw) return null;
    const d = raw.split(" ")[0];
    return d || null;
  }

  function inRange(dateStr, from, to) {
    if (!dateStr) return false;
    if (from && dateStr < from) return false;
    if (to && dateStr > to) return false;
    return true;
  }

  function sum(arr) {
    return arr.reduce((a,b)=>a+Number(b||0),0);
  }

  function formatCurrency(v) {
    return Number(v || 0).toLocaleString("ar-SA") + " ุฑูุงู";
  }

  function clearChart(id) {
    if (charts[id]) {
      charts[id].destroy();
      charts[id] = null;
    }
  }

  // ===========================
  // DASHBOARD
  // ===========================
  function resetDashboardDates() {
    document.getElementById("dashFrom").value = "";
    document.getElementById("dashTo").value = "";
    loadDashboard();
  }

  function getCostForDate(dateStr) {
    // Cost sheet: A:Details, B:Amount, C:Type (Monthly, Yearly, ...)
    // ููุง ูุญุณุจ ุชูุฑูุจ ุชูุฑูุจู: 
    // Monthly โ ููุณู ุนูู 30
    // Yearly โ ููุณู ุนูู 365
    // Daily โ ูุงูู
    // Weekly โ ููุณู ุนูู 7
    let total = 0;
    allCosts.forEach(r => {
      const amount = Number(r[1] || 0);
      const type = String(r[2] || "").toLowerCase();
      if (!amount) return;
      if (type === "daily") total += amount;
      else if (type === "weekly") total += amount / 7;
      else if (type === "monthly") total += amount / 30;
      else if (type === "yearly") total += amount / 365;
      else total += amount; // ูู ูุง ุญุฏุฏ ุงูููุน ูุนุชุจุฑู ูุงูู
    });
    return total;
  }

  async function loadDashboard() {
    const from = document.getElementById("dashFrom").value || null;
    const to = document.getElementById("dashTo").value || null;

    let visits = allVisits.slice();
    if (from || to) {
      visits = visits.filter(v => inRange(parseDateFromVisit(v), from, to));
    }

    let totalRevenue = 0;
    let cash = 0;
    let network = 0;
    let totalCommission = 0;
    let revenueByDay = {};
    let profitByDay = {};
    let commissionByEmployee = {};

    visits.forEach(v => {
      const price = Number(v[2] || 0);
      const method = String(v[11] || "");
      const employee = String(v[4] || "");
      const service = v[1];
      const date = parseDateFromVisit(v);

      totalRevenue += price;
      if (method === "ูุงุด") cash += price;
      if (method === "ุดุจูุฉ") network += price;

      const comm = commissionMap[service] || 0;
      totalCommission += comm;
      if (employee) {
        commissionByEmployee[employee] = (commissionByEmployee[employee] || 0) + comm;
      }

      if (date) {
        revenueByDay[date] = (revenueByDay[date] || 0) + price;
      }
    });

    // ุชูุฏูุฑ ุงููุตุงุฑูู ุงูููููุฉ ุงูุฅุฌูุงููุฉ ูููุชุฑุฉ
    let costTotal = 0;
    let daysSet = new Set(Object.keys(revenueByDay));
    daysSet.forEach(d => {
      costTotal += getCostForDate(d);
    });

    const totalProfit = totalRevenue - (costTotal + totalCommission);

    // ุจูุงุก profitByDay
    Object.keys(revenueByDay).forEach(d => {
      const rev = revenueByDay[d];
      const cost = getCostForDate(d);
      // ุชูุฏูุฑ ุนูููุฉ ุงูููู: ูุณุจุฉ ูู ุฅุฌูุงูู ุงูุนูููุฉ ุญุณุจ ูุณุจุฉ ุงูุฏุฎู
      const dayShare = rev / (totalRevenue || 1);
      const dayComm = totalCommission * dayShare;
      profitByDay[d] = rev - (cost + dayComm);
    });

    // ุฃูุถู ููุธู / ุฎุฏูุฉ / ูุฑุน / ููู
    let bestEmployee = "-";
    let bestEmployeeVal = 0;
    Object.keys(commissionByEmployee).forEach(e => {
      if (commissionByEmployee[e] > bestEmployeeVal) {
        bestEmployeeVal = commissionByEmployee[e];
        bestEmployee = e;
      }
    });

    let serviceCount = {};
    let branchCount = {};
    let dayCount = {};
    visits.forEach(v => {
      const s = v[1];
      const b = v[6];
      const d = parseDateFromVisit(v);
      if (s) serviceCount[s] = (serviceCount[s] || 0) + 1;
      if (b) branchCount[b] = (branchCount[b] || 0) + 1;
      if (d) dayCount[d] = (dayCount[d] || 0) + 1;
    });

    function getMaxKey(obj) {
      let maxK = "-";
      let maxV = 0;
      Object.keys(obj).forEach(k => {
        if (obj[k] > maxV) {
          maxV = obj[k];
          maxK = k;
        }
      });
      return maxK;
    }

    const bestService = getMaxKey(serviceCount);
    const bestBranch = getMaxKey(branchCount);
    const bestDay = getMaxKey(dayCount);

    const avgVisitPrice = visits.length ? (totalRevenue / visits.length) : 0;

    document.getElementById("dashboardKpis").innerHTML = `
      <div class="grid">
        <div class="kpi">
          <div class="kpi-title">๐ฐ ุฅุฌูุงูู ุงูุฏุฎู</div>
          <div class="kpi-value">${formatCurrency(totalRevenue)}</div>
          <div class="kpi-sub">ูู ${visits.length} ุฒูุงุฑุฉ</div>
        </div>
        <div class="kpi">
          <div class="kpi-title">๐ธ ุฅุฌูุงูู ุงููุตุงุฑูู ุงูุชูุฏูุฑูุฉ</div>
          <div class="kpi-value">${formatCurrency(costTotal)}</div>
          <div class="kpi-sub">ูู ุดูุช Cost</div>
        </div>
        <div class="kpi">
          <div class="kpi-title">๐ผ ุฅุฌูุงูู ุงูุนูููุงุช</div>
          <div class="kpi-value">${formatCurrency(totalCommission)}</div>
          <div class="kpi-sub">ุญุณุจ ุดูุช Commissions</div>
        </div>
        <div class="kpi">
          <div class="kpi-title">๐ ุตุงูู ุงูุฑุจุญ ุงูุชูุฏูุฑู</div>
          <div class="kpi-value">${formatCurrency(totalProfit)}</div>
          <div class="kpi-sub">ุงูุฏุฎู - (ุงููุตุงุฑูู + ุงูุนูููุงุช)</div>
        </div>
        <div class="kpi">
          <div class="kpi-title">๐ณ ุดุจูุฉ</div>
          <div class="kpi-value">${formatCurrency(network)}</div>
          <div class="kpi-sub">ุฅุฌูุงูู ุงููุฏููุน ุจุงูุดุจูุฉ</div>
        </div>
        <div class="kpi">
          <div class="kpi-title">๐ต ูุงุด</div>
          <div class="kpi-value">${formatCurrency(cash)}</div>
          <div class="kpi-sub">ุฅุฌูุงูู ุงููุฏููุน ูุงุด</div>
        </div>
        <div class="kpi">
          <div class="kpi-title">๐งฝ ุนุฏุฏ ุงูุฒูุงุฑุงุช</div>
          <div class="kpi-value">${visits.length}</div>
          <div class="kpi-sub">ูู ุงููุชุฑุฉ ุงููุญุฏุฏุฉ</div>
        </div>
        <div class="kpi">
          <div class="kpi-title">๐ฅ ุนุฏุฏ ุงูุนููุงุก</div>
          <div class="kpi-value">${allCustomers.length}</div>
          <div class="kpi-sub">ุฅุฌูุงูู ุงูุนููุงุก ุงููุณุฌููู</div>
        </div>
        <div class="kpi">
          <div class="kpi-title">๐ณ ูุชูุณุท ุณุนุฑ ุงูุฒูุงุฑุฉ</div>
          <div class="kpi-value">${formatCurrency(avgVisitPrice)}</div>
          <div class="kpi-sub">ุงูุฏุฎู รท ุนุฏุฏ ุงูุฒูุงุฑุงุช</div>
        </div>
        <div class="kpi">
          <div class="kpi-title">๐ ุฃูุถู ููุธู (ุนูููุฉ)</div>
          <div class="kpi-value">${bestEmployee}</div>
          <div class="kpi-sub">${formatCurrency(bestEmployeeVal)}</div>
        </div>
        <div class="kpi">
          <div class="kpi-title">๐งด ุฃูุซุฑ ุฎุฏูุฉ ุทูุจุงู</div>
          <div class="kpi-value">${bestService}</div>
          <div class="kpi-sub">ุญุณุจ ุนุฏุฏ ุงูุฒูุงุฑุงุช</div>
        </div>
        <div class="kpi">
          <div class="kpi-title">๐ข ุฃูุถู ูุฑุน</div>
          <div class="kpi-value">${bestBranch}</div>
          <div class="kpi-sub">ุญุณุจ ุนุฏุฏ ุงูุฒูุงุฑุงุช</div>
        </div>
      </div>
    `;

    // Charts
    const labels = Object.keys(revenueByDay).sort();
    const revData = labels.map(d => revenueByDay[d]);
    const profitData = labels.map(d => profitByDay[d] || 0);

    clearChart("chartRevenueDaily");
    clearChart("chartProfitDaily");
    clearChart("chartCommissionEmployees");

    charts["chartRevenueDaily"] = new Chart(document.getElementById("chartRevenueDaily"), {
      type:"bar",
      data:{
        labels,
        datasets:[{
          label:"ุงูุฏุฎู ุงููููู",
          data:revData,
          backgroundColor:"#0D47A1"
        }]
      }
    });

    charts["chartProfitDaily"] = new Chart(document.getElementById("chartProfitDaily"), {
      type:"line",
      data:{
        labels,
        datasets:[{
          label:"ุตุงูู ุงูุฑุจุญ ุงููููู",
          data:profitData,
          borderColor:"#FF8F00",
          backgroundColor:"rgba(255,143,0,0.2)",
          fill:true,
          tension:0.3
        }]
      }
    });

    const empLabels = Object.keys(commissionByEmployee);
    const empData = empLabels.map(e => commissionByEmployee[e]);

    charts["chartCommissionEmployees"] = new Chart(document.getElementById("chartCommissionEmployees"), {
      type:"bar",
      data:{
        labels:empLabels,
        datasets:[{
          label:"ุนูููุงุช ุงูููุธููู",
          data:empData,
          backgroundColor:"#FF8F00"
        }]
      }
    });
  }

  // ===========================
  // PERIOD REPORTS (DAILY/WEEKLY/MONTHLY/YEARLY)
  // ===========================
  function initPeriodTab() {
    document.getElementById("reportType").addEventListener("change", onReportTypeChange);
  }

  function onReportTypeChange() {
    const type = document.getElementById("reportType").value;
    document.getElementById("dailyFilter").style.display = (type === "daily") ? "block" : "none";
    document.getElementById("weeklyFilter").style.display = (type === "weekly") ? "block" : "none";
    document.getElementById("monthlyFilter").style.display = (type === "monthly") ? "block" : "none";
    document.getElementById("yearlyFilter").style.display = (type === "yearly") ? "block" : "none";
  }

  function getWeekRangeFromDate(dateStr) {
    // ูุนุชุจุฑ ุจุฏุงูุฉ ุงูุฃุณุจูุน ุงูุฃุฑุจุนุงุก
    const d = new Date(dateStr);
    if (isNaN(d)) return null;
    // 3 = Wednesday
    let day = d.getDay(); // 0-6
    // ูุญูู ุงูุชุงุฑูุฎ ุฅูู ุงูุฃุฑุจุนุงุก ุงูุณุงุจู
    let diffToWed = (day - 3 + 7) % 7;
    const start = new Date(d);
    start.setDate(d.getDate() - diffToWed);
    const end = new Date(start);
    end.setDate(start.getDate() + 7);
    const fmt = x => x.toISOString().slice(0,10);
    return { from: fmt(start), to: fmt(end) };
  }

  function loadPeriodReport() {
    const type = document.getElementById("reportType").value;
    let from = null, to = null, label = "";

    if (type === "daily") {
      const d = document.getElementById("dailyDate").value;
      if (!d) { alert("ุงุฎุชุฑ ุชุงุฑูุฎ ุงูููู"); return; }
      from = d; to = d;
      label = "ุชูุฑูุฑ ูููู ูู " + d;
    } else if (type === "weekly") {
      const d = document.getElementById("weeklyAnyDate").value;
      if (!d) { alert("ุงุฎุชุฑ ุฃู ุชุงุฑูุฎ ุฏุงุฎู ุงูุฃุณุจูุน"); return; }
      const range = getWeekRangeFromDate(d);
      from = range.from;
      to = range.to;
      label = `ุชูุฑูุฑ ุฃุณุจูุนู ูู ${from} ุฅูู ${to}`;
    } else if (type === "monthly") {
      const y = document.getElementById("monthlyYear").value;
      const m = document.getElementById("monthlyMonth").value;
      if (!y || !m) { alert("ุฃุฏุฎู ุงูุณูุฉ ูุงูุดูุฑ"); return; }
      const mm = String(m).padStart(2,"0");
      from = `${y}-${mm}-01`;
      const lastDay = new Date(y, m, 0).getDate();
      to = `${y}-${mm}-${String(lastDay).padStart(2,"0")}`;
      label = `ุชูุฑูุฑ ุดูุฑู ูู ${y}-${mm}`;
    } else if (type === "yearly") {
      const y = document.getElementById("yearlyYear").value;
      if (!y) { alert("ุฃุฏุฎู ุงูุณูุฉ"); return; }
      from = `${y}-01-01`;
      to = `${y}-12-31`;
      label = `ุชูุฑูุฑ ุณููู ูู ${y}`;
    }

    let visits = allVisits.filter(v => inRange(parseDateFromVisit(v), from, to));

    let totalRevenue = 0;
    let totalCommission = 0;
    let totalCost = 0;
    let revenueByDay = {};
    let profitByDay = {};
    let serviceCount = {};
    let employeeCount = {};

    visits.forEach(v => {
      const price = Number(v[2] || 0);
      const service = v[1];
      const employee = v[4];
      const date = parseDateFromVisit(v);

      totalRevenue += price;
      const comm = commissionMap[service] || 0;
      totalCommission += comm;

      if (service) serviceCount[service] = (serviceCount[service] || 0) + 1;
      if (employee) employeeCount[employee] = (employeeCount[employee] || 0) + 1;

      if (date) {
        revenueByDay[date] = (revenueByDay[date] || 0) + price;
      }
    });

    let daysSet = new Set(Object.keys(revenueByDay));
    daysSet.forEach(d => {
      totalCost += getCostForDate(d);
    });

    const totalProfit = totalRevenue - (totalCost + totalCommission);

    function getMaxKey(obj) {
      let maxK = "-";
      let maxV = 0;
      Object.keys(obj).forEach(k => {
        if (obj[k] > maxV) {
          maxV = obj[k];
          maxK = k;
        }
      });
      return maxK;
    }

    const bestService = getMaxKey(serviceCount);
    const bestEmployee = getMaxKey(employeeCount);

    Object.keys(revenueByDay).forEach(d => {
      const rev = revenueByDay[d];
      const cost = getCostForDate(d);
      const share = rev / (totalRevenue || 1);
      const comm = totalCommission * share;
      profitByDay[d] = rev - (cost + comm);
    });

    document.getElementById("periodSummary").innerHTML = `
      <div style="margin-bottom:8px;font-weight:600;">${label}</div>
      <div class="grid">
        <div class="kpi">
          <div class="kpi-title">๐ฐ ุฅุฌูุงูู ุงูุฏุฎู</div>
          <div class="kpi-value">${formatCurrency(totalRevenue)}</div>
        </div>
        <div class="kpi">
          <div class="kpi-title">๐ธ ุฅุฌูุงูู ุงููุตุงุฑูู ุงูุชูุฏูุฑูุฉ</div>
          <div class="kpi-value">${formatCurrency(totalCost)}</div>
        </div>
        <div class="kpi">
          <div class="kpi-title">๐ผ ุฅุฌูุงูู ุงูุนูููุงุช</div>
          <div class="kpi-value">${formatCurrency(totalCommission)}</div>
        </div>
        <div class="kpi">
          <div class="kpi-title">๐ ุตุงูู ุงูุฑุจุญ ุงูุชูุฏูุฑู</div>
          <div class="kpi-value">${formatCurrency(totalProfit)}</div>
        </div>
        <div class="kpi">
          <div class="kpi-title">๐งฝ ุนุฏุฏ ุงูุฒูุงุฑุงุช</div>
          <div class="kpi-value">${visits.length}</div>
        </div>
        <div class="kpi">
          <div class="kpi-title">๐งด ุฃูุซุฑ ุฎุฏูุฉ ุทูุจุงู</div>
          <div class="kpi-value">${bestService}</div>
        </div>
        <div class="kpi">
          <div class="kpi-title">๐ ุฃูุซุฑ ููุธู ูุดุงุทุงู</div>
          <div class="kpi-value">${bestEmployee}</div>
        </div>
      </div>
    `;

    const labels = Object.keys(revenueByDay).sort();
    const revData = labels.map(d => revenueByDay[d]);
    const profitData = labels.map(d => profitByDay[d] || 0);

    clearChart("chartPeriodRevenue");
    charts["chartPeriodRevenue"] = new Chart(document.getElementById("chartPeriodRevenue"), {
      type:"bar",
      data:{
        labels,
        datasets:[
          {
            label:"ุงูุฏุฎู",
            data:revData,
            backgroundColor:"#0D47A1"
          },
          {
            label:"ุตุงูู ุงูุฑุจุญ",
            data:profitData,
            backgroundColor:"#FF8F00"
          }
        ]
      }
    });
  }

  // ===========================
  // PAYROLL
  // ===========================
  function setDefaultPayrollWeek() {
    const today = new Date();
    const range = getWeekRangeFromDate(today.toISOString().slice(0,10));
    document.getElementById("payFrom").value = range.from;
    document.getElementById("payTo").value = range.to;
  }

  function loadPayroll() {
    const from = document.getElementById("payFrom").value;
    const to = document.getElementById("payTo").value;
    if (!from || !to) {
      alert("ุงุฎุชุฑ ูู ุชุงุฑูุฎ ูุฅูู ุชุงุฑูุฎ");
      return;
    }

    let visits = allVisits.filter(v => inRange(parseDateFromVisit(v), from, to));

    let payroll = {};
    allEmployees.forEach(e => {
      const name = e[0];
      payroll[name] = { visits:0, commission:0, revenue:0 };
    });

    visits.forEach(v => {
      const employee = v[4];
      const service = v[1];
      const price = Number(v[2] || 0);
      const comm = commissionMap[service] || 0;
      if (!payroll[employee]) {
        payroll[employee] = { visits:0, commission:0, revenue:0 };
      }
      payroll[employee].visits += 1;
      payroll[employee].commission += comm;
      payroll[employee].revenue += price;
    });

    const rows = Object.keys(payroll).map(name => {
      const p = payroll[name];
      return { name, ...p };
    }).filter(r => r.visits > 0);

    if (!rows.length) {
      document.getElementById("payrollTable").innerHTML =
        `<div style="text-align:center;color:#9CA3AF;font-size:14px;">ูุง ุชูุฌุฏ ุฒูุงุฑุงุช ูู ูุฐู ุงููุชุฑุฉ.</div>`;
      return;
    }

    document.getElementById("payrollTable").innerHTML = `
      <table>
        <thead>
          <tr>
            <th>ุงูููุธู</th>
            <th>ุนุฏุฏ ุงูุฒูุงุฑุงุช</th>
            <th>ุฅุฌูุงูู ุงูุฏุฎู ุงูุฐู ุงุดุชุบู ุนููู</th>
            <th>ุฅุฌูุงูู ุงูุนูููุฉ ุงููุณุชุญูุฉ</th>
          </tr>
        </thead>
        <tbody>
          ${rows.map(r => `
            <tr>
              <td>${r.name}</td>
              <td>${r.visits}</td>
              <td>${formatCurrency(r.revenue)}</td>
              <td>${formatCurrency(r.commission)}</td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    `;
  }

  // ===========================
  // DECISION REPORTS
  // ===========================
  function loadDecisionReports() {
    if (!allVisits.length) {
      document.getElementById("decisionContent").innerHTML = "ุฌุงุฑู ุงูุชุญููู...";
      return;
    }

    let serviceCount = {};
    let serviceRevenue = {};
    let hourCount = {};
    let branchRevenue = {};
    let customerVisits = {};
    let customerRevenue = {};

    allVisits.forEach(v => {
      const service = v[1];
      const price = Number(v[2] || 0);
      const branch = v[6];
      const membership = v[0];
      const checkIn = String(v[8] || "");
      const hour = checkIn.split(" ")[1] ? checkIn.split(" ")[1].slice(0,2) : null;

      if (service) {
        serviceCount[service] = (serviceCount[service] || 0) + 1;
        serviceRevenue[service] = (serviceRevenue[service] || 0) + price;
      }
      if (branch) {
        branchRevenue[branch] = (branchRevenue[branch] || 0) + price;
      }
      if (membership) {
        customerVisits[membership] = (customerVisits[membership] || 0) + 1;
        customerRevenue[membership] = (customerRevenue[membership] || 0) + price;
      }
      if (hour) {
        hourCount[hour] = (hourCount[hour] || 0) + 1;
      }
    });

    function topN(obj, n=5) {
      return Object.keys(obj)
        .map(k => ({ key:k, value:obj[k] }))
        .sort((a,b)=>b.value-a.value)
        .slice(0,n);
    }

    const topServices = topN(serviceCount);
    const lowServices = topN(serviceCount).reverse();
    const topBranches = topN(branchRevenue);
    const topHours = topN(hourCount);
    const topCustomersVisits = topN(customerVisits);
    const topCustomersRevenue = topN(customerRevenue);

    document.getElementById("decisionContent").innerHTML = `
      <div class="grid">
        <div>
          <h4>๐งด ุฃูุซุฑ ุงูุฎุฏูุงุช ุทูุจุงู</h4>
          <table>
            <thead><tr><th>ุงูุฎุฏูุฉ</th><th>ุนุฏุฏ ุงูุฒูุงุฑุงุช</th></tr></thead>
            <tbody>
              ${topServices.map(r=>`
                <tr><td>${r.key}</td><td>${r.value}</td></tr>
              `).join("")}
            </tbody>
          </table>
        </div>
        <div>
          <h4>๐งด ุฃูู ุงูุฎุฏูุงุช ุทูุจุงู</h4>
          <table>
            <thead><tr><th>ุงูุฎุฏูุฉ</th><th>ุนุฏุฏ ุงูุฒูุงุฑุงุช</th></tr></thead>
            <tbody>
              ${lowServices.map(r=>`
                <tr><td>${r.key}</td><td>${r.value}</td></tr>
              `).join("")}
            </tbody>
          </table>
        </div>
        <div>
          <h4>๐ข ุงููุฑูุน ุงูุฃุนูู ุฏุฎูุงู</h4>
          <table>
            <thead><tr><th>ุงููุฑุน</th><th>ุงูุฏุฎู</th></tr></thead>
            <tbody>
              ${topBranches.map(r=>`
                <tr><td>${r.key}</td><td>${formatCurrency(r.value)}</td></tr>
              `).join("")}
            </tbody>
          </table>
        </div>
        <div>
          <h4>โฐ ุฃููุงุช ุงูุฐุฑูุฉ</h4>
          <table>
            <thead><tr><th>ุงูุณุงุนุฉ</th><th>ุนุฏุฏ ุงูุฒูุงุฑุงุช</th></tr></thead>
            <tbody>
              ${topHours.map(r=>`
                <tr><td>${r.key}:00</td><td>${r.value}</td></tr>
              `).join("")}
            </tbody>
          </table>
        </div>
        <div>
          <h4>๐ฅ ุงูุนููุงุก ุงูุฃูุซุฑ ุฒูุงุฑุฉ</h4>
          <table>
            <thead><tr><th>ุงูุนุถููุฉ</th><th>ุนุฏุฏ ุงูุฒูุงุฑุงุช</th></tr></thead>
            <tbody>
              ${topCustomersVisits.map(r=>`
                <tr><td>${r.key}</td><td>${r.value}</td></tr>
              `).join("")}
            </tbody>
          </table>
        </div>
        <div>
          <h4>๐ ุงูุนููุงุก ุงูุฃุนูู ุฅููุงูุงู</h4>
          <table>
            <thead><tr><th>ุงูุนุถููุฉ</th><th>ุฅุฌูุงูู ุงูุฅููุงู</th></tr></thead>
            <tbody>
              ${topCustomersRevenue.map(r=>`
                <tr><td>${r.key}</td><td>${formatCurrency(r.value)}</td></tr>
              `).join("")}
            </tbody>
          </table>
        </div>
      </div>
    `;
  }

  // ===========================
  // CUSTOMERS
  // ===========================
  function loadCustomers() {
    const box = document.getElementById("customersTable");
    const q = document.getElementById("customerSearch").value.trim().toLowerCase();

    const visitsMap = {};
    allVisits.forEach(v => {
      const mem = v[0];
      if (!visitsMap[mem]) visitsMap[mem] = [];
      visitsMap[mem].push(v);
    });

    const filtered = allCustomers.filter(c => {
      const name = String(c[0] || "").toLowerCase();
      const phone = String(c[1] || "").toLowerCase();
      const mem = String(c[8] || "").toLowerCase();
      if (!q) return true;
      return name.includes(q) || phone.includes(q) || mem.includes(q);
    });

    if (!filtered.length) {
      box.innerHTML = `<div style="text-align:center;color:#9CA3AF;font-size:14px;">ูุง ุชูุฌุฏ ูุชุงุฆุฌ ูุทุงุจูุฉ</div>`;
      return;
    }

    box.innerHTML = `
      <table>
        <thead>
          <tr>
            <th>ุงูุงุณู</th>
            <th>ุงูุนุถููุฉ</th>
            <th>ุงูุฌูุงู</th>
            <th>ุนุฏุฏ ุงูุฒูุงุฑุงุช</th>
            <th>ุฅุฌูุงูู ุงููุฏููุน</th>
            <th>ุงูููุงุท</th>
            <th>ุงููุณุชูู</th>
          </tr>
        </thead>
        <tbody>
          ${filtered.map(c => {
            const mem = c[8];
            const phone = c[1];
            const vs = visitsMap[mem] || [];
            const totalPaid = vs.reduce((s,v)=>s+Number(v[2]||0),0);
            return `
              <tr>
                <td>${c[0] || "-"}</td>
                <td>${mem || "-"}</td>
                <td>${phone || "-"}</td>
                <td>${vs.length}</td>
                <td>${formatCurrency(totalPaid)}</td>
                <td>${c[11] || 0}</td>
                <td>${c[12] || "-"}</td>
              </tr>
            `;
          }).join("")}
        </tbody>
      </table>
    `;
  }

  // ===========================
  // BOOKINGS
  // ===========================
  function loadBookings() {
    const box = document.getElementById("bookingsList");
    if (!allBookings.length) {
      box.innerHTML = `<div style="text-align:center;color:#9CA3AF;font-size:14px;">ูุง ุชูุฌุฏ ุญุฌูุฒุงุช ุญุงููุงู</div>`;
      return;
    }

    box.innerHTML = allBookings.map((b,i) => {
      const phone = b[0];
      const membership = b[1];
      const service = b[2];
      const date = b[3];
      const time = b[4];
      const status = b[5];
      return `
        <div style="border:1px solid #E5E7EB;border-radius:12px;padding:10px;margin-bottom:10px;background:white;font-size:14px;">
          <b>ุงูุฎุฏูุฉ:</b> ${service}<br>
          <b>ุงูุชุงุฑูุฎ:</b> ${date} ${time}<br>
          <b>ุงูุฌูุงู:</b> ${phone}<br>
          <b>ุงูุนุถููุฉ:</b> ${membership}<br>
          <b>ุงูุญุงูุฉ:</b> <span class="tag">${status}</span>
        </div>
      `;
    }).join("");
  }

  // ===========================
  // COSTS
  // ===========================
  function loadCosts() {
    const boxSum = document.getElementById("costSummary");
    const boxTable = document.getElementById("costTable");

    if (!allCosts.length) {
      boxSum.innerHTML = `<div style="color:#9CA3AF;font-size:14px;">ูุง ุชูุฌุฏ ุจูุงูุงุช ูุตุงุฑูู ูู ุดูุช Cost</div>`;
      boxTable.innerHTML = "";
      return;
    }

    let total = 0;
    let byType = {};
    allCosts.forEach(r => {
      const amount = Number(r[1] || 0);
      const type = String(r[2] || "Other");
      total += amount;
      byType[type] = (byType[type] || 0) + amount;
    });

    boxSum.innerHTML = `
      <div class="grid">
        <div class="kpi">
          <div class="kpi-title">๐ธ ุฅุฌูุงูู ุงููุตุงุฑูู ุงููุณุฌูุฉ</div>
          <div class="kpi-value">${formatCurrency(total)}</div>
        </div>
        ${Object.keys(byType).map(t => `
          <div class="kpi">
            <div class="kpi-title">${t}</div>
            <div class="kpi-value">${formatCurrency(byType[t])}</div>
          </div>
        `).join("")}
      </div>
    `;

    boxTable.innerHTML = `
      <table>
        <thead>
          <tr>
            <th>ุงูุชูุงุตูู</th>
            <th>ุงููุจูุบ</th>
            <th>ุงูููุน</th>
          </tr>
        </thead>
        <tbody>
          ${allCosts.map(r => `
            <tr>
              <td>${r[0] || "-"}</td>
              <td>${formatCurrency(r[1] || 0)}</td>
              <td>${r[2] || "-"}</td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    `;
  }

  // ===========================
  // START
  // ===========================
  initData();
</script>

</body>
</html>
