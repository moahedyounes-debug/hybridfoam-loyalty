<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø§Ù„Ùƒ - Owner Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- ECharts -->
<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>

<!-- Flatpickr -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<style>
:root {
  --bg: #020617;
  --bg-soft: #020617;
  --card: #020617;
  --border: #1f2937;
  --accent: #2563eb;
  --accent-soft: #1d4ed8;
  --danger: #dc2626;
  --success: #16a34a;
  --text-main: #f9fafb;
  --text-muted: #9ca3af;
  --radius-lg: 16px;
  --radius-md: 12px;
  --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.7);
}

body.light {
  --bg: #f3f4f6;
  --bg-soft: #e5e7eb;
  --card: #ffffff;
  --border: #d1d5db;
  --accent: #2563eb;
  --accent-soft: #1d4ed8;
  --danger: #dc2626;
  --success: #16a34a;
  --text-main: #111827;
  --text-muted: #6b7280;
  --shadow-soft: 0 10px 25px rgba(15, 23, 42, 0.15);
}

*,
*::before,
*::after {
  box-sizing: border-box;
}

body {
  margin: 0;
  font-family: "Tajawal", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  background: radial-gradient(circle at top, #1e293b 0, #020617 45%, #000 100%);
  color: var(--text-main);
  direction: rtl;
}

/* Layout */
.layout {
  display: flex;
  min-height: 100vh;
}

/* Sidebar */
.sidebar {
  width: 260px;
  background: rgba(15, 23, 42, 0.96);
  border-left: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  padding: 18px 14px;
  gap: 10px;
}

body.light .sidebar {
  background: #ffffff;
}

.brand {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 16px;
}

.brand-logo-img {
  width: 40px;
  height: 40px;
  border-radius: 14px;
  object-fit: contain;
  background: #020617;
}

.brand-text {
  font-size: 18px;
  font-weight: 600;
}

.nav-section-title {
  font-size: 11px;
  color: var(--text-muted);
  margin: 10px 4px 4px;
}

.nav {
  display: flex;
  flex-direction: column;
  gap: 6px;
  margin-bottom: 6px;
}

.nav-btn {
  width: 100%;
  text-align: right;
  padding: 9px 11px;
  border-radius: 10px;
  border: none;
  background: transparent;
  color: var(--text-muted);
  font-size: 14px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: space-between;
  transition: 0.15s ease-out;
}

.nav-btn span {
  display: inline-flex;
  align-items: center;
  gap: 6px;
}

.nav-btn.active {
  background: rgba(37, 99, 235, 0.22);
  color: var(--text-main);
}

.nav-btn:hover {
  background: rgba(15, 23, 42, 0.9);
  color: var(--text-main);
}

body.light .nav-btn:hover {
  background: #e5e7eb;
}

/* Main */
.main {
  flex: 1;
  display: flex;
  flex-direction: column;
  min-width: 0;
}

/* Topbar */
.topbar {
  padding: 12px 18px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: rgba(15, 23, 42, 0.9);
  backdrop-filter: blur(10px);
  position: sticky;
  top: 0;
  z-index: 10;
}

body.light .topbar {
  background: rgba(249, 250, 251, 0.9);
}

.topbar-left {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.topbar-title {
  font-size: 16px;
  font-weight: 500;
}

.topbar-sub {
  font-size: 12px;
  color: var(--text-muted);
}

.stats-bar {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  justify-content: flex-end;
}

.pill {
  padding: 4px 10px;
  border-radius: 999px;
  background: rgba(15, 23, 42, 0.9);
  border: 1px solid var(--border);
  font-size: 12px;
  color: var(--text-muted);
  display: inline-flex;
  align-items: center;
  gap: 4px;
}

body.light .pill {
  background: #ffffff;
}

/* Theme toggle */
.theme-toggle {
  padding: 6px 10px;
  border-radius: 999px;
  border: 1px solid var(--border);
  background: transparent;
  color: var(--text-main);
  font-size: 12px;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  gap: 6px;
}

/* Content */
.content {
  padding: 18px;
  display: flex;
  flex-direction: column;
  gap: 18px;
}

.section {
  display: none;
}

.section.active {
  display: block;
}

.card {
  background: var(--card);
  border-radius: var(--radius-lg);
  padding: 16px;
  border: 1px solid var(--border);
  box-shadow: var(--shadow-soft);
}

.card-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 10px;
}

.card-header h2,
.card-header h3 {
  margin: 0;
}

h2, h3 {
  margin: 0 0 10px;
}

p {
  margin: 0;
}

/* KPI Cards */
.kpi-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 10px;
}

.kpi-card {
  background: linear-gradient(135deg, rgba(37,99,235,0.12), rgba(15,23,42,0.9));
  border-radius: 14px;
  padding: 12px;
  border: 1px solid rgba(37,99,235,0.4);
  display: flex;
  flex-direction: column;
  gap: 4px;
}

body.light .kpi-card {
  background: linear-gradient(135deg, #eff6ff, #ffffff);
}

.kpi-label {
  font-size: 12px;
  color: var(--text-muted);
}

.kpi-value {
  font-size: 18px;
  font-weight: 600;
}

.kpi-trend {
  font-size: 11px;
}

/* Inputs */
label {
  display: block;
  font-size: 13px;
  color: var(--text-muted);
  margin-top: 8px;
  margin-bottom: 3px;
}

input, select, textarea {
  width: 100%;
  padding: 10px 11px;
  border-radius: var(--radius-md);
  border: 1px solid var(--border);
  background: #020617;
  color: var(--text-main);
  font-size: 14px;
  margin-bottom: 6px;
  outline: none;
  transition: 0.15s ease-out;
}

body.light input,
body.light select,
body.light textarea {
  background: #f9fafb;
}

input:focus,
select:focus,
textarea:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.4);
}

textarea {
  min-height: 90px;
  resize: vertical;
}

/* Buttons */
button {
  padding: 10px 12px;
  border-radius: var(--radius-md);
  border: none;
  background: var(--accent);
  color: white;
  font-size: 14px;
  cursor: pointer;
  margin-top: 8px;
  position: relative;
  transition: 0.15s ease-out;
}

button.loading {
  color: transparent !important;
  cursor: not-allowed;
  background: #6b7280 !important;
}

button.loading::after {
  content: "";
  position: absolute;
  top: 50%;
  left: 50%;
  width: 20px;
  height: 20px;
  margin-top: -10px;
  margin-left: -10px;
  border: 3px solid white;
  border-top-color: transparent;
  border-radius: 50%;
  animation: spin 0.7s linear infinite;
}

button:active {
  transform: scale(0.97);
}

button.secondary {
  background: #111827;
  color: var(--text-main);
}

button.danger {
  background: var(--danger);
}

/* Loader keyframes */
@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Lists */
.list {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

/* Grid */
.grid {
  display: grid;
  gap: 10px;
}

.grid-2 {
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
}

/* Status text */
.status-text {
  font-size: 12px;
  color: var(--text-muted);
  margin-top: 6px;
  text-align: center;
}

/* Charts */
.chart-box {
  width: 100%;
  height: 260px;
}

/* Table */
.table-wrapper {
  width: 100%;
  overflow-x: auto;
}

table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}

th, td {
  padding: 8px 6px;
  border-bottom: 1px solid var(--border);
  text-align: right;
  white-space: nowrap;
}

th {
  font-weight: 600;
  color: var(--text-muted);
}

/* Responsive */
@media (max-width: 900px) {
  .layout {
    flex-direction: column;
  }
  .sidebar {
    width: 100%;
    flex-direction: row;
    overflow-x: auto;
    border-left: none;
    border-bottom: 1px solid var(--border);
  }
  .nav {
    flex-direction: row;
    flex-wrap: nowrap;
  }
  .nav-btn {
    white-space: nowrap;
  }
  .topbar {
    flex-direction: column;
    align-items: flex-start;
    gap: 8px;
  }
  .stats-bar {
    justify-content: flex-start;
  }
}
</style>
</head>
<body class="dark">

<div class="layout">

  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="brand">
      <img src="logo.png" class="brand-logo-img" alt="Logo">
      <div class="brand-text">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø§Ù„Ùƒ</div>
    </div>

    <div class="nav-section-title">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
    <div class="nav">
      <button class="nav-btn active" data-target="dashboard"><span>Dashboard</span></button>
    </div>

    <div class="nav-section-title">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª</div>
    <div class="nav">
      <button class="nav-btn" data-target="financial"><span>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠØ©</span></button>
      <button class="nav-btn" data-target="visits"><span>Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª</span></button>
      <button class="nav-btn" data-target="bookings"><span>Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</span></button>
      <button class="nav-btn" data-target="employees"><span>Ø§Ù„Ù…ÙˆØ¸ÙÙˆÙ† ÙˆØ§Ù„Ø±ÙˆØ§ØªØ¨</span></button>
      <button class="nav-btn" data-target="branches"><span>Ø§Ù„ÙØ±ÙˆØ¹</span></button>
      <button class="nav-btn" data-target="notifications"><span>Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</span></button>
    </div>
  </aside>

  <!-- Main -->
  <main class="main">

    <div class="topbar">
      <div class="topbar-left">
        <div class="topbar-title">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø§Ù„Ùƒ</div>
        <div class="topbar-sub">Ù†Ø¸Ø±Ø© Ø´Ø§Ù…Ù„Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¯Ø§Ø¡ØŒ Ø§Ù„Ø²ÙŠØ§Ø±Ø§ØªØŒ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§ØªØŒ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙˆØ§Ù„ÙØ±ÙˆØ¹</div>
      </div>

      <div class="stats-bar">
        <div class="pill">ğŸ‘¥ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡: <span id="sCustomers">0</span></div>
        <div class="pill">ğŸš— Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª: <span id="sCars">0</span></div>
        <div class="pill">ğŸ§¾ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª: <span id="sVisits">0</span></div>
        <div class="pill">ğŸ’° Ø§Ù„Ù…Ø¨Ø§Ù„Øº: <span id="sAmount">0</span></div>
        <button class="theme-toggle" id="themeToggle">ğŸŒ“ ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹</button>
      </div>
    </div>

    <div class="content">

      <!-- Dashboard -->
      <section id="dashboard" class="section active">
        <div class="card">
          <div class="card-header">
            <h2>Ù…Ù„Ø®Øµ Ø¹Ø§Ù…</h2>
          </div>
          <div class="kpi-grid">
            <div class="kpi-card">
              <div class="kpi-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</div>
              <div class="kpi-value" id="kpiCustomers">0</div>
              <div class="kpi-trend" id="kpiCustomersTrend"></div>
            </div>
            <div class="kpi-card">
              <div class="kpi-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</div>
              <div class="kpi-value" id="kpiCars">0</div>
              <div class="kpi-trend" id="kpiCarsTrend"></div>
            </div>
            <div class="kpi-card">
              <div class="kpi-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª</div>
              <div class="kpi-value" id="kpiVisits">0</div>
              <div class="kpi-trend" id="kpiVisitsTrend"></div>
            </div>
            <div class="kpi-card">
              <div class="kpi-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ø§Ù„Øº</div>
              <div class="kpi-value" id="kpiAmount">0</div>
              <div class="kpi-trend" id="kpiAmountTrend"></div>
            </div>
            <div class="kpi-card">
              <div class="kpi-label">Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</div>
              <div class="kpi-value" id="kpiRetention">0%</div>
            </div>
            <div class="kpi-card">
              <div class="kpi-label">Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¥Ù†ÙØ§Ù‚ Ù„ÙƒÙ„ Ø¹Ù…ÙŠÙ„</div>
              <div class="kpi-value" id="kpiAvgSpend">0</div>
            </div>
            <div class="kpi-card">
              <div class="kpi-label">Ù…ØªÙˆØ³Ø· Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ù„ÙƒÙ„ Ø¹Ù…ÙŠÙ„</div>
              <div class="kpi-value" id="kpiAvgVisits">0</div>
            </div>
            <div class="kpi-card">
              <div class="kpi-label">ØµØ­Ø© Ø§Ù„Ø¹Ù…Ù„</div>
              <div class="kpi-value" id="kpiHealthScore">0 / 100</div>
              <div class="kpi-trend" id="kpiHealthStatus"></div>
            </div>
          </div>
        </div>

        <div class="grid grid-2">
          <div class="card">
            <div class="card-header">
              <h3>Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h3>
            </div>
            <div id="chartAmountPerDay" class="chart-box"></div>
          </div>
          <div class="card">
            <div class="card-header">
              <h3>Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h3>
            </div>
            <div id="chartVisitsPerDay" class="chart-box"></div>
          </div>
        </div>

        <div class="grid grid-2">
          <div class="card">
            <div class="card-header">
              <h3>Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø£ÙƒØ«Ø± Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‹Ø§</h3>
            </div>
            <div id="chartServices" class="chart-box"></div>
          </div>
          <div class="card">
            <div class="card-header">
              <h3>Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h3>
            </div>
            <div id="chartLevels" class="chart-box"></div>
          </div>
        </div>

        <div class="grid grid-2">
          <div class="card">
            <div class="card-header">
              <h3>Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø°Ø±ÙˆØ©</h3>
            </div>
            <div id="chartPeakHours" class="chart-box"></div>
          </div>
          <div class="card">
            <div class="card-header">
              <h3>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</h3>
            </div>
            <div id="chartCars" class="chart-box"></div>
          </div>
        </div>
      </section>

      <!-- Financial Reports -->
      <section id="financial" class="section">
        <div class="card">
          <div class="card-header">
            <h2>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©</h2>
          </div>

          <div class="grid grid-2">
            <div>
              <label>Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
              <input id="finFrom" class="datePicker" placeholder="YYYY-MM-DD">
            </div>
            <div>
              <label>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
              <input id="finTo" class="datePicker" placeholder="YYYY-MM-DD">
            </div>
          </div>

<button id="finLoadBtn">Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠ</button>
<button id="finExportBtn" style="background:#16a34a;display:none;">â¬‡ï¸ ØªØµØ¯ÙŠØ± Excel</button>
<div class="status-text" id="finStatus"></div>

            
          <div class="table-wrapper" style="margin-top:10px;">
            <table>
              <thead>
                <tr>
                  <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
                  <th>Ø§Ù„Ø¬ÙˆØ§Ù„</th>
                  <th>Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©</th>
                  <th>Ø§Ù„Ø³ÙŠØ§Ø±Ø©</th>
                  <th>Ø§Ù„Ø®Ø¯Ù…Ø©</th>
                  <th>Ø§Ù„Ø³Ø¹Ø±</th>
                  <th>Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©</th>
                  <th>Ø§Ù„ÙØ±Ø¹</th>
                  <th>Ø§Ù„Ù…ÙˆØ¸Ù</th>
                  <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                </tr>
              </thead>
              <tbody id="finTableBody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Visits -->
      <section id="visits" class="section">
        <div class="card">
          <div class="card-header">
            <h2>Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®</h2>
          </div>

          <label>Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
          <input id="visitsFrom" class="datePicker" placeholder="YYYY-MM-DD">

          <label>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
          <input id="visitsTo" class="datePicker" placeholder="YYYY-MM-DD">

          <button id="visitsOwnerBtn">Ø¹Ø±Ø¶ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª</button>

          <div id="visitsOwnerList" class="list" style="margin-top:10px;"></div>
        </div>
      </section>

      <!-- Bookings -->
      <section id="bookings" class="section">
        <div class="card">
          <div class="card-header">
            <h2>Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</h2>
          </div>

          <label>Ø§Ø®ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ® (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input id="bookingsDateOwner" class="datePicker" placeholder="YYYY-MM-DD">

          <div id="bookingsListOwner" class="list" style="margin-top:10px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
        </div>
      </section>

      <!-- Employees / Payroll -->
      <section id="employees" class="section">
        <div class="card">
          <div class="card-header">
            <h2>Ø§Ù„Ù…ÙˆØ¸ÙÙˆÙ† ÙˆØ§Ù„Ø±ÙˆØ§ØªØ¨</h2>
          </div>

          <div class="grid grid-2">
            <div>
              <h3>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h3>
              <div id="employeesList" class="list"></div>
            </div>
            <div>
              <h3>Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±ÙˆØ§ØªØ¨</h3>
              <label>Ø§Ù„Ù…ÙˆØ¸Ù</label>
              <select id="payrollEmployee"></select>

              <label>Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
              <input id="payrollFrom" class="datePicker" placeholder="YYYY-MM-DD">

              <label>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
              <input id="payrollTo" class="datePicker" placeholder="YYYY-MM-DD">

              <button id="payrollBtn">Ø­Ø³Ø§Ø¨</button>
              <div id="payrollResult" class="status-text" style="margin-top:10px;"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- Branches -->
      <section id="branches" class="section">
        <div class="card">
          <div class="card-header">
            <h2>Ø§Ù„ÙØ±ÙˆØ¹</h2>
          </div>
          <div id="branchesList" class="list"></div>
        </div>
      </section>

      <!-- Notifications -->
      <section id="notifications" class="section">
        <div class="card">
          <div class="card-header">
            <h2>Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</h2>
          </div>

          <label>Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</label>
          <input id="notifPhone" placeholder="05xxxxxxxx">

          <button id="notifLoadBtn">Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</button>

          <div id="notifList" class="list" style="margin-top:10px;"></div>
        </div>
      </section>

    </div>
  </main>
</div>

<script src="api.js?v=3"></script>
<script>
/* ========== Helpers ========== */
const $ = (id) => document.getElementById(id);

function setLoading(btn, state = true) {
  if (!btn) return;
  if (state) {
    btn.classList.add("loading");
    btn.disabled = true;
  } else {
    btn.classList.remove("loading");
    btn.disabled = false;
  }
}

function createCard(html) {
  const div = document.createElement("div");
  div.className = "card";
  div.innerHTML = html;
  return div;
}

function clear(el) {
  if (el) el.innerHTML = "";
}

/* ========== Tabs ========== */
function initTabs() {
  const sections = document.querySelectorAll(".section");
  const navButtons = document.querySelectorAll(".nav-btn");

  navButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      const target = btn.dataset.target;
      sections.forEach(s => s.classList.remove("active"));
      $(target).classList.add("active");
      navButtons.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
    });
  });
}

/* ========== Theme Toggle ========== */
function initTheme() {
  const btn = $("themeToggle");
  const saved = localStorage.getItem("owner_theme");
  if (saved === "light") {
    document.body.classList.add("light");
  }

  btn.addEventListener("click", () => {
    document.body.classList.toggle("light");
    localStorage.setItem("owner_theme", document.body.classList.contains("light") ? "light" : "dark");
  });
}

/* ========== Date Pickers ========== */
function initDatePickers() {
  const options = { dateFormat: "Y-m-d", allowInput: true };
  flatpickr("#visitsFrom", options);
  flatpickr("#visitsTo", options);
  flatpickr("#bookingsDateOwner", options);
  flatpickr("#payrollFrom", options);
  flatpickr("#payrollTo", options);
  flatpickr("#reportsFrom", options);
  flatpickr("#reportsTo", options);
  flatpickr("#finFrom", options);
  flatpickr("#finTo", options);
}

/* ========== Dashboard & Charts ========== */
let dashboardData = null;

async function loadDashboard() {
  const res = await apiGet({ action: "getOwnersDashboard" });
  dashboardData = res;

  // KPIs
  $("kpiCustomers").innerText = res.totals.customers;
  $("kpiCars").innerText = res.totals.cars;
  $("kpiVisits").innerText = res.totals.visits;
  $("kpiAmount").innerText = res.totals.amount.toFixed(0);
  $("kpiRetention").innerText = res.totals.retention_rate.toFixed(1) + "%";
  $("kpiAvgSpend").innerText = res.totals.avg_spend_per_customer.toFixed(1);
  $("kpiAvgVisits").innerText = res.totals.avg_visits_per_customer.toFixed(1);
  $("kpiHealthScore").innerText = res.business_health.score + " / 100";
  $("kpiHealthStatus").innerText = res.business_health.status;

  $("sCustomers").innerText = res.totals.customers;
  $("sCars").innerText = res.totals.cars;
  $("sVisits").innerText = res.totals.visits;
  $("sAmount").innerText = res.totals.amount.toFixed(0);

  initChartsFromDashboard(res);
}

function initChartsFromDashboard(res) {
  // Amount per day (approx using visits_per_day * avg price)
  const dates = res.visits_per_day.map(v => v.date);
  const visitsCounts = res.visits_per_day.map(v => v.count);

  // Services breakdown
  const servicesNames = res.services_breakdown.map(s => s.service);
  const servicesCounts = res.services_breakdown.map(s => s.count);

  // Levels
  const levelsNames = Object.keys(res.levels);
  const levelsCounts = Object.values(res.levels);

  // Peak hours
  const peakHours = res.peak_hours.sort((a,b) => a.hour - b.hour);
  const peakHoursLabels = peakHours.map(h => h.hour + ":00");
  const peakHoursCounts = peakHours.map(h => h.count);

  // Cars stats (top car types)
  const carTypes = res.cars_stats.top_car_types.slice(0, 6);
  const carTypesNames = carTypes.map(c => c.car);
  const carTypesCounts = carTypes.map(c => c.count);

  // Chart: Visits per day
  const chartVisits = echarts.init($("chartVisitsPerDay"));
  chartVisits.setOption({
    tooltip: { trigger: "axis" },
    xAxis: { type: "category", data: dates },
    yAxis: { type: "value" },
    series: [{
      name: "Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª",
      type: "line",
      smooth: true,
      data: visitsCounts,
      areaStyle: {}
    }]
  });

  // Chart: Amount per day (ØªÙ‚Ø±ÙŠØ¨ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ØªÙˆØ³Ø· Ø§Ù„Ù…Ø¨Ù„Øº Ù„ÙƒÙ„ Ø²ÙŠØ§Ø±Ø©)
  const avgAmountPerVisit = res.totals.visits > 0 ? res.totals.amount / res.totals.visits : 0;
  const amountPerDay = visitsCounts.map(c => (c * avgAmountPerVisit).toFixed(0));

  const chartAmount = echarts.init($("chartAmountPerDay"));
  chartAmount.setOption({
    tooltip: { trigger: "axis" },
    xAxis: { type: "category", data: dates },
    yAxis: { type: "value" },
    series: [{
      name: "Ø§Ù„Ù…Ø¨Ø§Ù„Øº (ØªÙ‚Ø±ÙŠØ¨)",
      type: "bar",
      data: amountPerDay,
      itemStyle: { color: "#22c55e" }
    }]
  });

  // Chart: Services
  const chartServices = echarts.init($("chartServices"));
  chartServices.setOption({
    tooltip: { trigger: "axis" },
    xAxis: { type: "category", data: servicesNames },
    yAxis: { type: "value" },
    series: [{
      name: "Ø¹Ø¯Ø¯ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª",
      type: "bar",
      data: servicesCounts,
      itemStyle: { color: "#2563eb" }
    }]
  });

  // Chart: Levels
  const chartLevels = echarts.init($("chartLevels"));
  chartLevels.setOption({
    tooltip: { trigger: "item" },
    series: [{
      type: "pie",
      radius: "65%",
      data: levelsNames.map((name, i) => ({
        name,
        value: levelsCounts[i]
      }))
    }]
  });

  // Chart: Peak hours
  const chartPeak = echarts.init($("chartPeakHours"));
  chartPeak.setOption({
    tooltip: { trigger: "axis" },
    xAxis: { type: "category", data: peakHoursLabels },
    yAxis: { type: "value" },
    series: [{
      name: "Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª",
      type: "line",
      smooth: true,
      data: peakHoursCounts
    }]
  });

  // Chart: Cars
  const chartCars = echarts.init($("chartCars"));
  chartCars.setOption({
    tooltip: { trigger: "axis" },
    xAxis: { type: "category", data: carTypesNames },
    yAxis: { type: "value" },
    series: [{
      name: "Ø¹Ø¯Ø¯ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª",
      type: "bar",
      data: carTypesCounts,
      itemStyle: { color: "#f97316" }
    }]
  });

  window.addEventListener("resize", () => {
    chartVisits.resize();
    chartAmount.resize();
    chartServices.resize();
    chartLevels.resize();
    chartPeak.resize();
    chartCars.resize();
  });
}

/* ========== Visits (owner) ========== */
async function loadVisitsOwner() {
  const btn = $("visitsOwnerBtn");
  const from = $("visitsFrom").value.trim();
  const to = $("visitsTo").value.trim();

  setLoading(btn, true);

  let fromDate, toDate;
  if (!from && !to) {
    fromDate = "2000-01-01T00:00:00.000Z";
    toDate = "2100-01-01T23:59:59.000Z";
  } else {
    const f = from || to;
    const t = to || from;
    fromDate = new Date(f + "T00:00:00").toISOString();
    toDate = new Date(t + "T23:59:59").toISOString();
  }

  const res = await apiGet({
    action: "getVisitsByDate",
    from: fromDate,
    to: toDate
  });

  setLoading(btn, false);

  const list = $("visitsOwnerList");
  list.innerHTML = "";

  if (!res.visits || res.visits.length === 0) {
    list.innerHTML = "<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø²ÙŠØ§Ø±Ø§Øª</p>";
    return;
  }

  res.visits.forEach(v => {
    list.appendChild(createCard(`
      Ø§Ù„ØªØ§Ø±ÙŠØ®: ${v.date}<br>
      Ø§Ù„Ø®Ø¯Ù…Ø©: ${v.service}<br>
      Ø§Ù„Ø³Ø¹Ø±: ${v.price}<br>
      Ø§Ù„Ù†Ù‚Ø§Ø·: ${v.points}<br>
      Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©: ${v.membership}<br>
      Ø§Ù„Ù…ÙˆØ¸Ù: ${v.employee || "-"}<br>
      Ø§Ù„ÙØ±Ø¹: ${v.branch || "-"}
    `));
  });
}

/* ========== Bookings (owner) ========== */
async function loadBookingsOwner() {
  const date = $("bookingsDateOwner").value.trim();
  const res = await apiGet({
    action: "getBookings",
    date
  });

  const list = $("bookingsListOwner");
  clear(list);

  if (!res.bookings.length) {
    list.innerHTML = "<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª</p>";
    return;
  }

  res.bookings.forEach(b => {
    const div = createCard(`
      Ø§Ù„Ø¬ÙˆØ§Ù„: ${b.phone}<br>
      Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©: ${b.membership}<br>
      Ø§Ù„Ø®Ø¯Ù…Ø©: ${b.service}<br>
      Ø§Ù„ØªØ§Ø±ÙŠØ®: ${b.date} ${b.time}<br>
      Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: <b>${b.status}</b><br><br>
      <button class="secondary" onclick="confirmBookingOwner(this, ${b.row})">ØªØ£ÙƒÙŠØ¯</button>
      <button class="danger" onclick="cancelBookingOwner(this, ${b.row})">Ø¥Ù„ØºØ§Ø¡</button>
    `);
    list.appendChild(div);
  });
}

async function confirmBookingOwner(btn, row) {
  setLoading(btn, true);
  await apiPost({ action: "updateBookingStatus", row, status: "Approved" });
  setLoading(btn, false);
  loadBookingsOwner();
}

async function cancelBookingOwner(btn, row) {
  setLoading(btn, true);
  await apiPost({ action: "updateBookingStatus", row, status: "Cancelled" });
  setLoading(btn, false);
  loadBookingsOwner();
}

/* ========== Employees & Payroll ========== */
async function loadEmployees() {
  const res = await apiGet({ action: "getEmployees" });
  const list = $("employeesList");
  clear(list);
  const select = $("payrollEmployee");
  select.innerHTML = "";

  if (!res.employees || !res.employees.length) {
    list.innerHTML = "<p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ¸ÙÙˆÙ†</p>";
    return;
  }

  res.employees.forEach(e => {
    list.appendChild(createCard(`
      Ø§Ù„Ø§Ø³Ù…: ${e.employee}<br>
      Ø§Ù„Ø­Ø§Ù„Ø©: ${e.status}<br>
      Ø§Ù„Ø¬ÙˆØ§Ù„: ${e.phone || "-"}<br>
      Ø§Ù„ÙØ±Ø¹: ${e.branch || "-"}
    `));

    const opt = document.createElement("option");
    opt.value = e.employee;
    opt.textContent = e.employee;
    select.appendChild(opt);
  });
}

async function loadPayroll() {
  const btn = $("payrollBtn");
  const employee = $("payrollEmployee").value;
  const from = $("payrollFrom").value.trim();
  const to = $("payrollTo").value.trim();

  if (!employee || !from || !to) return alert("Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¸Ù ÙˆØ§Ù„ÙØªØ±Ø©");

  setLoading(btn, true);

  const res = await apiGet({
    action: "getPayroll",
    employee,
    from,
    to
  });

  setLoading(btn, false);

  $("payrollResult").innerHTML = `
    Ø§Ù„Ù…ÙˆØ¸Ù: ${res.employee}<br>
    Ø¹Ø¯Ø¯ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª: ${res.total_visits}<br>
    Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©: ${res.total_commission}<br>
    Ø¹Ø¯Ø¯ Ø§Ù„ØºØ³Ù„Ø§Øª: ${res.total_washes}
  `;
}

/* ========== Branches ========== */
async function loadBranches() {
  const res = await apiGet({ action: "getBranches" });
  const list = $("branchesList");
  clear(list);

  if (!res.branches || !res.branches.length) {
    list.innerHTML = "<p>Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØ±ÙˆØ¹</p>";
    return;
  }

  res.branches.forEach(b => {
    list.appendChild(createCard(`
      Ø§Ù„ÙØ±Ø¹: ${b.branch}<br>
      Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©: ${b.city}<br>
      Ø§Ù„Ù…Ø¯ÙŠØ±: ${b.manager || "-"}
    `));
  });
}

/* ========== Notifications ========== */
async function loadNotifications() {
  const btn = $("notifLoadBtn");
  const phone = $("notifPhone").value.trim();
  if (!phone) return alert("Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„");

  setLoading(btn, true);

  const res = await apiGet({
    action: "getNotifications",
    phone
  });

  setLoading(btn, false);

  const list = $("notifList");
  clear(list);

  if (!res.notifications || !res.notifications.length) {
    list.innerHTML = "<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù…</p>";
    return;
  }

  res.notifications.forEach(n => {
    const div = createCard(`
      Ø§Ù„Ø±Ø³Ø§Ù„Ø©: ${n.message}<br>
      Ø§Ù„Ù†ÙˆØ¹: ${n.type}<br>
      Ø§Ù„ØªØ§Ø±ÙŠØ®: ${n.created_at}<br>
      Ù…Ù‚Ø±ÙˆØ¡: ${n.read ? "Ù†Ø¹Ù…" : "Ù„Ø§"}<br><br>
      ${n.read ? "" : `<button class="secondary" onclick="markNotifRead(this, ${n.row})">ØªØ­Ø¯ÙŠØ¯ ÙƒÙ…Ù‚Ø±ÙˆØ¡</button>`}
    `);
    list.appendChild(div);
  });
}

async function markNotifRead(btn, row) {
  setLoading(btn, true);
  await apiGet({ action: "markNotificationRead", row });
  setLoading(btn, false);
  $("notifLoadBtn").click();
}

/* ========== Financial Reports ========== */
async function loadFinancialReport() {
  const btn = $("finLoadBtn");
  const from = $("finFrom").value.trim();
  const to = $("finTo").value.trim();
  const status = $("finStatus");
  const tbody = $("finTableBody");

  if (!from || !to) {
    alert("Ø§Ø®ØªØ± Ù…Ù† ÙˆØ¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®");
    return;
  }

  setLoading(btn, true);
  status.innerText = "Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©...";
  tbody.innerHTML = "";

  const fromDate = new Date(from + "T00:00:00").toISOString();
  const toDate = new Date(to + "T23:59:59").toISOString();

  const res = await apiGet({
    action: "getVisitsByDate",
    from: fromDate,
    to: toDate
  });

  if (!res.visits || res.visits.length === 0) {
    status.innerText = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©";
      $("finExportBtn").style.display = "block";
    setLoading(btn, false);
    return;
  }

  // Ù†Ø¬Ù…Ø¹ Ø§Ù„Ø¹Ø¶ÙˆÙŠØ§Øª Ø§Ù„ÙØ±ÙŠØ¯Ø©
  const memberships = [...new Set(res.visits.map(v => String(v.membership)))];

  // Ù†Ø¬ÙŠØ¨ Ø¨ÙŠØ§Ù†Ø§Øª ÙƒÙ„ Ø¹Ø¶ÙˆÙŠØ© Ù…Ù† API
  const membershipMap = {};
  for (const m of memberships) {
    const info = await apiGet({ action: "getByMembership", membership: m });
    membershipMap[m] = info;
  }

  // Ù†Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„
  res.visits.forEach(v => {
    const m = String(v.membership);
    const info = membershipMap[m];
    const customer = info && info.customer ? info.customer : null;
    const car = info && info.car ? info.car : null;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${customer ? customer.name : "-"}</td>
      <td>${customer ? customer.phone : "-"}</td>
      <td>${m}</td>
      <td>${car ? `${car.car} â€” ${car.plate_numbers} ${car.plate_letters}` : "-"}</td>
      <td>${v.service}</td>
      <td>${v.price}</td>
      <td>${v.commission}</td>
      <td>${v.branch || "-"}</td>
      <td>${v.employee || "-"}</td>
      <td>${v.date}</td>
    `;
    tbody.appendChild(tr);
  });

  status.innerText = `ØªÙ… ØªØ­Ù…ÙŠÙ„ ${res.visits.length} Ø²ÙŠØ§Ø±Ø© Ù…Ø§Ù„ÙŠØ©.`;
  setLoading(btn, false);
}

/* ========== Events & Init ========== */
function initEvents() {
  $("visitsOwnerBtn").onclick = loadVisitsOwner;
  $("bookingsDateOwner").onchange = loadBookingsOwner;
  $("payrollBtn").onclick = loadPayroll;
  $("notifLoadBtn").onclick = loadNotifications;
  $("finLoadBtn").onclick = loadFinancialReport;
  $("finExportBtn").onclick = exportFinancialToExcel;
}

initTabs();
initTheme();
initDatePickers();
initEvents();
loadDashboard();
loadBookingsOwner();
loadEmployees();
loadBranches();

    /* ========== Export to Excel ========== */
function exportFinancialToExcel() {
  const rows = [];
  const table = document.getElementById("finTableBody");
  const trs = table.querySelectorAll("tr");

  // Header
  rows.push([
    "Ø§Ù„Ø¹Ù…ÙŠÙ„",
    "Ø§Ù„Ø¬ÙˆØ§Ù„",
    "Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©",
    "Ø§Ù„Ø³ÙŠØ§Ø±Ø©",
    "Ø§Ù„Ø®Ø¯Ù…Ø©",
    "Ø§Ù„Ø³Ø¹Ø±",
    "Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©",
    "Ø§Ù„ÙØ±Ø¹",
    "Ø§Ù„Ù…ÙˆØ¸Ù",
    "Ø§Ù„ØªØ§Ø±ÙŠØ®"
  ]);

  // Rows
  trs.forEach(tr => {
    const cells = [...tr.querySelectorAll("td")].map(td => td.innerText);
    rows.push(cells);
  });

  // Convert to CSV
  let csv = "";
  rows.forEach(r => {
    csv += r.map(v => `"${v}"`).join(",") + "\n";
  });

  // Convert CSV â†’ Excel Blob
  const blob = new Blob([csv], { type: "application/vnd.ms-excel" });
  const url = URL.createObjectURL(blob);

  // Download
  const a = document.createElement("a");
  a.href = url;
  a.download = "financial-report.xlsx";
  a.click();

  URL.revokeObjectURL(url);
}

</script>

</body>
</html>
