<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø§Ù„Ùƒ</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="api.js"></script>

<style>
body{
font-family:"Tajawal",sans-serif;
background:#F4FAFF;
color:#0D47A1;
padding:16px;
}
h2{margin-bottom:12px;}
.tabs{
display:flex;
gap:8px;
margin-bottom:16px;
overflow-x:auto;
}
.tab-btn{
padding:10px 16px;
border-radius:999px;
background:#E3F2FD;
color:#0D47A1;
border:none;
cursor:pointer;
font-size:14px;
white-space:nowrap;
}
.tab-btn.active{
background:#0D47A1;
color:white;
}
.tab-content{display:none;}
.tab-content.active{display:block;}
.card{
background:white;
padding:16px;
border-radius:16px;
margin-bottom:16px;
box-shadow:0 4px 12px rgba(0,0,0,0.08);
border:1px solid #E3F2FD;
}
.grid{
display:grid;
grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
gap:16px;
}
.value{
font-size:20px;
font-weight:700;
margin-top:6px;
}
input,select{
width:100%;
padding:8px;
border-radius:8px;
border:1px solid #D1D5DB;
margin-bottom:8px;
font-size:14px;
}
.btn{
padding:10px 16px;
border:none;
border-radius:999px;
background:#0D47A1;
color:white;
cursor:pointer;
font-size:14px;
margin-top:6px;
}
.btn-outline{
padding:10px 16px;
border-radius:999px;
background:white;
border:1px solid #0D47A1;
color:#0D47A1;
cursor:pointer;
font-size:14px;
margin-top:6px;
}
table{
width:100%;
border-collapse:collapse;
font-size:13px;
}
th,td{
border-bottom:1px solid #E5E7EB;
padding:6px;
text-align:right;
}
th{
background:#F3F4F6;
font-weight:600;
}
.tag{
background:#E3F2FD;
padding:2px 6px;
border-radius:999px;
font-size:11px;
color:#0D47A1;
}
</style>
</head>

<body>

<h2>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø§Ù„Ùƒ</h2>

<div class="tabs">
<button class="tab-btn active" onclick="openTab('dashboard')">ğŸ“Š Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
<button class="tab-btn" onclick="openTab('activeCars')">ğŸš— Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª ØºÙŠØ± Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø©</button>
<button class="tab-btn" onclick="openTab('reports')">ğŸ“‘ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
<button class="tab-btn" onclick="openTab('customers')">ğŸ‘¥ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</button>
<button class="tab-btn" onclick="openTab('bookings')">ğŸ“… Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</button>
</div>

<!-- DASHBOARD -->
<div id="dashboard" class="tab-content active">

<div class="card">
<h3>ğŸ“… ÙÙ„ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ®</h3>
<label>Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
<input type="date" id="dateFrom">
<label>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
<input type="date" id="dateTo">
<button class="btn" onclick="loadDashboard()">Ø¹Ø±Ø¶</button>
<button class="btn-outline" onclick="resetDates()">Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
</div>

<div class="card">
<h3>ğŸ“Š Ù…Ù„Ø®Øµ</h3>
<div id="dashboardContent">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
</div>

<div class="card">
<h3>ğŸ“ˆ Ø´Ø§Ø±Øª Ø§Ù„ÙˆØ§Ø±Ø¯ Ø§Ù„ÙŠÙˆÙ…ÙŠ</h3>
<canvas id="chartRevenue"></canvas>
</div>

<div class="card">
<h3>ğŸ“‰ Ø´Ø§Ø±Øª Ø¹Ù…ÙˆÙ„Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h3>
<canvas id="chartCommission"></canvas>
</div>

</div>

<!-- ACTIVE CARS -->
<div id="activeCars" class="tab-content">
<div class="card">
<h3>ğŸš— Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ØºØ³Ù„Ø© (ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹Ø©)</h3>
<div id="activeCarsList">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
</div>
</div>

<!-- REPORTS -->
<div id="reports" class="tab-content">
<div class="card">
<h3>ğŸ“‘ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©</h3>
<button class="btn" onclick="downloadExcel()">ØªØ­Ù…ÙŠÙ„ Excel</button>
<div id="reportsTable">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
</div>
</div>

<!-- CUSTOMERS -->
<div id="customers" class="tab-content">
<div class="card">
<h3>ğŸ‘¥ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h3>
<input id="customerSearch" placeholder="Ø¨Ø­Ø« Ø¹Ù† Ø¹Ù…ÙŠÙ„">
<button class="btn" onclick="loadCustomers()">Ø¨Ø­Ø«</button>
<div id="customersTable">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
</div>
</div>

<!-- BOOKINGS -->
<div id="bookings" class="tab-content">
<div class="card">
<h3>ğŸ“… Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</h3>
<div id="bookingsList">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
</div>
</div>

<script>

function openTab(id){
document.querySelectorAll(".tab-btn").forEach(btn => btn.classList.remove("active"));
document.querySelectorAll(".tab-content").forEach(tab => tab.classList.remove("active"));
event.target.classList.add("active");
document.getElementById(id).classList.add("active");
}

function resetDates(){
document.getElementById("dateFrom").value = "";
document.getElementById("dateTo").value = "";
loadDashboard();
}

async function loadDashboard() {
const from = document.getElementById("dateFrom").value;
const to = document.getElementById("dateTo").value;

const visitsRes = await apiGetAll("Visits");
const customersRes = await apiGetAll("Customers");

if (!visitsRes.success) return;

let visits = visitsRes.rows;

if (from && to) {
visits = visits.filter(v => {
const date = String(v[8] || "").slice(0, 10);
return date >= from && date <= to;
});
}

let total = 0, cash = 0, network = 0;
let commissionMap = {};

visits.forEach(v => {
const price = Number(v[2] || 0);
const method = String(v[11] || "");
const employee = String(v[4] || "");

total += price;
if (method === "ÙƒØ§Ø´") cash += price;
if (method === "Ø´Ø¨ÙƒØ©") network += price;

if (employee) {
commissionMap[employee] = (commissionMap[employee] || 0) + Math.round(price * 0.10);
}
});

document.getElementById("dashboardContent").innerHTML = `
<div class="grid">
<div class="card"><h4>ğŸ’° Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙˆØ§Ø±Ø¯</h4><div class="value">${total} Ø±ÙŠØ§Ù„</div></div>
<div class="card"><h4>ğŸ’³ Ø´Ø¨ÙƒØ©</h4><div class="value">${network} Ø±ÙŠØ§Ù„</div></div>
<div class="card"><h4>ğŸ’µ ÙƒØ§Ø´</h4><div class="value">${cash} Ø±ÙŠØ§Ù„</div></div>
<div class="card"><h4>ğŸ§½ Ø¹Ø¯Ø¯ Ø§Ù„Ø®Ø¯Ù…Ø§Øª</h4><div class="value">${visits.length}</div></div>
<div class="card"><h4>ğŸ‘¥ Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h4><div class="value">${customersRes.rows.length}</div></div>
<div class="card"><h4>ğŸ’¼ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ù…ÙˆÙ„Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h4><div class="value">${
Object.values(commissionMap).reduce((a,b)=>a+b,0)
} Ø±ÙŠØ§Ù„</div></div>
</div>
`;

const revenueByDay = {};
visits.forEach(v => {
const date = String(v[8] || "").slice(0, 10);
const price = Number(v[2] || 0);
revenueByDay[date] = (revenueByDay[date] || 0) + price;
});

new Chart(document.getElementById("chartRevenue"), {
type: "bar",
data: {
labels: Object.keys(revenueByDay),
datasets: [{
label: "Ø§Ù„ÙˆØ§Ø±Ø¯ Ø§Ù„ÙŠÙˆÙ…ÙŠ",
data: Object.values(revenueByDay),
backgroundColor: "#0D47A1"
}]
}
});

new Chart(document.getElementById("chartCommission"), {
type: "bar",
data: {
labels: Object.keys(commissionMap),
datasets: [{
label: "Ø¹Ù…ÙˆÙ„Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†",
data: Object.values(commissionMap),
backgroundColor: "#FF8F00"
}]
}
});
}

async function loadActiveCars() {
const box = document.getElementById("activeCarsList");
box.innerHTML = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...";

const visitsRes = await apiGetActiveVisits();

if (!visitsRes.success || !visitsRes.visits.length) {
box.innerHTML = `<div style="text-align:center;color:#9CA3AF;font-size:14px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³ÙŠØ§Ø±Ø§Øª Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ØºØ³Ù„Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.</div>`;
return;
}

const carsRes = await apiGetAll("Cars");
let carMap = {};

if (carsRes.success) {
carsRes.rows.forEach(c => {
const membership = c[0];
carMap[membership] = {
car: c[2],
size: c[3],
letters: c[4],
numbers: c[5]
};
});
}

box.innerHTML = visitsRes.visits.map(v => {
const row = v.row;
const d = v.data;
const membership = d[0];

let plate = "â€”";
let carName = "â€”";

if (membership && carMap[membership]) {
plate = `${carMap[membership].numbers} ${carMap[membership].letters}`;
carName = carMap[membership].car;
}

return `
<div style="border:1px solid #E5E7EB;border-radius:12px;padding:10px;margin-bottom:10px;background:white;font-size:14px;">
<b>ğŸš— Ø§Ù„Ù„ÙˆØ­Ø©:</b> ${plate}<br>
<b>Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø©:</b> ${carName}<br>
<b>Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©:</b> ${membership || "â€”"}<br>
<b>Ø§Ù„Ø®Ø¯Ù…Ø©:</b> ${d[1]}<br>
<b>Ø§Ù„Ø³Ø¹Ø±:</b> ${d[2]} Ø±ÙŠØ§Ù„<br>
<b>Ø§Ù„Ù…ÙˆÙ‚Ù:</b> ${d[12] || "â€”"}<br>
<b>Ø§Ù„ÙØ±Ø¹:</b> ${d[9] || "â€”"}<br>

<label style="font-size:13px;margin-top:6px;display:block;">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</label>
<select id="pay_${row}" style="width:100%;padding:6px;border-radius:8px;border:1px solid #D1D5DB;">
<option value="ÙƒØ§Ø´">ÙƒØ§Ø´</option>
<option value="Ø´Ø¨ÙƒØ©">Ø´Ø¨ÙƒØ©</option>
</select>

<button onclick="markActiveCarPaid(${row})"
style="margin-top:8px;width:100%;padding:8px;background:#0D47A1;color:white;border:none;border-radius:8px;cursor:pointer;">
ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹
</button>
</div>
`;
}).join("");
}

async function markActiveCarPaid(row) {
const method = document.getElementById(`pay_${row}`).value;

const res = await apiPost({
action: "closeVisit",
row,
payment_status: "Ù…Ø¯ÙÙˆØ¹",
payment_method: method
});

if (!res.success) {
alert("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹");
return;
}

alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­");
loadActiveCars();
}

document.querySelector("[onclick=\"openTab('activeCars')\"]")
.addEventListener("click", loadActiveCars);

async function loadReports() {
const box = document.getElementById("reportsTable");
box.innerHTML = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...";

const visitsRes = await apiGetAll("Visits");

if (!visitsRes.success) {
box.innerHTML = "Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª";
return;
}

const visits = visitsRes.rows;

box.innerHTML = `
<table>
<thead>
<tr>
<th>Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©</th>
<th>Ø§Ù„Ø®Ø¯Ù…Ø©</th>
<th>Ø§Ù„Ø³Ø¹Ø±</th>
<th>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</th>
<th>Ø§Ù„Ù…ÙˆØ¸Ù</th>
<th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
<th>Ø§Ù„ÙØ±Ø¹</th>
</tr>
</thead>
<tbody>
${visits.map(v => `
<tr>
<td>${v[0] || "â€”"}</td>
<td>${v[1] || "â€”"}</td>
<td>${v[2] || 0} Ø±ÙŠØ§Ù„</td>
<td>${v[11] || "â€”"}</td>
<td>${v[4] || "â€”"}</td>
<td>${v[8] || "â€”"}</td>
<td>${v[9] || "â€”"}</td>
</tr>
`).join("")}
</tbody>
</table>
`;
}

function downloadExcel() {
const table = document.getElementById("reportsTable").innerHTML;

const excelContent = `
<html xmlns:o="urn:schemas-microsoft-com:office:office"
xmlns:x="urn:schemas-microsoft-com:office:excel"
xmlns="http://www.w3.org/TR/REC-html40">
<head><meta charset="UTF-8"></head>
<body>
<table>${table}</table>
</body>
</html>
`;

const blob = new Blob([excelContent], { type: "application/vnd.ms-excel" });
const url = URL.createObjectURL(blob);
const a = document.createElement("a");
a.href = url;
a.download = "reports.xls";
a.click();
URL.revokeObjectURL(url);
}

document.querySelector("[onclick=\"openTab('reports')\"]")
.addEventListener("click", loadReports);

async function loadCustomers() {
const box = document.getElementById("customersTable");
const q = document.getElementById("customerSearch").value.trim().toLowerCase();

box.innerHTML = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...";

const customersRes = await apiGetAll("Customers");
const carsRes = await apiGetAll("Cars");
const visitsRes = await apiGetAll("Visits");

if (!customersRes.success) {
box.innerHTML = "Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª";
return;
}

const customers = customersRes.rows;

const carsMap = {};
if (carsRes.success) {
carsRes.rows.forEach(c => {
const mem = c[0];
if (!carsMap[mem]) carsMap[mem] = [];
carsMap[mem].push(c);
});
}

const visitsMap = {};
if (visitsRes.success) {
visitsRes.rows.forEach(v => {
const mem = v[0];
if (!visitsMap[mem]) visitsMap[mem] = [];
visitsMap[mem].push(v);
});
}

const filtered = customers.filter(c => {
const name = String(c[0] || "").toLowerCase();
const phone = String(c[1] || "").toLowerCase();
const mem = String(c[8] || "").toLowerCase();
if (!q) return true;
return name.includes(q) || phone.includes(q) || mem.includes(q);
});

if (!filtered.length) {
box.innerHTML = `<div style="text-align:center;color:#9CA3AF;font-size:14px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø©</div>`;
return;
}

box.innerHTML = `
<table>
<thead>
<tr>
<th>Ø§Ù„Ø§Ø³Ù…</th>
<th>Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©</th>
<th>Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</th>
<th>Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª</th>
<th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th>
<th>Ø§Ù„Ù†Ù‚Ø§Ø·</th>
<th>Ø§Ù„Ù…Ø³ØªÙˆÙ‰</th>
</tr>
</thead>
<tbody>
${filtered.map(c => {
const mem = c[8];
const cars = carsMap[mem] || [];
const visits = visitsMap[mem] || [];
const totalPaid = visits.reduce((sum, v) => sum + Number(v[2] || 0), 0);

return `
<tr>
<td>${c[0]}</td>
<td>${mem}</td>
<td>${cars.length}</td>
<td>${visits.length}</td>
<td>${totalPaid} Ø±ÙŠØ§Ù„</td>
<td>${c[11] || 0}</td>
<td>${c[12] || "â€”"}</td>
</tr>
`;
}).join("")}
</tbody>
</table>
`;
}

document.querySelector("[onclick=\"openTab('customers')\"]")
.addEventListener("click", loadCustomers);

async function loadBookings() {
const box = document.getElementById("bookingsList");
box.innerHTML = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...";

const res = await apiGetAll("Bookings");

if (!res.success || !res.rows.length) {
box.innerHTML = `<div style="text-align:center;color:#9CA3AF;font-size:14px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</div>`;
return;
}

box.innerHTML = res.rows.map((b, i) => {
const phone = b[0];
const membership = b[1];
const service = b[2];
const date = b[3];
const time = b[4];
const status = b[5];

return `
<div style="border:1px solid #E5E7EB;border-radius:12px;padding:10px;margin-bottom:10px;background:white;font-size:14px;">
<b>Ø§Ù„Ø®Ø¯Ù…Ø©:</b> ${service}<br>
<b>Ø§Ù„ØªØ§Ø±ÙŠØ®:</b> ${date} ${time}<br>
<b>Ø§Ù„Ø¬ÙˆØ§Ù„:</b> ${phone}<br>
<b>Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©:</b> ${membership}<br>
<b>Ø§Ù„Ø­Ø§Ù„Ø©:</b> <span class="tag">${status}</span><br>

<button onclick="updateBookingStatus(${i + 2}, 'Ù…Ø¤ÙƒØ¯', '${phone}')" class="btn" style="width:100%;margin-top:6px;">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø²</button>
<button onclick="updateBookingStatus(${i + 2}, 'Ù…Ù„ØºÙŠ', '${phone}')" class="btn-outline" style="width:100%;margin-top:6px;">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¬Ø²</button>
</div>
`;
}).join("");
}

async function updateBookingStatus(row, status, phone) {
const res = await apiPost({
action: "updateRow",
sheet: "Bookings",
row,
values: JSON.stringify([null, null, null, null, null, status, null])
});

if (!res.success) {
alert("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø¬Ø²");
return;
}

alert
