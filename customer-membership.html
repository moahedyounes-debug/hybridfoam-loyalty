<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="manifest" href="manifest.json">

    <script>
        if ("serviceWorker" in navigator) {
            navigator.serviceWorker.register("service-worker.js");
        }
    </script>

    <script src="api.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>

    <style>
        body {
            font-family: sans-serif;
            background: #f5f5f5;
            margin: 0;
            padding: 0;
            text-align: center;
        }

        .page-header {
            background: #007bff;
            color: white;
            padding: 16px;
            font-size: 20px;
        }

        .card-wrapper {
            margin: 25px auto;
            max-width: 380px;
        }

        .card {
            border-radius: 18px;
            overflow: hidden;
            box-shadow: 0 0 10px rgba(0,0,0,0.15);
            background: #fff;
            text-align: right;
        }

        .card-header {
            padding: 16px 18px;
            color: #fff;
            position: relative;
        }

        .brand {
            font-size: 18px;
            font-weight: bold;
        }

        .subtitle {
            font-size: 14px;
            opacity: 0.9;
            margin-top: 4px;
        }

        .vip-crown {
            position: absolute;
            top: -12px;
            right: 12px;
            font-size: 26px;
            display: none;
        }

        .card-body {
            padding: 16px 18px 20px;
        }

        .row {
            margin-bottom: 6px;
            font-size: 15px;
        }

        .row strong {
            display: inline-block;
            min-width: 90px;
        }

        #qrcode {
            margin: 15px auto;
            width: 120px;
            height: 120px;
        }

        .footer-row {
            margin-top: 10px;
            font-size: 14px;
            color: #555;
        }

        .btn-main {
            width: 90%;
            max-width: 350px;
            padding: 14px;
            margin: 18px auto 0;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 17px;
            cursor: pointer;
        }

        .back {
            display: block;
            width: 90%;
            max-width: 350px;
            padding: 14px;
            margin: 14px auto 24px;
            background: #6c757d;
            color: white;
            text-align: center;
            border-radius: 10px;
            font-size: 17px;
            text-decoration: none;
        }

        .loading {
            margin-top: 30px;
            font-size: 18px;
            color: #555;
        }

        /* Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª */
        .level-gold   { background: #d4af37; }
        .level-silver { background: #9e9e9e; }
        .level-bronze { background: #cd7f32; }
        .level-basic  { background: #007bff; }
    </style>
</head>

<body>

    <div class="page-header">Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©</div>

    <div id="loading" class="loading">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©...</div>

    <div id="content" style="display:none;">

        <div class="card-wrapper">
            <div id="card" class="card">

                <div id="cardHeader" class="card-header level-basic">
                    <div class="vip-crown" id="vipCrown">ğŸ‘‘</div>
                    <div class="brand">Ø±ØºÙˆØ© Ø§Ù„Ù‡Ø¬ÙŠÙ†</div>
                    <div class="subtitle">Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ÙˆÙ„Ø§Ø¡</div>
                </div>

                <div class="card-body">
                    <div class="row"><strong>Ø§Ù„Ø§Ø³Ù…:</strong> <span id="name"></span></div>
                    <div class="row"><strong>Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©:</strong> <span id="membership"></span></div>
                    <div class="row"><strong>Ø§Ù„Ù…Ø³ØªÙˆÙ‰:</strong> <span id="level"></span></div>
                    <div class="row"><strong>Ø§Ù„Ù†Ù‚Ø§Ø·:</strong> <span id="points"></span></div>

                    <div id="qrcode"></div>

                    <div class="footer-row"><strong>Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ:</strong> <span id="subscription"></span></div>
                    <div class="footer-row"><strong>Ø¢Ø®Ø± Ø²ÙŠØ§Ø±Ø©:</strong> <span id="lastVisit"></span></div>
                </div>
            </div>
        </div>

        <button id="installBtn" class="btn-main" style="display:none;">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ù„Ù„Ø¬ÙˆØ§Ù„</button>

        <a href="customer-dashboard.html" class="back">Ø±Ø¬ÙˆØ¹ Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„</a>
    </div>

    <script>
        let deferredPrompt;

        window.addEventListener("beforeinstallprompt", (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById("installBtn").style.display = "block";
        });

        document.getElementById("installBtn").onclick = async () => {
            const btn = document.getElementById("installBtn");
            btn.disabled = true;
            btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø¶Ø§ÙØ©...";
            deferredPrompt.prompt();
            await deferredPrompt.userChoice;
            btn.innerText = "ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©";
        };

        function applyLevelStyle(levelText) {
            const header = document.getElementById("cardHeader");
            const crown = document.getElementById("vipCrown");

            header.classList.remove("level-gold","level-silver","level-bronze","level-basic");
            crown.style.display = "none";

            const level = (levelText || "").trim();

            if (level.includes("Ø°Ù‡Ø¨ÙŠ") || level.includes("VIP")) {
                header.classList.add("level-gold");
                crown.style.display = "block";
            } else if (level.includes("ÙØ¶ÙŠ")) {
                header.classList.add("level-silver");
            } else if (level.includes("Ø¨Ø±ÙˆÙ†Ø²ÙŠ")) {
                header.classList.add("level-bronze");
            } else {
                header.classList.add("level-basic");
            }
        }

        async function loadMembership() {
            const phone = localStorage.getItem("customer_phone");

            if (!phone) {
                window.location.href = "customer-login.html";
                return;
            }

            const res = await apiGet({
                action: "getCustomerDashboard",
                phone
            });

            if (!res.success) {
                document.getElementById("loading").innerText = "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©";
                return;
            }

            const c = res.customer;

            document.getElementById("name").innerText = c.name;
            document.getElementById("membership").innerText = c.membership || "-";
            document.getElementById("level").innerText = c.level || "-";
            document.getElementById("points").innerText = c.points ?? 0;
            document.getElementById("subscription").innerText = c.subscription || "Ø¨Ø¯ÙˆÙ† Ø§Ø´ØªØ±Ø§Ùƒ";
            document.getElementById("lastVisit").innerText = res.last_visit ? res.last_visit.date : "â€”";

            applyLevelStyle(c.level || "");

            new QRCode(document.getElementById("qrcode"), {
                text: c.phone,
                width: 120,
                height: 120
            });

            document.getElementById("loading").style.display = "none";
            document.getElementById("content").style.display = "block";
        }

        window.onload = () => {
            setTimeout(loadMembership, 120);
        };
    </script>

</body>
</html>
