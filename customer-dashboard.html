<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„ - Hybrid Foam</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        :root {
            --bg: #050509;
            --card: #111119;
            --card-soft: #181824;
            --gold: #d4af37;
            --gold-soft: #f5e3a3;
            --text-main: #f5f5f5;
            --text-muted: #aaaaaa;
            --danger: #ff5252;
            --success: #4caf50;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: "Tajawal", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: radial-gradient(circle at top, #202030 0, #050509 55%);
            color: var(--text-main);
            padding: 20px 12px 40px;
        }

        .container {
            max-width: 520px;
            margin: auto;
        }

        .header {
            text-align: center;
            margin-bottom: 22px;
        }

        .logo-circle {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: 2px solid var(--gold);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            font-weight: 700;
            font-size: 22px;
            color: var(--gold-soft);
            background: radial-gradient(circle at top, #333344 0, #050509 70%);
        }

        .header h2 {
            margin: 0;
            font-size: 22px;
            letter-spacing: 1px;
        }

        .header p {
            margin: 6px 0 0;
            font-size: 13px;
            color: var(--text-muted);
        }

        .grid {
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .card {
            background: linear-gradient(135deg, #111119 0, #050509 60%);
            border-radius: 14px;
            padding: 14px 14px 12px;
            border: 1px solid rgba(212, 175, 55, 0.18);
            box-shadow: 0 10px 25px rgba(0,0,0,0.55);
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .card-title {
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .card-title span.icon {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: radial-gradient(circle at top, #f5e3a3 0, #d4af37 55%, #8b6b1f 100%);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            color: #111119;
        }

        .card-sub {
            font-size: 11px;
            color: var(--text-muted);
        }

        .pill {
            padding: 3px 10px;
            border-radius: 999px;
            font-size: 11px;
            border: 1px solid rgba(212, 175, 55, 0.6);
            color: var(--gold-soft);
        }

        .pill.green {
            border-color: var(--success);
            color: #b9f6ca;
        }

        .pill.red {
            border-color: var(--danger);
            color: #ff8a80;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            margin-bottom: 6px;
        }

        .label {
            color: var(--text-muted);
        }

        .value {
            font-weight: 500;
        }

        .value.gold {
            color: var(--gold-soft);
        }

        .value.big {
            font-size: 18px;
            font-weight: 600;
        }

        .divider {
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.12), transparent);
            margin: 8px 0 6px;
        }

        .tag-row {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 4px;
        }

        .tag {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 999px;
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.06);
            color: var(--text-muted);
        }

        .car-box, .visit-box, .booking-box {
            margin-top: 8px;
            padding: 9px 10px;
            border-radius: 10px;
            background: radial-gradient(circle at top left, #26263a 0, #111119 55%);
            border: 1px solid rgba(255,255,255,0.06);
            font-size: 12px;
        }

        .car-top {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }

        .plate {
            font-family: "SF Mono", ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.18);
            background: rgba(0,0,0,0.35);
        }

        .muted {
            color: var(--text-muted);
            font-size: 12px;
        }

        .empty {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .footer-note {
            margin-top: 18px;
            text-align: center;
            font-size: 11px;
            color: var(--text-muted);
        }

        .highlight {
            color: var(--gold-soft);
        }

        .btn-row {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .btn {
            flex: 1;
            padding: 8px 10px;
            border-radius: 999px;
            border: 1px solid rgba(212,175,55,0.6);
            background: radial-gradient(circle at top, #f5e3a3 0, #d4af37 55%, #8b6b1f 100%);
            color: #111119;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn.ghost {
            background: transparent;
            color: var(--gold-soft);
            border-color: rgba(212,175,55,0.4);
        }

        .loading {
            text-align: center;
            font-size: 13px;
            color: var(--text-muted);
            margin-top: 10px;
        }
    </style>
</head>

<body>
<div class="container">
    <div class="header">
        <div class="logo-circle">HF</div>
        <h2>Ù„ÙˆØ­Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„</h2>
        <p>Ø¹Ø±Ø¶ Ù…Ù„Ø®Øµ Ø¹Ø¶ÙˆÙŠØªÙƒ ÙˆØ²ÙŠØ§Ø±Ø§ØªÙƒ ÙÙŠ Hybrid Foam</p>
    </div>

    <div id="loading" class="loading">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ...</div>

    <div id="dashboard" class="grid" style="display:none;">
        <!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ -->
        <div class="card" id="card-customer">
            <div class="card-header">
                <div>
                    <div class="card-title">
                        <span class="icon">ğŸ‘¤</span>
                        <span>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</span>
                    </div>
                    <div class="card-sub">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø­Ø³Ø§Ø¨Ùƒ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</div>
                </div>
                <div id="membership-pill" class="pill">Ø¹Ø¶Ùˆ</div>
            </div>

            <div class="info-row">
                <span class="label">Ø§Ù„Ø§Ø³Ù…</span>
                <span id="c-name" class="value gold"></span>
            </div>
            <div class="info-row">
                <span class="label">Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</span>
                <span id="c-phone" class="value"></span>
            </div>
            <div class="info-row">
                <span class="label">Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©</span>
                <span id="c-membership" class="value"></span>
            </div>
            <div class="info-row">
                <span class="label">Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</span>
                <span id="c-city" class="value"></span>
            </div>

            <div class="divider"></div>

            <div class="info-row">
                <span class="label">Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…ØªØ§Ø­Ø©</span>
                <span id="c-points" class="value big"></span>
            </div>
            <div class="info-row">
                <span class="label">ØºØ³ÙŠÙ„ Ù…Ø¬Ø§Ù†ÙŠ</span>
                <span id="c-freewash" class="value"></span>
            </div>

            <div class="tag-row">
                <span id="c-level-tag" class="tag">Ø§Ù„Ù…Ø³ØªÙˆÙ‰: â€”</span>
                <span class="tag">Hybrid Foam Loyalty</span>
            </div>
        </div>

        <!-- Ø³ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ -->
        <div class="card" id="card-cars">
            <div class="card-header">
                <div>
                    <div class="card-title">
                        <span class="icon">ğŸš—</span>
                        <span>Ø³ÙŠØ§Ø±Ø§ØªÙƒ Ø§Ù„Ù…Ø³Ø¬Ù„Ø©</span>
                    </div>
                    <div class="card-sub">Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„Ùƒ</div>
                </div>
                <div id="cars-count-pill" class="pill">0 Ø³ÙŠØ§Ø±Ø©</div>
            </div>

            <div id="cars-list"></div>

            <div id="cars-empty" class="empty" style="display:none;">
                Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³ÙŠØ§Ø±Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.
            </div>

            <div class="btn-row">
                <button class="btn" onclick="goToAddCar()">Ø¥Ø¶Ø§ÙØ© Ø³ÙŠØ§Ø±Ø©</button>
                <button class="btn ghost" onclick="goToCars()">Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</button>
            </div>
        </div>

        <!-- Ø¢Ø®Ø± Ø²ÙŠØ§Ø±Ø© -->
        <div class="card" id="card-last-visit">
            <div class="card-header">
                <div>
                    <div class="card-title">
                        <span class="icon">ğŸ§½</span>
                        <span>Ø¢Ø®Ø± Ø²ÙŠØ§Ø±Ø©</span>
                    </div>
                    <div class="card-sub">ØªÙØ§ØµÙŠÙ„ Ø¢Ø®Ø± Ø®Ø¯Ù…Ø© ØªÙ…Øª Ø¹Ù„Ù‰ Ø¹Ø¶ÙˆÙŠØªÙƒ</div>
                </div>
                <div id="visit-status-pill" class="pill green">Ù†Ø´Ø·</div>
            </div>

            <div id="visit-content"></div>

            <div id="visit-empty" class="empty" style="display:none;">
                Ù„Ø§ ØªÙˆØ¬Ø¯ Ø²ÙŠØ§Ø±Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.
            </div>
        </div>

        <!-- Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª -->
        <div class="card" id="card-bookings">
            <div class="card-header">
                <div>
                    <div class="card-title">
                        <span class="icon">ğŸ“…</span>
                        <span>Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</span>
                    </div>
                    <div class="card-sub">Ù…ÙˆØ§Ø¹ÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙˆØ§Ù„Ø³Ø§Ø¨Ù‚Ø©</div>
                </div>
                <div id="bookings-count-pill" class="pill">0 Ø­Ø¬Ø²</div>
            </div>

            <div id="bookings-list"></div>

            <div id="bookings-empty" class="empty" style="display:none;">
                Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ù…Ø³Ø¬Ù„Ø©.
            </div>

            <div class="btn-row">
                <button class="btn" onclick="goToBooking()">Ø­Ø¬Ø² Ù…ÙˆØ¹Ø¯ Ø¬Ø¯ÙŠØ¯</button>
                <button class="btn ghost" onclick="goToBookings()">Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</button>
            </div>
        </div>
    </div>

    <div class="footer-note">
        Ø£ÙŠ Ø§Ø³ØªÙØ³Ø§Ø± Ø£Ùˆ Ù…Ø³Ø§Ø¹Ø¯Ø© Ø¹Ø¨Ø± Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ù‚Ù…
        <span class="highlight">0582007063</span>
    </div>
</div>

<script src="api.js"></script>

<script>
let CUSTOMER = null;
let PHONE = "";

// Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
window.addEventListener("DOMContentLoaded", async () => {
    try {
        const storedCustomer = localStorage.getItem("customer");
        const storedPhone = localStorage.getItem("phone");

        if (!storedCustomer || !storedPhone) {
            window.location.href = "customer-home.html";
            return;
        }

        CUSTOMER = JSON.parse(storedCustomer);
        PHONE = storedPhone;

        await loadDashboard();
    } catch (e) {
        console.error(e);
        document.getElementById("loading").innerText = "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.";
    }
});

async function loadDashboard() {
    const loading = document.getElementById("loading");
    const dash = document.getElementById("dashboard");

    loading.style.display = "block";
    dash.style.display = "none";

    // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ù€ APIs Ø§Ù„Ø³Ø±ÙŠØ¹Ø©
    const [customerRes, carsRes, visitsRes, bookingsRes] = await Promise.all([
        apiGet({ action: "getCustomerByPhone", phone: PHONE }),
        apiGet({ action: "getCarsByPhone", phone: PHONE }),
        apiGet({ action: "getVisitsByMembership", membership: CUSTOMER.membership || "" }),
        apiGet({ action: "getBookingsByPhone", phone: PHONE })
    ]);

    // ØªØ¹Ø¨Ø¦Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„
    renderCustomer(customerRes);
    renderCars(carsRes);
    renderLastVisit(visitsRes);
    renderBookings(bookingsRes);

    loading.style.display = "none";
    dash.style.display = "flex";
}

// ====== Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ ======
function renderCustomer(res) {
    const nameEl = document.getElementById("c-name");
    const phoneEl = document.getElementById("c-phone");
    const cityEl = document.getElementById("c-city");
    const membershipEl = document.getElementById("c-membership");
    const pointsEl = document.getElementById("c-points");
    const freeWashEl = document.getElementById("c-freewash");
    const levelTag = document.getElementById("c-level-tag");
    const membershipPill = document.getElementById("membership-pill");

    const row = res && res.success && res.customer ? res.customer : null;

    const name = row ? row[2] : (CUSTOMER.name || "-");
    const membership = row ? row[3] : (CUSTOMER.membership || "-");
    const city = row ? row[4] : (CUSTOMER.city || "-");
    const points = row ? (row[11] || 0) : 0;
    const freeWash = row ? (row[13] || 0) : 0;
    const level = row ? (row[12] || "â€”") : "â€”";

    nameEl.innerText = name || "-";
    phoneEl.innerText = PHONE;
    cityEl.innerText = city || "-";
    membershipEl.innerText = membership || "-";
    pointsEl.innerText = points;
    freeWashEl.innerText = freeWash > 0 ? "Ù…ØªÙˆÙØ± (" + freeWash + ")" : "Ù„Ø§ ÙŠÙˆØ¬Ø¯";
    levelTag.innerText = "Ø§Ù„Ù…Ø³ØªÙˆÙ‰: " + level;

    if (membership && membership !== "-") {
        membershipPill.innerText = "Ø¹Ø¶Ùˆ Ù†Ø´Ø·";
    } else {
        membershipPill.innerText = "Ø²Ø§Ø¦Ø±";
        membershipPill.classList.add("red");
    }
}

// ====== Ø¹Ø±Ø¶ Ø³ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ ======
function renderCars(res) {
    const list = document.getElementById("cars-list");
    const empty = document.getElementById("cars-empty");
    const pill = document.getElementById("cars-count-pill");

    list.innerHTML = "";

    if (!res || !res.success || !res.cars || res.cars.length === 0) {
        empty.style.display = "block";
        pill.innerText = "0 Ø³ÙŠØ§Ø±Ø©";
        return;
    }

    empty.style.display = "none";
    pill.innerText = res.cars.length + " Ø³ÙŠØ§Ø±Ø©";

    res.cars.forEach(r => {
        const carName = r[2] || "-";
        const size = r[3] || "-";
        const plateLetters = r[4] || "";
        const plateNumbers = r[5] || "";
        const city = r[6] || "-";

        const div = document.createElement("div");
        div.className = "car-box";
        div.innerHTML = `
            <div class="car-top">
                <span>${carName} â€¢ ${size}</span>
                <span class="plate">${plateLetters} - ${plateNumbers}</span>
            </div>
            <div class="muted">Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©: ${city}</div>
        `;
        list.appendChild(div);
    });
}

// ====== Ø¹Ø±Ø¶ Ø¢Ø®Ø± Ø²ÙŠØ§Ø±Ø© ======
function renderLastVisit(res) {
    const container = document.getElementById("visit-content");
    const empty = document.getElementById("visit-empty");
    const pill = document.getElementById("visit-status-pill");

    container.innerHTML = "";

    if (!res || !res.success || !res.visits || res.visits.length === 0) {
        empty.style.display = "block";
        pill.innerText = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø²ÙŠØ§Ø±Ø§Øª";
        pill.classList.remove("green");
        pill.classList.add("red");
        return;
    }

    empty.style.display = "none";

    // ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® (Ø§Ù„Ø¹Ù…ÙˆØ¯ 8)
    const visits = res.visits.sort((a, b) => new Date(b[8]) - new Date(a[8]));
    const v = visits[0];

    const service = v[1] || "-";
    const price = v[2] || "-";
    const points = v[3] || "-";
    const branch = v[6] || "-";
    const inTime = v[8] || "-";
    const outTime = v[9] || "â€”";

    pill.innerText = "Ø¢Ø®Ø± Ø²ÙŠØ§Ø±Ø©";

    const div = document.createElement("div");
    div.className = "visit-box";
    div.innerHTML = `
        <div class="info-row">
            <span class="label">Ø§Ù„Ø®Ø¯Ù…Ø©</span>
            <span class="value">${service}</span>
        </div>
        <div class="info-row">
            <span class="label">Ø§Ù„Ø³Ø¹Ø±</span>
            <span class="value">${price}</span>
        </div>
        <div class="info-row">
            <span class="label">Ø§Ù„Ù†Ù‚Ø§Ø·</span>
            <span class="value">${points}</span>
        </div>
        <div class="info-row">
            <span class="label">Ø§Ù„ÙØ±Ø¹</span>
            <span class="value">${branch}</span>
        </div>
        <div class="info-row">
            <span class="label">ÙˆÙ‚Øª Ø§Ù„Ø¯Ø®ÙˆÙ„</span>
            <span class="value">${inTime}</span>
        </div>
        <div class="info-row">
            <span class="label">ÙˆÙ‚Øª Ø§Ù„Ø®Ø±ÙˆØ¬</span>
            <span class="value">${outTime}</span>
        </div>
    `;
    container.appendChild(div);
}

// ====== Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª ======
function renderBookings(res) {
    const list = document.getElementById("bookings-list");
    const empty = document.getElementById("bookings-empty");
    const pill = document.getElementById("bookings-count-pill");

    list.innerHTML = "";

    if (!res || !res.success || !res.bookings || res.bookings.length === 0) {
        empty.style.display = "block";
        pill.innerText = "0 Ø­Ø¬Ø²";
        return;
    }

    empty.style.display = "none";
    pill.innerText = res.bookings.length + " Ø­Ø¬Ø²";

    res.bookings.forEach(r => {
        const service = r[2] || "-";
        const date = r[3] || "-";
        const time = r[4] || "-";
        const status = r[5] || "-";

        const div = document.createElement("div");
        div.className = "booking-box";
        div.innerHTML = `
            <div class="info-row">
                <span class="label">Ø§Ù„Ø®Ø¯Ù…Ø©</span>
                <span class="value">${service}</span>
            </div>
            <div class="info-row">
                <span class="label">Ø§Ù„ØªØ§Ø±ÙŠØ®</span>
                <span class="value">${date}</span>
            </div>
            <div class="info-row">
                <span class="label">Ø§Ù„ÙˆÙ‚Øª</span>
                <span class="value">${time}</span>
            </div>
            <div class="info-row">
                <span class="label">Ø§Ù„Ø­Ø§Ù„Ø©</span>
                <span class="value">${status}</span>
            </div>
        `;
        list.appendChild(div);
    });
}

// ====== ØªÙ†Ù‚Ù„ Ø§Ù„Ø£Ø²Ø±Ø§Ø± ======
function goToAddCar() {
    window.location.href = "customer-add-car.html";
}

function goToCars() {
    window.location.href = "customer-cars.html";
}

function goToBooking() {
    window.location.href = "customer-booking.html";
}

function goToBookings() {
    window.location.href = "customer-bookings.html";
}
</script>

</body>
</html>
