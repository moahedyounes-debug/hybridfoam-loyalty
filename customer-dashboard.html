<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- manifest (PWA) -->
    <link rel="manifest" href="manifest.json">

    <!-- Service Worker -->
    <script>
        if ("serviceWorker" in navigator) {
            navigator.serviceWorker.register("service-worker.js");
        }
    </script>

    <style>
        body {
            font-family: "Tajawal", sans-serif;
            background: #f5f5f5;
            margin: 0;
            padding: 0;
        }

        /* Header */
        .header {
            background: white;
            padding: 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 0 10px #0001;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .header .name {
            font-size: 20px;
            font-weight: bold;
        }

        .notif {
            position: relative;
            font-size: 24px;
            cursor: pointer;
        }

        .notif .dot {
            width: 10px;
            height: 10px;
            background: red;
            border-radius: 50%;
            position: absolute;
            top: 0;
            right: 0;
        }

        /* Container */
        .container {
            padding: 20px;
            max-width: 480px;
            margin: auto;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 0 10px #0001;
        }

        .progress-container {
            margin-top: 15px;
        }

        .progress-bar {
            width: 100%;
            height: 14px;
            background: #eee;
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #007bff;
            width: 0%;
            transition: 0.5s;
        }

        /* Buttons */
        .btn {
            display: block;
            width: 100%;
            padding: 14px;
            background: #007bff;
            color: white;
            text-align: center;
            border-radius: 8px;
            margin-top: 12px;
            text-decoration: none;
            font-size: 18px;
        }

        .btn-whatsapp {
            background: #25D366;
        }
    </style>
</head>

<body>

<!-- Header -->
<div class="header">
    <div class="name" id="headerName">Ù…Ø±Ø­Ø¨Ù‹Ø§</div>

    <div class="notif" onclick="openNotifications()">
        ğŸ””
        <div class="dot" id="notifDot" style="display:none;"></div>
    </div>
</div>

<div class="container">

    <!-- Customer Info -->
    <div class="card">
        <h3>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</h3>
        <p><strong>Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„:</strong> <span id="customerPhone"></span></p>
        <p><strong>Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©:</strong> <span id="customerMembership"></span></p>
        <p><strong>Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</strong> <span id="customerPoints"></span></p>
        <p><strong>Ø§Ù„Ù…Ø³ØªÙˆÙ‰:</strong> <span id="customerLevel"></span></p>
        <p><strong>Ø¢Ø®Ø± Ø²ÙŠØ§Ø±Ø©:</strong> <span id="lastVisit"></span></p>

        <!-- Progress -->
        <div class="progress-container">
            <p id="progressText"></p>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>
    </div>

    <!-- Buttons -->
    <a class="btn" id="visitsBtn">Ø²ÙŠØ§Ø±Ø§ØªÙŠ</a>
    <a class="btn" id="bookingsBtn">Ø­Ø¬ÙˆØ²Ø§ØªÙŠ</a>
    <a class="btn" id="carsBtn">Ø³ÙŠØ§Ø±Ø§ØªÙŠ</a>
    <a class="btn" id="bookingBtn">Ø­Ø¬Ø² Ù…ÙˆØ¹Ø¯</a>
    <a class="btn btn-whatsapp" id="whatsappBtn">Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…ØºØ³Ù„Ø©</a>

</div>

<script src="api.js"></script>

<script>
/* ============================
   Ù‚Ø±Ø§Ø¡Ø© Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·
   ============================ */
const urlParams = new URLSearchParams(window.location.search);
const phone = urlParams.get("phone");

if (!phone) {
    alert("Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");
}

/* ============================
   ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„
   ============================ */
window.onload = async function () {
    const res = await apiGet({
        action: "getCustomerDashboard",
        phone
    });

    if (!res.success) {
        alert("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙŠÙ„");
        return;
    }

    const customer = res.customer;
    const lastVisit = res.last_visit;

    // Header
    document.getElementById("headerName").textContent = "Ù…Ø±Ø­Ø¨Ù‹Ø§ØŒ " + customer.name;

    // Ø¥Ø´Ø¹Ø§Ø±Ø§Øª (placeholder)
    if (res.unread_notifications > 0) {
        document.getElementById("notifDot").style.display = "block";
    }

    // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„
    document.getElementById("customerPhone").textContent = customer.phone;
    document.getElementById("customerMembership").textContent = customer.membership;
    document.getElementById("customerPoints").textContent = customer.points;
    document.getElementById("customerLevel").textContent = customer.level;
    document.getElementById("lastVisit").textContent = lastVisit ? lastVisit.check_in : "Ù„Ø§ ÙŠÙˆØ¬Ø¯";

    /* ============================
       Ø´Ø§Ø±Øª Ø§Ù„ØªÙ‚Ø¯Ù… Ù„Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªØ§Ù„ÙŠ
       ============================ */
    const current = customer.points;
    const nextLevel = customer.next_level_points; // Ù…Ù† Ø§Ù„Ù€ API
    const percent = Math.min((current / nextLevel) * 100, 100);

    document.getElementById("progressFill").style.width = percent + "%";
    document.getElementById("progressText").textContent =
        `Ø§Ù„Ù†Ù‚Ø§Ø·: ${current} / ${nextLevel} â€” Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${nextLevel - current}`;
    
    /* ============================
       Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙ†Ù‚Ù„
       ============================ */
    document.getElementById("visitsBtn").href = "customer-visits.html?phone=" + phone;
    document.getElementById("bookingsBtn").href = "customer-bookings.html?phone=" + phone;
    document.getElementById("carsBtn").href = "customer-cars.html?phone=" + phone;
    document.getElementById("bookingBtn").href = "customer-booking.html?phone=" + phone;

    /* ============================
       Ø²Ø± Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨
       ============================ */
    const msg = `Ù…Ø±Ø­Ø¨Ù‹Ø§ØŒ Ø£Ù†Ø§ ${customer.name} - Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©: ${customer.membership}`;
    const encoded = encodeURIComponent(msg);

    document.getElementById("whatsappBtn").href =
        "https://wa.me/966582007063?text=" + encoded;
};

/* ============================
   ÙØªØ­ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
   ============================ */
function openNotifications() {
    alert("Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© ØµÙØ­Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù„Ø§Ø­Ù‚Ù‹Ø§");
}
</script>

</body>
</html>
