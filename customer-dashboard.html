<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>لوحة العميل</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        body{
            font-family:"Tajawal",sans-serif;
            background:#f5f5f5;
            padding:20px;
        }
        .section{
            background:white;
            padding:20px;
            border-radius:15px;
            box-shadow:0 4px 12px #0002;
            margin-bottom:20px;
        }
        .title{
            font-size:20px;
            font-weight:700;
            margin-bottom:10px;
        }
        .sub{
            color:#777;
            margin-bottom:15px;
        }
        .row{
            display:flex;
            justify-content:space-between;
            margin-bottom:6px;
        }
        .label{color:#777;}
        .value{font-weight:600;}

        .btn{
            width:100%;
            padding:14px;
            margin-top:10px;
            border:none;
            border-radius:8px;
            background:#007bff;
            color:white;
            font-size:17px;
            cursor:pointer;
        }

        .progress-box{
            background:#eee;
            border-radius:10px;
            height:12px;
            margin-top:10px;
        }
        .progress-fill{
            height:100%;
            background:#28a745;
            border-radius:10px;
            width:0%;
        }
    </style>
</head>

<body>

<h2 style="text-align:center;margin-bottom:20px;">لوحة العميل</h2>

<!-- بيانات العميل -->
<div class="section">
    <div class="title">بيانات العميل</div>
    <div class="sub">معلومات حسابك الأساسية</div>

    <div class="row"><span class="label">الاسم:</span><span class="value" id="name">—</span></div>
    <div class="row"><span class="label">رقم الجوال:</span><span class="value" id="phone">—</span></div>
    <div class="row"><span class="label">رقم العضوية:</span><span class="value" id="membership">—</span></div>
    <div class="row"><span class="label">النقاط المتاحة:</span><span class="value" id="points">0</span></div>

    <div class="row"><span class="label">المستوى:</span><span class="value" id="level">—</span></div>

    <div class="progress-box">
        <div class="progress-fill" id="progress"></div>
    </div>

    <div class="row"><span class="label">كم باقي للمستوى التالي:</span><span class="value" id="nextLevel">—</span></div>

    <button class="btn" onclick="window.location.href='customer-membership-card.html'">
        عرض بطاقة العضوية
    </button>
</div>

<!-- سيارات العميل -->
<div class="section">
    <div class="title">سياراتك المسجلة</div>
    <div class="sub">السيارات المرتبطة برقم جوالك</div>

    <div id="cars">جاري التحميل...</div>

    <button class="btn" onclick="window.location.href='customer-cars.html'">عرض كل السيارات</button>
    <button class="btn" onclick="window.location.href='customer-add-car.html'">إضافة سيارة</button>

    <button class="btn" onclick="window.location.href='customer-visits-full.html'">
        سجل السيارات (آخر الزيارات)
    </button>
</div>

<!-- آخر زيارة -->
<div class="section">
    <div class="title">آخر زيارة</div>
    <div class="sub">تفاصيل آخر خدمة تمت على عضويتك</div>

    <div id="lastVisit">لا توجد زيارات مسجلة حتى الآن.</div>
</div>

<!-- الحجوزات -->
<div class="section">
    <div class="title">الحجوزات</div>
    <div class="sub">مواعيدك الحالية والسابقة</div>

    <div id="lastBooking">لا توجد حجوزات مسجلة.</div>

    <button class="btn" onclick="window.location.href='customer-booking.html'">حجز موعد جديد</button>
    <button class="btn" onclick="window.location.href='customer-bookings.html'">عرض كل الحجوزات</button>
</div>

<script src="api.js"></script>

<script>
let CUSTOMER = JSON.parse(localStorage.getItem("customer"));
let PHONE = CUSTOMER.phone;

// تحميل بيانات العميل
window.onload = async function(){
    loadCustomerInfo();
    await loadCars();
    await loadLastVisit();
    await loadLastBooking();
    loadLevelSystem();
};

// بيانات العميل
function loadCustomerInfo(){
    document.getElementById("name").innerText = CUSTOMER.name || "—";
    document.getElementById("phone").innerText = PHONE;
    document.getElementById("membership").innerText = CUSTOMER.membership;
    document.getElementById("points").innerText = CUSTOMER.points || 0;
}

// تحميل السيارات
async function loadCars(){
    const box = document.getElementById("cars");

    const res = await apiGet({ action:"getCarsByPhone", phone:PHONE });

    if(!res.success || res.cars.length === 0){
        box.innerHTML = "لا توجد سيارات مسجلة حتى الآن.";
        return;
    }

    box.innerHTML = res.cars.map(c =>
        `<div>${c[2]} (${c[3]}) • ${c[5]} ${c[4]}</div>`
    ).join("");
}

// آخر زيارة
async function loadLastVisit(){
    const box = document.getElementById("lastVisit");

    const res = await apiGet({ action:"getVisitsByPhone", phone:PHONE });

    if(!res.success || res.visits.length === 0){
        box.innerHTML = "لا توجد زيارات مسجلة حتى الآن.";
        return;
    }

    const v = res.visits[res.visits.length - 1];

    box.innerHTML = `${v[2]} • ${v[3]} ريال • ${v[5]}`;
}

// آخر حجز
async function loadLastBooking(){
    const box = document.getElementById("lastBooking");

    const res = await apiGet({ action:"getBookingsByPhone", phone:PHONE });

    if(!res.success || res.bookings.length === 0){
        box.innerHTML = "لا توجد حجوزات مسجلة.";
        return;
    }

    const b = res.bookings[res.bookings.length - 1];

    box.innerHTML = `${b[2]} • ${b[3]} ${b[4]}`;
}

// نظام المستويات
function loadLevelSystem(){
    let points = Number(CUSTOMER.points || 0);

    let level = "Bronze";
    let next = 100 - points;
    let progress = (points / 100) * 100;

    if(points >= 100 && points < 300){
        level = "Silver";
        next = 300 - points;
        progress = ((points - 100) / 200) * 100;
    }
    else if(points >= 300){
        level = "Gold";
        next = 0;
        progress = 100;
    }

    document.getElementById("level").innerText = level;
    document.getElementById("nextLevel").innerText = next + " نقطة";
    document.getElementById("progress").style.width = progress + "%";
}
</script>

</body>
</html>
