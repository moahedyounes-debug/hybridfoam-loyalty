<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  font-family:"Tajawal",sans-serif;
  background:#F4FAFF;
  color:#0D47A1;
  padding:16px;
}

.logo{
  width:140px;
  display:block;
  margin:0 auto 10px auto;
}

h2{
  text-align:center;
  margin-bottom:6px;
  font-size:24px;
  font-weight:700;
  color:#0D47A1;
}

.subtitle{
  text-align:center;
  color:#4FC3F7;
  font-size:14px;
  margin-bottom:18px;
}

.section{
  background:#FFFFFF;
  border-radius:18px;
  padding:18px;
  margin-bottom:16px;
  box-shadow:0 4px 12px rgba(0,0,0,0.08);
  border:1px solid #E3F2FD;
}

.title{
  font-size:18px;
  font-weight:700;
  margin-bottom:6px;
  display:flex;
  align-items:center;
  gap:6px;
  color:#0D47A1;
}

.sub{
  font-size:13px;
  color:#4FC3F7;
  margin-bottom:12px;
}

.row{
  display:flex;
  justify-content:space-between;
  margin-bottom:6px;
  font-size:15px;
}

.label{color:#4FC3F7;}
.value{color:#0D47A1;font-weight:600;}

.btn{
  width:100%;
  padding:12px;
  border:none;
  border-radius:999px;
  background:#0D47A1;
  color:white;
  font-size:15px;
  cursor:pointer;
  margin-top:10px;
}

.btn-outline{
  background:transparent;
  border:2px solid #0D47A1;
  color:#0D47A1;
}

.car-card{
  background:#F0F7FF;
  padding:12px;
  border-radius:14px;
  margin-bottom:10px;
  display:flex;
  align-items:center;
  gap:12px;
  border:1px solid #DCEBFF;
}

.car-img{
  width:55px;
  height:55px;
  border-radius:10px;
  background:#0D47A1;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:26px;
  color:white;
}

.car-info div{
  font-size:14px;
  margin-bottom:2px;
  color:#0D47A1;
}

.empty{
  font-size:14px;
  color:#4FC3F7;
}

.logout{
  text-align:center;
  margin-top:10px;
  font-size:14px;
  color:#D32F2F;
  cursor:pointer;
}

.progress-box{
  background:#E3F2FD;
  border-radius:999px;
  height:10px;
  margin-top:8px;
  overflow:hidden;
}

.progress-fill{
  height:100%;
  background:#4FC3F7;
  width:0%;
  transition:.4s;
}

.next-level{
  font-size:13px;
  color:#FF8F00;
  margin-top:6px;
  text-align:left;
}

.whatsapp-btn{
  width:100%;
  padding:12px;
  border:none;
  border-radius:999px;
  background:#25D366;
  color:white;
  font-size:16px;
  cursor:pointer;
  margin-top:20px;
}
</style>
</head>

<body>

<img src="logo.png" class="logo">

<h2>Ù„ÙˆØ­Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„</h2>
<div class="subtitle">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø±ØºÙˆØ© Ø§Ù„Ù‡Ø¬ÙŠÙ† â€” ÙƒÙ„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ ÙÙŠ Ù…ÙƒØ§Ù† ÙˆØ§Ø­Ø¯</div>

<!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ -->
<div class="section">
  <div class="title">ğŸ‘¤ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</div>
  <div class="sub">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø­Ø³Ø§Ø¨Ùƒ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</div>

  <div class="row"><span class="label">Ø§Ù„Ø§Ø³Ù…</span><span class="value" id="name">â€”</span></div>
  <div class="row"><span class="label">Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</span><span class="value" id="phone">â€”</span></div>
  <div class="row"><span class="label">Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©</span><span class="value" id="membership">â€”</span></div>
  <div class="row"><span class="label">Ø§Ù„ÙØ±Ø¹</span><span class="value" id="city">â€”</span></div>
  <div class="row"><span class="label">Ø§Ù„Ù†Ù‚Ø§Ø·</span><span class="value" id="points">0</span></div>
  <div class="row"><span class="label">ØºØ³ÙŠÙ„ Ù…Ø¬Ø§Ù†ÙŠ</span><span class="value" id="freeWash">â€”</span></div>
  <div class="row"><span class="label">Ø§Ù„Ù…Ø³ØªÙˆÙ‰</span><span class="value" id="level">â€”</span></div>

  <div class="progress-box">
    <div class="progress-fill" id="progress"></div>
  </div>

  <div class="next-level" id="nextLevelText"></div>

  <button class="btn btn-outline" onclick="window.location.href='customer-membership.html'">
    Ø¹Ø±Ø¶ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©
  </button>
</div>

<!-- Ø³ÙŠØ§Ø±Ø§Øª -->
<div class="section">
  <div class="title">ğŸš— Ø³ÙŠØ§Ø±Ø§ØªÙƒ</div>
  <div class="sub">Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø­Ø³Ø§Ø¨Ùƒ</div>

  <div id="carsBox" class="empty">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>

  <button class="btn btn-outline" onclick="window.location.href='customer-cars.html'">Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</button>
  <button class="btn" onclick="window.location.href='customer-add-car.html'">Ø¥Ø¶Ø§ÙØ© Ø³ÙŠØ§Ø±Ø©</button>
</div>

<!-- Ø¢Ø®Ø± Ø²ÙŠØ§Ø±Ø© -->
<div class="section">
  <div class="title">ğŸ§½ Ø¢Ø®Ø± Ø²ÙŠØ§Ø±Ø©</div>
  <div class="sub">ØªÙØ§ØµÙŠÙ„ Ø¢Ø®Ø± Ø®Ø¯Ù…Ø© ØªÙ…Øª Ø¹Ù„Ù‰ Ø¹Ø¶ÙˆÙŠØªÙƒ</div>

  <div id="lastVisitBox" class="empty">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
</div>

<!-- Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª -->
<div class="section">
  <div class="title">ğŸ“… Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</div>
  <div class="sub">Ù…ÙˆØ§Ø¹ÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙˆØ§Ù„Ø³Ø§Ø¨Ù‚Ø©</div>

  <div id="bookingsBox" class="empty">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>

  <button class="btn btn-outline" onclick="window.location.href='customer-bookings.html'">Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</button>
  <button class="btn" onclick="window.location.href='customer-booking.html'">Ø­Ø¬Ø² Ù…ÙˆØ¹Ø¯ Ø¬Ø¯ÙŠØ¯</button>
</div>

<button class="whatsapp-btn" onclick="contactWhatsApp()">Ø§Ù„ØªÙˆØ§ØµÙ„ Ø¹Ø¨Ø± Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨</button>

<div class="logout" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</div>

<script src="api.js"></script>

<script>

let CUSTOMER = JSON.parse(localStorage.getItem("customer") || "null");
let PHONE = CUSTOMER ? CUSTOMER.phone : null;

if(!CUSTOMER || !PHONE){
  window.location.href = "customer-home.html";
}

window.onload = async function(){
  await loadCustomerFromAPI();
  loadCustomerInfoFromLocal();

  await Promise.all([
    loadCars(),
    loadLastVisit(),
    loadBookings()
  ]);

  loadLevelSystem();
};

// Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„Ø´ÙŠØª
async function loadCustomerFromAPI(){
  const res = await apiGetCustomerByPhone(PHONE);
  if(!res.success) return;

  const c = res.customer;

  CUSTOMER = {
    name: c[0],
    phone: c[1],
    membership: c[8],
    city: c[4],
    last_visit: c[9],
    visit_count: c[10],
    points: c[11],
    level: c[12],
    free_wash: c[13]
  };

  localStorage.setItem("customer", JSON.stringify(CUSTOMER));
}

function loadCustomerInfoFromLocal(){
  document.getElementById("name").innerText = CUSTOMER.name;
  document.getElementById("phone").innerText = CUSTOMER.phone;
  document.getElementById("membership").innerText = CUSTOMER.membership;
  document.getElementById("city").innerText = CUSTOMER.city;
  document.getElementById("points").innerText = CUSTOMER.points;
  document.getElementById("freeWash").innerText = CUSTOMER.free_wash > 0 ? "Ù…ØªÙˆÙØ±" : "Ù„Ø§ ÙŠÙˆØ¬Ø¯";
  document.getElementById("level").innerText = CUSTOMER.level;
}

async function loadCars(){
  const box = document.getElementById("carsBox");
  const res = await apiGetCarsByPhone(PHONE);

  if(!res.success){
    box.innerHTML = "Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.";
    return;
  }

  const cars = res.cars.map(c => c.data);

  if(cars.length === 0){
    box.innerHTML = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³ÙŠØ§Ø±Ø§Øª Ù…Ø³Ø¬Ù„Ø©.";
    return;
  }

  box.classList.remove("empty");

  box.innerHTML = cars.map(c => `
    <div class="car-card">
      <div class="car-img">ğŸš—</div>
      <div class="car-info">
        <div><b>${c[2]}</b></div>
        <div>Ø§Ù„Ø­Ø¬Ù…: ${c[3]}</div>
        <div>Ø§Ù„Ù„ÙˆØ­Ø©: ${c[5]} ${c[4]}</div>
        <div>Ø¹Ø¶ÙˆÙŠØ© Ø§Ù„Ø³ÙŠØ§Ø±Ø©: <span style="color:#FF8F00">${c[0]}</span></div>
      </div>
    </div>
  `).join("");
}

async function loadLastVisit(){
  const box = document.getElementById("lastVisitBox");
  const res = await apiGetVisitsByMembership(CUSTOMER.membership);

  if(!res.success || !res.visits.length){
    box.innerHTML = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø²ÙŠØ§Ø±Ø§Øª.";
    return;
  }

  const last = res.visits[res.visits.length - 1].data;

  box.classList.remove("empty");

  box.innerHTML = `
    <div style="font-size:14px;">
      Ø§Ù„Ø®Ø¯Ù…Ø©: ${last[1]}<br>
      Ø§Ù„Ø³Ø¹Ø±: ${last[2]} Ø±ÙŠØ§Ù„<br>
      Ø§Ù„Ù†Ù‚Ø§Ø·: ${last[3]}<br>
      Ø§Ù„ØªØ§Ø±ÙŠØ®: ${last[8]}
    </div>
  `;
}

async function loadBookings(){
  const box = document.getElementById("bookingsBox");
  const res = await apiGetBookingsByPhone(PHONE);

  if(!res.success || !res.bookings.length){
    box.innerHTML = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª.";
    return;
  }

  const bookings = res.bookings.map(b => b.data);
  const last = bookings[bookings.length - 1];

  box.classList.remove("empty");

  box.innerHTML = `
    <div style="font-size:14px;margin-bottom:6px;">${bookings.length} Ø­Ø¬Ø²</div>
    <div style="font-size:14px;">
      Ø¢Ø®Ø± Ø­Ø¬Ø²: ${last[2]} â€¢ ${last[3]} ${last[4]}
    </div>
  `;
}

function loadLevelSystem(){
  const level = CUSTOMER.level;
  const points = Number(CUSTOMER.points || 0);

  let next = 0;
  let progress = 0;

  if(level === "Bronze"){
    next = 100 - points;
    progress = (points / 100) * 100;
  }

  if(level === "Silver"){
    next = 200 - points;
    progress = ((points - 100) / 100) * 100;
  }

  if(level === "Gold"){
    next = 400 - points;
    progress = ((points - 200) / 200) * 100;
  }

  if(level === "Platinum"){
    next = 900 - points;
    progress = ((points - 400) / 500) * 100;
  }

  if(level === "VIP"){
    next = 0;
    progress = 100;
  }

  document.getElementById("progress").style.width = progress + "%";

  document.getElementById("nextLevelText").innerText =
    next > 0 ? `Ù…ØªØ¨Ù‚ÙŠ ${next} Ù†Ù‚Ø·Ø© Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªØ§Ù„ÙŠ` : "Ø£Ù†Øª ÙÙŠ Ø£Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ ğŸ‰";
}

function logout(){
  localStorage.removeItem("customer");
  window.location.href = "customer-home.html";
}

// ÙˆØ§ØªØ³Ø§Ø¨
async function contactWhatsApp() {
  const phone = CUSTOMER.phone;
  let msg = "Ù…Ø±Ø­Ø¨Ø§Ù‹ Ù…ØºØ³Ù„Ø© Ø±ØºÙˆØ© Ø§Ù„Ù‡Ø¬ÙŠÙ†%0A";

  const res = await apiGetCustomerByPhone(phone);

  if (!res.success) {
    msg += "Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„: " + phone;
    window.location.href = "https://wa.me/966582007063?text=" + msg;
    return;
  }

  const c = res.customer;

  const carsRes = await apiGet({ action: "getAll", sheet: "Cars" });

  let carCount = 0;

  if (carsRes.success) {
    carCount = carsRes.rows.filter(r => r[1] === phone).length;
  }

  msg +=
    "Ø§Ù„Ø§Ø³Ù…: " + c[0] + "%0A" +
    "Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©: " + c[8] + "%0A" +
    "Ø¹Ø¯Ø¯ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª: " + carCount;

  window.location.href = "https://wa.me/966582007063?text=" + msg;
}

</script>

</body>
</html>
