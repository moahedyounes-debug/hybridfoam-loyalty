<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        body{
            font-family:"Tajawal",sans-serif;
            background:#050608;
            color:#f5f5f5;
            padding:16px;
        }
        h2{
            text-align:center;
            margin-bottom:12px;
        }
        .subtitle{
            text-align:center;
            color:#aaa;
            font-size:13px;
            margin-bottom:18px;
        }
        .section{
            background:#111318;
            border-radius:16px;
            padding:16px;
            margin-bottom:14px;
            box-shadow:0 8px 20px rgba(0,0,0,0.6);
        }
        .badge{
            display:inline-block;
            padding:4px 10px;
            border-radius:999px;
            font-size:11px;
            background:#16a34a22;
            color:#4ade80;
            margin-bottom:8px;
        }
        .title{
            font-size:16px;
            font-weight:700;
            margin-bottom:4px;
        }
        .sub{
            font-size:12px;
            color:#9ca3af;
            margin-bottom:10px;
        }
        .row{
            display:flex;
            justify-content:space-between;
            margin-bottom:4px;
            font-size:13px;
        }
        .label{color:#9ca3af;}
        .value{color:#e5e7eb;font-weight:500;}

        .btn{
            width:100%;
            padding:10px 12px;
            margin-top:8px;
            border:none;
            border-radius:999px;
            background:linear-gradient(135deg,#22c55e,#16a34a);
            color:white;
            font-size:14px;
            cursor:pointer;
        }
        .btn-outline{
            background:transparent;
            border:1px solid #374151;
        }

        .progress-box{
            background:#111827;
            border-radius:999px;
            height:8px;
            margin-top:8px;
            overflow:hidden;
        }
        .progress-fill{
            height:100%;
            background:linear-gradient(90deg,#22c55e,#a3e635);
            width:0%;
        }

        .empty{
            font-size:13px;
            color:#6b7280;
        }

        /* Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª */
        .car-card{
            background:#1a1c22;
            padding:12px;
            border-radius:12px;
            margin-bottom:10px;
            box-shadow:0 4px 12px rgba(0,0,0,0.4);
        }
        .car-title{
            font-size:15px;
            font-weight:600;
            margin-bottom:4px;
        }
        .car-sub{
            font-size:12px;
            color:#9ca3af;
        }
    </style>
</head>

<body>

<h2>Ù„ÙˆØ­Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„</h2>
<div class="subtitle">Ø¹Ø±Ø¶ Ù…Ù„Ø®Øµ Ø¹Ø¶ÙˆÙŠØªÙƒ ÙˆØ²ÙŠØ§Ø±Ø§ØªÙƒ ÙÙŠ Hybrid Foam</div>

<!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ -->
<div class="section">
    <div class="badge">Ø¹Ø¶Ùˆ Ù†Ø´Ø·</div>
    <div class="title">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</div>
    <div class="sub">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø­Ø³Ø§Ø¨Ùƒ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</div>

    <div class="row"><span class="label">Ø§Ù„Ø§Ø³Ù…</span><span class="value" id="name">â€”</span></div>
    <div class="row"><span class="label">Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</span><span class="value" id="phone">â€”</span></div>
    <div class="row"><span class="label">Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©</span><span class="value" id="membership">â€”</span></div>
    <div class="row"><span class="label">Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</span><span class="value" id="city">â€”</span></div>
    <div class="row"><span class="label">Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…ØªØ§Ø­Ø©</span><span class="value" id="points">0</span></div>
    <div class="row"><span class="label">ØºØ³ÙŠÙ„ Ù…Ø¬Ø§Ù†ÙŠ</span><span class="value" id="freeWash">Ù„Ø§ ÙŠÙˆØ¬Ø¯</span></div>
    <div class="row"><span class="label">Ø§Ù„Ù…Ø³ØªÙˆÙ‰</span><span class="value" id="level">â€”</span></div>
    <div class="row"><span class="label">Ø§Ù„ØªÙ‚Ø¯Ù… Ù„Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªØ§Ù„ÙŠ</span><span class="value" id="nextLevel">â€”</span></div>

    <div class="progress-box">
        <div class="progress-fill" id="progress"></div>
    </div>

    <button class="btn btn-outline" onclick="window.location.href='customer-membership.html'">
        Ø¹Ø±Ø¶ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©
    </button>
</div>

<!-- Ø³ÙŠØ§Ø±Ø§ØªÙƒ -->
<div class="section">
    <div class="title">Ø³ÙŠØ§Ø±Ø§ØªÙƒ Ø§Ù„Ù…Ø³Ø¬Ù„Ø©</div>
    <div class="sub">Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„Ùƒ.</div>

    <div id="carsBox" class="empty">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>

    <button class="btn btn-outline" onclick="window.location.href='customer-cars.html'">
        Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª
    </button>
    <button class="btn" onclick="window.location.href='customer-add-car.html'">
        Ø¥Ø¶Ø§ÙØ© Ø³ÙŠØ§Ø±Ø©
    </button>
    <button class="btn btn-outline" onclick="window.location.href='customer-visits-full.html'">
        Ø³Ø¬Ù„ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª (ÙƒÙ„ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª)
    </button>
</div>

<!-- Ø¢Ø®Ø± Ø²ÙŠØ§Ø±Ø© -->
<div class="section">
    <div class="title">Ø¢Ø®Ø± Ø²ÙŠØ§Ø±Ø©</div>
    <div class="sub">ØªÙØ§ØµÙŠÙ„ Ø¢Ø®Ø± Ø®Ø¯Ù…Ø© ØªÙ…Øª Ø¹Ù„Ù‰ Ø¹Ø¶ÙˆÙŠØªÙƒ</div>

    <div id="lastVisitBox" class="empty">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
</div>

<!-- Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª -->
<div class="section">
    <div class="title">Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</div>
    <div class="sub">Ù…ÙˆØ§Ø¹ÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙˆØ§Ù„Ø³Ø§Ø¨Ù‚Ø©</div>

    <div id="bookingsBox" class="empty">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>

    <button class="btn btn-outline" onclick="window.location.href='customer-bookings.html'">
        Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª
    </button>
    <button class="btn" onclick="window.location.href='customer-booking.html'">
        Ø­Ø¬Ø² Ù…ÙˆØ¹Ø¯ Ø¬Ø¯ÙŠØ¯
    </button>
</div>

<script src="api.js"></script>

<script>
let CUSTOMER = JSON.parse(localStorage.getItem("customer") || "null");
let PHONE = CUSTOMER ? CUSTOMER.phone : null;

window.onload = async function(){
    if(!CUSTOMER || !PHONE){
        console.log("customer not found in localStorage");
        return;
    }

    loadCustomerInfo();
    const cars = await loadCars();
    await loadLastVisit(cars);
    await loadBookings();
    loadLevelSystem();
};

// Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„
function loadCustomerInfo(){
    document.getElementById("name").innerText = CUSTOMER.name;
    document.getElementById("phone").innerText = CUSTOMER.phone;
    document.getElementById("membership").innerText = CUSTOMER.membership;
    document.getElementById("city").innerText = CUSTOMER.city;
    document.getElementById("points").innerText = CUSTOMER.points;
    document.getElementById("freeWash").innerText = CUSTOMER.freeWash > 0 ? "Ù…ØªÙˆÙØ±" : "Ù„Ø§ ÙŠÙˆØ¬Ø¯";
}

// Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª
async function loadCars(){
    const box = document.getElementById("carsBox");

    const res = await apiGet({
        action:"getAll",
        sheet:"Cars"
    });

    const cars = res.rows.filter(r => r[1] == PHONE);

    if(cars.length === 0){
        box.innerHTML = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³ÙŠØ§Ø±Ø§Øª Ù…Ø³Ø¬Ù„Ø©.";
        return [];
    }

    box.classList.remove("empty");
    box.innerHTML = cars.map(c => `
        <div class="car-card">
            <div class="car-title">${c[2]} â€¢ ${c[3]}</div>
            <div class="car-sub">Ø§Ù„Ù„ÙˆØ­Ø©: ${c[5]} ${c[4]}</div>
            <div class="car-sub">Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©: ${c[0]}</div>
        </div>
    `).join("");

    return cars;
}

// Ù‚Ø±Ø§Ø¡Ø© Ø¢Ø®Ø± Ø²ÙŠØ§Ø±Ø©
async function loadLastVisit(cars){
    const box = document.getElementById("lastVisitBox");

    const memberships = cars.map(c => c[0]);

    const res = await apiGet({
        action:"getAll",
        sheet:"Visits"
    });

    const visits = res.rows.filter(v => memberships.includes(v[0]));

    if(visits.length === 0){
        box.innerHTML = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø²ÙŠØ§Ø±Ø§Øª.";
        return;
    }

    const v = visits[visits.length - 1];

    box.classList.remove("empty");
    box.innerHTML = `
        <div style="font-size:13px;">
            Ø§Ù„Ø®Ø¯Ù…Ø©: ${v[1]}<br>
            Ø§Ù„Ø³Ø¹Ø±: ${v[2]} Ø±ÙŠØ§Ù„<br>
            Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…ÙƒØªØ³Ø¨Ø©: ${v[3]}<br>
            Ø§Ù„ØªØ§Ø±ÙŠØ®: ${v[8]}
        </div>
    `;
}

// Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª
async function loadBookings(){
    const box = document.getElementById("bookingsBox");

    const res = await apiGet({
        action:"getAll",
        sheet:"Bookings"
    });

    const bookings = res.rows.filter(r => r[1] == PHONE);

    if(bookings.length === 0){
        box.innerHTML = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª.";
        return;
    }

    const last = bookings[bookings.length - 1];

    box.classList.remove("empty");
    box.innerHTML = `
        <div style="font-size:13px;margin-bottom:4px;">${bookings.length} Ø­Ø¬Ø²</div>
        <div style="font-size:13px;">
            Ø¢Ø®Ø± Ø­Ø¬Ø²: ${last[2]} â€¢ ${last[3]} ${last[4]}
        </div>
    `;
}

// Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª
function loadLevelSystem(){
    let points = Number(CUSTOMER.points || 0);

    let levelName = "Hybrid Foam Loyalty";
    let next = 100 - points;
    let progress = (points / 100) * 100;

    if(points >= 100 && points < 300){
        levelName = "Hybrid Foam Silver";
        next = 300 - points;
        progress = ((points - 100) / 200) * 100;
    }else if(points >= 300){
        levelName = "Hybrid Foam Gold";
        next = 0;
        progress = 100;
    }

    document.getElementById("level").innerText = levelName;
    document.getElementById("nextLevel").innerText = next > 0 ? (next + " Ù†Ù‚Ø·Ø©") : "Ø£Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ ğŸ‰";
    document.getElementById("progress").style.width = progress + "%";
}
</script>

</body>
</html>
