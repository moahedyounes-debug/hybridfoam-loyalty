<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>لوحة العميل</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        body {
            font-family: "Tajawal", sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 480px;
            margin: auto;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 0 10px #0001;
        }

        h2, h3 {
            margin: 0 0 15px 0;
        }

        .car-box {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .btn {
            display: block;
            width: 100%;
            padding: 14px;
            background: #007bff;
            color: white;
            text-align: center;
            border-radius: 8px;
            margin-top: 15px;
            text-decoration: none;
            font-size: 18px;
        }
    </style>
</head>

<body>

<div class="container">

    <div class="card">
        <h2 id="customerName">...</h2>
        <p><strong>رقم الجوال:</strong> <span id="customerPhone"></span></p>
        <p><strong>العضوية:</strong> <span id="customerMembership"></span></p>
        <p><strong>النقاط:</strong> <span id="customerPoints"></span></p>
        <p><strong>المستوى:</strong> <span id="customerLevel"></span></p>
        <p><strong>آخر زيارة:</strong> <span id="lastVisit"></span></p>
    </div>

    <div class="card">
        <h3>سيارات العميل</h3>
        <div id="carsList"></div>

        <a class="btn" href="customer-add-car.html">إضافة سيارة جديدة</a>
    </div>

    <div class="card">
        <h3>الحجوزات</h3>
        <div id="bookingsList"></div>

        <a class="btn" id="bookingBtn">حجز موعد</a>
    </div>

</div>

<script src="api.js"></script>

<script>
/* ============================
   قراءة رقم الجوال من الرابط
   ============================ */
const urlParams = new URLSearchParams(window.location.search);
const phone = urlParams.get("phone");

if (!phone) {
    alert("رقم الجوال غير موجود");
}

/* ============================
   تحميل بيانات العميل
   ============================ */
window.onload = async function () {
    const res = await apiGet({
        action: "getCustomerDashboard",
        phone
    });

    if (!res.success) {
        alert("لم يتم العثور على العميل");
        return;
    }

    const customer = res.customer;
    const cars = res.cars;
    const lastVisit = res.last_visit;
    const bookings = res.bookings;

    // بيانات العميل
    document.getElementById("customerName").textContent = customer.name;
    document.getElementById("customerPhone").textContent = customer.phone;
    document.getElementById("customerMembership").textContent = customer.membership;
    document.getElementById("customerPoints").textContent = customer.points;
    document.getElementById("customerLevel").textContent = customer.level;
    document.getElementById("lastVisit").textContent = lastVisit ? lastVisit.check_in : "لا يوجد";

    // سيارات العميل
    const carsList = document.getElementById("carsList");
    carsList.innerHTML = "";

    cars.forEach(car => {
        const box = document.createElement("div");
        box.className = "car-box";
        box.innerHTML = `
            <strong>${car.car}</strong><br>
            الحجم: ${car.size}<br>
            اللوحة: ${car.plate_letters} - ${car.plate_numbers}<br>
            المدينة: ${car.city}<br>
            العضوية: ${car.membership}
        `;
        carsList.appendChild(box);
    });

    // الحجوزات
    const bookingsList = document.getElementById("bookingsList");
    bookingsList.innerHTML = "";

    bookings.forEach(b => {
        const div = document.createElement("div");
        div.className = "car-box";
        div.innerHTML = `
            <strong>${b.service}</strong><br>
            التاريخ: ${b.date}<br>
            الوقت: ${b.time}<br>
            الحالة: ${b.status}
        `;
        bookingsList.appendChild(div);
    });

    // زر الحجز
    document.getElementById("bookingBtn").href = "customer-booking.html?phone=" + phone;
};
</script>

</body>
</html>
