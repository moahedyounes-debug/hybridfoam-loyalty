<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>لوحة العميل</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        body {
            font-family: "Tajawal", sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 500px;
            margin: auto;
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 0 10px #0001;
        }

        h2 {
            text-align: center;
            margin-bottom: 25px;
        }

        .section {
            margin-top: 25px;
            padding: 15px;
            background: #fafafa;
            border-radius: 10px;
            border: 1px solid #eee;
        }

        .item {
            margin-bottom: 10px;
        }

        .label {
            font-weight: bold;
        }

        .car-box, .visit-box, .booking-box {
            padding: 10px;
            background: #fff;
            border-radius: 8px;
            border: 1px solid #ddd;
            margin-top: 10px;
        }
    </style>
</head>

<body>

<div class="container">
    <h2>لوحة العميل</h2>

    <div id="customer-info" class="section"></div>
    <div id="cars" class="section"></div>
    <div id="last-visit" class="section"></div>
    <div id="bookings" class="section"></div>
</div>

<script src="api.js"></script>

<script>
let PHONE = "";

/* عند تحميل الصفحة */
window.onload = async function () {
    const url = new URL(window.location.href);
    PHONE = url.searchParams.get("phone");

    if (!PHONE) {
        document.body.innerHTML = "<h2>رقم الجوال غير موجود</h2>";
        return;
    }

    await loadDashboard();
};

/* تحميل بيانات لوحة العميل */
async function loadDashboard() {
    const customers = await apiGet({ action: "getAll", sheet: "Customers" });
    const cars = await apiGet({ action: "getAll", sheet: "Cars" });
    const visits = await apiGet({ action: "getAll", sheet: "Visits" });
    const bookings = await apiGet({ action: "getAll", sheet: "Bookings" });

    if (!customers.success || !cars.success || !visits.success || !bookings.success) {
        alert("تعذر تحميل البيانات");
        return;
    }

    renderCustomer(customers.rows);
    renderCars(cars.rows);
    renderLastVisit(visits.rows);
    renderBookings(bookings.rows);
}

/* عرض بيانات العميل */
function renderCustomer(rows) {
    const div = document.getElementById("customer-info");

    const row = rows.find(r => String(r[1]).replace(/["'=]/g, "") === PHONE);

    if (!row) {
        div.innerHTML = "<h3>العميل غير موجود</h3>";
        return;
    }

    const name = row[0];
    const membership = row[8];
    const points = row[11];
    const freeWash = row[13];

    div.innerHTML = `
        <h3>بيانات العميل</h3>
        <div class="item"><span class="label">الاسم:</span> ${name}</div>
        <div class="item"><span class="label">رقم الجوال:</span> ${PHONE}</div>
        <div class="item"><span class="label">العضوية:</span> ${membership}</div>
        <div class="item"><span class="label">النقاط:</span> ${points}</div>
        <div class="item"><span class="label">غسيل مجاني:</span> ${freeWash > 0 ? "متوفر" : "لا يوجد"}</div>
    `;
}

/* عرض سيارات العميل */
function renderCars(rows) {
    const div = document.getElementById("cars");
    div.innerHTML = "<h3>سيارات العميل</h3>";

    rows.forEach(r => {
        const storedPhone = String(r[1]).replace(/["'=]/g, "");
        if (storedPhone === PHONE) {
            div.innerHTML += `
                <div class="car-box">
                    <div><span class="label">السيارة:</span> ${r[2]}</div>
                    <div><span class="label">الحجم:</span> ${r[3]}</div>
                    <div><span class="label">اللوحة:</span> ${r[5]} - ${r[4]}</div>
                    <div><span class="label">المدينة:</span> ${r[6]}</div>
                </div>
            `;
        }
    });
}

/* عرض آخر زيارة */
function renderLastVisit(rows) {
    const div = document.getElementById("last-visit");
    div.innerHTML = "<h3>آخر زيارة</h3>";

    // نبحث عن آخر زيارة حسب التاريخ
    const visits = rows
        .filter(r => String(r[0]) === getMembership())
        .sort((a, b) => new Date(b[8]) - new Date(a[8]));

    if (visits.length === 0) {
        div.innerHTML += "<div>لا توجد زيارات</div>";
        return;
    }

    const v = visits[0];

    div.innerHTML += `
        <div class="visit-box">
            <div><span class="label">الخدمة:</span> ${v[1]}</div>
            <div><span class="label">السعر:</span> ${v[2]}</div>
            <div><span class="label">النقاط:</span> ${v[3]}</div>
            <div><span class="label">الفرع:</span> ${v[6]}</div>
            <div><span class="label">الدخول:</span> ${v[8]}</div>
            <div><span class="label">الخروج:</span> ${v[9] || "—"}</div>
        </div>
    `;
}

/* جلب عضوية العميل */
function getMembership() {
    const customers = document.getElementById("customer-info").innerHTML;
    const match = customers.match(/العضوية:<\/span>\s*(\d+)/);
    return match ? match[1] : "";
}

/* عرض حجوزات العميل */
function renderBookings(rows) {
    const div = document.getElementById("bookings");
    div.innerHTML = "<h3>الحجوزات</h3>";

    rows.forEach(r => {
        const storedPhone = String(r[0]).replace(/["'=]/g, "");
        if (storedPhone === PHONE) {
            div.innerHTML += `
                <div class="booking-box">
                    <div><span class="label">الخدمة:</span> ${r[2]}</div>
                    <div><span class="label">التاريخ:</span> ${r[3]}</div>
                    <div><span class="label">الوقت:</span> ${r[4]}</div>
                    <div><span class="label">الحالة:</span> ${r[5]}</div>
                </div>
            `;
        }
    });
}
</script>

</body>
</html>
