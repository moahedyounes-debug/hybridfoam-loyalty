<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body{
      font-family:"Tajawal",sans-serif;
      background:#050608;
      color:#f5f5f5;
      padding:16px;
      animation:fadeIn .4s ease;
    }

    @keyframes fadeIn{
      from{opacity:0;transform:translateY(10px);}
      to{opacity:1;transform:translateY(0);}
    }

    h2{
      text-align:center;
      margin-bottom:6px;
      font-size:22px;
      font-weight:700;
    }

    .subtitle{
      text-align:center;
      color:#aaa;
      font-size:13px;
      margin-bottom:18px;
    }

    .section{
      background:#111318;
      border-radius:18px;
      padding:18px;
      margin-bottom:16px;
      box-shadow:0 8px 20px rgba(0,0,0,0.5);
      animation:fadeIn .5s ease;
    }

    .title{
      font-size:17px;
      font-weight:700;
      margin-bottom:6px;
      display:flex;
      align-items:center;
      gap:6px;
    }

    .title span{
      font-size:18px;
    }

    .sub{
      font-size:12px;
      color:#9ca3af;
      margin-bottom:12px;
    }

    .row{
      display:flex;
      justify-content:space-between;
      margin-bottom:6px;
      font-size:14px;
    }

    .label{color:#9ca3af;}
    .value{color:#e5e7eb;font-weight:500;}

    .btn{
      width:100%;
      padding:12px;
      margin-top:10px;
      border:none;
      border-radius:999px;
      background:linear-gradient(135deg,#22c55e,#16a34a);
      color:white;
      font-size:15px;
      cursor:pointer;
    }

    .btn-outline{
      background:transparent;
      border:1px solid #374151;
    }

    /* Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª */
    .car-card{
      background:#1a1c22;
      padding:12px;
      border-radius:14px;
      margin-bottom:10px;
      display:flex;
      align-items:center;
      gap:12px;
      box-shadow:0 4px 12px rgba(0,0,0,0.4);
      animation:fadeIn .4s ease;
    }

    .car-img{
      width:55px;
      height:55px;
      border-radius:10px;
      background:#0d0f12;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:26px;
    }

    .car-info{
      flex:1;
    }

    .car-info div{
      font-size:13px;
      margin-bottom:2px;
    }

    .empty{
      font-size:13px;
      color:#6b7280;
    }

    .logout{
      text-align:center;
      margin-top:10px;
      font-size:13px;
      color:#f97373;
      cursor:pointer;
    }

    /* Progress */
    .progress-box{
      background:#1f2937;
      border-radius:999px;
      height:8px;
      margin-top:8px;
      overflow:hidden;
    }

    .progress-fill{
      height:100%;
      background:linear-gradient(90deg,#22c55e,#a3e635);
      width:0%;
      transition:.4s;
    }
  </style>
</head>

<body>

<h2>Ù„ÙˆØ­Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„</h2>
<div class="subtitle">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Hybrid Foam â€” ÙƒÙ„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ ÙÙŠ Ù…ÙƒØ§Ù† ÙˆØ§Ø­Ø¯</div>

<!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ -->
<div class="section">
  <div class="title"><span>ğŸ‘¤</span> Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</div>
  <div class="sub">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø­Ø³Ø§Ø¨Ùƒ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</div>

  <div class="row"><span class="label">Ø§Ù„Ø§Ø³Ù…</span><span class="value" id="name">â€”</span></div>
  <div class="row"><span class="label">Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</span><span class="value" id="phone">â€”</span></div>
  <div class="row"><span class="label">Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©</span><span class="value" id="membership">â€”</span></div>
  <div class="row"><span class="label">Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</span><span class="value" id="city">â€”</span></div>
  <div class="row"><span class="label">Ø§Ù„Ù†Ù‚Ø§Ø·</span><span class="value" id="points">0</span></div>
  <div class="row"><span class="label">ØºØ³ÙŠÙ„ Ù…Ø¬Ø§Ù†ÙŠ</span><span class="value" id="freeWash">â€”</span></div>
  <div class="row"><span class="label">Ø§Ù„Ù…Ø³ØªÙˆÙ‰</span><span class="value" id="level">â€”</span></div>
  <div class="row"><span class="label">Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªØ§Ù„ÙŠ</span><span class="value" id="nextLevel">â€”</span></div>

  <div class="progress-box">
    <div class="progress-fill" id="progress"></div>
  </div>

  <button class="btn btn-outline" onclick="window.location.href='customer-membership.html'">
    Ø¹Ø±Ø¶ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©
  </button>
</div>

<!-- Ø³ÙŠØ§Ø±Ø§Øª -->
<div class="section">
  <div class="title"><span>ğŸš—</span> Ø³ÙŠØ§Ø±Ø§ØªÙƒ</div>
  <div class="sub">Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø­Ø³Ø§Ø¨Ùƒ</div>

  <div id="carsBox" class="empty">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>

  <button class="btn btn-outline" onclick="window.location.href='customer-cars.html'">Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</button>
  <button class="btn" onclick="window.location.href='customer-add-car.html'">Ø¥Ø¶Ø§ÙØ© Ø³ÙŠØ§Ø±Ø©</button>
</div>

<!-- Ø¢Ø®Ø± Ø²ÙŠØ§Ø±Ø© -->
<div class="section">
  <div class="title"><span>ğŸ§½</span> Ø¢Ø®Ø± Ø²ÙŠØ§Ø±Ø©</div>
  <div class="sub">ØªÙØ§ØµÙŠÙ„ Ø¢Ø®Ø± Ø®Ø¯Ù…Ø© ØªÙ…Øª Ø¹Ù„Ù‰ Ø¹Ø¶ÙˆÙŠØªÙƒ</div>

  <div id="lastVisitBox" class="empty">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
</div>

<!-- Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª -->
<div class="section">
  <div class="title"><span>ğŸ“…</span> Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</div>
  <div class="sub">Ù…ÙˆØ§Ø¹ÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙˆØ§Ù„Ø³Ø§Ø¨Ù‚Ø©</div>

  <div id="bookingsBox" class="empty">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>

  <button class="btn btn-outline" onclick="window.location.href='customer-bookings.html'">Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</button>
  <button class="btn" onclick="window.location.href='customer-booking.html'">Ø­Ø¬Ø² Ù…ÙˆØ¹Ø¯ Ø¬Ø¯ÙŠØ¯</button>
</div>

<div class="logout" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</div>

<script src="api.js"></script>
<script>

let CUSTOMER = JSON.parse(localStorage.getItem("customer") || "null");
let PHONE = CUSTOMER ? CUSTOMER.phone : null;

if(!CUSTOMER || !PHONE){
  window.location.href = "customer-login.html";
}

window.onload = async function(){
  loadCustomerInfoFromLocal();

  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø§Ù„ØªÙˆØ§Ø²ÙŠ (Ø£Ø³Ø±Ø¹)
  const [cars, visits, bookings] = await Promise.all([
    loadCars(),
    loadLastVisit(),
    loadBookings()
  ]);

  loadLevelSystem();
};

function loadCustomerInfoFromLocal(){
  document.getElementById("name").innerText = CUSTOMER.name;
  document.getElementById("phone").innerText = CUSTOMER.phone;
  document.getElementById("membership").innerText = CUSTOMER.membership;
  document.getElementById("city").innerText = CUSTOMER.city;
  document.getElementById("points").innerText = CUSTOMER.points;
  document.getElementById("freeWash").innerText = CUSTOMER.free_wash > 0 ? "Ù…ØªÙˆÙØ±" : "Ù„Ø§ ÙŠÙˆØ¬Ø¯";
  document.getElementById("level").innerText = CUSTOMER.level;
}

async function loadCars(){
  const box = document.getElementById("carsBox");

  const res = await apiGetCarsByPhone(PHONE);
  if(!res.success){
    box.innerHTML = "Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.";
    return;
  }

  const cars = res.cars.map(c => c.data);

  if(cars.length === 0){
    box.innerHTML = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³ÙŠØ§Ø±Ø§Øª Ù…Ø³Ø¬Ù„Ø©.";
    return;
  }

  box.classList.remove("empty");

  box.innerHTML = cars.map(c => `
    <div class="car-card">
      <div class="car-img">ğŸš—</div>
      <div class="car-info">
        <div><b>${c[2]}</b></div>
        <div>Ø§Ù„Ø­Ø¬Ù…: ${c[3]}</div>
        <div>Ø§Ù„Ù„ÙˆØ­Ø©: ${c[5]} ${c[4]}</div>
      </div>
    </div>
  `).join("");
}

async function loadLastVisit(){
  const box = document.getElementById("lastVisitBox");

  const membership = CUSTOMER.membership;
  const res = await apiGetVisitsByMembership(membership);

  if(!res.success || res.visits.length === 0){
    box.innerHTML = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø²ÙŠØ§Ø±Ø§Øª.";
    return;
  }

  const last = res.visits[res.visits.length - 1].data;

  box.classList.remove("empty");
  box.innerHTML = `
    <div style="font-size:14px;">
      Ø§Ù„Ø®Ø¯Ù…Ø©: ${last[1]}<br>
      Ø§Ù„Ø³Ø¹Ø±: ${last[2]} Ø±ÙŠØ§Ù„<br>
      Ø§Ù„Ù†Ù‚Ø§Ø·: ${last[3]}<br>
      Ø§Ù„ØªØ§Ø±ÙŠØ®: ${last[8]}
    </div>
  `;
}

async function loadBookings(){
  const box = document.getElementById("bookingsBox");

  const res = await apiGetBookingsByPhone(PHONE);
  if(!res.success || res.bookings.length === 0){
    box.innerHTML = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª.";
    return;
  }

  const bookings = res.bookings.map(b => b.data);
  const last = bookings[bookings.length - 1];

  box.classList.remove("empty");
  box.innerHTML = `
    <div style="font-size:14px;margin-bottom:6px;">${bookings.length} Ø­Ø¬Ø²</div>
    <div style="font-size:14px;">
      Ø¢Ø®Ø± Ø­Ø¬Ø²: ${last[2]} â€¢ ${last[3]} ${last[4]}
    </div>
  `;
}

function loadLevelSystem(){
  let points = Number(CUSTOMER.points || 0);

  let levelName = "Hybrid Foam Loyalty";
  let next = 100 - points;
  let progress = (points / 100) * 100;

  if(points >= 100 && points < 300){
    levelName = "Hybrid Foam Silver";
    next = 300 - points;
    progress = ((points - 100) / 200) * 100;
  }else if(points >= 300){
    levelName = "Hybrid Foam Gold";
    next = 0;
    progress = 100;
  }

  document.getElementById("level").innerText = levelName;
  document.getElementById("nextLevel").innerText = next > 0 ? next + " Ù†Ù‚Ø·Ø©" : "Ø£Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ ğŸ‰";
  document.getElementById("progress").style.width = progress + "%";
}

function logout(){
  localStorage.removeItem("customer");
  window.location.href = "customer-login.html";
}

</script>

</body>
</html>
