<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ù„ÙˆØ­Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„</title>
<script src="api.js"></script>

<style>
body {
    font-family: sans-serif;
    background: #f5f5f5;
    padding: 20px;
}

.card {
    background: white;
    padding: 20px;
    border-radius: 12px;
    margin-bottom: 15px;
    box-shadow: 0 0 10px #ddd;
}

h3 { margin-top: 0; }

.btn {
    display: block;
    padding: 12px;
    background: #007bff;
    color: white;
    text-align: center;
    border-radius: 8px;
    text-decoration: none;
    margin-bottom: 10px;
}

.btn-green {
    background: #28a745;
}

.btn-orange {
    background: #ff9800;
}

.progress {
    background: #eee;
    border-radius: 10px;
    overflow: hidden;
    margin-top: 10px;
}

.progress-bar {
    height: 12px;
    background: #007bff;
}
</style>
</head>

<body>

<h2>Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ</h2>

<div id="membershipCard" class="card"></div>
<div id="lastVisit" class="card"></div>

<h3>Ø§Ù„ØªØ­ÙƒÙ…</h3>
<a class="btn" href="customer-booking-new.html">Ø­Ø¬Ø² Ù…ÙˆØ¹Ø¯</a>
<a class="btn" href="customer-cars.html">Ø³ÙŠØ§Ø±Ø§ØªÙŠ</a>
<a class="btn" href="customer-bookings.html">Ø­Ø¬ÙˆØ²Ø§ØªÙŠ</a>
<a class="btn" href="customer-visits.html">Ø³Ø¬Ù„ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª</a>
<a class="btn btn-green" href="customer-add-car.html">Ø¥Ø¶Ø§ÙØ© Ø³ÙŠØ§Ø±Ø©</a>
<a class="btn btn-orange" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</a>

<script>
const phone = localStorage.getItem("phone");
if (!phone) window.location.href = "customer-login.html";

function logout() {
    localStorage.clear();
    window.location.href = "customer-login.html";
}

function getNextLevelInfo(points) {
    if (points < 200) return { next: "Silver", need: 200 - points };
    if (points < 500) return { next: "Gold", need: 500 - points };
    if (points < 1000) return { next: "Platinum", need: 1000 - points };
    if (points < 2000) return { next: "VIP", need: 2000 - points };
    return { next: "Ø£Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰", need: 0 };
}

async function loadDashboard() {
    const res = await apiGet({ action: "getCustomerDashboard", phone });

    if (!res.success) return;

    const c = res.customer;
    const next = getNextLevelInfo(c.points);
    const progressPercent = Math.min(100, (c.points / (c.points + next.need)) * 100);

    // Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©
    document.getElementById("membershipCard").innerHTML = `
        <h3>Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©</h3>
        <p>Ø§Ù„Ø§Ø³Ù…: ${c.name}</p>
        <p>Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©: ${c.membership}</p>
        <p>Ø§Ù„Ù…Ø³ØªÙˆÙ‰: ${c.level}</p>
        <p>Ø§Ù„Ù†Ù‚Ø§Ø·: ${c.points}</p>
        <p>Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªØ§Ù„ÙŠ: ${next.next}</p>
        <p>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${next.need} Ù†Ù‚Ø·Ø©</p>

        <div class="progress">
            <div class="progress-bar" style="width:${progressPercent}%"></div>
        </div>

        <p>Ø§Ù„ØºØ³Ù„Ø§Øª Ø§Ù„Ù…Ø¬Ø§Ù†ÙŠØ©: ${c.free_wash}</p>
    `;

    // Ø¢Ø®Ø± Ø²ÙŠØ§Ø±Ø©
    if (res.last_visit) {
        const v = res.last_visit;

        let statusText = "";
        if (!v.check_out) statusText = "<span style='color:orange'>ğŸš— Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ØºØ³Ù„Ø©</span>";
        else statusText = "<span style='color:green'>âœ” Ù…ÙƒØªÙ…Ù„Ø©</span>";

        let ratingButton = "";
        if (!v.rating) {
            ratingButton = `<a class="btn btn-orange" href="customer-rate.html">ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø²ÙŠØ§Ø±Ø©</a>`;
        }

        document.getElementById("lastVisit").innerHTML = `
            <h3>Ø¢Ø®Ø± Ø²ÙŠØ§Ø±Ø©</h3>
            <p>Ø§Ù„Ø®Ø¯Ù…Ø©: ${v.service_detail}</p>
            <p>Ø§Ù„Ø³Ø¹Ø±: ${v.price} Ø±ÙŠØ§Ù„</p>
            <p>Ø§Ù„Ø­Ø§Ù„Ø©: ${v.payment_status}</p>
            <p>Ø­Ø§Ù„Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø©: ${statusText}</p>
            <p>ÙˆÙ‚Øª Ø§Ù„Ø¯Ø®ÙˆÙ„: ${v.check_in}</p>
            <p>ÙˆÙ‚Øª Ø§Ù„Ø®Ø±ÙˆØ¬: ${v.check_out || "Ù„Ù… ØªÙƒØªÙ…Ù„ Ø¨Ø¹Ø¯"}</p>
            ${ratingButton}
        `;
    }
}

loadDashboard();
</script>

</body>
</html>
