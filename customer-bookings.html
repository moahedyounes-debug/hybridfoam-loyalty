<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>حجز موعد</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        body {
            font-family: "Tajawal", sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 450px;
            margin: auto;
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 0 10px #0001;
        }

        h2 {
            text-align: center;
            margin-bottom: 25px;
        }

        label {
            font-weight: bold;
            margin-top: 12px;
            display: block;
        }

        select, input {
            width: 100%;
            padding: 12px;
            margin-top: 6px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        button {
            width: 100%;
            padding: 14px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            margin-top: 20px;
            font-size: 18px;
            cursor: pointer;
        }
    </style>
</head>

<body>

<div class="container">
    <h2>حجز موعد</h2>

    <label>اختر السيارة</label>
    <select id="carSelect">
        <option value="">جاري التحميل...</option>
    </select>

    <label>اختر الخدمة</label>
    <select id="serviceSelect">
        <option value="">جاري التحميل...</option>
    </select>

    <label>التاريخ</label>
    <input id="date" type="date">

    <label>الوقت</label>
    <input id="time" type="time">

    <button onclick="submitBooking()">تأكيد الحجز</button>
</div>

<script src="api.js"></script>

<script>
/* ============================
   قراءة رقم الجوال من الرابط
   ============================ */
const urlParams = new URLSearchParams(window.location.search);
const phone = urlParams.get("phone");

if (!phone) {
    alert("رقم الجوال غير موجود");
}

/* ============================
   تحميل سيارات العميل
   ============================ */
async function loadCars() {
    const res = await apiGet({
        action: "getCarsByPhone",
        phone
    });

    const select = document.getElementById("carSelect");
    select.innerHTML = "<option value=''>اختر السيارة</option>";

    if (!res.success) return;

    res.cars.forEach(car => {
        const opt = document.createElement("option");
        opt.value = car.membership;
        opt.textContent = `${car.car} - ${car.plate_letters} ${car.plate_numbers}`;
        select.appendChild(opt);
    });
}

/* ============================
   تحميل الخدمات
   ============================ */
async function loadServices() {
    const res = await apiGet({ action: "getCommissions" });

    const select = document.getElementById("serviceSelect");
    select.innerHTML = "<option value=''>اختر الخدمة</option>";

    if (!res.success) return;

    res.commissions.forEach(s => {
        const opt = document.createElement("option");
        opt.value = s.service_type;
        opt.textContent = `${s.service_type} - ${s.price} ريال`;
        select.appendChild(opt);
    });
}

/* ============================
   تنفيذ الحجز
   ============================ */
async function submitBooking() {
    const membership = document.getElementById("carSelect").value;
    const service = document.getElementById("serviceSelect").value;
    const date = document.getElementById("date").value;
    const time = document.getElementById("time").value;

    if (!membership || !service || !date || !time) {
        alert("الرجاء تعبئة جميع الحقول");
        return;
    }

    const res = await apiPost({
        action: "addBooking",
        phone,
        membership,
        service,
        date,
        time
    });

    if (!res.success) {
        alert("حدث خطأ أثناء الحجز");
        return;
    }

    alert("تم الحجز بنجاح");
    window.location.href = "customer-dashboard.html?phone=" + phone;
}

/* ============================
   تحميل البيانات عند فتح الصفحة
   ============================ */
window.onload = function () {
    loadCars();
    loadServices();
};
</script>

</body>
</html>
