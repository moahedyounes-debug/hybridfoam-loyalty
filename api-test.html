<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Hybrid Foam â€“ FULL API TESTER</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        body {
            font-family: "Tajawal", sans-serif;
            background: #f0f2f5;
            padding: 20px;
        }
        h2, h3 {
            margin-bottom: 10px;
        }
        .box {
            background: white;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        button {
            width: 100%;
            padding: 12px;
            margin: 5px 0;
            border: none;
            border-radius: 8px;
            background: #007bff;
            color: white;
            font-size: 16px;
            cursor: pointer;
        }
        button:hover {
            background: #005fcc;
        }
        textarea {
            width: 100%;
            height: 260px;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid #ccc;
            font-size: 14px;
            margin-top: 10px;
        }
        input, select {
            width: 100%;
            padding: 10px;
            margin: 6px 0;
            border-radius: 8px;
            border: 1px solid #ccc;
        }
    </style>
</head>

<body>

<h2>ğŸ§ª Hybrid Foam â€“ FULL API TESTER</h2>

<div class="box">
    <h3>ğŸ”— Ø±Ø§Ø¨Ø· Ø§Ù„Ù€ API (ÙŠØªÙ… Ù‚Ø±Ø§Ø¡ØªÙ‡ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù…Ù† api.js)</h3>
    <input id="apiUrl" placeholder="Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...">
</div>

<!-- ===========================
       VISITS TESTS
=========================== -->
<div class="box">
    <h3>ğŸ§¼ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Visits</h3>

    <button style="background:#28a745" onclick="testSingleService()">Ø§Ø®ØªØ¨Ø§Ø± Ø®Ø¯Ù…Ø© ÙˆØ§Ø­Ø¯Ø© (Ø®ØµÙ… + Ø¥ÙƒØ±Ø§Ù…ÙŠØ© + ÙƒØ§Ø´)</button>

    <button style="background:#6f42c1" onclick="testMultiService()">Ø§Ø®ØªØ¨Ø§Ø± Ø¹Ø¯Ø© Ø®Ø¯Ù…Ø§Øª (ØªÙˆØ²ÙŠØ¹ Ø®ØµÙ… + Ø¥ÙƒØ±Ø§Ù…ÙŠØ© + Ø´Ø¨ÙƒØ©)</button>
</div>

<textarea id="output" placeholder="Ø§Ù„Ù†ØªÙŠØ¬Ø© ØªØ¸Ù‡Ø± Ù‡Ù†Ø§..."></textarea>

<!-- ===========================
       LOAD API_URL FROM api.js
=========================== -->
<script src="api.js"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
    if (typeof API_URL !== "undefined") {
        document.getElementById("apiUrl").value = API_URL;
    } else {
        document.getElementById("apiUrl").value = "âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ API_URL ÙÙŠ api.js";
    }
});
</script>

<!-- ===========================
       FULL TEST LOGIC
=========================== -->
<script>

async function apiCall(url, params) {
    const form = new URLSearchParams();
    Object.keys(params).forEach(k => form.append(k, params[k]));
    const res = await fetch(url, { method: "POST", body: form });
    return res.json();
}

/* ============================================================
   ğŸ”¥ 1) Ø§Ø®ØªØ¨Ø§Ø± Ø®Ø¯Ù…Ø© ÙˆØ§Ø­Ø¯Ø© (Ø®ØµÙ… + Ø¥ÙƒØ±Ø§Ù…ÙŠØ© + ÙƒØ§Ø´)
============================================================ */
async function testSingleService() {
    const url = document.getElementById("apiUrl").value;

    // 1) Ø¥Ø¶Ø§ÙØ© Ø²ÙŠØ§Ø±Ø©
    let add = await apiCall(url, {
        action: "addVisit",
        membership: "20260001",
        plate_numbers: "9999",
        plate_letters: "Ø£ Ø¨ Ø¬",
        car_type: "Ø³ÙŠØ¯Ø§Ù†",
        car_model: "ÙƒØ§Ù…Ø±ÙŠ",
        car_size: "ÙˆØ³Ø·",
        service_detail: "Ø®Ø§Ø±Ø¬ÙŠ ØµØºÙŠØ±",
        price: 25,
        points: 3,
        employee_in: "Ø£Ø­Ù…Ø¯",
        branch: "Ù…ÙƒØ©"
    });

    if (!add.success) {
        document.getElementById("output").value =
            "âŒ Ø®Ø·Ø£ ÙÙŠ addVisit:\n\n" + JSON.stringify(add, null, 2);
        return;
    }

    const row = add.row;

    // 2) Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø²ÙŠØ§Ø±Ø©
    let close = await apiCall(url, {
        action: "closeVisit",
        row: row,
        payment_status: "Ù…Ø¯ÙÙˆØ¹",
        payment_method: "ÙƒØ§Ø´",
        cash_amount: 20,
        card_amount: 0,
        total_paid: 20,
        tip: 5,
        discount: 5
    });

    document.getElementById("output").value =
        "âœ” Ø§Ø®ØªØ¨Ø§Ø± Ø®Ø¯Ù…Ø© ÙˆØ§Ø­Ø¯Ø© (Ø®ØµÙ… + Ø¥ÙƒØ±Ø§Ù…ÙŠØ©)\n\n" +
        "Row: " + row + "\n\n" +
        JSON.stringify(close, null, 2);
}

/* ============================================================
   ğŸ”¥ 2) Ø§Ø®ØªØ¨Ø§Ø± Ø¹Ø¯Ø© Ø®Ø¯Ù…Ø§Øª (ØªÙˆØ²ÙŠØ¹ Ø®ØµÙ… + Ø¥ÙƒØ±Ø§Ù…ÙŠØ© + Ø´Ø¨ÙƒØ©)
============================================================ */
async function testMultiService() {
    const url = document.getElementById("apiUrl").value;

    const services = [
        { detail: "ØºØ³ÙŠÙ„", price: 25 },
        { detail: "ØªÙ„Ù…ÙŠØ¹", price: 15 },
        { detail: "ØªØºÙ„ÙŠÙ", price: 10 }
    ];

    const rows = [];

    // 1) Ø¥Ø¶Ø§ÙØ© 3 Ø®Ø¯Ù…Ø§Øª
    for (let s of services) {
        let add = await apiCall(url, {
            action: "addVisit",
            membership: "20260001",
            plate_numbers: "7777",
            plate_letters: "Ø£ Ø¨ Ø¬",
            car_type: "Ø³ÙŠØ¯Ø§Ù†",
            car_model: "ÙƒØ§Ù…Ø±ÙŠ",
            car_size: "ÙˆØ³Ø·",
            service_detail: s.detail,
            price: s.price,
            points: 3,
            employee_in: "Ø£Ø­Ù…Ø¯",
            branch: "Ù…ÙƒØ©"
        });

        rows.push(add.row);
    }

    // ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø®ØµÙ…
    const discount = 5;
    const tip = 10;
    const total = 25 + 15 + 10;

    const discounts = [
        Math.round((25 / total) * discount),
        Math.round((15 / total) * discount),
        Math.round((10 / total) * discount)
    ];

    const paid = [
        25 - discounts[0],
        15 - discounts[1],
        10 - discounts[2]
    ];

    // 2) Ø¥ØºÙ„Ø§Ù‚ ÙƒÙ„ Ø²ÙŠØ§Ø±Ø©
    for (let i = 0; i < rows.length; i++) {
        await apiCall(url, {
            action: "closeVisit",
            row: rows[i],
            payment_status: "Ù…Ø¯ÙÙˆØ¹",
            payment_method: "Ø´Ø¨ÙƒØ©",
            cash_amount: 0,
            card_amount: paid[i],
            total_paid: paid[i],
            tip: i === 0 ? tip : 0,
            discount: discounts[i]
        });
    }

    document.getElementById("output").value =
        "âœ” Ø§Ø®ØªØ¨Ø§Ø± Ø¹Ø¯Ø© Ø®Ø¯Ù…Ø§Øª (ØªÙˆØ²ÙŠØ¹ Ø®ØµÙ… + Ø¥ÙƒØ±Ø§Ù…ÙŠØ©)\n\n" +
        "Rows: " + JSON.stringify(rows, null, 2);
}

</script>

</body>
</html>
