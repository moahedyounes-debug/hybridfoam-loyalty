<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>ØµÙØ­Ø© Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª â€” Ø¬Ø§Ù‡Ø²Ø© 100%</title>
<style>
body { font-family: Tahoma; padding: 20px; background:#f2f2f2 }
.card { background:#fff; padding:20px; margin-bottom:20px; border-radius:10px; border:1px solid #ccc }
button { padding:10px 20px; background:#2563eb; color:#fff; border:none; border-radius:6px; cursor:pointer; margin:5px }
button:hover { background:#1e4fc7 }
.service { display:flex; justify-content:space-between; padding:5px 0; border-bottom:1px solid #eee }
.modal-bg { display:none; position:fixed; inset:0; background:#0008; padding:40px }
.modal { background:#fff; padding:20px; border-radius:10px; max-width:400px; margin:auto }
input, select { width:100%; padding:8px; margin:5px 0 10px; }
</style>
</head>
<body>

<h1>ğŸ”§ ØµÙØ­Ø© Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª â€” Add / Update / Close</h1>

<button onclick="addPaidVisit()">â• Ø¥Ø¶Ø§ÙØ© Ø²ÙŠØ§Ø±Ø© Ù…Ø¯ÙÙˆØ¹Ø© Ø¬Ø§Ù‡Ø²Ø©</button>
<button onclick="addUnpaidVisit()">â• Ø¥Ø¶Ø§ÙØ© Ø²ÙŠØ§Ø±Ø© ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹Ø© Ø¬Ø§Ù‡Ø²Ø©</button>
<button onclick="loadActive()">ğŸ”„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©</button>

<div id="visits"></div>

<!-- ===========================
     Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø¯ÙØ¹
=========================== -->
<div id="modal" class="modal-bg">
  <div class="modal">
    <h2>ğŸ’³ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯ÙØ¹</h2>

    <p><b>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</b> <span id="m_total"></span></p>

    <label>Ø§Ù„Ø®ØµÙ…</label>
    <input id="m_discount">

    <label>Ø§Ù„Ø¥ÙƒØ±Ø§Ù…ÙŠØ©</label>
    <input id="m_tip">

    <label>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</label>
    <select id="m_method">
      <option value="ÙƒØ§Ø´">ÙƒØ§Ø´</option>
      <option value="Ø´Ø¨ÙƒØ©">Ø´Ø¨ÙƒØ©</option>
      <option value="Ø¬Ø²Ø¦ÙŠ">Ø¬Ø²Ø¦ÙŠ</option>
    </select>

    <label>ÙƒØ§Ø´</label>
    <input id="m_cash">

    <label>Ø´Ø¨ÙƒØ©</label>
    <input id="m_card">

    <button onclick="confirmPayment()">âœ” ØªÙ†ÙÙŠØ° Ø§Ù„Ø¯ÙØ¹</button>
    <button onclick="closeModal()">âœ– Ø¥ØºÙ„Ø§Ù‚</button>

    <p id="m_result"></p>
  </div>
</div>

<script>
let API = "https://script.google.com/macros/s/AKfycbzX4ChhmrFTDKtJSBQeqPKlUz5Kplua0phhw_tuJkGyx3NWdDeZocXZCZPxQHJnEqyKaw/exec";
let currentPlate = null;
let currentRows = [];

// ===========================
// 1) Ø¥Ø¶Ø§ÙØ© Ø²ÙŠØ§Ø±Ø© Ù…Ø¯ÙÙˆØ¹Ø© Ø¬Ø§Ù‡Ø²Ø©
// ===========================
async function addPaidVisit() {
  await fetch(API + "?action=addVisit", {
    method: "POST",
    body: new URLSearchParams({
      plate_numbers: "1234",
      plate_letters: "Ø£ Ø¨ Ø¬",
      car_type: "ØªÙˆÙŠÙˆØªØ§",
      car_model: "ÙƒØ§Ù…Ø±ÙŠ",
      car_size: "Ù…ØªÙˆØ³Ø·",
      employee_in: "Ù…ÙˆØ¸Ù ØªØ¬Ø±ÙŠØ¨ÙŠ",
      branch: "Ù…ÙƒØ©",
      parking_slot: "A1",
      payment_status: "Ù…Ø¯ÙÙˆØ¹",
      payment_method: "ÙƒØ§Ø´",
      discount: 0,
      tip: 0,
      cash_amount: 70,
      card_amount: 0,
      services: JSON.stringify([
        {name:"ØºØ³ÙŠÙ„ Ø®Ø§Ø±Ø¬ÙŠ", price:30, points:6, commission:5},
        {name:"ØºØ³ÙŠÙ„ Ø¯Ø§Ø®Ù„ÙŠ", price:40, points:8, commission:7}
      ])
    })
  });

  alert("âœ” ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø²ÙŠØ§Ø±Ø© Ù…Ø¯ÙÙˆØ¹Ø©");
  loadActive();
}

// ===========================
// 2) Ø¥Ø¶Ø§ÙØ© Ø²ÙŠØ§Ø±Ø© ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹Ø© Ø¬Ø§Ù‡Ø²Ø©
// ===========================
async function addUnpaidVisit() {
  await fetch(API + "?action=addVisit", {
    method: "POST",
    body: new URLSearchParams({
      plate_numbers: "5678",
      plate_letters: "Ø¯ Ø± Ø³",
      car_type: "Ù‡ÙŠÙˆÙ†Ø¯Ø§ÙŠ",
      car_model: "Ø³ÙˆÙ†Ø§ØªØ§",
      car_size: "Ù…ØªÙˆØ³Ø·",
      employee_in: "Ù…ÙˆØ¸Ù ØªØ¬Ø±ÙŠØ¨ÙŠ",
      branch: "Ù…ÙƒØ©",
      parking_slot: "B2",
      payment_status: "ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹",
      payment_method: "",
      discount: 0,
      tip: 0,
      cash_amount: 0,
      card_amount: 0,
      services: JSON.stringify([
        {name:"ØºØ³ÙŠÙ„ Ø®Ø§Ø±Ø¬ÙŠ", price:30, points:6, commission:5},
        {name:"ØºØ³ÙŠÙ„ Ø¯Ø§Ø®Ù„ÙŠ", price:40, points:8, commission:7}
      ])
    })
  });

  alert("âœ” ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø²ÙŠØ§Ø±Ø© ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹Ø©");
  loadActive();
}

// ===========================
// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©
// ===========================
async function loadActive() {
  const box = document.getElementById("visits");
  box.innerHTML = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...";

  const res = await fetch(API + "?action=getActiveVisits");
  const data = await res.json();

  if (!data.success || !data.visits.length) {
    box.innerHTML = "<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø²ÙŠØ§Ø±Ø§Øª</p>";
    return;
  }

  const cars = {};

  data.visits.forEach(v => {
    const r = v.data;
    const plate = r[1];

    if (!cars[plate]) {
      cars[plate] = {
        plate,
        rows: [],
        total: 0,
        discount: Number(r[24] || 0),
        tip: Number(r[23] || 0)
      };
    }

    cars[plate].rows.push(v);
    cars[plate].total += Number(r[7] || 0);
  });

  box.innerHTML = "";

  Object.values(cars).forEach(car => {
    const div = document.createElement("div");
    div.className = "card";

    let servicesHTML = "";
    car.rows.forEach(r => {
      servicesHTML += `
        <div class="service">
          <span>${r.data[6]}</span>
          <span>${r.data[7]} Ø±ÙŠØ§Ù„</span>
        </div>
      `;
    });

    div.innerHTML = `
      <h3>ğŸš— Ù„ÙˆØ­Ø©: ${car.plate}</h3>
      ${servicesHTML}
      <p><b>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</b> ${car.total} Ø±ÙŠØ§Ù„</p>
      <p><b>Ø§Ù„Ø®ØµÙ…:</b> ${car.discount} Ø±ÙŠØ§Ù„</p>
      <p><b>Ø§Ù„Ø¥ÙƒØ±Ø§Ù…ÙŠØ©:</b> ${car.tip} Ø±ÙŠØ§Ù„</p>

      <button onclick="openModal('${car.plate}')">ğŸ’³ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯ÙØ¹</button>
    `;

    box.appendChild(div);
  });
}

// ===========================
// ÙØªØ­ Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø¯ÙØ¹
// ===========================
function openModal(plate) {
  currentPlate = plate;
  document.getElementById("modal").style.display = "block";

  fetch(API + "?action=getActiveVisits")
    .then(r => r.json())
    .then(d => {
      currentRows = d.visits.filter(v => v.data[1] === plate);
      const total = currentRows.reduce((s, v) => s + Number(v.data[7]), 0);

      document.getElementById("m_total").textContent = total + " Ø±ÙŠØ§Ù„";
      document.getElementById("m_discount").value = currentRows[0].data[24] || 0;
      document.getElementById("m_tip").value = currentRows[0].data[23] || 0;
    });
}

function closeModal() {
  document.getElementById("modal").style.display = "none";
}

// ===========================
// ØªÙ†ÙÙŠØ° Ø§Ù„Ø¯ÙØ¹
// ===========================
async function confirmPayment() {
  const discount = Number(m_discount.value);
  const tip = Number(m_tip.value);
  const method = m_method.value;
  const cash = Number(m_cash.value || 0);
  const card = Number(m_card.value || 0);

  for (const r of currentRows) {
    await fetch(API + "?action=closeVisit", {
      method: "POST",
      body: new URLSearchParams({
        row: r.row,
        payment_method: method,
        discount,
        tip,
        cash_amount: cash,
        card_amount: card,
        total_paid: cash + card
      })
    });
  }

  m_result.textContent = "âœ” ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯ÙØ¹";
  loadActive();
}
</script>

</body>
</html>
