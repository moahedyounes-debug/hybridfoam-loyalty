<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Visit Payment Tester</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body { font-family:"Tajawal",sans-serif; background:#f0f2f5; padding:20px; }
.box { background:white; padding:15px; border-radius:12px; margin-bottom:20px; }
button { width:100%; padding:12px; margin:5px 0; background:#007bff; color:white; border:none; border-radius:8px; }
textarea { width:100%; height:260px; margin-top:10px; }
</style>
</head>

<body>

<h2>ğŸ§ª Visit Payment Tester</h2>

<div class="box">
    <h3>ğŸ”— API URL</h3>
    <input id="apiUrl" placeholder="Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...">
</div>

<div class="box">
    <h3>ğŸ”¥ Ø§Ù„Ø­Ø§Ù„Ø© 1 â€” ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹ â†’ Ø«Ù… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯ÙØ¹</h3>
    <button onclick="test_Unpaid_Single()">Ø®Ø¯Ù…Ø© ÙˆØ§Ø­Ø¯Ø©</button>
    <button onclick="test_Unpaid_Multi()">Ø®Ø¯Ù…Ø§Øª Ù…ØªØ¹Ø¯Ø¯Ø©</button>
</div>

<div class="box">
    <h3>ğŸ”¥ Ø§Ù„Ø­Ø§Ù„Ø© 2 â€” Ù…Ø¯ÙÙˆØ¹ Ù…Ù† Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</h3>
    <button onclick="test_Paid_Single()">Ø®Ø¯Ù…Ø© ÙˆØ§Ø­Ø¯Ø©</button>
    <button onclick="test_Paid_Multi()">Ø®Ø¯Ù…Ø§Øª Ù…ØªØ¹Ø¯Ø¯Ø©</button>
</div>

<textarea id="output" placeholder="Ø§Ù„Ù†ØªÙŠØ¬Ø© ØªØ¸Ù‡Ø± Ù‡Ù†Ø§..."></textarea>

<script src="api.js"></script>
<script>
document.addEventListener("DOMContentLoaded",()=>{
    if(typeof API_URL!=="undefined") el("apiUrl").value=API_URL;
});

function el(id){ return document.getElementById(id); }

async function api(url,data){
    const form=new URLSearchParams();
    Object.keys(data).forEach(k=>form.append(k,data[k]));
    const res=await fetch(url,{method:"POST",body:form});
    return res.json();
}

/* ============================================================
   ğŸ”¥ Ø§Ù„Ø­Ø§Ù„Ø© 1 â€” ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹ â†’ Ø«Ù… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯ÙØ¹
============================================================ */

/* -------- Ø®Ø¯Ù…Ø© ÙˆØ§Ø­Ø¯Ø© -------- */
async function test_Unpaid_Single(){
    const url=el("apiUrl").value;

    // 1) ØªØ³Ø¬ÙŠÙ„ Ø²ÙŠØ§Ø±Ø© ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹Ø©
    const add=await api(url,{
        action:"addVisit",
        membership:"20260001",
        plate_numbers:"1111",
        plate_letters:"Ø£ Ø¨ Ø¬",
        car_type:"Ø³ÙŠØ¯Ø§Ù†",
        car_model:"ÙƒØ§Ù…Ø±ÙŠ",
        car_size:"ÙˆØ³Ø·",
        employee_in:"Ø£Ø­Ù…Ø¯",
        branch:"Ù…ÙƒØ©",
        payment_status:"ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹",
        services:JSON.stringify([
            {name:"Ø®Ø§Ø±Ø¬ÙŠ ØµØºÙŠØ±",price:25,points:3,commission:0}
        ])
    });

    let out="ğŸ“Œ addVisit (ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹):\n"+JSON.stringify(add,null,2);

    const row=add.row;
    if(!row){ el("output").value=out+"\n\nâŒ row undefined"; return; }

    // 2) ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯ÙØ¹
    const close=await api(url,{
        action:"closeVisit",
        row:row,
        payment_status:"Ù…Ø¯ÙÙˆØ¹",
        payment_method:"ÙƒØ§Ø´",
        cash_amount:20,
        card_amount:0,
        total_paid:20,
        discount:5,
        tip:5
    });

    out+="\n\nğŸ“Œ closeVisit:\n"+JSON.stringify(close,null,2);
    el("output").value=out;
}

/* -------- Ø®Ø¯Ù…Ø§Øª Ù…ØªØ¹Ø¯Ø¯Ø© -------- */
async function test_Unpaid_Multi(){
    const url=el("apiUrl").value;

    const services=[
        {name:"ØºØ³ÙŠÙ„",price:25,points:3,commission:0},
        {name:"ØªÙ„Ù…ÙŠØ¹",price:15,points:3,commission:0},
        {name:"ØªØºÙ„ÙŠÙ",price:10,points:3,commission:0}
    ];

    const rows=[];

    // 1) ØªØ³Ø¬ÙŠÙ„ 3 Ø®Ø¯Ù…Ø§Øª ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹Ø©
    for(let s of services){
        const add=await api(url,{
            action:"addVisit",
            membership:"20260001",
            plate_numbers:"2222",
            plate_letters:"Ø£ Ø¨ Ø¬",
            car_type:"Ø³ÙŠØ¯Ø§Ù†",
            car_model:"ÙƒØ§Ù…Ø±ÙŠ",
            car_size:"ÙˆØ³Ø·",
            employee_in:"Ø£Ø­Ù…Ø¯",
            branch:"Ù…ÙƒØ©",
            payment_status:"ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹",
            services:JSON.stringify([s])
        });
        rows.push(add.row);
    }

    let out="ğŸ“Œ addVisit (ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹):\n"+JSON.stringify(rows,null,2);

    // ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø®ØµÙ…
    const discount=5;
    const tip=10;
    const total=25+15+10;
    const discounts=[
        Math.round(25/total*discount),
        Math.round(15/total*discount),
        Math.round(10/total*discount)
    ];
    const paid=[
        25-discounts[0],
        15-discounts[1],
        10-discounts[2]
    ];

    // 2) ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯ÙØ¹
    for(let i=0;i<rows.length;i++){
        await api(url,{
            action:"closeVisit",
            row:rows[i],
            payment_status:"Ù…Ø¯ÙÙˆØ¹",
            payment_method:"Ø´Ø¨ÙƒØ©",
            cash_amount:0,
            card_amount:paid[i],
            total_paid:paid[i],
            discount:discounts[i],
            tip:i===0?tip:0
        });
    }

    out+="\n\nğŸ“Œ closeVisit ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ°";
    el("output").value=out;
}

/* ============================================================
   ğŸ”¥ Ø§Ù„Ø­Ø§Ù„Ø© 2 â€” Ù…Ø¯ÙÙˆØ¹ Ù…Ù† Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
============================================================ */

/* -------- Ø®Ø¯Ù…Ø© ÙˆØ§Ø­Ø¯Ø© -------- */
async function test_Paid_Single(){
    const url=el("apiUrl").value;

    const add=await api(url,{
        action:"addVisit",
        membership:"20260001",
        plate_numbers:"3333",
        plate_letters:"Ø£ Ø¨ Ø¬",
        car_type:"Ø³ÙŠØ¯Ø§Ù†",
        car_model:"ÙƒØ§Ù…Ø±ÙŠ",
        car_size:"ÙˆØ³Ø·",
        employee_in:"Ø£Ø­Ù…Ø¯",
        branch:"Ù…ÙƒØ©",
        payment_status:"Ù…Ø¯ÙÙˆØ¹",
        payment_method:"ÙƒØ§Ø´",
        cash_amount:20,
        card_amount:0,
        total_paid:20,
        discount:5,
        tip:5,
        services:JSON.stringify([
            {name:"Ø®Ø§Ø±Ø¬ÙŠ ØµØºÙŠØ±",price:25,points:3,commission:0}
        ])
    });

    el("output").value="ğŸ“Œ addVisit (Ù…Ø¯ÙÙˆØ¹):\n"+JSON.stringify(add,null,2);
}

/* -------- Ø®Ø¯Ù…Ø§Øª Ù…ØªØ¹Ø¯Ø¯Ø© -------- */
async function test_Paid_Multi(){
    const url=el("apiUrl").value;

    const services=[
        {name:"ØºØ³ÙŠÙ„",price:25,points:3,commission:0},
        {name:"ØªÙ„Ù…ÙŠØ¹",price:15,points:3,commission:0},
        {name:"ØªØºÙ„ÙŠÙ",price:10,points:3,commission:0}
    ];

    const rows=[];
    const discount=5;
    const tip=10;
    const total=25+15+10;
    const discounts=[
        Math.round(25/total*discount),
        Math.round(15/total*discount),
        Math.round(10/total*discount)
    ];
    const paid=[
        25-discounts[0],
        15-discounts[1],
        10-discounts[2]
    ];

    for(let i=0;i<services.length;i++){
        const add=await api(url,{
            action:"addVisit",
            membership:"20260001",
            plate_numbers:"4444",
            plate_letters:"Ø£ Ø¨ Ø¬",
            car_type:"Ø³ÙŠØ¯Ø§Ù†",
            car_model:"ÙƒØ§Ù…Ø±ÙŠ",
            car_size:"ÙˆØ³Ø·",
            employee_in:"Ø£Ø­Ù…Ø¯",
            branch:"Ù…ÙƒØ©",
            payment_status:"Ù…Ø¯ÙÙˆØ¹",
            payment_method:"Ø´Ø¨ÙƒØ©",
            cash_amount:0,
            card_amount:paid[i],
            total_paid:paid[i],
            discount:discounts[i],
            tip:i===0?tip:0,
            services:JSON.stringify([services[i]])
        });
        rows.push(add.row);
    }

    el("output").value="ğŸ“Œ addVisit (Ù…Ø¯ÙÙˆØ¹):\n"+JSON.stringify(rows,null,2);
}
</script>

</body>
</html>
