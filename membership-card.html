<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#000000">

<script>
if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("service-worker.js");
}
</script>

<style>
    body {
        font-family: "Tahoma", sans-serif;
        background: #f2f2f2;
        padding: 25px;
        text-align: center;
    }

    .card {
        width: 360px;
        margin: auto;
        border-radius: 22px;
        overflow: hidden;
        background: white;
        box-shadow: 0 6px 18px rgba(0,0,0,0.15);
    }

    .top {
        padding: 25px;
        color: white;
        text-align: center;
    }

    .logo {
        width: 85px;
        height: 85px;
        object-fit: contain;
        margin-bottom: 10px;
        filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
    }

    .level-text {
        font-size: 22px;
        font-weight: bold;
        margin-top: 5px;
    }

    .qr-box {
        margin-top: 15px;
    }

    .bottom {
        padding: 20px;
        text-align: right;
        background: #fff;
    }

    .row {
        margin-bottom: 10px;
        font-size: 16px;
    }

    .row b {
        color: #333;
    }

    .add-btn {
        margin-top: 18px;
        background: #000;
        color: white;
        padding: 12px 18px;
        border-radius: 12px;
        font-size: 16px;
        cursor: pointer;
        display: none;
        width: 100%;
        text-align: center;
    }
</style>

<script src="api.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
</head>
<body>

<h2>Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©</h2>

<div id="cardContainer"></div>

<script>
let deferredPrompt;

// ÙŠØ¸Ù‡Ø± Ø²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¹Ù†Ø¯ ØªÙˆÙØ± Ø§Ù„Ø­Ø¯Ø«
window.addEventListener("beforeinstallprompt", (e) => {
    e.preventDefault();
    deferredPrompt = e;

    const btn = document.getElementById("addBtn");
    if (btn) btn.style.display = "block";
});

async function loadCard() {
    const phone = localStorage.getItem("customer_phone");

    if (!phone) {
        alert("ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹");
        location.href = "login.html";
        return;
    }

    const res = await apiGet({
        action: "getByPhone",
        phone
    });

    if (!res.success) {
        document.getElementById("cardContainer").innerHTML =
            "<h3 style='color:red;'>Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>";
        return;
    }

    const c = res.customer;
    const car = res.cars[0];

    // Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª
    let color = "#cd7f32"; // Bronze
    if (c.level === "Silver") color = "#c0c0c0";
    if (c.level === "Gold") color = "#d4af37";
    if (c.level === "Platinum") color = "#e5e4e2";
    if (c.level === "VIP") color = "#000";

    // ØªØ§Ø¬ VIP
    let levelText = c.level;
    if (c.level === "VIP") levelText = "ğŸ‘‘ VIP";

    document.getElementById("cardContainer").innerHTML = `
        <div class="card">
            <div class="top" style="background:${color};">

                <img src="logo.png" class="logo">

                <div><b>Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©:</b> ${car.membership}</div>
                <div class="level-text">${levelText}</div>

                <div class="qr-box">
                    <canvas id="qr"></canvas>
                </div>
            </div>

            <div class="bottom">
                <div class="row"><b>Ø§Ù„Ø§Ø³Ù…:</b> ${c.name}</div>
                <div class="row"><b>Ø§Ù„Ù†Ù‚Ø§Ø·:</b> ${c.points} Ù†Ù‚Ø·Ø©</div>
                <div class="row"><b>Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©:</b> ${car.car} â€” ${car.plate_numbers} ${car.plate_letters}</div>
                <div class="row"><b>Ø¢Ø®Ø± Ø²ÙŠØ§Ø±Ø©:</b> ${c.last_visit || "â€”"}</div>

                <div id="addBtn" class="add-btn" onclick="addToHome()">
                    ğŸ“± Ø£Ø¶Ù Ù„Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                </div>
            </div>
        </div>
    `;

    // QR ÙŠÙ‚Ø±Ø£ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„
    new QRious({
        element: document.getElementById("qr"),
        value: phone,
        size: 150
    });
}

function addToHome() {
    if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt = null;
    } else {
        alert("Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ù„Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©:\n\nğŸ“± iPhone:\nØ§Ø¶ØºØ· Ù…Ø´Ø§Ø±ÙƒØ© â†’ Add to Home Screen\n\nğŸ¤– Android:\nÙ…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© â†’ Add to Home Screen");
    }
}

loadCard();
</script>

</body>
</html>
