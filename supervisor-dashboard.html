<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø´Ø±Ù - Ù†Ø³Ø®Ø© Ø¬Ø¯ÙŠØ¯Ø©</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: "Tajawal", sans-serif;
      background: #f4f7fb;
      color: #0d47a1;
      margin: 0;
      padding: 16px;
      max-width: 1200px;
      margin-inline: auto;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }
    .header-title {
      font-size: 22px;
      font-weight: 700;
    }
    .header-sub {
      font-size: 13px;
      color: #4fc3f7;
    }
    .btn {
      padding: 8px 14px;
      border-radius: 999px;
      border: none;
      background: #0d47a1;
      color: #fff;
      font-size: 13px;
      cursor: pointer;
    }
    .btn-outline {
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid #0d47a1;
      background: #fff;
      color: #0d47a1;
      font-size: 13px;
      cursor: pointer;
    }
    .tabs {
      display: flex;
      gap: 8px;
      border-bottom: 1px solid #e0e7ff;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    .tab {
      padding: 8px 14px;
      border-radius: 999px 999px 0 0;
      cursor: pointer;
      font-size: 13px;
      background: #e3f2fd;
      color: #0d47a1;
      border: 1px solid transparent;
      border-bottom: none;
    }
    .tab.active {
      background: #fff;
      border-color: #e0e7ff;
      border-bottom: 1px solid #fff;
      font-weight: 600;
    }
    .tab-content {
      background: #fff;
      border-radius: 0 12px 12px 12px;
      border: 1px solid #e0e7ff;
      padding: 14px;
      box-shadow: 0 4px 10px rgba(15, 23, 42, 0.06);
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 12px;
    }
    .card {
      background: #fff;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      padding: 10px 12px;
      box-shadow: 0 2px 6px rgba(15, 23, 42, 0.04);
      font-size: 13px;
    }
    .card-title {
      font-size: 14px;
      font-weight: 700;
      margin-bottom: 4px;
      color: #0d47a1;
    }
    .card-sub {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 8px;
    }
    .stat-row {
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      margin-bottom: 4px;
    }
    .label {
      color: #6b7280;
    }
    .value {
      color: #0d47a1;
      font-weight: 600;
    }
    input, select {
      width: 100%;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-size: 13px;
      margin-bottom: 6px;
      box-sizing: border-box;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    th, td {
      padding: 4px 6px;
      border-bottom: 1px solid #e5e7eb;
      text-align: right;
    }
    th {
      background: #f3f4f6;
      font-weight: 600;
    }
    .tag {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      background: #e3f2fd;
      color: #0d47a1;
      font-size: 11px;
    }
    .logout {
      margin-top: 16px;
      text-align: center;
      font-size: 13px;
      color: #d32f2f;
      cursor: pointer;
    }
    @media (max-width: 600px) {
      body { padding: 10px; }
      .tab-content { border-radius: 12px; }
    }
  </style>
</head>
<body>

  <div class="header">
    <div>
      <div class="header-title">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø´Ø±Ù - Ù†Ø³Ø®Ø© Ø¬Ø¯ÙŠØ¯Ø©</div>
      <div class="header-sub">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙŠÙˆÙ… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ù…Ù† Ù…ÙƒØ§Ù† ÙˆØ§Ø­Ø¯</div>
    </div>
    <button class="btn-outline" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
  </div>

  <div class="tabs">
    <div class="tab active" data-tab="summary">Ø§Ù„Ù…Ù„Ø®Øµ</div>
    <div class="tab" data-tab="visits">Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª</div>
    <div class="tab" data-tab="customers">Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</div>
    <div class="tab" data-tab="bookings">Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</div>
    <div class="tab" data-tab="invoices">Ø§Ù„ÙÙˆØ§ØªÙŠØ±</div>
  </div>

  <div class="tab-content">

    <!-- Ø§Ù„Ù…Ù„Ø®Øµ -->
    <div id="tab-summary">
      <div class="grid">
        <div class="card">
          <div class="card-title">ğŸ“Š Ù…Ù„Ø®Øµ Ø§Ù„ÙŠÙˆÙ…</div>
          <div class="card-sub">Ø§Ù„ÙˆØ§Ø±Ø¯ Ø§Ù„ÙŠÙˆÙ…ÙŠ Ø­Ø³Ø¨ Ø·Ø±Ù‚ Ø§Ù„Ø¯ÙØ¹ ÙˆØ§Ù„Ø®Ø¯Ù…Ø§Øª</div>
          <div class="stat-row">
            <span class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ø§Ù„ÙŠÙˆÙ…</span>
            <span class="value" id="sumTotal">0 Ø±ÙŠØ§Ù„</span>
          </div>
          <div class="stat-row">
            <span class="label">ÙƒØ§Ø´ Ø§Ù„ÙŠÙˆÙ…</span>
            <span class="value" id="sumCash">0 Ø±ÙŠØ§Ù„</span>
          </div>
          <div class="stat-row">
            <span class="label">Ø´Ø¨ÙƒØ© Ø§Ù„ÙŠÙˆÙ…</span>
            <span class="value" id="sumCard">0 Ø±ÙŠØ§Ù„</span>
          </div>
          <div class="stat-row">
            <span class="label">Ø¹Ø¯Ø¯ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø©</span>
            <span class="value" id="sumVisits">0</span>
          </div>
          <div class="stat-row">
            <span class="label">Ø¹Ø¯Ø¯ Ø§Ù„Ø®Ø¯Ù…Ø§Øª</span>
            <span class="value" id="sumServices">0</span>
          </div>
          <div class="stat-row">
            <span class="label">Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</span>
            <span class="value" id="sumCustomers">0</span>
          </div>
          <button class="btn" style="margin-top:8px;width:100%;" onclick="loadSummary()">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„Ø®Øµ</button>
        </div>

        <div class="card">
          <div class="card-title">ğŸ§½ Ø¹Ø¯Ø¯ Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹</div>
          <div class="card-sub">Ø­Ø³Ø¨ Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø©</div>
          <div id="sumServicesByType" style="font-size:13px;color:#374151;">
            Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...
          </div>
        </div>
      </div>
    </div>

    <!-- Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª -->
    <div id="tab-visits" style="display:none;">
      <div class="grid">
        <div class="card">
          <div class="card-title">ğŸš— Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„ÙŠÙˆÙ…</div>
          <div class="card-sub">ÙƒÙ„ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ø³Ø¬Ù„Ø© Ø§Ù„ÙŠÙˆÙ…</div>
          <div id="todayVisitsBox" style="max-height:260px;overflow:auto;font-size:13px;">
            Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...
          </div>
          <button class="btn" style="margin-top:8px;width:100%;" onclick="loadTodayVisits()">ØªØ­Ø¯ÙŠØ« Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„ÙŠÙˆÙ…</button>
        </div>

        <div class="card">
          <div class="card-title">ğŸš˜ Ø²ÙŠØ§Ø±Ø§Øª ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹Ø©</div>
          <div class="card-sub">ÙƒÙ„ Ø²ÙŠØ§Ø±Ø© Ø­Ø§Ù„ØªÙ‡Ø§ Ù„ÙŠØ³Øª "Ù…Ø¯ÙÙˆØ¹"</div>
          <div id="activeVisitsBox" style="max-height:260px;overflow:auto;font-size:13px;">
            Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...
          </div>
          <button class="btn" style="margin-top:8px;width:100%;" onclick="loadActiveVisits()">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©</button>
        </div>
      </div>
    </div>

    <!-- Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ -->
    <div id="tab-customers" style="display:none;">
      <div class="grid">
        <div class="card">
          <div class="card-title">ğŸ” Ø¨Ø­Ø« Ø¹Ù† Ø¹Ù…ÙŠÙ„</div>
          <div class="card-sub">Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</div>
          <input id="custPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„" />
          <button class="btn" style="width:100%;" onclick="searchCustomer()">Ø¨Ø­Ø«</button>
          <div id="custInfo" style="margin-top:8px;font-size:13px;color:#374151;">
            Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯.
          </div>
        </div>

        <div class="card">
          <div class="card-title">ğŸš— Ø³ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</div>
          <div id="custCars" style="max-height:260px;overflow:auto;font-size:13px;">
            Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª.
          </div>
        </div>

        <div class="card">
          <div class="card-title">ğŸ“‹ Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</div>
          <div id="custVisits" style="max-height:260px;overflow:auto;font-size:13px;">
            Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª.
          </div>
        </div>
      </div>
    </div>

    <!-- Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª -->
    <div id="tab-bookings" style="display:none;">
      <div class="card">
        <div class="card-title">ğŸ“… Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</div>
        <div class="card-sub">ÙƒÙ„ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª Ù…Ù† Ø´ÙŠØª Bookings</div>
        <button class="btn" style="margin-bottom:8px;" onclick="loadBookings()">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</button>
        <div id="bookingsBox" style="max-height:320px;overflow:auto;font-size:13px;">
          Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...
        </div>
      </div>
    </div>

    <!-- Ø§Ù„ÙÙˆØ§ØªÙŠØ± -->
    <div id="tab-invoices" style="display:none;">
      <div class="grid">
        <div class="card">
          <div class="card-title">ğŸ§¾ Ø¨Ø­Ø« Ø¹Ù† Ø²ÙŠØ§Ø±Ø§Øª Ø³ÙŠØ§Ø±Ø©</div>
          <div class="card-sub">Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø© (Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø£Ùˆ Ø§Ù„Ø£Ø­Ø±Ù Ø£Ùˆ ÙƒÙ„ÙŠÙ‡Ù…Ø§)</div>
          <input id="invPlate" placeholder="Ù…Ø«Ø§Ù„: 1234 Ø£Ùˆ Ø£ Ø¨ Ø¬" />
          <button class="btn" style="width:100%;" onclick="searchInvoices()">Ø¨Ø­Ø«</button>
          <div id="invVisits" style="margin-top:8px;max-height:260px;overflow:auto;font-size:13px;">
            Ù„Ø§ ØªÙˆØ¬Ø¯ Ø²ÙŠØ§Ø±Ø§Øª Ø¨Ø¹Ø¯.
          </div>
        </div>

        <div class="card">
          <div class="card-title">ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ ÙØ§ØªÙˆØ±Ø© ÙˆØ§ØªØ³Ø§Ø¨</div>
          <div class="card-sub">Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù†Øµ Ø¨Ø§Ù„ÙÙˆØ§ØªÙŠØ± ÙˆØ¥Ø±Ø³Ø§Ù„Ù‡ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨</div>
          <button class="btn-outline" style="width:100%;margin-bottom:6px;" onclick="sendInvoice('last')">
            Ø¥Ø±Ø³Ø§Ù„ ÙØ§ØªÙˆØ±Ø© Ø¢Ø®Ø± Ø²ÙŠØ§Ø±Ø©
          </button>
          <button class="btn-outline" style="width:100%;" onclick="sendInvoice('all')">
            Ø¥Ø±Ø³Ø§Ù„ ÙØ§ØªÙˆØ±Ø© ÙƒÙ„ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª
          </button>
        </div>
      </div>
    </div>

  </div>

  <div class="logout" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</div>

  <script src="api.js"></script>
  <script>
    function logout() {
      localStorage.removeItem("supervisor");
      window.location.href = "index.html";
    }

    function toDayString(d) {
      const x = new Date(d);
      if (isNaN(x)) return "";
      return x.toISOString().slice(0, 10);
    }

    // ØªØ¨ÙˆÙŠØ¨Ø§Øª
    const tabs = document.querySelectorAll(".tab");
    const tabViews = {
      summary: document.getElementById("tab-summary"),
      visits: document.getElementById("tab-visits"),
      customers: document.getElementById("tab-customers"),
      bookings: document.getElementById("tab-bookings"),
      invoices: document.getElementById("tab-invoices")
    };

    tabs.forEach(t => {
      t.addEventListener("click", () => {
        tabs.forEach(x => x.classList.remove("active"));
        t.classList.add("active");
        const key = t.getAttribute("data-tab");
        Object.keys(tabViews).forEach(k => {
          tabViews[k].style.display = k === key ? "block" : "none";
        });
      });
    });

    // ===== Ø§Ù„Ù…Ù„Ø®Øµ =====
    async function loadSummary() {
      const sumTotal = document.getElementById("sumTotal");
      const sumCash = document.getElementById("sumCash");
      const sumCard = document.getElementById("sumCard");
      const sumVisits = document.getElementById("sumVisits");
      const sumServices = document.getElementById("sumServices");
      const sumCustomers = document.getElementById("sumCustomers");
      const sumServicesByType = document.getElementById("sumServicesByType");

      sumTotal.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...";
      sumCash.innerText = "...";
      sumCard.innerText = "...";
      sumVisits.innerText = "...";
      sumServices.innerText = "...";
      sumCustomers.innerText = "...";
      sumServicesByType.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...";

      const visitsRes = await apiGetAll("Visits");
      const custRes = await apiGetAll("Customers");

      if (!visitsRes.success) {
        sumTotal.innerText = "Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª";
        return;
      }

      const today = toDayString(new Date());
      let total = 0, cash = 0, card = 0, visitsCount = 0, servicesCount = 0;
      const byService = {};

      (visitsRes.rows || []).forEach(r => {
        const checkIn = r[13];
        const payStatus = String(r[15] || "").trim();
        if (!checkIn || payStatus !== "Ù…Ø¯ÙÙˆØ¹") return;
        const day = String(checkIn).split(" ")[0];
        if (day !== today) return;

        const price = Number(r[7] || 0);
        const cashAmount = Number(r[20] || 0);
        const cardAmount = Number(r[21] || 0);
        const totalPaid = Number(r[22] || price);

        total += totalPaid;
        cash += cashAmount;
        card += cardAmount;
        visitsCount++;
        servicesCount++;

        const service = r[6] || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯"; // service_detail
        byService[service] = (byService[service] || 0) + 1;
      });

      sumTotal.innerText = total + " Ø±ÙŠØ§Ù„";
      sumCash.innerText = cash + " Ø±ÙŠØ§Ù„";
      sumCard.innerText = card + " Ø±ÙŠØ§Ù„";
      sumVisits.innerText = visitsCount;
      sumServices.innerText = servicesCount;
      sumCustomers.innerText = custRes.success && custRes.rows ? custRes.rows.length : 0;

      if (!Object.keys(byService).length) {
        sumServicesByType.innerText = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø®Ø¯Ù…Ø§Øª Ø§Ù„ÙŠÙˆÙ….";
      } else {
        sumServicesByType.innerHTML = Object.keys(byService)
          .map(s => `<div>${s}: <span class="tag">${byService[s]}</span></div>`)
          .join("");
      }
    }

    // ===== Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª =====
    async function loadTodayVisits() {
      const box = document.getElementById("todayVisitsBox");
      box.innerHTML = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...";
      const res = await apiGetAll("Visits");
      if (!res.success) {
        box.innerHTML = "<span style='color:#d32f2f;'>Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span>";
        return;
      }
      const today = toDayString(new Date());
      const rows = (res.rows || []).filter(r => {
        const checkIn = r[13];
        if (!checkIn) return false;
        const day = String(checkIn).split(" ")[0];
        return day === today;
      });
      if (!rows.length) {
        box.innerHTML = "<span style='color:#9ca3af;'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„ÙŠÙˆÙ….</span>";
        return;
      }
      box.innerHTML = rows.map(r => {
        const plate = `${r[1] || ""} ${r[2] || ""}`;
        const service = r[6] || "â€”"; // service_detail
        const price = Number(r[7] || 0);
        const emp = r[9]
