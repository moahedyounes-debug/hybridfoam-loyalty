<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø´Ø±Ù</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="dashboard.css">
  <script src="api.js"></script>

  <style>
    body{
      font-family:"Tajawal",sans-serif;
      background:#F4FAFF;
      color:#0D47A1;
      padding:16px;
    }
    .header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:16px;
    }
    .logo{width:120px;}
    h2{margin:0;}
    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(280px,1fr));
      gap:16px;
    }
    .card{
      background:#fff;
      border-radius:16px;
      padding:14px;
      box-shadow:0 4px 12px rgba(0,0,0,0.08);
      border:1px solid #E3F2FD;
    }
    .card h3{
      margin-top:0;
      margin-bottom:10px;
      font-size:16px;
    }
    .stat-row{
      display:flex;
      justify-content:space-between;
      margin-bottom:6px;
      font-size:14px;
    }
    .label{color:#4FC3F7;}
    .value{color:#0D47A1;font-weight:600;}
    .btn{
      padding:8px 12px;
      border:none;
      border-radius:999px;
      background:#0D47A1;
      color:#fff;
      font-size:13px;
      cursor:pointer;
      margin-top:8px;
    }
    .btn-outline{
      background:transparent;
      border:1px solid #0D47A1;
      color:#0D47A1;
    }
    input,select{
      width:100%;
      padding:6px 8px;
      border-radius:8px;
      border:1px solid #D1D5DB;
      margin-bottom:6px;
      font-size:13px;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
    }
    th,td{
      border-bottom:1px solid #E5E7EB;
      padding:4px 6px;
      text-align:right;
    }
    th{background:#F3F4F6;font-weight:600;}
    .tag{
      display:inline-block;
      padding:2px 6px;
      border-radius:999px;
      font-size:11px;
      background:#E3F2FD;
      color:#0D47A1;
    }
    .logout{
      margin-top:16px;
      text-align:center;
      font-size:14px;
      color:#D32F2F;
      cursor:pointer;
    }
    .section-title{
      font-size:15px;
      font-weight:700;
      margin-bottom:6px;
      color:#0D47A1;
    }
    .small{
      font-size:12px;
      color:#6B7280;
      margin-bottom:6px;
    }
    @media(max-width:900px){
      .header{flex-direction:column;gap:8px;}
    }
  </style>
</head>

<body>

  <div class="header">
    <div style="display:flex;align-items:center;gap:10px;">
      <img src="logo.png" class="logo">
      <div>
        <h2>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø´Ø±Ù</h2>
        <div style="font-size:13px;color:#4FC3F7;">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙŠÙˆÙ… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ù…Ù† Ù…ÙƒØ§Ù† ÙˆØ§Ø­Ø¯</div>
      </div>
    </div>
    <button class="btn-outline" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
  </div>

  <div class="grid">

    <!-- Ù…Ù„Ø®Øµ Ø§Ù„ÙŠÙˆÙ… -->
    <div class="card">
      <div class="section-title">ğŸ“Š Ù…Ù„Ø®Øµ Ø§Ù„ÙŠÙˆÙ…</div>
      <div class="small">Ø§Ù„ÙˆØ§Ø±Ø¯ Ø§Ù„ÙŠÙˆÙ…ÙŠ Ø­Ø³Ø¨ Ø·Ø±Ù‚ Ø§Ù„Ø¯ÙØ¹ ÙˆØ§Ù„Ø®Ø¯Ù…Ø§Øª</div>

      <div class="stat-row">
        <span class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙˆØ§Ø±Ø¯ Ø§Ù„ÙŠÙˆÙ…</span>
        <span class="value" id="todayTotal">0 Ø±ÙŠØ§Ù„</span>
      </div>
      <div class="stat-row">
        <span class="label">Ø´Ø¨ÙƒØ© Ø§Ù„ÙŠÙˆÙ…</span>
        <span class="value" id="todayNetwork">0 Ø±ÙŠØ§Ù„</span>
      </div>
      <div class="stat-row">
        <span class="label">ÙƒØ§Ø´ Ø§Ù„ÙŠÙˆÙ…</span>
        <span class="value" id="todayCash">0 Ø±ÙŠØ§Ù„</span>
      </div>

      <hr style="margin:10px 0;">

      <div class="section-title" style="font-size:14px;">ğŸ§½ Ø¹Ø¯Ø¯ Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„ÙŠÙˆÙ…</div>
      <div id="todayServices" class="small">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>

      <hr style="margin:10px 0;">

      <div class="section-title" style="font-size:14px;">ğŸ‘¥ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</div>
      <div class="stat-row">
        <span class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø­Ø§Ù…Ù„ÙŠ Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©</span>
        <span class="value" id="totalMembers">0</span>
      </div>
    </div>

    <!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ© -->
    <div class="card">
      <div class="section-title">ğŸ‘¤ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</div>
      <div class="small">Ø¨Ø­Ø« ØªÙØµÙŠÙ„ÙŠ ÙÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</div>

      <input id="customerSearch" placeholder="Ø§Ø³Ù… / Ø±Ù‚Ù… Ø¹Ø¶ÙˆÙŠØ© / Ø¬ÙˆØ§Ù„">
      <button class="btn" onclick="loadCustomers()">Ø¨Ø­Ø«</button>

      <div style="max-height:260px;overflow:auto;margin-top:6px;">
        <table>
          <thead>
            <tr>
              <th>Ø§Ù„Ø§Ø³Ù…</th>
              <th>Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©</th>
              <th>Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</th>
              <th>Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª</th>
              <th>Ø§Ù„Ø®Ø¯Ù…Ø§Øª</th>
              <th>Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th>
            </tr>
          </thead>
          <tbody id="customersTable">
            <tr><td colspan="6" style="text-align:center;color:#9CA3AF;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ØºØ³Ù„Ø© -->
    <div class="card">
      <div class="section-title">ğŸš— Ø³ÙŠØ§Ø±Ø§Øª Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ØºØ³Ù„Ø© (ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹Ø©)</div>
      <div class="small">ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹ Ù„ÙƒÙ„ Ø³ÙŠØ§Ø±Ø©</div>

      <div id="activeVisitsList" class="small">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
      <button class="btn" onclick="loadActiveVisits()" style="width:100%;">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
    </div>

    <!-- Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª -->
    <div class="card">
      <div class="section-title">ğŸ“… Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</div>
      <div class="small">ØªØ£ÙƒÙŠØ¯ Ø£Ùˆ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª ÙˆØ¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„</div>

      <div id="bookingsList" class="small">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
      <button class="btn" onclick="loadBookings()" style="width:100%;">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</button>
    </div>

    <!-- Ø·Ø¨Ø§Ø¹Ø© / Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„ÙØ§ØªÙˆØ±Ø© -->
    <div class="card">
      <div class="section-title">ğŸ§¾ Ø§Ù„ÙÙˆØ§ØªÙŠØ± ÙˆÙ…Ø´Ø§Ø±ÙƒØªÙ‡Ø§</div>
      <div class="small">Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù„Ø¢Ø®Ø± Ø²ÙŠØ§Ø±Ø© Ø£Ùˆ ÙƒÙ„ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª</div>

      <input id="invoiceSearch" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©">
      <button class="btn" onclick="searchInvoices()">Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª</button>

      <div id="invoiceVisits" class="small" style="max-height:160px;overflow:auto;margin-top:6px;">
        Ù„Ø§ ØªÙˆØ¬Ø¯ Ø²ÙŠØ§Ø±Ø§Øª Ø¨Ø¹Ø¯
      </div>

      <div style="margin-top:8px;">
        <button class="btn-outline" onclick="sendInvoice('last')">Ø¥Ø±Ø³Ø§Ù„ ÙØ§ØªÙˆØ±Ø© Ø¢Ø®Ø± Ø²ÙŠØ§Ø±Ø©</button>
        <button class="btn-outline" onclick="sendInvoice('all')">Ø¥Ø±Ø³Ø§Ù„ ÙØ§ØªÙˆØ±Ø© ÙƒÙ„ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª</button>
      </div>
    </div>

  </div>

  <div class="logout" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</div>

<script>
function logout(){
  localStorage.removeItem("supervisor");
  window.location.href = "index.html";
}

/* ============================
   Ù…Ù„Ø®Øµ Ø§Ù„ÙŠÙˆÙ…
============================ */

async function loadTodaySummary(){
  const visitsRes = await apiGetAll("Visits");
  if(!visitsRes.success) return;

  const today = new Date().toISOString().slice(0,10);
  const todayVisits = visitsRes.rows.filter(v => String(v[8] || "").startsWith(today));

  let total = 0, cash = 0, network = 0;
  const serviceCount = {};

  todayVisits.forEach(v => {
    const price = Number(v[2] || 0);
    const method = String(v[11] || "");
    const service = String(v[1] || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯");

    total += price;
    if(method === "ÙƒØ§Ø´") cash += price;
    if(method === "Ø´Ø¨ÙƒØ©") network += price;

    serviceCount[service] = (serviceCount[service] || 0) + 1;
  });

  document.getElementById("todayTotal").innerText = total + " Ø±ÙŠØ§Ù„";
  document.getElementById("todayCash").innerText = cash + " Ø±ÙŠØ§Ù„";
  document.getElementById("todayNetwork").innerText = network + " Ø±ÙŠØ§Ù„";

  const servicesBox = document.getElementById("todayServices");
  if(Object.keys(serviceCount).length === 0){
    servicesBox.innerText = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø®Ø¯Ù…Ø§Øª Ø§Ù„ÙŠÙˆÙ….";
  } else {
    servicesBox.innerHTML = Object.keys(serviceCount).map(s =>
      `<div>${s}: <span class="tag">${serviceCount[s]}</span></div>`
    ).join("");
  }

  const customersRes = await apiGetAll("Customers");
  if(customersRes.success){
    document.getElementById("totalMembers").innerText = customersRes.rows.length;
  }
}

/* ============================
   Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©
============================ */

async function loadCustomers(){
  const q = document.getElementById("customerSearch").value.trim().toLowerCase();
  const tbody = document.getElementById("customersTable");
  tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#9CA3AF;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>';

  const customersRes = await apiGetAll("Customers");
  const carsRes = await apiGetAll("Cars");
  const visitsRes = await apiGetAll("Visits");

  if(!customersRes.success){
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#9CA3AF;">Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>';
    return;
  }

  const customers = customersRes.rows;

  const carsByMembership = {};
  if(carsRes.success){
    carsRes.rows.forEach(c => {
      const mem = c[0];
      if(!carsByMembership[mem]) carsByMembership[mem] = [];
      carsByMembership[mem].push(c);
    });
  }

  const visitsByMembership = {};
  if(visitsRes.success){
    visitsRes.rows.forEach(v => {
      const mem = v[0];
      if(!visitsByMembership[mem]) visitsByMembership[mem] = [];
      visitsByMembership[mem].push(v);
    });
  }

  const filtered = customers.filter(c => {
    const name = String(c[0] || "").toLowerCase();
    const phone = String(c[1] || "").toLowerCase();
    const mem = String(c[8] || "").toLowerCase();
    if(!q) return true;
    return name.includes(q) || phone.includes(q) || mem.includes(q);
  });

  if(filtered.length === 0){
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#9CA3AF;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</td></tr>';
    return;
  }

  tbody.innerHTML = filtered.map(c => {
    const mem = c[8];
    const cars = carsByMembership[mem] || [];
    const visits = visitsByMembership[mem] || [];

    const servicesCount = visits.length;
    const paidAmount = visits.reduce((sum, v) => sum + Number(v[2] || 0), 0);

    return `
      <tr>
        <td>${c[0]}</td>
        <td>${mem || "â€”"}</td>
        <td>${cars.length}</td>
        <td>${visits.length}</td>
        <td>${servicesCount}</td>
        <td>${paidAmount} Ø±ÙŠØ§Ù„</td>
      </tr>
    `;
  }).join("");
}

/* ============================
   Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª ØºÙŠØ± Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø©
============================ */

async function loadActiveVisits(){
  const box = document.getElementById("activeVisitsList");
  box.innerHTML = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...";

  const res = await apiGetActiveVisits();
  if(!res.success || !res.visits || res.visits.length === 0){
    box.innerHTML = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³ÙŠØ§Ø±Ø§Øª ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.";
    return;
  }

  const carsRes = await apiGetAll("Cars");
  let carMap = {};
  if(carsRes.success){
    carsRes.rows.forEach(r => {
      const mem = r[0];
      carMap[mem] = {
        car: r[2],
        letters: r[4],
        numbers: r[5]
      };
    });
  }

  box.innerHTML = res.visits.map(v => {
    const row = v.row;
    const d = v.data;
    const mem = d[0];

    let plate = "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
    let carName = "";
    if(carMap[mem]){
      plate = `${carMap[mem].numbers} ${carMap[mem].letters}`;
      carName = carMap[mem].car;
    }

    return `
      <div style="border:1px solid #E5E7EB;border-radius:10px;padding:6px 8px;margin-bottom:6px;font-size:13px;">
        <b>ğŸš— Ø§Ù„Ù„ÙˆØ­Ø©:</b> ${plate} â€” ${carName}<br>
        <b>Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©:</b> ${mem || "â€”"}<br>
        <b>Ø§Ù„Ø®Ø¯Ù…Ø©:</b> ${d[1]}<br>
        <b>Ø§Ù„Ø³Ø¹Ø±:</b> ${d[2]} Ø±ÙŠØ§Ù„<br>
        <b>Ø§Ù„Ù…ÙˆÙ‚Ù:</b> ${d[12] || "â€”"}<br>
        <label style="font-size:12px;">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</label>
        <select id="pay_${row}" style="margin-top:2px;">
          <option value="ÙƒØ§Ø´">ÙƒØ§Ø´</option>
          <option value="Ø´Ø¨ÙƒØ©">Ø´Ø¨ÙƒØ©</option>
        </select>
        <button class="btn" style="margin-top:4px;font-size:11px;padding:4px 8px;" onclick="markPaid(${row})">
          ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹
        </button>
      </div>
    `;
  }).join("");
}

async function markPaid(row){
  const method = document.getElementById(`pay_${row}`).value;
  const res = await apiPost({
    action:"closeVisit",
    row,
    payment_status:"Ù…Ø¯ÙÙˆØ¹",
    payment_method:method
  });
  if(!res.success){
    alert("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹");
    return;
  }
  alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹");
  loadActiveVisits();
}

/* ============================
   Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª
============================ */

async function loadBookings(){
  const box = document.getElementById("bookingsList");
  box.innerHTML = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...";

  const res = await apiGetAll("Bookings");
  if(!res.success || !res.rows.length){
    box.innerHTML = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹.";
    return;
  }

  box.innerHTML = res.rows.map((b, idx) => {
    const phone = b[0];
    const mem = b[1];
    const service = b[2];
    const date = b[3];
    const time = b[4];
    const status = b[5];

    return `
      <div style="border:1px solid #E5E7EB;border-radius:10px;padding:6px 8px;margin-bottom:6px;font-size:13px;">
        <b>Ø§Ù„Ø®Ø¯Ù…Ø©:</b> ${service}<br>
        <b>Ø§Ù„ØªØ§Ø±ÙŠØ®:</b> ${date} ${time}<br>
        <b>Ø§Ù„Ø¬ÙˆØ§Ù„:</b> ${phone}<br>
        <b>Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©:</b> ${mem || "â€”"}<br>
        <b>Ø§Ù„Ø­Ø§Ù„Ø©:</b> <span class="tag">${status}</span><br>
        <button class="btn" style="margin-top:4px;font-size:11px;padding:4px 8px;" onclick="updateBooking(${idx+2},'Ù…Ø¤ÙƒØ¯')">ØªØ£ÙƒÙŠØ¯</button>
        <button class="btn-outline" style="margin-top:4px;font-size:11px;padding:4px 8px;" onclick="updateBooking(${idx+2},'Ù…Ù„ØºÙŠ')">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    `;
  }).join("");
}

async function updateBooking(row,status){
  const res = await apiPost({
    action:"updateRow",
    sheet:"Bookings",
    row,
    values:JSON.stringify([null,null,null,null,null,status,null])
  });
  if(!res.success){
    alert("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø¬Ø²");
    return;
  }
  alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø¬Ø² Ø¥Ù„Ù‰: " + status);
  loadBookings();
}

/* ============================
   Ø§Ù„ÙÙˆØ§ØªÙŠØ± ÙˆÙ…Ø´Ø§Ø±ÙƒØªÙ‡Ø§
============================ */

let INVOICE_STATE = {
  customer:null,
  visits:[]
};

async function searchInvoices(){
  const q = document.getElementById("invoiceSearch").value.trim();
  const box = document.getElementById("invoiceVisits");
  box.innerHTML = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...";

  if(!q){
    box.innerHTML = "Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø£Ùˆ Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©.";
    return;
  }

  let custRes = null;

  if(/^05\d{8}$/.test(q)){
    custRes = await apiGetCustomerByPhone(q);
  } else {
    custRes = await apiGetCustomerByMembership(q);
  }

  if(!custRes.success){
    box.innerHTML = "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙŠÙ„.";
    return;
  }

  const c = custRes.customer;
  INVOICE_STATE.customer = {
    name:c[0],
    phone:c[1],
    membership:c[8]
  };

  const visitsRes = await apiGetVisitsByMembership(c[8]);
  if(!visitsRes.success || !visitsRes.visits.length){
    box.innerHTML = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø²ÙŠØ§Ø±Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„.";
    INVOICE_STATE.visits = [];
    return;
  }

  INVOICE_STATE.visits = visitsRes.visits.map(v => v.data);

  box.innerHTML = INVOICE_STATE.visits.map((v,idx) => `
    <div style="border-bottom:1px solid #E5E7EB;padding:4px 0;font-size:13px;">
      #${idx+1} â€” ${v[1]} â€” ${v[2]} Ø±ÙŠØ§Ù„ â€” ${v[8]}
    </div>
  `).join("");
}

function sendInvoice(mode){
  if(!INVOICE_STATE.customer || !INVOICE_STATE.visits.length){
    alert("Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹.");
    return;
  }

  let selectedVisits = [];
  if(mode === "last"){
    selectedVisits = [INVOICE_STATE.visits[INVOICE_STATE.visits.length-1]];
  } else {
    selectedVisits = INVOICE_STATE.visits;
  }

  const c = INVOICE_STATE.customer;

  let total = 0;
  let lines = selectedVisits.map((v,idx) => {
    total += Number(v[2] || 0);
    return `${idx+1}- ${v[1]} â€” ${v[2]} Ø±ÙŠØ§Ù„ (${v[8]})`;
  }).join("\n");

  const msg =
    `ÙØ§ØªÙˆØ±Ø© Ø²ÙŠØ§Ø±Ø§Øª Ù…ØºØ³Ù„Ø© Ø±ØºÙˆØ© Ø§Ù„Ù‡Ø¬ÙŠÙ†\n` +
    `Ø§Ù„Ø¹Ù…ÙŠÙ„: ${c.name}\n` +
    `Ø§Ù„Ø¬ÙˆØ§Ù„: ${c.phone}\n` +
    `Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©: ${c.membership}\n\n` +
    `Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª:\n${lines}\n\n` +
    `Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${total} Ø±ÙŠØ§Ù„`;

  const url = `https://wa.me/?text=${encodeURIComponent(msg)}`;
  window.open(url,"_blank");
}

/* ============================
   ØªØ´ØºÙŠÙ„ Ø£ÙˆÙ„ÙŠ
============================ */

loadTodaySummary();
loadCustomers();
loadActiveVisits();
loadBookings();
</script>

</body>
</html>
