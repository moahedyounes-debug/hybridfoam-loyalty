<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø´Ø±Ù</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body {
    font-family: "Tajawal", sans-serif;
    background: #f4f6f9;
    margin: 0;
}

.tabs {
    display: flex;
    overflow-x: auto;
    background: #2563eb;
    color: white;
}

.tab {
    padding: 14px 20px;
    cursor: pointer;
    white-space: nowrap;
}

.tab.active {
    background: #1e40af;
}

.section {
    display: none;
    padding: 15px;
}

.section.active {
    display: block;
}

.card {
    background: white;
    padding: 15px;
    border-radius: 12px;
    margin-bottom: 15px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

input, select, button, textarea {
    width: 100%;
    padding: 12px;
    margin-top: 10px;
    border-radius: 8px;
    border: 1px solid #ccc;
}

button {
    background: #2563eb;
    color: white;
    border: none;
    font-size: 16px;
}

button.loading {
    background: #6b7280 !important;
}

.chart-box {
    width: 100%;
    height: 200px;
    background: white;
    border-radius: 12px;
    margin-bottom: 15px;
}

.car-btn {
    padding: 12px;
    background: #f3f3f3;
    border-radius: 10px;
    margin-top: 8px;
    cursor: pointer;
    border: 1px solid #ddd;
}
.car-btn:hover {
    background: #e5e5e5;
}
</style>
</head>

<body>

<!-- Tabs -->
<div class="tabs">
    <div class="tab active" onclick="showTab('dashboard', this)">Dashboard</div>
    <div class="tab" onclick="showTab('search', this)">Ø¨Ø­Ø« Ø¹Ù…ÙŠÙ„</div>
    <div class="tab" onclick="showTab('visits', this)">Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</div>
    <div class="tab" onclick="showTab('cars', this)">Ø³ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</div>
    <div class="tab" onclick="showTab('notify', this)">Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±</div>
    <div class="tab" onclick="showTab('addVisit', this)">Ø¥Ø¶Ø§ÙØ© Ø²ÙŠØ§Ø±Ø©</div>
    <div class="tab" onclick="showTab('bookings', this)">Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</div>
    <div class="tab" onclick="showTab('ratings', this)">Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</div>
</div>

<!-- Dashboard -->
<div id="dashboard" class="section active">
    <h2>Dashboard</h2>
    <div class="card">
        <h3>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h3>
        <p id="stats">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
    </div>
    <div class="chart-box" id="chart">ğŸ“Š Ø§Ù„Ø´Ø§Ø±Øª Ù‡Ù†Ø§</div>
</div>

<!-- Search Customer -->
<div id="search" class="section">
    <h2>Ø¨Ø­Ø« Ø¹Ù† Ø¹Ù…ÙŠÙ„</h2>
    <input id="searchPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©">
    <button id="searchBtn" onclick="searchCustomer()">Ø¨Ø­Ø«</button>

    <button onclick="startScanner()" style="background:#16a34a;margin-top:10px">Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</button>
    <div id="reader" style="width:100%;margin-top:15px;display:none;"></div>

    <div id="searchResult"></div>
</div>

<!-- Customer Visits -->
<div id="visits" class="section">
    <h2>Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</h2>
    <input id="visitsPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„">
    <button id="visitsBtn" onclick="loadCustomerVisits()">Ø¹Ø±Ø¶ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª</button>
    <div id="visitsList"></div>
</div>

<!-- Customer Cars -->
<div id="cars" class="section">
    <h2>Ø³ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</h2>
    <input id="carsPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„">
    <button id="carsBtn" onclick="loadCustomerCars()">Ø¹Ø±Ø¶ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</button>
    <div id="carsList"></div>
</div>

<!-- Send Notification -->
<div id="notify" class="section">
    <h2>Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±</h2>
    <input id="notifyPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„">
    <textarea id="notifyMsg" placeholder="Ù†Øµ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±"></textarea>
    <button id="notifyBtn" onclick="sendNotification()">Ø¥Ø±Ø³Ø§Ù„</button>
    <p id="notifyStatus"></p>
</div>

<!-- Add Visit (NEW VERSION) -->
<div id="addVisit" class="section">
    <h2>Ø¥Ø¶Ø§ÙØ© Ø²ÙŠØ§Ø±Ø©</h2>

    <div class="card">
        <label>Ø§Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø£Ùˆ Ø§Ù„Ø¹Ø¶ÙˆÙŠØ© Ø£Ùˆ Ù„ÙˆØ­Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø©</label>
        <input id="visitSearch" placeholder="05xxxxxxx Ø£Ùˆ 12345 Ø£Ùˆ ABC 1234">
        <button id="visitSearchBtn" onclick="searchVisitCustomer()">Ø¨Ø­Ø«</button>
    </div>

    <div id="visitCarsBox" class="card" style="display:none;">
        <h3>Ø§Ø®ØªØ± Ø§Ù„Ø³ÙŠØ§Ø±Ø©</h3>
        <div id="visitCarsList"></div>
    </div>

    <div id="visitForm" class="card" style="display:none;">
        <h3>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø²ÙŠØ§Ø±Ø©</h3>

        <label>Ø§Ù„Ø®Ø¯Ù…Ø©</label>
        <select id="vService" onchange="updateVisitPrice()"></select>

        <label>Ø§Ù„Ø³Ø¹Ø±</label>
        <input type="number" id="vPrice" onchange="updateVisitPoints()">

        <label>Ø§Ù„Ù†Ù‚Ø§Ø·</label>
        <input type="number" id="vPoints" readonly>

        <label>Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
        <input id="vEmployee">

        <label>Ø§Ù„ÙØ±Ø¹</label>
        <select id="vBranch">
            <option value="Ù…ÙƒØ©">Ù…ÙƒØ©</option>
        </select>

        <button id="addVisitBtn" onclick="submitVisit()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø²ÙŠØ§Ø±Ø©</button>
        <p id="addVisitStatus"></p>
    </div>
</div>

<!-- Bookings -->
<div id="bookings" class="section">
    <h2>Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</h2>
    <div id="bookingsList">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
</div>

<!-- Ratings -->
<div id="ratings" class="section">
    <h2>Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</h2>
    <div id="ratingsList">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
</div>

<script src="api.js?v=3"></script>

<script>
function showTab(id, el) {
    document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
    document.getElementById(id).classList.add("active");

    document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
    el.classList.add("active");
}

/* ========== Dashboard ========== */
async function loadDashboard() {
    const res = await apiGet({ action: "getOwnersDashboard" });
    document.getElementById("stats").innerHTML = `
        Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡: ${res.totals.customers}<br>
        Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª: ${res.totals.cars}<br>
        Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª: ${res.totals.visits}<br>
        Ø§Ù„Ù…Ø¨Ø§Ù„Øº: ${res.totals.amount}
    `;
}

/* ========== Barcode Scanner ========== */
let scanner = null;

function startScanner() {
    const reader = document.getElementById("reader");
    reader.style.display = "block";

    scanner = new Html5Qrcode("reader");
    scanner.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        (decodedText) => {
            document.getElementById("searchPhone").value = decodedText;
            scanner.stop();
            reader.style.display = "none";
            searchCustomer();
        }
    ).catch(() => alert("Ù„Ø§ ÙŠÙ…ÙƒÙ† ÙØªØ­ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§"));
}

/* ========== Search Customer ========== */
async function searchCustomer() {
    const btn = document.getElementById("searchBtn");
    btn.classList.add("loading");
    btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...";

    const phone = document.getElementById("searchPhone").value;
    const res = await apiGet({ action: "getByPhone", phone });

    btn.classList.remove("loading");
    btn.innerText = "Ø¨Ø­Ø«";

    if (!res.success) {
        document.getElementById("searchResult").innerHTML = "ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯";
        return;
    }

    document.getElementById("searchResult").innerHTML = `
        <div class="card">
            Ø§Ù„Ø§Ø³Ù…: ${res.customer.name}<br>
            Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©: ${res.customer.membership}<br>
            Ø§Ù„Ù†Ù‚Ø§Ø·: ${res.customer.points}<br>
            Ø§Ù„Ù…Ø³ØªÙˆÙ‰: ${res.customer.level}
        </div>
    `;
}

/* ========== Customer Visits ========== */
async function loadCustomerVisits() {
    const btn = document.getElementById("visitsBtn");
    btn.classList.add("loading");
    btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...";

    const phone = document.getElementById("visitsPhone").value;
    const res = await apiGet({ action: "getVisitsByPhone", phone });

    btn.classList.remove("loading");
    btn.innerText = "Ø¹Ø±Ø¶ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª";

    let html = "";
    res.visits.forEach(v => {
        html += `
            <div class="card">
                ${v.service} - ${v.date}<br>
                Ø§Ù„Ø³Ø¹Ø±: ${v.price}<br>
                Ø§Ù„Ù†Ù‚Ø§Ø·: ${v.points}
            </div>
        `;
    });

    document.getElementById("visitsList").innerHTML = html;
}

/* ========== Customer Cars ========== */
async function loadCustomerCars() {
    const btn = document.getElementById("carsBtn");
    btn.classList.add("loading");
    btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...";

    const phone = document.getElementById("carsPhone").value;
    const res = await apiGet({ action: "getCarsByPhone", phone });

    btn.classList.remove("loading");
    btn.innerText = "Ø¹Ø±Ø¶ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª";

    let html = "";
    res.cars.forEach(c => {
        html += `
            <div class="card">
                ${c.car} - ${c.plate_letters} ${c.plate_numbers}<br>
                Ø§Ù„Ø­Ø¬Ù…: ${c.size}<br>
                Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©: ${c.city}
            </div>
        `;
    });

    document.getElementById("carsList").innerHTML = html;
}

/* ========== Send Notification ========== */
async function sendNotification() {
    const btn = document.getElementById("notifyBtn");
    btn.classList.add("loading");
    btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...";

    const msg = document.getElementById("notifyMsg").value;

    await apiPost({
        action: "addRating",
        membership: "",
        rating: 0,
        comment: msg
    });

    btn.classList.remove("loading");
    btn.innerText = "Ø¥Ø±Ø³Ø§Ù„";
    document.getElementById("notifyStatus").innerText = "ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„";
}

/* ============================================================
   NEW ADD VISIT SYSTEM
============================================================ */

let visitSelectedMembership = null;
let visitServices = {};

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø§Øª
async function loadVisitServices() {
    const res = await apiGet({ action: "getCommissions" });

    const select = document.getElementById("vService");
    select.innerHTML = "";

    res.commissions.forEach(s => {
        visitServices[s.service] = Number(s.price || 0);

        const opt = document
