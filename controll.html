<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - CarTech</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
:root {
  --bg: #020617;
  --bg-soft: #0f172a;
  --card: #0f172a;
  --border: #1e293b;
  --accent: #2563eb;
  --danger: #dc2626;
  --success: #16a34a;
  --text-main: #f8fafc;
  --text-muted: #94a3b8;
  --radius-lg: 16px;
  --radius-md: 12px;
  --shadow-soft: 0 18px 45px rgba(0,0,0,0.4);
}

body {
  margin: 0;
  font-family: "Tajawal", sans-serif;
  background: var(--bg);
  color: var(--text-main);
}

.layout {
  display: flex;
  min-height: 100vh;
}

.sidebar {
  width: 260px;
  background: var(--bg-soft);
  border-left: 1px solid var(--border);
  padding: 18px 14px;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.brand {
  display: flex;
  align-items: center;
  gap: 10px;
}

.brand-logo {
  width: 40px;
  height: 40px;
  border-radius: 12px;
  background: #1e293b;
  display: flex;
  align-items: center;
  justify-content: center;
}

.brand-text {
  font-size: 18px;
  font-weight: 600;
}

.nav-section-title {
  font-size: 11px;
  color: var(--text-muted);
  margin-top: 12px;
}

.nav {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.nav-btn {
  padding: 10px;
  background: transparent;
  border: none;
  color: var(--text-muted);
  text-align: right;
  border-radius: 10px;
  cursor: pointer;
  transition: 0.2s;
}

.nav-btn.active,
.nav-btn:hover {
  background: rgba(37,99,235,0.25);
  color: var(--text-main);
}

.main {
  flex: 1;
  display: flex;
  flex-direction: column;
}

.topbar {
  padding: 12px 18px;
  background: var(--bg-soft);
  border-bottom: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.topbar-title {
  font-size: 18px;
  font-weight: 600;
}

.topbar-sub {
  font-size: 12px;
  color: var(--text-muted);
}

.stats-bar {
  display: flex;
  gap: 8px;
  align-items: center;
}

.pill {
  padding: 4px 10px;
  border-radius: 999px;
  background: var(--bg);
  border: 1px solid var(--border);
  font-size: 12px;
  color: var(--text-muted);
}

.content {
  padding: 18px;
  display: flex;
  flex-direction: column;
  gap: 18px;
}

.section { display: none; }
.section.active { display: block; }

.card {
  background: var(--card);
  border-radius: var(--radius-lg);
  padding: 16px;
  border: 1px solid var(--border);
  box-shadow: var(--shadow-soft);
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

label {
  font-size: 13px;
  color: var(--text-muted);
  margin-bottom: 4px;
}

input, select {
  width: 100%;
  padding: 10px;
  border-radius: var(--radius-md);
  border: 1px solid var(--border);
  background: var(--bg);
  color: var(--text-main);
  margin-bottom: 10px;
}

button {
  padding: 10px 12px;
  border-radius: var(--radius-md);
  border: none;
  background: var(--accent);
  color: white;
  cursor: pointer;
<div class="content">

<!-- ========== DASHBOARD ========== -->
<section id="dashboard" class="section active">
  <div class="card">
    <div class="card-header">
      <h2>Ù…Ù„Ø®Øµ Ø§Ù„ÙØ±Ø¹</h2>
    </div>

    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-top:10px;">
      <div class="card"><div>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</div><div id="dTotalCustomers" style="font-size:22px;font-weight:600;">0</div></div>
      <div class="card"><div>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª</div><div id="dTotalVisits" style="font-size:22px;font-weight:600;">0</div></div>
      <div class="card"><div>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ø§Ù„Øº</div><div id="dTotalAmount" style="font-size:22px;font-weight:600;">0</div></div>
      <div class="card"><div>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©</div><div id="dTotalCommission" style="font-size:22px;font-weight:600;">0</div></div>
    </div>

    <div style="margin-top:20px;">
      <canvas id="visitsChart" height="80"></canvas>
    </div>
  </div>
</section>

<!-- ========== SEARCH CUSTOMER ========== -->
<section id="customers" class="section">
  <div class="card">
    <div class="card-header"><h2>Ø¨Ø­Ø« Ø¹Ù† Ø¹Ù…ÙŠÙ„</h2></div>

    <label>Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©</label>
    <input id="searchPhone" placeholder="05xxxxxxxx Ø£Ùˆ 2026xxxx">
    <button id="searchBtn">Ø¨Ø­Ø«</button>

    <div id="searchResult" style="margin-top:10px;"></div>
  </div>
</section>

<!-- ========== BRANCH VISITS ========== -->
<section id="visits" class="section">
  <div class="card">
    <div class="card-header"><h2>Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„ÙØ±Ø¹</h2></div>

    <label>Ø§Ø®ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ® (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
    <input id="visitsDate" class="datePicker" placeholder="YYYY-MM-DD">
    <button id="visitsBtn">Ø¹Ø±Ø¶ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª</button>

    <div id="visitsList" class="list" style="margin-top:10px;"></div>
  </div>
</section>

<!-- ========== CUSTOMER CARS ========== -->
<section id="cars" class="section">
  <div class="card">
    <div class="card-header"><h2>Ø³ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</h2></div>

    <label>Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</label>
    <input id="carsPhone" placeholder="05xxxxxxxx">
    <button id="carsBtn">Ø¹Ø±Ø¶ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</button>

    <div id="carsList" class="list" style="margin-top:10px;"></div>
  </div>
</section>

<!-- ========== ADD VISIT (NEW VERSION) ========== -->
<section id="addVisit" class="section">
  <div class="card">
    <div class="card-header"><h2>Ø¥Ø¶Ø§ÙØ© Ø²ÙŠØ§Ø±Ø©</h2></div>

    <!-- Ø¨Ø­Ø« -->
    <div class="card" style="background:var(--bg-soft);margin-bottom:10px;">
      <div class="card-header"><h3>Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„</h3></div>

      <label>Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ / Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¶ÙˆÙŠØ© / Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø©</label>
      <input id="visitSearch" placeholder="05xxxxxxxx Ø£Ùˆ 2026xxxx Ø£Ùˆ Ù„ÙˆØ­Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø©">
      <button id="visitSearchBtn">Ø¨Ø­Ø«</button>
    </div>

    <!-- Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø³ÙŠØ§Ø±Ø© -->
    <div id="visitCarsBox" class="card" style="display:none;background:var(--bg-soft);margin-bottom:10px;">
      <div class="card-header"><h3>Ø§Ø®ØªØ± Ø§Ù„Ø³ÙŠØ§Ø±Ø©</h3></div>
      <div id="visitCarsList" class="list"></div>
    </div>

    <!-- Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø²ÙŠØ§Ø±Ø© -->
    <div id="visitForm" class="card" style="display:none;background:var(--bg-soft);">
      <div class="card-header"><h3>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø²ÙŠØ§Ø±Ø©</h3></div>

      <p id="visitSelectedInfo" style="font-size:12px;color:var(--text-muted);"></p>

      <!-- Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø© (E) -->
      <label>Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©</label>
      <select id="vService"></select>

      <!-- ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø© (A) -->
      <label>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø©</label>
      <select id="vServiceDetail"></select>

      <!-- Ø§Ù„Ø³Ø¹Ø± -->
      <label>Ø§Ù„Ø³Ø¹Ø±</label>
      <input type="number" id="vPrice">

      <!-- Ø§Ù„Ø¹Ù…ÙˆÙ„Ø© -->
      <label>Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©</label>
      <input type="number" id="vCommission" readonly>

      <!-- Ø§Ù„Ù†Ù‚Ø§Ø· -->
      <label>Ø§Ù„Ù†Ù‚Ø§Ø·</label>
      <input type="number" id="vPoints" readonly>

      <!-- Ø§Ù„Ù…ÙˆØ¸Ù -->
      <label>Ø§Ù„Ù…ÙˆØ¸Ù (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
      <select id="vEmployee">
        <option value="">Ø¨Ø¯ÙˆÙ† Ù…ÙˆØ¸Ù</option>
      </select>

      <!-- Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆÙ‚Ù -->
      <label>Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆÙ‚Ù</label>
      <select id="vParkingSlot">
        <option value="">Ø¨Ø¯ÙˆÙ†</option>
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
        <option value="6">6</option>
      </select>

      <!-- Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹ -->
      <label>Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹</label>
      <select id="vPaymentStatus">
        <option value="Paid">Ù…Ø¯ÙÙˆØ¹</option>
        <option value="Pending">ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹</option>
      </select>

      <button id="addVisitBtn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø²ÙŠØ§Ø±Ø©</button>

      <p id="addVisitStatus" style="font-size:12px;color:var(--text-muted);margin-top:6px;"></p>
    </div>
  </div>
</section>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="api.js?v=3"></script>

<script>
const $ = (id)=>document.getElementById(id);

/* ===========================
   THEME
=========================== */
(function(){
  const saved = localStorage.getItem("sup_theme") || "dark";
  document.body.setAttribute("data-theme", saved);

  const toggle = document.createElement("button");
  toggle.textContent = "ğŸŒ™ / â˜€ï¸";
  toggle.className = "pill";
  toggle.style.cursor = "pointer";
  toggle.onclick = ()=>{
    const next = document.body.getAttribute("data-theme")==="dark" ? "light" : "dark";
    document.body.setAttribute("data-theme", next);
    localStorage.setItem("sup_theme", next);
  };
  document.querySelector(".stats-bar").appendChild(toggle);
})();

/* ===========================
   NAVIGATION
=========================== */
document.querySelectorAll(".nav-btn").forEach(btn=>{
  btn.onclick = ()=>{
    document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
    document.getElementById(btn.dataset.target).classList.add("active");

    document.querySelectorAll(".nav-btn").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
  };
});

/* ===========================
   DATE PICKERS
=========================== */
flatpickr(".datePicker",{dateFormat:"Y-m-d",allowInput:true});

/* ===========================
   GLOBAL VARS
=========================== */
let currentBranch = null;
let employeesList = [];
let servicesMap = {};
let selectedMembership = null;
let selectedCar = null;

/* ===========================
   LOAD BRANCHES
=========================== */
async function loadBranches(){
  const res = await apiGet({action:"getBranches"});
  const select = document.createElement("select");
  select.id = "branchSelect";
  select.style.padding = "6px";
  select.style.borderRadius = "8px";
  select.style.background = "var(--bg)";
  select.style.color = "var(--text-main)";
  select.style.border = "1px solid var(--border)";

  res.branches.forEach(b=>{
    const opt = document.createElement("option");
    opt.value = b.branch;
    opt.textContent = `${b.branch} â€” ${b.city}`;
    select.appendChild(opt);
  });

  const saved = localStorage.getItem("supervisor_branch");
  currentBranch = saved || res.branches[0].branch;
  select.value = currentBranch;

  select.onchange = ()=>{
    currentBranch = select.value;
    localStorage.setItem("supervisor_branch", currentBranch);
    loadDashboard();
    loadBookings();
  };

  document.querySelector(".topbar-left").appendChild(select);
}

/* ===========================
   LOAD EMPLOYEES
=========================== */
async function loadEmployees(){
  const res = await apiGet({action:"getEmployees"});
  employeesList = res.employees || [];

  const sel = $("vEmployee");
  sel.innerHTML = `<option value="">Ø¨Ø¯ÙˆÙ† Ù…ÙˆØ¸Ù</option>`;

  employeesList.forEach(e=>{
    const opt = document.createElement("option");
    opt.value = e.employee;
    opt.textContent = e.employee;
    sel.appendChild(opt);
  });
}

/* ===========================
   LOAD SERVICES (TYPE + DETAIL)
=========================== */
async function loadServices(){
  const res = await apiGet({action:"getCommissions"});
  const selType = $("vService");
  const selDetail = $("vServiceDetail");

  selType.innerHTML = "";
  selDetail.innerHTML = "";

  servicesMap = {};

  res.commissions.forEach(c=>{
    if (!c.type) return;

    if (!servicesMap[c.type]) servicesMap[c.type] = [];

    servicesMap[c.type].push({
      detail: c.detail,
      price: c.price,
      commission: c.commission
    });
  });

  Object.keys(servicesMap).forEach(type=>{
    const opt = document.createElement("option");
    opt.value = type;
    opt.textContent = type;
    selType.appendChild(opt);
  });

  updateServiceDetails();
}

function updateServiceDetails(){
  const type = $("vService").value;
  const selDetail = $("vServiceDetail");
  selDetail.innerHTML = "";

  if (!servicesMap[type]) return;

  servicesMap[type].forEach(s=>{
    const opt = document.createElement("option");
    opt.value = s.detail;
    opt.textContent = s.detail;
    selDetail.appendChild(opt);
  });

  updatePriceAndCommission();
}

$("vService").onchange = updateServiceDetails;
$("vServiceDetail").onchange = updatePriceAndCommission;

/* ===========================
   PRICE + COMMISSION
=========================== */
function updatePriceAndCommission(){
  const type = $("vService").value;
  const detail = $("vServiceDetail").value;

  const service = servicesMap[type].find(s=>s.detail === detail);
  if (!service) return;

  $("vPrice").value = service.price;
  $("vCommission").value = service.commission;
  $("vPoints").value = Math.floor(service.price / 5);
}
/* ===========================
   DASHBOARD
=========================== */
async function loadDashboard(){
  const res = await apiGet({
    action:"getVisitsByDate",
    from:"2000-01-01T00:00:00.000Z",
    to:"2100-01-01T23:59:59.000Z"
  });

  const visits = (res.visits || []).filter(v=>v.branch === currentBranch);

  const totalAmount = visits.reduce((s,v)=>s + Number(v.price||0), 0);
  const totalVisits = visits.length;
  const totalCommission = visits.reduce((s,v)=>s + Number(v.commission||0), 0);
  const customers = new Set(visits.map(v=>v.membership)).size;

  $("dTotalAmount").textContent = totalAmount;
  $("dTotalVisits").textContent = totalVisits;
  $("dTotalCustomers").textContent = customers;
  $("dTotalCommission").textContent = totalCommission;

  const map = {};
  visits.forEach(v=>{
    map[v.date] = (map[v.date] || 0) + 1;
  });

  const labels = Object.keys(map).sort();
  const data = labels.map(l=>map[l]);

  new Chart($("visitsChart"),{
    type:"line",
    data:{labels,datasets:[{label:"Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª",data,borderColor:"#2563eb"}]},
    options:{responsive:true,plugins:{legend:{display:false}}}
  });
}

/* ===========================
   SMART SEARCH
=========================== */
async function smartSearch(q){
  if(q.startsWith("05") && q.length===10){
    return await apiGet({action:"getByPhone",phone:q});
  }
  if(/^\d+$/.test(q)){
    return await apiGet({action:"getByMembership",membership:q});
  }
  return await apiGet({action:"getByPlate",plate:q});
}

/* ===========================
   SEARCH CUSTOMER
=========================== */
$("searchBtn").onclick = async ()=>{
  const q = $("searchPhone").value.trim();
  const res = await smartSearch(q);

  const box = $("searchResult");
  box.innerHTML = "";

  if(!res || !res.success){
    box.innerHTML = "<div class='card'>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>";
    return;
  }

  const c = res.customer;
  box.innerHTML = `
    <div class="card">
      Ø§Ù„Ø§Ø³Ù…: ${c.name}<br>
      Ø§Ù„Ø¬ÙˆØ§Ù„: ${c.phone}<br>
      Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©: ${c.membership}<br>
      Ø§Ù„Ù†Ù‚Ø§Ø·: ${c.points}<br>
      Ø§Ù„Ù…Ø³ØªÙˆÙ‰: ${c.level}<br>
      Ø¢Ø®Ø± Ø²ÙŠØ§Ø±Ø©: ${c.last_visit || "â€”"}<br>
      Ø¹Ø¯Ø¯ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª: ${c.visit_count}
    </div>
  `;
};

/* ===========================
   BRANCH VISITS
=========================== */
$("visitsBtn").onclick = async ()=>{
  const date = $("visitsDate").value.trim();
  const from = date ? date+"T00:00:00.000Z" : "2000-01-01T00:00:00.000Z";
  const to   = date ? date+"T23:59:59.000Z" : "2100-01-01T23:59:59.000Z";

  const res = await apiGet({action:"getVisitsByDate",from,to});
  const list = $("visitsList");
  list.innerHTML = "";

  const visits = (res.visits||[]).filter(v=>v.branch===currentBranch);

  if(!visits.length){
    list.innerHTML = "<div class='card'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø²ÙŠØ§Ø±Ø§Øª</div>";
    return;
  }

  visits.forEach(v=>{
    const div = document.createElement("div");
    div.className="card";
    div.innerHTML = `
      Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©: ${v.membership}<br>
      Ø§Ù„Ø®Ø¯Ù…Ø©: ${v.service}<br>
      Ø§Ù„Ø³Ø¹Ø±: ${v.price}<br>
      Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©: ${v.commission}<br>
      Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹: ${v.payment_status}<br>
      Ø§Ù„Ù…ÙˆÙ‚Ù: ${v.parking_slot}<br>
      Ø§Ù„ØªØ§Ø±ÙŠØ®: ${v.date}
    `;
    list.appendChild(div);
  });
};

/* ===========================
   CUSTOMER CARS
=========================== */
$("carsBtn").onclick = async ()=>{
  const phone = $("carsPhone").value.trim();
  const res = await apiGet({action:"getCarsByPhone",phone});
  const list = $("carsList");
  list.innerHTML = "";

  if(!res.cars || !res.cars.length){
    list.innerHTML = "<div class='card'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³ÙŠØ§Ø±Ø§Øª</div>";
    return;
  }

  res.cars.forEach(c=>{
    const div = document.createElement("div");
    div.className="card";
    div.innerHTML = `
      ${c.car} â€” ${c.plate_letters} ${c.plate_numbers}<br>
      Ø§Ù„Ø­Ø¬Ù…: ${c.size}<br>
      Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©: ${c.city}<br>
      Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©: ${c.membership}
    `;
    list.appendChild(div);
  });
};

/* ===========================
   ADD VISIT â€” SEARCH
=========================== */
$("visitSearchBtn").onclick = async ()=>{
  const q = $("visitSearch").value.trim();
  const res = await smartSearch(q);

  const box = $("visitCarsBox");
  const list = $("visitCarsList");
  list.innerHTML = "";

  if(!res || !res.cars || !res.cars.length){
    alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³ÙŠØ§Ø±Ø§Øª");
    box.style.display="none";
    $("visitForm").style.display="none";
    return;
  }

  box.style.display="block";

  res.cars.forEach(c=>{
    const div = document.createElement("div");
    div.className="card";
    div.style.cursor="pointer";
    div.innerHTML = `
      ${c.car} â€” ${c.plate_letters} ${c.plate_numbers}<br>
      Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©: ${c.membership}
    `;
    div.onclick = ()=>{
      selectedMembership = c.membership;
      selectedCar = c;

      $("visitSelectedInfo").textContent =
        `Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©: ${c.membership} â€” Ø§Ù„Ø³ÙŠØ§Ø±Ø©: ${c.car} â€” Ø§Ù„Ù„ÙˆØ­Ø©: ${c.plate_letters} ${c.plate_numbers}`;

      $("visitForm").style.display="block";
    };
    list.appendChild(div);
  });
};

/* ===========================
   ADD VISIT â€” SUBMIT
=========================== */
$("addVisitBtn").onclick = async ()=>{
  if(!selectedMembership) return alert("Ø§Ø®ØªØ± Ø§Ù„Ø³ÙŠØ§Ø±Ø©");

  const type = $("vService").value;
  const detail = $("vServiceDetail").value;

  const service = detail;
  const price = Number($("vPrice").value);
  const points = Number($("vPoints").value);
  const employee = $("vEmployee").value;
  const payment_status = $("vPaymentStatus").value;
  const parking_slot = $("vParkingSlot").value;

  const res = await apiPost({
    action:"addVisit",
    membership:selectedMembership,
    service,
    price,
    points,
    employee,
    branch:currentBranch,
    rating:"",
    payment_status,
    parking_slot
  });

  $("addVisitStatus").textContent = res.success ? "âœ” ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø²ÙŠØ§Ø±Ø©" : "âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„";

  if(res.success) loadDashboard();
};

/* ===========================
   BOOKINGS
=========================== */
async function loadBookings(){
  const res = await apiGet({action:"getBookings"});
  const list = $("bookingsList");
  if(!list) return;

  list.innerHTML = "";

  if(!res.bookings || !res.bookings.length){
    list.innerHTML = "<div class='card'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª</div>";
    return;
  }

  res.bookings.forEach(b=>{
    const div = document.createElement("div");
    div.className="card";
    div.innerHTML = `
      Ø§Ù„Ø¬ÙˆØ§Ù„: ${b.phone}<br>
      Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©: ${b.membership}<br>
      Ø§Ù„Ø®Ø¯Ù…Ø©: ${b.service}<br>
      Ø§Ù„ØªØ§Ø±ÙŠØ®: ${b.date} ${b.time}<br>
      Ø§Ù„Ø­Ø§Ù„Ø©: ${b.status}<br><br>
      <button class="btn-secondary" onclick="confirmBooking(${b.row})">ØªØ£ÙƒÙŠØ¯</button>
      <button class="btn-danger" onclick="cancelBooking(${b.row})">Ø¥Ù„ØºØ§Ø¡</button>
    `;
    list.appendChild(div);
  });
}

async function confirmBooking(row){
  await apiPost({action:"updateBookingStatus",row,status:"Approved"});
  loadBookings();
}

async function cancelBooking(row){
  await apiPost({action:"updateBookingStatus",row,status:"Cancelled"});
  loadBookings();
}

/* ===========================
   EXPORT EXCEL
=========================== */
$("exportBtn").onclick = async ()=>{
  const from = $("exportFrom").value.trim();
  const to = $("exportTo").value.trim();

  if(!from || !to) return alert("Ø§Ø®ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ®");

  const res = await apiGet({
    action:"getVisitsByDate",
    from:from+"T00:00:00.000Z",
    to:to+"T23:59:59.000Z"
  });

  const visits = (res.visits||[]).filter(v=>v.branch===currentBranch);

  if(!visits.length){
    alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª");
    return;
  }

  const data = visits.map(v=>({
    "Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©": v.membership,
    "Ø§Ù„Ø®Ø¯Ù…Ø©": v.service,
    "Ø§Ù„Ø³Ø¹Ø±": v.price,
    "Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©": v.commission,
    "Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹": v.payment_status,
    "Ø§Ù„Ù…ÙˆÙ‚Ù": v.parking_slot,
    "Ø§Ù„ØªØ§Ø±ÙŠØ®": v.date
  }));

  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Report");

  XLSX.writeFile(wb, `Report-${currentBranch}-${from}-to-${to}.xlsx`);
};

/* ===========================
   INIT
=========================== */
(async function init(){
  await loadBranches();
  await loadEmployees();
  await loadServices();
  await loadDashboard();
  await loadBookings();
})();
</script>

</body>
</html>
