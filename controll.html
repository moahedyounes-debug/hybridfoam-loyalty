<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>لوحة المشرف</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- مكتبة الباركود -->
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
    :root {
        --bg: #0f172a;
        --bg-soft: #111827;
        --accent: #2563eb;
        --accent-soft: #1d4ed8;
        --card-bg: #0b1120;
        --border: #1f2937;
        --text-main: #f9fafb;
        --text-muted: #9ca3af;
        --danger: #dc2626;
        --success: #16a34a;
    }

    * { box-sizing: border-box; }

    body {
        margin: 0;
        font-family: "Tajawal", sans-serif;
        background: var(--bg);
        color: var(--text-main);
        direction: rtl;
    }

    .layout {
        display: flex;
        min-height: 100vh;
    }

    /* Sidebar */
    .sidebar {
        width: 260px;
        background: var(--bg-soft);
        border-left: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        padding: 20px 16px;
    }

    .brand {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 24px;
    }

    .brand-logo {
        width: 40px;
        height: 40px;
        border-radius: 12px;
        background: linear-gradient(135deg, #2563eb, #4f46e5);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 18px;
    }

    .brand-text {
        font-size: 18px;
        font-weight: 600;
    }

    .nav-section-title {
        font-size: 12px;
        color: var(--text-muted);
        margin: 10px 4px;
    }

    .nav {
        display: flex;
        flex-direction: column;
        gap: 6px;
        margin-bottom: 20px;
    }

    .nav-btn {
        width: 100%;
        text-align: right;
        padding: 10px 12px;
        border-radius: 10px;
        border: none;
        background: transparent;
        color: var(--text-muted);
        font-size: 14px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between;
        transition: 0.15s;
    }

    .nav-btn.active {
        background: rgba(37, 99, 235, 0.18);
        color: var(--text-main);
    }

    .nav-btn:hover {
        background: rgba(15, 23, 42, 0.9);
        color: var(--text-main);
    }

    /* Main */
    .main {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-width: 0;
    }

    .topbar {
        padding: 14px 18px;
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: rgba(15, 23, 42, 0.9);
        backdrop-filter: blur(10px);
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .content {
        padding: 18px;
        display: flex;
        flex-direction: column;
        gap: 18px;
    }

    .section { display: none; }
    .section.active { display: block; }

    .card {
        background: var(--card-bg);
        border-radius: 14px;
        padding: 14px;
        border: 1px solid var(--border);
    }

    input, select, textarea {
        width: 100%;
        padding: 10px 11px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: #020617;
        color: var(--text-main);
        font-size: 14px;
        margin-top: 8px;
    }

    button {
        padding: 10px 12px;
        border-radius: 10px;
        border: none;
        background: var(--accent);
        color: white;
        font-size: 14px;
        cursor: pointer;
        margin-top: 10px;
    }

    button.loading {
        background: #6b7280 !important;
        cursor: default;
    }

    .list { display: flex; flex-direction: column; gap: 10px; }
</style>
</head>
<body>

<div class="layout">

    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="brand">
            <div class="brand-logo">AD</div>
            <div class="brand-text">لوحة المشرف</div>
        </div>

        <div class="nav-section-title">الرئيسية</div>
        <div class="nav">
            <button class="nav-btn active" data-target="dashboard">Dashboard</button>
        </div>

        <div class="nav-section-title">العملاء</div>
        <div class="nav">
            <button class="nav-btn" data-target="search">بحث عميل</button>
            <button class="nav-btn" data-target="visits">زيارات العميل</button>
            <button class="nav-btn" data-target="cars">سيارات العميل</button>
            <button class="nav-btn" data-target="addVisit">إضافة زيارة</button>
        </div>

        <div class="nav-section-title">التفاعل</div>
        <div class="nav">
            <button class="nav-btn" data-target="notify">إرسال إشعار</button>
            <button class="nav-btn" data-target="bookings">الحجوزات</button>
            <button class="nav-btn" data-target="ratings">التقييمات</button>
        </div>
    </aside>

    <!-- Main -->
    <main class="main">

        <div class="topbar">
            <div>لوحة المشرف</div>
        </div>

        <div class="content">

            <!-- Dashboard -->
            <section id="dashboard" class="section active">
                <div class="card">
                    <h3>إحصائيات</h3>
                    <p id="stats">جاري التحميل...</p>
                </div>
            </section>

            <!-- Search -->
            <section id="search" class="section">
                <div class="card">
                    <h3>بحث عميل</h3>
                    <input id="searchPhone" placeholder="رقم الجوال أو العضوية">
                    <button onclick="searchCustomer()">بحث</button>
                    <div id="searchResult" style="margin-top:10px;"></div>
                </div>
            </section>

            <!-- Visits -->
            <section id="visits" class="section">
                <div class="card">
                    <h3>زيارات العميل</h3>
                    <input id="visitsPhone" placeholder="رقم الجوال">
                    <button onclick="loadCustomerVisits()">عرض الزيارات</button>
                    <div id="visitsList" class="list"></div>
                </div>
            </section>

            <!-- Cars -->
            <section id="cars" class="section">
                <div class="card">
                    <h3>سيارات العميل</h3>
                    <input id="carsPhone" placeholder="رقم الجوال">
                    <button onclick="loadCustomerCars()">عرض السيارات</button>
                    <div id="carsList" class="list"></div>
                </div>
            </section>

            <!-- Notify -->
            <section id="notify" class="section">
                <div class="card">
                    <h3>إرسال إشعار</h3>
                    <textarea id="notifyMsg" placeholder="نص الإشعار"></textarea>
                    <button onclick="sendNotification()">إرسال</button>
                    <p id="notifyStatus"></p>
                </div>
            </section>

            <!-- Add Visit -->
            <section id="addVisit" class="section">
                <div class="card">
                    <h3>إضافة زيارة</h3>

                    <label>رقم العضوية</label>
                    <input id="vMembership">

                    <label>الخدمة</label>
                    <select id="vService" onchange="updateVisitPrice()"></select>

                    <label>السعر</label>
                    <input id="vPrice" type="number" onchange="updateVisitPoints()">

                    <label>النقاط</label>
                    <input id="vPoints" readonly>

                    <button onclick="addVisit()">إضافة</button>
                    <p id="addVisitStatus"></p>
                </div>
            </section>

            <!-- Bookings -->
            <section id="bookings" class="section">
                <div class="card">
                    <h3>الحجوزات</h3>
                    <div id="bookingsList" class="list"></div>
                </div>
            </section>

            <!-- Ratings -->
            <section id="ratings" class="section">
                <div class="card">
                    <h3>التقييمات</h3>
                    <div id="ratingsList" class="list"></div>
                </div>
            </section>

        </div>
    </main>
</div>

<script src="api.js?v=3"></script>
    <script>
/* ========== Navigation ========== */
const sections = document.querySelectorAll(".section");
const navButtons = document.querySelectorAll(".nav-btn");

navButtons.forEach(btn => {
    btn.addEventListener("click", () => {
        const target = btn.getAttribute("data-target");
        sections.forEach(s => s.classList.remove("active"));
        document.getElementById(target).classList.add("active");

        navButtons.forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
    });
});

/* ========== Dashboard ========== */
async function loadDashboard() {
    const res = await apiGet({ action: "getOwnersDashboard" });

    document.getElementById("stats").innerHTML = `
        العملاء: ${res.totals.customers}<br>
        السيارات: ${res.totals.cars}<br>
        الزيارات: ${res.totals.visits}<br>
        المبالغ: ${res.totals.amount}
    `;
}

/* ========== Search Customer ========== */
async function searchCustomer() {
    const phone = document.getElementById("searchPhone").value.trim();
    const btn = document.getElementById("searchBtn");

    if (!phone) return alert("أدخل رقم الجوال");

    btn.classList.add("loading");
    btn.innerText = "جاري البحث...";

    const res = await apiGet({ action: "getByPhone", phone });

    btn.classList.remove("loading");
    btn.innerText = "بحث";

    if (!res.success) {
        document.getElementById("searchResult").innerHTML = "غير موجود";
        return;
    }

    document.getElementById("searchResult").innerHTML = `
        <div class="card">
            الاسم: ${res.customer.name}<br>
            العضوية: ${res.customer.membership}<br>
            النقاط: ${res.customer.points}<br>
            المستوى: ${res.customer.level}
        </div>
    `;
}

/* ========== Customer Visits ========== */
async function loadCustomerVisits() {
    const phone = document.getElementById("visitsPhone").value.trim();
    const btn = document.getElementById("visitsBtn");

    if (!phone) return alert("أدخل رقم الجوال");

    btn.classList.add("loading");
    btn.innerText = "جاري التحميل...";

    const res = await apiGet({ action: "getVisitsByPhone", phone });

    btn.classList.remove("loading");
    btn.innerText = "عرض الزيارات";

    const list = document.getElementById("visitsList");
    list.innerHTML = "";

    res.visits.forEach(v => {
        list.innerHTML += `
            <div class="card">
                ${v.service} - ${v.date}<br>
                السعر: ${v.price}<br>
                النقاط: ${v.points}
            </div>
        `;
    });
}

/* ========== Customer Cars ========== */
async function loadCustomerCars() {
    const phone = document.getElementById("carsPhone").value.trim();
    const btn = document.getElementById("carsBtn");

    if (!phone) return alert("أدخل رقم الجوال");

    btn.classList.add("loading");
    btn.innerText = "جاري التحميل...";

    const res = await apiGet({ action: "getCarsByPhone", phone });

    btn.classList.remove("loading");
    btn.innerText = "عرض السيارات";

    const list = document.getElementById("carsList");
    list.innerHTML = "";

    res.cars.forEach(c => {
        list.innerHTML += `
            <div class="card">
                ${c.car} - ${c.plate_letters} ${c.plate_numbers}<br>
                الحجم: ${c.size}<br>
                المدينة: ${c.city}
            </div>
        `;
    });
}

/* ========== Send Notification ========== */
async function sendNotification() {
    const msg = document.getElementById("notifyMsg").value.trim();
    const btn = document.getElementById("notifyBtn");

    if (!msg) return alert("أدخل نص الإشعار");

    btn.classList.add("loading");
    btn.innerText = "جاري الإرسال...";

    await apiPost({
        action: "addRating",
        membership: "",
        rating: 0,
        comment: msg
    });

    btn.classList.remove("loading");
    btn.innerText = "إرسال";

    document.getElementById("notifyStatus").innerText = "تم الإرسال";
}

/* ============================================================
   ADD VISIT — خدمة منسدلة + سعر تلقائي + نقاط تلقائية
============================================================ */

let visitServices = {}; // { "غسيل خارجي": 20, "غسيل كامل": 40 }

async function loadVisitServices() {
    const res = await apiGet({ action: "getCommissions" });

    const select = document.getElementById("vService");
    select.innerHTML = "";

    res.commissions.forEach(s => {
        visitServices[s.service] = Number(s.price);

        const opt = document.createElement("option");
        opt.value = s.service;
        opt.textContent = s.service;
        select.appendChild(opt);
    });

    updateVisitPrice();
}

function updateVisitPrice() {
    const service = document.getElementById("vService").value;
    const price = visitServices[service] || 0;

    document.getElementById("vPrice").value = price;
    updateVisitPoints();
}

function updateVisitPoints() {
    const price = Number(document.getElementById("vPrice").value);
    const points = Math.floor(price / 5); // مثال: كل 5 ريال = نقطة

    document.getElementById("vPoints").value = points;
}

async function addVisit() {
    const membership = document.getElementById("vMembership").value.trim();
    const service = document.getElementById("vService").value;
    const price = document.getElementById("vPrice").value;
    const points = document.getElementById("vPoints").value;
    const btn = document.getElementById("addVisitBtn");

    if (!membership) return alert("أدخل رقم العضوية");

    btn.classList.add("loading");
    btn.innerText = "جاري الإضافة...";

    await apiPost({
        action: "addVisit",
        membership,
        service,
        price,
        points
    });

    btn.classList.remove("loading");
    btn.innerText = "إضافة";

    document.getElementById("addVisitStatus").innerText = "تمت الإضافة بنجاح";
}

/* ========== Bookings ========== */
async function loadBookings() {
    const res = await apiGet({ action: "getAllBookings" });

    const list = document.getElementById("bookingsList");
    list.innerHTML = "";

    res.bookings.forEach(b => {
        list.innerHTML += `
            <div class="card">
                ${b.service} - ${b.date} ${b.time}<br>
                الحالة: ${b.status}<br>
                <button onclick="confirmBooking(${b.row})">تأكيد</button>
                <button onclick="cancelBooking(${b.row})" style="background:#dc2626">إلغاء</button>
            </div>
        `;
    });
}

async function confirmBooking(row) {
    await apiPost({ action: "updateBookingStatus", row, status: "Approved" });
    loadBookings();
}

async function cancelBooking(row) {
    await apiPost({ action: "updateBookingStatus", row, status: "Cancelled" });
    loadBookings();
}

/* ========== Ratings ========== */
async function loadRatings() {
    const res = await apiGet({
        action: "getVisitsByDate",
        from: "2000-01-01",
        to: "2100-01-01"
    });

    const list = document.getElementById("ratingsList");
    list.innerHTML = "";

    res.visits.forEach(v => {
        list.innerHTML += `
            <div class="card">
                ${v.service} - ${v.date}<br>
                نقاط: ${v.points}
            </div>
        `;
    });
}

/* ========== INITIAL LOAD ========== */
loadDashboard();
loadBookings();
loadRatings();
loadVisitServices();
</script>

    
