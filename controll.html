<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>لوحة المشرف</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body {
    font-family: "Tajawal", sans-serif;
    background: #f4f6f9;
    margin: 0;
}
.tabs {
    display: flex;
    overflow-x: auto;
    background: #2563eb;
    color: white;
}
.tab {
    padding: 14px 20px;
    cursor: pointer;
    white-space: nowrap;
}
.tab.active {
    background: #1e40af;
}
.section {
    display: none;
    padding: 15px;
}
.section.active {
    display: block;
}
.card {
    background: white;
    padding: 15px;
    border-radius: 12px;
    margin-bottom: 15px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
input, select, button, textarea {
    width: 100%;
    padding: 12px;
    margin-top: 10px;
    border-radius: 8px;
    border: 1px solid #ccc;
}
button {
    background: #2563eb;
    color: white;
    border: none;
    font-size: 16px;
    transition: 0.2s;
}
button.loading {
    background: #6b7280 !important;
    cursor: not-allowed;
}
button:active {
    transform: scale(0.97);
}
</style>
</head>

<body>

<!-- Tabs -->
<div class="tabs">
    <div class="tab active" onclick="showTab('dashboard', this)">Dashboard</div>
    <div class="tab" onclick="showTab('search', this)">بحث عميل</div>
    <div class="tab" onclick="showTab('visits', this)">زيارات العميل</div>
    <div class="tab" onclick="showTab('cars', this)">سيارات العميل</div>
    <div class="tab" onclick="showTab('notify', this)">إرسال إشعار</div>
    <div class="tab" onclick="showTab('addVisit', this)">إضافة زيارة</div>
    <div class="tab" onclick="showTab('bookings', this)">الحجوزات</div>
    <div class="tab" onclick="showTab('ratings', this)">التقييمات</div>
</div>

<!-- Dashboard -->
<div id="dashboard" class="section active">
    <h2>Dashboard</h2>
    <div class="card">
        <h3>إحصائيات</h3>
        <p id="stats">جاري التحميل...</p>
    </div>
</div>

<!-- Search Customer -->
<div id="search" class="section">
    <h2>بحث عن عميل</h2>
    <input id="searchPhone" placeholder="رقم الجوال أو العضوية أو اللوحة">
    <button id="searchBtn" onclick="searchCustomer()">بحث</button>
    <div id="searchResult"></div>
</div>

<!-- Customer Visits -->
<div id="visits" class="section">
    <h2>زيارات العميل</h2>
    <input id="visitsPhone" placeholder="رقم الجوال">
    <button id="visitsBtn" onclick="loadCustomerVisits()">عرض الزيارات</button>
    <div id="visitsList"></div>
</div>

<!-- Customer Cars -->
<div id="cars" class="section">
    <h2>سيارات العميل</h2>
    <input id="carsPhone" placeholder="رقم الجوال">
    <button id="carsBtn" onclick="loadCustomerCars()">عرض السيارات</button>
    <div id="carsList"></div>
</div>

<!-- Send Notification -->
<div id="notify" class="section">
    <h2>إرسال إشعار</h2>
    <textarea id="notifyMsg" placeholder="نص الإشعار"></textarea>
    <button id="notifyBtn" onclick="sendNotification()">إرسال</button>
    <p id="notifyStatus"></p>
</div>

<!-- Add Visit -->
<div id="addVisit" class="section">
    <h2>إضافة زيارة</h2>

    <div class="card">
        <h3>بحث عن العميل</h3>
        <input id="visitSearch" placeholder="رقم الجوال / العضوية / اللوحة">
        <button id="visitSearchBtn" onclick="searchVisitCustomer()">بحث</button>
    </div>

    <div id="visitCarsBox" class="card" style="display:none;">
        <h3>اختر السيارة</h3>
        <div id="visitCarsList"></div>
    </div>

    <div id="visitForm" class="card" style="display:none;">
        <h3>تفاصيل الزيارة</h3>

        <label>الخدمة</label>
        <select id="vService" onchange="updateVisitPrice()"></select>

        <label>السعر</label>
        <input type="number" id="vPrice" onchange="updateVisitPoints()">

        <label>النقاط</label>
        <input type="number" id="vPoints" readonly>

        <button id="addVisitBtn" onclick="submitVisit()">تسجيل الزيارة</button>
        <p id="addVisitStatus"></p>
    </div>
</div>

<!-- Bookings -->
<div id="bookings" class="section">
    <h2>الحجوزات</h2>
    <div id="bookingsList">جاري التحميل...</div>
</div>

<!-- Ratings -->
<div id="ratings" class="section">
    <h2>التقييمات</h2>
    <div id="ratingsList">جاري التحميل...</div>
</div>

<script src="api.js?v=3"></script>

<script>
/* ===========================
   Tabs
=========================== */
function showTab(id, el) {
    document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
    document.getElementById(id).classList.add("active");

    document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
    el.classList.add("active");
}

/* ===========================
   Dashboard
=========================== */
async function loadDashboard() {
    const res = await apiGet({ action: "getOwnersDashboard" });

    document.getElementById("stats").innerHTML = `
        العملاء: ${res.totals.customers}<br>
        السيارات: ${res.totals.cars}<br>
        الزيارات: ${res.totals.visits}<br>
        المبالغ: ${res.totals.amount}
    `;
}

/* ===========================
   Search Customer
=========================== */
async function searchCustomer() {
    const btn = document.getElementById("searchBtn");
    const query = document.getElementById("searchPhone").value.trim();

    if (!query) return alert("أدخل قيمة للبحث");

    btn.classList.add("loading");
    btn.innerText = "جاري البحث...";
    btn.disabled = true;

    const res = await apiGet({ action: "searchCustomer", query });

    btn.classList.remove("loading");
    btn.innerText = "بحث";
    btn.disabled = false;

    if (!res.success || res.customers.length === 0) {
        document.getElementById("searchResult").innerHTML = "لا يوجد نتائج";
        return;
    }

    const c = res.customers[0];

    document.getElementById("searchResult").innerHTML = `
        <div class="card">
            الاسم: ${c.name}<br>
            العضوية: ${c.membership}<br>
            النقاط: ${c.points}<br>
            المستوى: ${c.level}
        </div>
    `;
}

/* ===========================
   Visits
=========================== */
async function loadCustomerVisits() {
    const btn = document.getElementById("visitsBtn");
    const phone = document.getElementById("visitsPhone").value.trim();

    if (!phone) return alert("أدخل رقم الجوال");

    btn.classList.add("loading");
    btn.innerText = "جاري التحميل...";
    btn.disabled = true;

    const res = await apiGet({ action: "getVisitsByPhone", phone });

    btn.classList.remove("loading");
    btn.innerText = "عرض الزيارات";
    btn.disabled = false;

    let html = "";
    res.visits.forEach(v => {
        html += `
            <div class="card">
                ${v.service} - ${v.date}<br>
                السعر: ${v.price}<br>
                النقاط: ${v.points}
            </div>
        `;
    });

    document.getElementById("visitsList").innerHTML = html;
}

/* ===========================
   Cars
=========================== */
async function loadCustomerCars() {
    const btn = document.getElementById("carsBtn");
    const phone = document.getElementById("carsPhone").value.trim();

    if (!phone) return alert("أدخل رقم الجوال");

    btn.classList.add("loading");
    btn.innerText = "جاري التحميل...";
    btn.disabled = true;

    const res = await apiGet({ action: "getCarsByPhone", phone });

    btn.classList.remove("loading");
    btn.innerText = "عرض السيارات";
    btn.disabled = false;

    let html = "";
    res.cars.forEach(c => {
        html += `
            <div class="card">
                ${c.car} - ${c.plate_letters} ${c.plate_numbers}<br>
                الحجم: ${c.size}<br>
                المدينة: ${c.city}
            </div>
        `;
    });

    document.getElementById("carsList").innerHTML = html;
}

/* ===========================
   Send Notification
=========================== */
async function sendNotification() {
    const btn = document.getElementById("notifyBtn");
    const msg = document.getElementById("notifyMsg").value.trim();

    if (!msg) return alert("أدخل نص الإشعار");

    btn.classList.add("loading");
    btn.innerText = "جاري الإرسال...";
    btn.disabled = true;

    await apiPost({
        action: "addRating",
        membership: "",
        rating: 0,
        comment: msg
    });

    btn.classList.remove("loading");
    btn.innerText = "إرسال";
    btn.disabled = false;

    document.getElementById("notifyStatus").innerText = "تم الإرسال";
}

/* ===========================
   Add Visit — Search
=========================== */
let selectedMembership = null;
let visitServices = {};

async function searchVisitCustomer() {
    const btn = document.getElementById("visitSearchBtn");
    const query = document.getElementById("visitSearch").value.trim();

    if (!query) return alert("أدخل رقم الجوال أو العضوية أو اللوحة");

    btn.classList.add("loading");
    btn.innerText = "جاري البحث...";
    btn.disabled = true;

    const res = await apiGet({
        action: "searchCustomer",
        query
    });

    btn.classList.remove("loading");
    btn.innerText = "بحث";
    btn.disabled = false;

    if (!res.success || res.cars.length === 0) {
        alert("لا يوجد نتائج");
        return;
    }

    document.getElementById("visitCarsBox").style.display = "block";

    const list = document.getElementById("visitCarsList");
    list.innerHTML = "";

    res.cars.forEach(car => {
        const div = document.createElement("div");
        div.className = "card";
        div.style.cursor = "pointer";
        div.innerHTML = `
            <b>${car.car}</b> — ${car.plate_letters} ${car.plate_numbers}<br>
            عضوية: ${car.membership}
        `;
        div.onclick = () => selectVisitCar(car.membership);
        list.appendChild(div);
    });
}

/* ===========================
   Add Visit — Select Car
=========================== */
function selectVisitCar(membership) {
    selectedMembership = membership;
    document.getElementById("visitForm").style.display = "block";
}

/* ===========================
   Add Visit — Load Services
=========================== */
async function loadVisitServices() {
    const res = await apiGet({ action: "getCommissions" });

    const select = document.getElementById("vService");
    select.innerHTML = "";

    res.commissions.forEach(s => {
        visitServices[s.service] = Number(s.price);

        const opt = document.createElement("option");
        opt.value = s.service;
        opt.textContent = s.service;
        select.appendChild(opt);
    });

    updateVisitPrice();
}

function updateVisitPrice() {
    const service = document.getElementById("vService").value;
    const price = visitServices[service] || 0;

    document.getElementById("vPrice").value = price;
    updateVisitPoints();
}

function updateVisitPoints() {
    const price = Number(document.getElementById("vPrice").value);
    document.getElementById("vPoints").value = Math.floor(price / 5);
}

/* ===========================
   Add Visit — Submit
=========================== */
async function submitVisit() {
    if (!selectedMembership) return alert("اختر السيارة أولاً");

    const btn = document.getElementById("addVisitBtn");

    btn.classList.add("loading");
    btn.innerText = "جاري التسجيل...";
    btn.disabled = true;

    const service = document.getElementById("vService").value;
    const price = document.getElementById("vPrice").value;
    const points = document.getElementById("vPoints").value;

    const res = await apiPost({
        action: "addVisit",
        membership: selectedMembership,
        service,
        price,
        points
    });

    btn.classList.remove("loading");
    btn.innerText = "تسجيل الزيارة";
    btn.disabled = false;

    if (res.success) {
        document.getElementById("addVisitStatus").innerText = "✔ تم تسجيل الزيارة بنجاح";
    } else {
        document.getElementById("addVisitStatus").innerText = "❌ حدث خطأ أثناء التسجيل";
    }
}

/* ===========================
   Bookings
=========================== */
async function loadBookings() {
    const res = await apiGet({ action: "getAllBookings" });

    let html = "";
    res.bookings.forEach(b => {
        html += `
            <div class="card">
                ${b.service} - ${b.date} ${b.time}<br>
                الحالة: ${b.status}<br>
                <button onclick="confirmBooking(${b.row})">تأكيد</button>
                <button onclick="cancelBooking(${b.row})" style="background:#dc2626">إلغاء</button>
            </div>
        `;
    });

    document.getElementById("bookingsList").innerHTML = html;
}

async function confirmBooking(row) {
    await apiPost({ action: "updateBookingStatus", row, status: "Approved" });
    loadBookings();
}

async function cancelBooking(row) {
    await apiPost({ action: "updateBookingStatus", row, status: "Cancelled" });
    loadBookings();
}

/* ===========================
   Ratings
=========================== */
async function loadRatings() {
    const res = await apiGet({
        action: "getVisitsByDate",
        from: "2000-01-01",
        to: "2100-01-01"
    });

    let html = "";
    res.visits.forEach(v => {
        html += `
            <div class="card">
                ${v.service} - ${v.date}<br>
                نقاط: ${v.points}
            </div>
        `;
    });

    document.getElementById("ratingsList").innerHTML = html;
}

/* ===========================
   Initial Load
=========================== */
loadDashboard();
loadBookings();
loadRatings();
loadVisitServices();
</script>

</body>
</html>
