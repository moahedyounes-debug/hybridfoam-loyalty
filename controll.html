<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø´Ø±Ù - Control Panel</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<style>
/* Ù†ÙØ³ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ù‡ÙˆÙŠØ© */
:root { --bg: #020617; --card: #020617; --border: #1f2937; --accent: #2563eb; --text-main: #f9fafb; }
body { margin: 0; font-family: "Tajawal", sans-serif; background: #020617; color: white; direction: rtl; padding: 20px; }
.container { max-width: 800px; margin: auto; }
.card { background: #0f172a; border: 1px solid var(--border); padding: 20px; border-radius: 12px; margin-bottom: 20px; }
input, select { width: 100%; padding: 12px; background: #1e293b; border: 1px solid var(--border); color: white; border-radius: 8px; margin-bottom: 10px; }
button { width: 100%; padding: 12px; background: var(--accent); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
.tabs { display: flex; gap: 10px; margin-bottom: 20px; }
.tab-btn { background: transparent; border: 1px solid var(--border); color: #9ca3af; }
.tab-btn.active { background: var(--accent); color: white; border-color: var(--accent); }
.hidden { display: none; }
.badge { padding: 3px 8px; border-radius: 4px; font-size: 12px; background: #16a34a; }
</style>
</head>
<body>

<div class="container">
    <h2 style="text-align:center; color:#2563eb">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø´Ø±Ù</h2>

    <div class="tabs">
        <button class="tab-btn active" onclick="showTab('visit')">ØªØ³Ø¬ÙŠÙ„ Ø²ÙŠØ§Ø±Ø©</button>
        <button class="tab-btn" onclick="showTab('search')">Ø¨Ø­Ø« Ø¹Ù† Ø¹Ù…ÙŠÙ„</button>
    </div>

    <div id="tab-visit">
        <div class="card">
            <h3>ØªØ³Ø¬ÙŠÙ„ Ø²ÙŠØ§Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>
            
            <label>Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
            <input type="tel" id="vPhone" placeholder="05xxxxxxxx">
            
            <label>Ø§Ù„Ø®Ø¯Ù…Ø©</label>
            <select id="vService" onchange="updatePrice()">
                <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø®Ø¯Ù…Ø©...</option>
                </select>

            <div style="display:flex; gap:10px;">
                <div style="flex:1">
                    <label>Ø§Ù„Ø³Ø¹Ø±</label>
                    <input type="number" id="vPrice">
                </div>
                <div style="flex:1">
                    <label>Ø§Ù„Ù…ÙˆØ¸Ù</label>
                    <select id="vEmployee">
                        <option value="">Ø¹Ø§Ù…</option>
                    </select>
                </div>
            </div>

            <button onclick="submitVisit()" id="submitBtn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø²ÙŠØ§Ø±Ø© âœ…</button>
        </div>
    </div>

    <div id="tab-search" class="hidden">
        <div class="card">
            <label>Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</label>
            <input id="sPhone" placeholder="05xxxxxxxx">
            <button onclick="searchCustomer()">Ø¨Ø­Ø« ğŸ”</button>
            <div id="searchResult" style="margin-top:20px; border-top:1px solid #333; padding-top:10px;"></div>
        </div>
    </div>

</div>

<script src="api.js"></script>
<script>
    let servicesData = {};

    // Ø§Ù„ØªÙ‡ÙŠØ¦Ø©
    async function init() {
        // Ø¬Ù„Ø¨ Ø§Ù„Ø®Ø¯Ù…Ø§Øª ÙˆØ§Ù„Ø£Ø³Ø¹Ø§Ø± Ù…Ù† 
        const res = await apiGet({ action: "getCommissions" });
        const sSelect = document.getElementById("vService");
        if(res.commissions) {
            res.commissions.forEach(c => {
                servicesData[c.service] = c.price; // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø³Ø¹Ø±
                sSelect.innerHTML += `<option value="${c.service}">${c.service}</option>`;
            });
        }
        
        // Ø¬Ù„Ø¨ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† [cite: 293]
        const empRes = await apiGet({ action: "getEmployees" });
        const eSelect = document.getElementById("vEmployee");
        if(empRes.employees) {
            empRes.employees.forEach(e => {
                eSelect.innerHTML += `<option value="${e.employee}">${e.employee}</option>`;
            });
        }
    }

    function updatePrice() {
        const service = document.getElementById("vService").value;
        const priceInput = document.getElementById("vPrice");
        if(servicesData[service]) {
            priceInput.value = servicesData[service];
        }
    }

    function showTab(id) {
        document.getElementById("tab-visit").classList.add("hidden");
        document.getElementById("tab-search").classList.add("hidden");
        document.getElementById("tab-" + id).classList.remove("hidden");
        
        document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
        event.target.classList.add("active");
    }

    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø²ÙŠØ§Ø±Ø© 
    async function submitVisit() {
        const phone = document.getElementById("vPhone").value;
        const service = document.getElementById("vService").value;
        const price = document.getElementById("vPrice").value;
        const employee = document.getElementById("vEmployee").value;

        if(!phone || !service) return alert("Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©");

        const btn = document.getElementById("submitBtn");
        btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...";
        btn.disabled = true;

        // Ø£ÙˆÙ„Ø§Ù‹ Ù†Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ø¶ÙˆÙŠØ© Ù„Ø£Ù† addVisit ÙŠØ­ØªØ§Ø¬ membership 
        const custRes = await apiGet({ action: "getByPhone", phone });
        let membership = "";
        
        if(custRes.success && custRes.customer) {
            membership = custRes.customer.membership;
        } else {
            // ØªØ³Ø¬ÙŠÙ„ Ø³Ø±ÙŠØ¹ Ù„Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯ [cite: 508]
            const regRes = await apiPost({ action: "registerCustomer", phone, name: "Ø¹Ù…ÙŠÙ„ Ø¬Ø¯ÙŠØ¯" });
            if(regRes.success) membership = regRes.membership;
            else return alert("Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„");
        }

        // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø²ÙŠØ§Ø±Ø©
        const res = await apiPost({
            action: "addVisit",
            membership: membership,
            service: service,
            price: price,
            points: Math.floor(price / 10), // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ù‚Ø§Ø· ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
            employee: employee,
            branch: "Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ" // Ø§ÙØªØ±Ø§Ø¶ÙŠ
        });

        if(res.success) {
            alert("ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!");
            document.getElementById("vPhone").value = "";
        } else {
            alert("Ø®Ø·Ø£: " + res.error);
        }
        
        btn.innerText = "ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø²ÙŠØ§Ø±Ø© âœ…";
        btn.disabled = false;
    }

    async function searchCustomer() {
        const phone = document.getElementById("sPhone").value;
        const res = await apiGet({ action: "getByPhone", phone });
        const div = document.getElementById("searchResult");
        
        if(res.success) {
            div.innerHTML = `
                <h3>${res.customer.name}</h3>
                <p>Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©: <span class="badge">${res.customer.membership}</span></p>
                <p>Ø§Ù„Ù†Ù‚Ø§Ø·: ${res.customer.points} (${res.customer.level})</p>
                <p>Ø¹Ø¯Ø¯ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª: ${res.customer.visit_count}</p>
            `;
        } else {
            div.innerHTML = "<p>Ø§Ù„Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯</p>";
        }
    }

    init();
</script>
</body>
</html>
