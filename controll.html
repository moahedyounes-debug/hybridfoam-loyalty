<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø´Ø±Ù</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ -->
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
    :root {
        --bg: #0f172a;
        --bg-soft: #111827;
        --accent: #2563eb;
        --accent-soft: #1d4ed8;
        --card-bg: #0b1120;
        --border: #1f2937;
        --text-main: #f9fafb;
        --text-muted: #9ca3af;
        --danger: #dc2626;
        --success: #16a34a;
    }

    * {
        box-sizing: border-box;
    }

    body {
        margin: 0;
        font-family: "Tajawal", sans-serif;
        background: var(--bg);
        color: var(--text-main);
        direction: rtl;
    }

    .layout {
        display: flex;
        min-height: 100vh;
    }

    /* Sidebar */
    .sidebar {
        width: 260px;
        background: var(--bg-soft);
        border-left: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        padding: 20px 16px;
    }

    .brand {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 24px;
    }

    .brand-logo {
        width: 40px;
        height: 40px;
        border-radius: 12px;
        background: linear-gradient(135deg, #2563eb, #4f46e5);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 18px;
    }

    .brand-text {
        font-size: 18px;
        font-weight: 600;
    }

    .nav-section-title {
        font-size: 12px;
        color: var(--text-muted);
        margin: 10px 4px;
    }

    .nav {
        display: flex;
        flex-direction: column;
        gap: 6px;
        margin-bottom: 20px;
    }

    .nav-btn {
        width: 100%;
        text-align: right;
        padding: 10px 12px;
        border-radius: 10px;
        border: none;
        background: transparent;
        color: var(--text-muted);
        font-size: 14px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: space-between;
        transition: 0.15s;
    }

    .nav-btn span {
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .nav-btn.active {
        background: rgba(37, 99, 235, 0.18);
        color: var(--text-main);
    }

    .nav-btn:hover {
        background: rgba(15, 23, 42, 0.9);
        color: var(--text-main);
    }

    .nav-badge {
        font-size: 11px;
        padding: 2px 8px;
        border-radius: 999px;
        background: rgba(148, 163, 184, 0.2);
        color: var(--text-muted);
    }

    .sidebar-footer {
        margin-top: auto;
        font-size: 12px;
        color: var(--text-muted);
        opacity: 0.8;
    }

    /* Main */
    .main {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-width: 0;
    }

    .topbar {
        padding: 14px 18px;
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: rgba(15, 23, 42, 0.9);
        backdrop-filter: blur(10px);
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .topbar-title {
        font-size: 18px;
        font-weight: 600;
    }

    .topbar-sub {
        font-size: 12px;
        color: var(--text-muted);
    }

    .topbar-right {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 13px;
        color: var(--text-muted);
    }

    .pill {
        padding: 4px 10px;
        border-radius: 999px;
        border: 1px solid var(--border);
    }

    .content {
        padding: 18px;
        display: flex;
        flex-direction: column;
        gap: 18px;
    }

    .section {
        display: none;
    }

    .section.active {
        display: block;
    }

    .section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 10px;
    }

    .section-header h2 {
        margin: 0;
        font-size: 18px;
    }

    .section-header small {
        color: var(--text-muted);
        font-size: 12px;
    }

    .grid {
        display: grid;
        gap: 14px;
    }

    @media (min-width: 900px) {
        .grid-3 {
            grid-template-columns: repeat(3, minmax(0, 1fr));
        }
        .grid-2 {
            grid-template-columns: repeat(2, minmax(0, 1fr));
        }
    }

    .card {
        background: var(--card-bg);
        border-radius: 14px;
        padding: 14px;
        border: 1px solid var(--border);
    }

    .card h3 {
        margin: 0 0 8px 0;
        font-size: 15px;
    }

    .stat-value {
        font-size: 22px;
        font-weight: 600;
        margin-top: 4px;
    }

    .stat-label {
        font-size: 12px;
        color: var(--text-muted);
    }

    .chart-box {
        height: 220px;
        border-radius: 14px;
        background: radial-gradient(circle at top left, rgba(37, 99, 235, 0.18), transparent),
                    radial-gradient(circle at bottom right, rgba(56, 189, 248, 0.12), transparent);
        border: 1px dashed var(--border);
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-muted);
        font-size: 13px;
        text-align: center;
        padding: 10px;
    }

    input, select, textarea, button {
        font-family: inherit;
    }

    input, select, textarea {
        width: 100%;
        padding: 10px 11px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: #020617;
        color: var(--text-main);
        font-size: 14px;
    }

    textarea {
        min-height: 90px;
        resize: vertical;
    }

    input::placeholder, textarea::placeholder {
        color: #6b7280;
    }

    button {
        padding: 10px 12px;
        border-radius: 10px;
        border: none;
        background: var(--accent);
        color: white;
        font-size: 14px;
        cursor: pointer;
        transition: 0.15s;
    }

    button:hover {
        background: var(--accent-soft);
    }

    button.loading {
        background: #6b7280 !important;
        cursor: default;
    }

    .btn-secondary {
        background: #111827;
    }

    .btn-danger {
        background: var(--danger);
    }

    .btn-success {
        background: var(--success);
    }

    .muted {
        color: var(--text-muted);
        font-size: 12px;
    }

    .list {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-top: 8px;
    }

    .badge-status {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 11px;
    }

    .badge-status.Approved {
        background: rgba(22, 163, 74, 0.15);
        color: #4ade80;
    }

    .badge-status.Pending {
        background: rgba(234, 179, 8, 0.15);
        color: #facc15;
    }

    .badge-status.Cancelled {
        background: rgba(220, 38, 38, 0.15);
        color: #fca5a5;
    }

    #reader {
        width: 100%;
        max-width: 320px;
        margin-top: 10px;
        border-radius: 12px;
        overflow: hidden;
    }

    @media (max-width: 800px) {
        .layout {
            flex-direction: column;
        }
        .sidebar {
            width: 100%;
            flex-direction: row;
            overflow-x: auto;
            border-left: none;
            border-bottom: 1px solid var(--border);
        }
        .brand {
            display: none;
        }
        .nav {
            flex-direction: row;
            flex-wrap: nowrap;
            overflow-x: auto;
        }
        .nav-btn {
            white-space: nowrap;
            font-size: 13px;
        }
        .sidebar-footer {
            display: none;
        }
    }
</style>
</head>
<body>

<div class="layout">

    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="brand">
            <div class="brand-logo">AD</div>
            <div class="brand-text">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø´Ø±Ù</div>
        </div>

        <div class="nav-section-title">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
        <div class="nav">
            <button class="nav-btn active" data-target="dashboard">
                <span>Dashboard</span>
            </button>
        </div>

        <div class="nav-section-title">Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</div>
        <div class="nav">
            <button class="nav-btn" data-target="search">
                <span>Ø¨Ø­Ø« Ø¹Ù…ÙŠÙ„</span>
            </button>
            <button class="nav-btn" data-target="visits">
                <span>Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</span>
            </button>
            <button class="nav-btn" data-target="cars">
                <span>Ø³ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</span>
            </button>
            <button class="nav-btn" data-target="addVisit">
                <span>Ø¥Ø¶Ø§ÙØ© Ø²ÙŠØ§Ø±Ø©</span>
            </button>
        </div>

        <div class="nav-section-title">Ø§Ù„ØªÙØ§Ø¹Ù„</div>
        <div class="nav">
            <button class="nav-btn" data-target="notify">
                <span>Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±</span>
            </button>
            <button class="nav-btn" data-target="bookings">
                <span>Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</span>
            </button>
            <button class="nav-btn" data-target="ratings">
                <span>Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</span>
            </button>
        </div>

        <div class="sidebar-footer">
            Ø¥ØµØ¯Ø§Ø± ØªØ¬Ø±ÙŠØ¨ÙŠ â€” Hybrid Foam Loyalty
        </div>
    </aside>

    <!-- Main -->
    <main class="main">
        <header class="topbar">
            <div>
                <div class="topbar-title">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø´Ø±Ù</div>
                <div class="topbar-sub">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ØŒ Ø§Ù„Ø²ÙŠØ§Ø±Ø§ØªØŒ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§ØªØŒ ÙˆØ§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</div>
            </div>
            <div class="topbar-right">
                <div class="pill" id="todayInfo">Ø§Ù„ÙŠÙˆÙ…</div>
            </div>
        </header>

        <div class="content">

            <!-- Dashboard -->
            <section id="dashboard" class="section active">
                <div class="section-header">
                    <h2>Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©</h2>
                    <small>Ù…Ù„Ø®Øµ Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø¹Ø§Ù…</small>
                </div>

                <div class="grid grid-4 grid-3">
                    <div class="card">
                        <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h3>
                        <div class="stat-value" id="statCustomers">...</div>
                        <div class="stat-label">Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ†</div>
                    </div>
                    <div class="card">
                        <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</h3>
                        <div class="stat-value" id="statCars">...</div>
                        <div class="stat-label">Ø¹Ø¯Ø¯ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ø³Ø¬Ù„Ø©</div>
                    </div>
                    <div class="card">
                        <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª</h3>
                        <div class="stat-value" id="statVisits">...</div>
                        <div class="stat-label">ÙƒÙ„ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ø³Ø¬Ù„Ø©</div>
                    </div>
                    <div class="card">
                        <h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ø§Ù„Øº</h3>
                        <div class="stat-value" id="statAmount">...</div>
                        <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ù…Ù† Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª</div>
                    </div>
                </div>

                <div class="card" style="margin-top:14px;">
                    <h3>Ø§Ù„Ø´Ø§Ø±Øª</h3>
                    <div class="chart-box" id="chart">
                        ğŸ“Š Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø´Ø§Ø±Øª Ù‡Ù†Ø§ Ù„Ø§Ø­Ù‚Ù‹Ø§
                    </div>
                </div>
            </section>

            <!-- Search Customer -->
            <section id="search" class="section">
                <div class="section-header">
                    <h2>Ø¨Ø­Ø« Ø¹Ù† Ø¹Ù…ÙŠÙ„</h2>
                    <small>Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©</small>
                </div>

                <div class="grid grid-2">
                    <div class="card">
                        <h3>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨Ø­Ø«</h3>
                        <input id="searchPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©">
                        <div style="display:flex; gap:8px; margin-top:10px;">
                            <button id="searchBtn" onclick="searchCustomer()">Ø¨Ø­Ø«</button>
                            <button class="btn-success" onclick="startScanner()">Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</button>
                        </div>
                        <div id="reader" style="display:none;"></div>
                    </div>

                    <div class="card">
                        <h3>Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø¨Ø­Ø«</h3>
                        <div id="searchResult" class="muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯</div>
                    </div>
                </div>
            </section>

            <!-- Customer Visits -->
            <section id="visits" class="section">
                <div class="section-header">
                    <h2>Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</h2>
                    <small>Ø¹Ø±Ø¶ Ø³Ø¬Ù„ Ø²ÙŠØ§Ø±Ø§Øª Ø¹Ù…ÙŠÙ„ Ù…Ø­Ø¯Ø¯</small>
                </div>

                <div class="grid grid-2">
                    <div class="card">
                        <h3>Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</h3>
                        <input id="visitsPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„">
                        <button id="visitsBtn" style="margin-top:10px;" onclick="loadCustomerVisits()">Ø¹Ø±Ø¶ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª</button>
                    </div>

                    <div class="card">
                        <h3>Ø³Ø¬Ù„ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª</h3>
                        <div id="visitsList" class="list muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯</div>
                    </div>
                </div>
            </section>

            <!-- Customer Cars -->
            <section id="cars" class="section">
                <div class="section-header">
                    <h2>Ø³ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</h2>
                    <small>Ø¹Ø±Ø¶ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„</small>
                </div>

                <div class="grid grid-2">
                    <div class="card">
                        <h3>Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</h3>
                        <input id="carsPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„">
                        <button id="carsBtn" style="margin-top:10px;" onclick="loadCustomerCars()">Ø¹Ø±Ø¶ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</button>
                    </div>

                    <div class="card">
                        <h3>Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</h3>
                        <div id="carsList" class="list muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯</div>
                    </div>
                </div>
            </section>

            <!-- Send Notification -->
            <section id="notify" class="section">
                <div class="section-header">
                    <h2>Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±</h2>
                    <small>Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù†ØµÙŠØ© Ø¯Ø§Ø®Ù„ÙŠØ© (ÙƒØªÙ‚ÙŠÙŠÙ…)</small>
                </div>

                <div class="card">
                    <h3>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±</h3>
                    <input id="notifyPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ (Ø­Ø§Ù„ÙŠÙ‹Ø§ ØºÙŠØ± Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ù€ API)">
                    <textarea id="notifyMsg" placeholder="Ù†Øµ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±"></textarea>
                    <button id="notifyBtn" onclick="sendNotification()">Ø¥Ø±Ø³Ø§Ù„</button>
                    <p id="notifyStatus" class="muted" style="margin-top:8px;"></p>
                </div>
            </section>

            <!-- Add Visit -->
            <section id="addVisit" class="section">
                <div class="section-header">
                    <h2>Ø¥Ø¶Ø§ÙØ© Ø²ÙŠØ§Ø±Ø©</h2>
                    <small>ØªØ³Ø¬ÙŠÙ„ Ø²ÙŠØ§Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø¹Ø¶Ùˆ</small>
                </div>

                <div class="card">
                    <h3>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø²ÙŠØ§Ø±Ø©</h3>
                    <input id="vMembership" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©">
                    <input id="vService" placeholder="Ø§Ù„Ø®Ø¯Ù…Ø©">
                    <input id="vPrice" placeholder="Ø§Ù„Ø³Ø¹Ø±">
                    <input id="vPoints" placeholder="Ø§Ù„Ù†Ù‚Ø§Ø·">
                    <button id="addVisitBtn" onclick="addVisit()">Ø¥Ø¶Ø§ÙØ©</button>
                    <p id="addVisitStatus" class="muted" style="margin-top:8px;"></p>
                </div>
            </section>

            <!-- Bookings -->
            <section id="bookings" class="section">
                <div class="section-header">
                    <h2>Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</h2>
                    <small>Ø¥Ø¯Ø§Ø±Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</small>
                </div>

                <div class="card">
                    <h3>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</h3>
                    <div id="bookingsList" class="list muted">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
                </div>
            </section>

            <!-- Ratings -->
            <section id="ratings" class="section">
                <div class="section-header">
                    <h2>Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª / Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®</h2>
                    <small>Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ø³Ø¬Ù„Ø©</small>
                </div>

                <div class="card">
                    <h3>Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª</h3>
                    <div id="ratingsList" class="list muted">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
                </div>
            </section>

        </div>
    </main>
</div>

<script src="api.js?v=3"></script>
<script>
/* ========== Navigation ========== */
const sections = document.querySelectorAll(".section");
const navButtons = document.querySelectorAll(".nav-btn");

navButtons.forEach(btn => {
    btn.addEventListener("click", () => {
        const target = btn.getAttribute("data-target");
        sections.forEach(s => s.classList.remove("active"));
        document.getElementById(target).classList.add("active");

        navButtons.forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
    });
});

/* ========== Topbar Date ========== */
(function setToday() {
    const el = document.getElementById("todayInfo");
    const d = new Date();
    const options = { weekday: "short", year: "numeric", month: "short", day: "numeric" };
    el.textContent = d.toLocaleDateString("ar-SA", options);
})();

/* ========== Dashboard ========== */
async function loadDashboard() {
    try {
        const res = await apiGet({ action: "getOwnersDashboard" });
        document.getElementById("statCustomers").textContent = res.totals.customers;
        document.getElementById("statCars").textContent = res.totals.cars;
        document.getElementById("statVisits").textContent = res.totals.visits;
        document.getElementById("statAmount").textContent = res.totals.amount;
    } catch (e) {
        document.getElementById("statCustomers").textContent = "-";
        document.getElementById("statCars").textContent = "-";
        document.getElementById("statVisits").textContent = "-";
        document.getElementById("statAmount").textContent = "-";
    }
}

/* ========== Barcode Scanner ========== */
let scanner = null;

function startScanner() {
    const reader = document.getElementById("reader");
    reader.style.display = "block";

    if (scanner) {
        scanner.stop().catch(() => {});
    }

    scanner = new Html5Qrcode("reader");
    scanner.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        (decodedText) => {
            document.getElementById("searchPhone").value = decodedText;
            scanner.stop().catch(() => {});
            reader.style.display = "none";
            searchCustomer();
        }
    ).catch(() => {
        alert("Ù„Ø§ ÙŠÙ…ÙƒÙ† ÙØªØ­ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§");
        reader.style.display = "none";
    });
}

/* ========== Search Customer ========== */
async function searchCustomer() {
    const btn = document.getElementById("searchBtn");
    const phone = document.getElementById("searchPhone").value.trim();

    if (!phone) {
        alert("Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø£Ùˆ Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©");
        return;
    }

    btn.classList.add("loading");
    btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...";

    try {
        const res = await apiGet({ action: "getByPhone", phone });

        btn.classList.remove("loading");
        btn.innerText = "Ø¨Ø­Ø«";

        if (!res.success) {
            document.getElementById("searchResult").innerHTML = "<span class='muted'>ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯</span>";
            return;
        }

        document.getElementById("searchResult").innerHTML = `
            <div class="card" style="background:#020617;border-color:#1f2937;">
                Ø§Ù„Ø§Ø³Ù…: ${res.customer.name}<br>
                Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©: ${res.customer.membership}<br>
                Ø§Ù„Ù†Ù‚Ø§Ø·: ${res.customer.points}<br>
                Ø§Ù„Ù…Ø³ØªÙˆÙ‰: ${res.customer.level}
            </div>
        `;
    } catch (e) {
        btn.classList.remove("loading");
        btn.innerText = "Ø¨Ø­Ø«";
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¨Ø­Ø«");
    }
}

/* ========== Customer Visits ========== */
async function loadCustomerVisits() {
    const btn = document.getElementById("visitsBtn");
    const phone = document.getElementById("visitsPhone").value.trim();

    if (!phone) {
        alert("Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„");
        return;
    }

    btn.classList.add("loading");
    btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...";

    try {
        const res = await apiGet({ action: "getVisitsByPhone", phone });

        btn.classList.remove("loading");
        btn.innerText = "Ø¹Ø±Ø¶ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª";

        const list = document.getElementById("visitsList");
        list.innerHTML = "";

        if (!res.visits || res.visits.length === 0) {
            list.innerHTML = "<span class='muted'>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø²ÙŠØ§Ø±Ø§Øª</span>";
            return;
        }

        res.visits.forEach(v => {
            const div = document.createElement("div");
            div.className = "card";
            div.innerHTML = `
                ${v.service} - ${v.date}<br>
                Ø§Ù„Ø³Ø¹Ø±: ${v.price}<br>
                Ø§Ù„Ù†Ù‚Ø§Ø·: ${v.points}
            `;
            list.appendChild(div);
        });
    } catch (e) {
        btn.classList.remove("loading");
        btn.innerText = "Ø¹Ø±Ø¶ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª";
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª");
    }
}

/* ========== Customer Cars ========== */
async function loadCustomerCars() {
    const btn = document.getElementById("carsBtn");
    const phone = document.getElementById("carsPhone").value.trim();

    if (!phone) {
        alert("Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„");
        return;
    }

    btn.classList.add("loading");
    btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...";

    try {
        const res = await apiGet({ action: "getCarsByPhone", phone });

        btn.classList.remove("loading");
        btn.innerText = "Ø¹Ø±Ø¶ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª";

        const list = document.getElementById("carsList");
        list.innerHTML = "";

        if (!res.cars || res.cars.length === 0) {
            list.innerHTML = "<span class='muted'>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³ÙŠØ§Ø±Ø§Øª</span>";
            return;
        }

        res.cars.forEach(c => {
            const div = document.createElement("div");
            div.className = "card";
            div.innerHTML = `
                ${c.car} - ${c.plate_letters} ${c.plate_numbers}<br>
                Ø§Ù„Ø­Ø¬Ù…: ${c.size}<br>
                Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©: ${c.city}
            `;
            list.appendChild(div);
        });
    } catch (e) {
        btn.classList.remove("loading");
        btn.innerText = "Ø¹Ø±Ø¶ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª";
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª");
    }
}

/* ========== Send Notification (as rating) ========== */
async function sendNotification() {
    const btn = document.getElementById("notifyBtn");
    const msg = document.getElementById("notifyMsg").value.trim();

    if (!msg) {
        alert("Ø£Ø¯Ø®Ù„ Ù†Øµ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±");
        return;
    }

    btn.classList.add("loading");
    btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...";

    try {
        await apiPost({
            action: "addRating",
            membership: "",
            rating: 0,
            comment: msg
        });

        btn.classList.remove("loading");
        btn.innerText = "Ø¥Ø±Ø³Ø§Ù„";
        document.getElementById("notifyStatus").innerText = "ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ (ÙƒØªÙ‚ÙŠÙŠÙ… Ø¯Ø§Ø®Ù„ÙŠ)";
    } catch (e) {
        btn.classList.remove("loading");
        btn.innerText = "Ø¥Ø±Ø³Ø§Ù„";
        document.getElementById("notifyStatus").innerText = "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„";
    }
}

/* ========== Add Visit ========== */
async function addVisit() {
    const btn = document.getElementById("addVisitBtn");
    const membership = document.getElementById("vMembership").value.trim();
    const service = document.getElementById("vService").value.trim();
    const price = document.getElementById("vPrice").value.trim();
    const points = document.getElementById("vPoints").value.trim();

    if (!membership || !service || !price || !points) {
        alert("ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„");
        return;
    }

    btn.classList.add("loading");
    btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø¶Ø§ÙØ©...";

    try {
        await apiPost({
            action: "addVisit",
            membership,
            service,
            price,
            points
        });

        btn.classList.remove("loading");
        btn.innerText = "Ø¥Ø¶Ø§ÙØ©";
        document.getElementById("addVisitStatus").innerText = "ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¬Ø§Ø­";
    } catch (e) {
        btn.classList.remove("loading");
        btn.innerText = "Ø¥Ø¶Ø§ÙØ©";
        document.getElementById("addVisitStatus").innerText = "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø¶Ø§ÙØ©";
    }
}

/* ========== Bookings ========== */
async function loadBookings() {
    try {
        const res = await apiGet({ action: "getAllBookings" });

        const list = document.getElementById("bookingsList");
        list.innerHTML = "";

        if (!res.bookings || res.bookings.length === 0) {
            list.innerHTML = "<span class='muted'>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª</span>";
            return;
        }

        res.bookings.forEach(b => {
            const div = document.createElement("div");
            div.className = "card";
            div.innerHTML = `
                ${b.service} - ${b.date} ${b.time}<br>
                Ø§Ù„Ø­Ø§Ù„Ø©: <span class="badge-status ${b.status}">${b.status}</span><br>
                <div style="display:flex; gap:8px; margin-top:8px;">
                    <button class="btn-success" onclick="confirmBooking(${b.row})">ØªØ£ÙƒÙŠØ¯</button>
                    <button class="btn-danger" onclick="cancelBooking(${b.row})">Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            `;
            list.appendChild(div);
        });
    } catch (e) {
        document.getElementById("bookingsList").innerHTML = "<span class='muted'>Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</span>";
    }
}

async function confirmBooking(row) {
    await apiPost({ action: "updateBookingStatus", row, status: "Approved" });
    loadBookings();
}

async function cancelBooking(row) {
    await apiPost({ action: "updateBookingStatus", row, status: "Cancelled" });
    loadBookings();
}

/* ========== Ratings (Visits by date) ========== */
async function loadRatings() {
    try {
        const res = await apiGet({ action: "getVisitsByDate", from: "2000-01-01", to: "2100-01-01" });

        const list = document.getElementById("ratingsList");
        list.innerHTML = "";

        if (!res.visits || res.visits.length === 0) {
            list.innerHTML = "<span class='muted'>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø²ÙŠØ§Ø±Ø§Øª</span>";
            return;
        }

        res.visits.forEach(v => {
            const div = document.createElement("div");
            div.className = "card";
            div.innerHTML = `
                ${v.service} - ${v.date}<br>
                Ù†Ù‚Ø§Ø·: ${v.points}
            `;
            list.appendChild(div);
        });
    } catch (e) {
        document.getElementById("ratingsList").innerHTML = "<span class='muted'>Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span>";
    }
}

/* ========== Initial Load ========== */
loadDashboard();
loadBookings();
loadRatings();
</script>

</body>
</html>
