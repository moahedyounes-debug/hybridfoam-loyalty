<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø´Ø±Ù - Supervisor Panel</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Flatpickr -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- SheetJS (Excel) -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
:root {
  --bg: #0f172a;
  --bg-soft: #020617;
  --card: #020617;
  --border: #1f2937;
  --accent: #2563eb;
  --accent-soft: #1d4ed8;
  --danger: #dc2626;
  --success: #16a34a;
  --warning: #f59e0b;
  --text-main: #f9fafb;
  --text-muted: #9ca3af;
  --radius-lg: 16px;
  --radius-md: 12px;
  --radius-sm: 8px;
  --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.7);
  --transition-fast: 0.15s ease-out;
}

[data-theme="light"] {
  --bg: #f3f4f6;
  --bg-soft: #e5e7eb;
  --card: #ffffff;
  --border: #d1d5db;
  --accent: #2563eb;
  --accent-soft: #1d4ed8;
  --danger: #dc2626;
  --success: #16a34a;
  --warning: #f59e0b;
  --text-main: #111827;
  --text-muted: #6b7280;
  --shadow-soft: 0 10px 30px rgba(15, 23, 42, 0.12);
}

*,
*::before,
*::after {
  box-sizing: border-box;
}

html, body {
  margin: 0;
  padding: 0;
  font-family: "Tajawal", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  background: radial-gradient(circle at top, #1e293b 0, #020617 45%, #000 100%);
  color: var(--text-main);
  direction: rtl;
}

body {
  background: var(--bg);
}

/* Layout */
.layout {
  display: flex;
  min-height: 100vh;
}

/* Sidebar */
.sidebar {
  width: 260px;
  background: rgba(15, 23, 42, 0.98);
  border-left: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  padding: 18px 14px;
  gap: 10px;
}

[data-theme="light"] .sidebar {
  background: #111827;
}

.brand {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 10px;
}

.brand-logo {
  width: 40px;
  height: 40px;
  border-radius: 14px;
  background: #020617;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
}

.brand-logo img {
  width: 100%;
  height: 100%;
  object-fit: contain;
}

.brand-text {
  font-size: 18px;
  font-weight: 600;
  color: #e5e7eb;
}

.nav-section-title {
  font-size: 11px;
  color: var(--text-muted);
  margin: 10px 4px 4px;
}

.nav {
  display: flex;
  flex-direction: column;
  gap: 6px;
  margin-bottom: 6px;
}

.nav-btn {
  width: 100%;
  text-align: right;
  padding: 9px 11px;
  border-radius: 10px;
  border: none;
  background: transparent;
  color: var(--text-muted);
  font-size: 14px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: space-between;
  transition: var(--transition-fast);
}

.nav-btn span {
  display: inline-flex;
  align-items: center;
  gap: 6px;
}

.nav-btn.active {
  background: rgba(37, 99, 235, 0.22);
  color: var(--text-main);
}

.nav-btn:hover {
  background: rgba(15, 23, 42, 0.9);
  color: var(--text-main);
}

/* Main */
.main {
  flex: 1;
  display: flex;
  flex-direction: column;
  min-width: 0;
}

/* Topbar */
.topbar {
  padding: 12px 18px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: rgba(15, 23, 42, 0.9);
  backdrop-filter: blur(10px);
  position: sticky;
  top: 0;
  z-index: 10;
}

[data-theme="light"] .topbar {
  background: #ffffffcc;
}

.topbar-left {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.topbar-title {
  font-size: 16px;
  font-weight: 500;
}

.topbar-sub {
  font-size: 12px;
  color: var(--text-muted);
}

.stats-bar {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  justify-content: flex-end;
}

.pill {
  padding: 4px 10px;
  border-radius: 999px;
  background: rgba(15, 23, 42, 0.9);
  border: 1px solid var(--border);
  font-size: 12px;
  color: var(--text-muted);
  display: inline-flex;
  align-items: center;
  gap: 4px;
}

[data-theme="light"] .pill {
  background: #f9fafb;
}

/* Theme toggle */
.theme-toggle {
  border-radius: 999px;
  border: 1px solid var(--border);
  padding: 6px 10px;
  font-size: 12px;
  background: transparent;
  color: var(--text-main);
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  gap: 6px;
}

/* Content */
.content {
  padding: 18px;
  display: flex;
  flex-direction: column;
  gap: 18px;
}

.section {
  display: none;
}

.section.active {
  display: block;
}

.card {
  background: var(--card);
  border-radius: var(--radius-lg);
  padding: 16px;
  border: 1px solid var(--border);
  box-shadow: var(--shadow-soft);
}

.card-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 10px;
}

.card-header h2,
.card-header h3 {
  margin: 0;
  text-align: right;
}

h2, h3 {
  text-align: right;
  margin: 0 0 10px;
}

p {
  text-align: right;
}

/* Inputs */
label {
  display: block;
  font-size: 13px;
  color: var(--text-muted);
  margin-top: 8px;
  margin-bottom: 3px;
}

input, select, textarea {
  width: 100%;
  padding: 10px 11px;
  border-radius: var(--radius-md);
  border: 1px solid var(--border);
  background: #020617;
  color: var(--text-main);
  font-size: 14px;
  margin-bottom: 6px;
  outline: none;
  transition: var(--transition-fast);
}

[data-theme="light"] input,
[data-theme="light"] select,
[data-theme="light"] textarea {
  background: #f9fafb;
}

input:focus,
select:focus,
textarea:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.4);
}

textarea {
  min-height: 90px;
  resize: vertical;
}

/* Buttons */
button {
  padding: 10px 12px;
  border-radius: var(--radius-md);
  border: none;
  background: var(--accent);
  color: white;
  font-size: 14px;
  cursor: pointer;
  margin-top: 8px;
  position: relative;
  transition: var(--transition-fast);
}

button.loading {
  color: transparent !important;
  cursor: not-allowed;
  background: #6b7280 !important;
}

button.loading::after {
  content: "";
  position: absolute;
  top: 50%;
  left: 50%;
  width: 20px;
  height: 20px;
  margin-top: -10px;
  margin-left: -10px;
  border: 3px solid white;
  border-top-color: transparent;
  border-radius: 50%;
  animation: spin 0.7s linear infinite;
}

button:active {
  transform: scale(0.97);
}

button.secondary {
  background: #111827;
  color: var(--text-main);
}

[data-theme="light"] button.secondary {
  background: #e5e7eb;
  color: #111827;
}

button.danger {
  background: var(--danger);
}

/* Loader keyframes */
@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Lists */
.list {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

/* Status text */
.status-text {
  font-size: 12px;
  color: var(--text-muted);
  margin-top: 6px;
  text-align: right;
}

/* Utility */
.row {
  display: flex;
  gap: 10px;
}

.row > * {
  flex: 1;
}

/* Dashboard grid */
.dashboard-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 12px;
  margin-top: 12px;
}

.dash-card {
  background: var(--card);
  border-radius: 14px;
  padding: 12px;
  border: 1px solid var(--border);
  font-size: 13px;
}

.dash-card-title {
  font-size: 13px;
  color: var(--text-muted);
  margin-bottom: 6px;
}

.dash-card-value {
  font-size: 18px;
  font-weight: 600;
  margin-bottom: 4px;
}

/* Simple bar container */
.bar-row {
  display: flex;
  align-items: center;
  gap: 6px;
  margin-bottom: 4px;
  font-size: 11px;
}

.bar-label {
  min-width: 70px;
  color: var(--text-muted);
}

.bar-track {
  flex: 1;
  height: 6px;
  border-radius: 999px;
  background: #020617;
  border: 1px solid var(--border);
  overflow: hidden;
}

[data-theme="light"] .bar-track {
  background: #f3f4f6;
}

.bar-fill {
  height: 100%;
  background: linear-gradient(90deg, #2563eb, #22c55e);
  width: 0%;
}

/* Charts container */
.charts-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
  gap: 14px;
  margin-top: 10px;
}

.chart-card {
  background: var(--card);
  border-radius: 14px;
  padding: 12px;
  border: 1px solid var(--border);
}

/* Table-like list */
.table-header, .table-row {
  display: grid;
  grid-template-columns: 1.2fr 1fr 1fr 1fr 1fr 1fr 1fr;
  gap: 6px;
  font-size: 12px;
  padding: 6px 8px;
}

.table-header {
  border-bottom: 1px solid var(--border);
  color: var(--text-muted);
}

.table-row {
  border-radius: 10px;
  background: rgba(15, 23, 42, 0.6);
}

[data-theme="light"] .table-row {
  background: #f9fafb;
}

/* Responsive */
@media (max-width: 900px) {
  .layout {
    flex-direction: column;
  }
  .sidebar {
    width: 100%;
    flex-direction: row;
    overflow-x: auto;
    border-left: none;
    border-bottom: 1px solid var(--border);
  }
  .nav {
    flex-direction: row;
    flex-wrap: nowrap;
  }
  .nav-btn {
    white-space: nowrap;
  }
  .topbar {
    flex-direction: column;
    align-items: flex-start;
    gap: 8px;
  }
  .stats-bar {
    justify-content: flex-start;
  }
  .table-header, .table-row {
    grid-template-columns: 1.5fr 1fr 1fr 1fr;
  }
}
</style>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="api.js?v=3"></script>
</head>
<body data-theme="dark">

<div class="layout">

  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="brand">
      <div class="brand-logo">
        <img src="logo.png" alt="Logo">
      </div>
      <div class="brand-text">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø´Ø±Ù</div>
    </div>

    <div class="nav-section-title">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
    <div class="nav">
      <button class="nav-btn active" data-target="dashboard"><span>Dashboard</span></button>
    </div>

    <div class="nav-section-title">Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</div>
    <div class="nav">
      <button class="nav-btn" data-target="customers"><span>Ø¨Ø­Ø« Ø¹Ù…ÙŠÙ„</span></button>
      <button class="nav-btn" data-target="visits"><span>Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</span></button>
      <button class="nav-btn" data-target="cars"><span>Ø³ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</span></button>
    </div>

    <div class="nav-section-title">Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª ÙˆØ§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</div>
    <div class="nav">
      <button class="nav-btn" data-target="addVisit"><span>Ø¥Ø¶Ø§ÙØ© Ø²ÙŠØ§Ø±Ø©</span></button>
      <button class="nav-btn" data-target="bookings"><span>Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</span></button>
    </div>

    <div class="nav-section-title">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</div>
    <div class="nav">
      <button class="nav-btn" data-target="reports"><span>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠØ©</span></button>
      <button class="nav-btn" data-target="export"><span>ØªØµØ¯ÙŠØ± Excel</span></button>
    </div>
  </aside>

  <!-- Main -->
  <main class="main">

    <div class="topbar">
      <div class="topbar-left">
        <div class="topbar-title">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø´Ø±Ù</div>
        <div class="topbar-sub">
          Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØ±Ø¹ØŒ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ØŒ Ø§Ù„Ø²ÙŠØ§Ø±Ø§ØªØŒ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠØ©
        </div>
      </div>

      <div class="stats-bar">
        <div class="pill">ğŸ¬ Ø§Ù„ÙØ±Ø¹: <span id="currentBranch">...</span></div>
        <div class="pill">ğŸ‘¥ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡: <span id="sCustomers">0</span></div>
        <div class="pill">ğŸš— Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª: <span id="sCars">0</span></div>
        <div class="pill">ğŸ§¾ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª: <span id="sVisits">0</span></div>
        <div class="pill">ğŸ’° Ø§Ù„Ù…Ø¨Ø§Ù„Øº: <span id="sAmount">0</span></div>
        <button class="theme-toggle" id="themeToggle">ğŸŒ™ / â˜€ï¸</button>
      </div>
    </div>

    <div class="content">

      <!-- Dashboard -->
      <section id="dashboard" class="section active">
        <div class="card">
          <div class="card-header">
            <h2>Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„ÙØ±Ø¹</h2>
            <div style="min-width:180px;">
              <label>Ø§Ø®ØªØ± Ø§Ù„ÙØ±Ø¹</label>
              <select id="branchSelect"></select>
            </div>
          </div>

          <p id="stats">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>

          <div class="dashboard-grid" id="dashCards"></div>

          <div class="charts-grid" style="margin-top:16px;">
            <div class="chart-card">
              <div class="dash-card-title">Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ÙŠÙˆÙ…</div>
              <canvas id="chartVisitsPerDay" height="140"></canvas>
            </div>
            <div class="chart-card">
              <div class="dash-card-title">Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ÙŠÙˆÙ…</div>
              <canvas id="chartAmountPerDay" height="140"></canvas>
            </div>
            <div class="chart-card">
              <div class="dash-card-title">Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø£ÙƒØ«Ø± Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‹Ø§</div>
              <canvas id="chartServices" height="140"></canvas>
            </div>
            <div class="chart-card">
              <div class="dash-card-title">Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† (Ø¹Ù…ÙˆÙ„Ø§Øª)</div>
              <canvas id="chartEmployees" height="140"></canvas>
            </div>
          </div>
        </div>
      </section>

      <!-- Customers -->
      <section id="customers" class="section">
        <div class="card">
          <div class="card-header">
            <h2>Ø¨Ø­Ø« Ø¹Ù† Ø¹Ù…ÙŠÙ„</h2>
          </div>

          <label>Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©</label>
          <input id="custSearchInput" placeholder="05xxxxxxxx Ø£Ùˆ 2026xxxx">
          <button id="custSearchBtn">Ø¨Ø­Ø«</button>

          <div id="custSearchResult" style="margin-top:10px;"></div>
        </div>
      </section>

      <!-- Visits -->
      <section id="visits" class="section">
        <div class="card">
          <div class="card-header">
            <h2>Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙÙŠ Ø§Ù„ÙØ±Ø¹</h2>
          </div>

          <div class="row">
            <div>
              <label>Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
              <input id="visitsFrom" class="datePicker" placeholder="YYYY-MM-DD">
            </div>
            <div>
              <label>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
              <input id="visitsTo" class="datePicker" placeholder="YYYY-MM-DD">
            </div>
          </div>

          <div class="row">
            <div>
              <label>Ø§Ù„Ø®Ø¯Ù…Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
              <input id="visitsServiceFilter" placeholder="Ù…Ø«Ø§Ù„: ØºØ³ÙŠÙ„ Ø®Ø§Ø±Ø¬ÙŠ">
            </div>
            <div>
              <label>Ø§Ù„Ù…ÙˆØ¸Ù (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
              <input id="visitsEmployeeFilter" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù">
            </div>
          </div>

          <button id="visitsLoadBtn">Ø¹Ø±Ø¶ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª</button>

          <div id="visitsList" class="list" style="margin-top:10px;"></div>
        </div>
      </section>

      <!-- Cars -->
      <section id="cars" class="section">
        <div class="card">
          <div class="card-header">
            <h2>Ø³ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h2>
          </div>

          <label>Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</label>
          <input id="carsPhone" placeholder="05xxxxxxxx">
          <button id="carsBtn">Ø¹Ø±Ø¶ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</button>

          <div id="carsList" class="list" style="margin-top:10px;"></div>
        </div>
      </section>

      <!-- Add Visit -->
      <section id="addVisit" class="section">
        <div class="card">
          <div class="card-header">
            <h2>Ø¥Ø¶Ø§ÙØ© Ø²ÙŠØ§Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø©</h2>
          </div>

          <div class="card" style="background:var(--bg-soft);margin-bottom:10px;">
            <div class="card-header">
              <h3>Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„</h3>
            </div>
            <label>Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø£Ùˆ Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©</label>
            <input id="visitSearch" placeholder="05xxxxxxxx Ø£Ùˆ 2026xxxx">
            <button id="visitSearchBtn">Ø¨Ø­Ø«</button>
          </div>

          <div id="visitCarsBox" class="card" style="display:none;background:var(--bg-soft);margin-bottom:10px;">
            <div class="card-header">
              <h3>Ø§Ø®ØªØ± Ø§Ù„Ø³ÙŠØ§Ø±Ø©</h3>
            </div>
            <div id="visitCarsList" class="list"></div>
          </div>

          <div id="visitForm" class="card" style="display:none;background:var(--bg-soft);">
            <div class="card-header">
              <h3>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø²ÙŠØ§Ø±Ø©</h3>
            </div>

            <p id="visitSelectedInfo" class="status-text"></p>

            <label>Ø§Ù„Ø®Ø¯Ù…Ø©</label>
            <select id="vService"></select>

            <div class="row">
              <div>
                <label>Ø§Ù„Ø³Ø¹Ø±</label>
                <input type="number" id="vPrice">
              </div>
              <div>
                <label>Ø§Ù„Ù†Ù‚Ø§Ø·</label>
                <input type="number" id="vPoints" readonly>
              </div>
            </div>

            <label>Ø§Ù„Ù…ÙˆØ¸Ù (Ù…Ù† Ø´ÙŠØª Employees - Ø¹Ù…ÙˆØ¯ A)</label>
            <select id="vEmployee"></select>

            <button id="addVisitBtn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø²ÙŠØ§Ø±Ø©</button>
            <p id="addVisitStatus" class="status-text"></p>
          </div>
        </div>
      </section>

      <!-- Bookings -->
      <section id="bookings" class="section">
        <div class="card">
          <div class="card-header">
            <h2>Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„ÙØ±Ø¹</h2>
          </div>

          <label>Ø§Ø®ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ® (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input id="bookingsDate" class="datePicker" placeholder="YYYY-MM-DD">

          <div id="bookingsList" class="list" style="margin-top:10px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
        </div>
      </section>

      <!-- Reports -->
      <section id="reports" class="section">
        <div class="card">
          <div class="card-header">
            <h2>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠØ©</h2>
          </div>

          <div class="row">
            <div>
              <label>Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
              <input id="reportsFrom" class="datePicker" placeholder="YYYY-MM-DD">
            </div>
            <div>
              <label>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
              <input id="reportsTo" class="datePicker" placeholder="YYYY-MM-DD">
            </div>
          </div>

          <button id="reportsBtn">Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>

          <div id="reportsSummary" class="dashboard-grid" style="margin-top:12px;"></div>

          <div id="reportsList" class="list" style="margin-top:10px;"></div>
        </div>
      </section>

      <!-- Export -->
      <section id="export" class="section">
        <div class="card">
          <div class="card-header">
            <h2>ØªØµØ¯ÙŠØ± Excel</h2>
          </div>

          <div class="row">
            <div>
              <label>ØªÙ‚Ø±ÙŠØ± ÙŠÙˆÙ…ÙŠ</label>
              <input id="exportDailyDate" class="datePicker" placeholder="YYYY-MM-DD">
              <button id="exportDailyBtn">ØªØµØ¯ÙŠØ± Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„ÙŠÙˆÙ…</button>
            </div>
            <div>
              <label>ØªÙ‚Ø±ÙŠØ± Ø´Ù‡Ø±ÙŠ</label>
              <input id="exportMonthlyDate" class="datePicker" placeholder="YYYY-MM (Ø§ÙƒØªØ¨ Ø£ÙˆÙ„ ÙŠÙˆÙ… ÙÙŠ Ø§Ù„Ø´Ù‡Ø± Ù…Ø«Ù„Ø§Ù‹) ">
              <button id="exportMonthlyBtn">ØªØµØ¯ÙŠØ± Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø´Ù‡Ø±</button>
            </div>
          </div>

          <p class="status-text">
            ÙŠØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ± Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Google Sheet Ø¹Ø¨Ø± Ø§Ù„Ù€ APIØŒ Ù…Ø¹ ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ.
          </p>
        </div>
      </section>

    </div>
  </main>
</div>

<script>
/* ========== Helpers ========== */
const $ = (id) => document.getElementById(id);

function setLoading(btn, state = true) {
  if (!btn) return;
  if (state) {
    btn.classList.add("loading");
    btn.disabled = true;
  } else {
    btn.classList.remove("loading");
    btn.disabled = false;
  }
}

function formatDateOnly(d) {
  const dt = new Date(d);
  return dt.toISOString().slice(0, 10);
}

/* ========== Theme Toggle ========== */
(function initTheme() {
  const saved = localStorage.getItem("supervisor_theme") || "dark";
  document.body.setAttribute("data-theme", saved);
  const btn = $("themeToggle");
  btn.addEventListener("click", () => {
    const current = document.body.getAttribute("data-theme");
    const next = current === "dark" ? "light" : "dark";
    document.body.setAttribute("data-theme", next);
    localStorage.setItem("supervisor_theme", next);
  });
})();

/* ========== Tabs ========== */
(function initTabs() {
  const sections = document.querySelectorAll(".section");
  const navButtons = document.querySelectorAll(".nav-btn");
  navButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      const target = btn.getAttribute("data-target");
      sections.forEach(s => s.classList.remove("active"));
      $(target).classList.add("active");
      navButtons.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
    });
  });
})();

/* ========== Date Pickers ========== */
(function initDatePickers() {
  const options = { dateFormat: "Y-m-d", allowInput: true };
  flatpickr("#visitsFrom", options);
  flatpickr("#visitsTo", options);
  flatpickr("#bookingsDate", options);
  flatpickr("#reportsFrom", options);
  flatpickr("#reportsTo", options);
  flatpickr("#exportDailyDate", options);
  flatpickr("#exportMonthlyDate", options);
})();

/* ========== Branch Handling ========== */
let currentBranch = null;
let branchesList = [];

async function loadBranches() {
  const res = await apiGet({ action: "getBranches" });
  branchesList = res.branches || [];
  const select = $("branchSelect");
  select.innerHTML = "";
  branchesList.forEach(b => {
    const opt = document.createElement("option");
    opt.value = b.branch;
    opt.textContent = `${b.branch} â€” ${b.city}`;
    select.appendChild(opt);
  });

  const savedBranch = localStorage.getItem("supervisor_branch");
  if (savedBranch && branchesList.find(b => b.branch === savedBranch)) {
    select.value = savedBranch;
    currentBranch = savedBranch;
  } else if (branchesList.length > 0) {
    currentBranch = branchesList[0].branch;
    select.value = currentBranch;
  }

  $("currentBranch").textContent = currentBranch || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";

  select.addEventListener("change", () => {
    currentBranch = select.value;
    localStorage.setItem("supervisor_branch", currentBranch);
    $("currentBranch").textContent = currentBranch;
    loadDashboard();
    loadBookings();
  });
}

/* ========== Dashboard & Charts ========== */
let chartVisitsPerDay, chartAmountPerDay, chartServices, chartEmployees;

async function loadDashboard() {
  const res = await apiGet({ action: "getOwnersDashboard" });

  // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ
  const branch = currentBranch;
  const visits = (res.visits_per_day_raw || res.visits_raw || []).length
    ? res.visits_raw
    : null;

  // Ø¨Ù…Ø§ Ø£Ù† getOwnersDashboard Ù„Ø§ ÙŠØ±Ø¬Ø¹ rawØŒ Ù†Ø³ØªØ®Ø¯Ù… Visits sheet Ø¹Ø¨Ø± API Ø¢Ø®Ø± Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©
  // Ù‡Ù†Ø§ Ù†Ø³ØªØ®Ø¯Ù… totals Ø§Ù„Ø¹Ø§Ù…Ø© + Ù†Ø¹ÙŠØ¯ Ø­Ø³Ø§Ø¨ Ø¨Ø¹Ø¶ Ø§Ù„Ø£Ø´ÙŠØ§Ø¡ Ù…Ù† getVisitsByDate Ù„ÙƒÙ„ Ø§Ù„ÙØªØ±Ø§Øª
  const fromDate = "2000-01-01T00:00:00.000Z";
  const toDate = "2100-01-01T23:59:59.000Z";
  const visitsRes = await apiGet({
    action: "getVisitsByDate",
    from: fromDate,
    to: toDate
  });

  const branchVisits = (visitsRes.visits || []).filter(v => v.branch === branch);

  const totalAmount = branchVisits.reduce((s, v) => s + Number(v.price || 0), 0);
  const totalVisits = branchVisits.length;
  const membershipsSet = new Set(branchVisits.map(v => v.membership));
  const totalCustomers = membershipsSet.size;

  $("stats").innerHTML = `
    Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙÙŠ Ø§Ù„ÙØ±Ø¹: ${totalCustomers}<br>
    Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª ÙÙŠ Ø§Ù„ÙØ±Ø¹: ${totalVisits}<br>
    Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ø§Ù„Øº: ${totalAmount}
  `;

  $("sCustomers").innerText = totalCustomers;
  $("sVisits").innerText = totalVisits;
  $("sAmount").innerText = totalAmount;

  // Ø³ÙŠØ§Ø±Ø§Øª Ø§Ù„ÙØ±Ø¹ (Ù…Ù† Cars + branch)
  const carsRes = await apiGet({ action: "getBranches" }); // ÙÙ‚Ø· Ù„Ù…Ø¹Ø±ÙØ© Ø§Ù„Ù…Ø¯Ù†ØŒ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª Ù…Ù† Visits
  const carsCount = new Set(branchVisits.map(v => v.membership + "_" + v.service)).size;
  $("sCars").innerText = carsCount;

  renderDashboardCards(branchVisits);
  renderCharts(branchVisits);
}

function renderDashboardCards(branchVisits) {
  const container = $("dashCards");
  container.innerHTML = "";

  const totalAmount = branchVisits.reduce((s, v) => s + Number(v.price || 0), 0);
  const totalVisits = branchVisits.length;
  const membershipsSet = new Set(branchVisits.map(v => v.membership));
  const totalCustomers = membershipsSet.size;

  const avgTicket = totalVisits ? (totalAmount / totalVisits).toFixed(1) : 0;
  const avgPerCustomer = totalCustomers ? (totalAmount / totalCustomers).toFixed(1) : 0;

  const servicesMap = {};
  const employeesMap = {};
  const daysMap = {};

  branchVisits.forEach(v => {
    const d = formatDateOnly(v.date);
    daysMap[d] = (daysMap[d] || 0) + 1;

    const s = v.service || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
    servicesMap[s] = (servicesMap[s] || 0) + 1;

    const e = v.employee || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
    employeesMap[e] = (employeesMap[e] || 0) + Number(v.commission || 0);
  });

  const topService = Object.entries(servicesMap).sort((a,b)=>b[1]-a[1])[0];
  const topEmployee = Object.entries(employeesMap).sort((a,b)=>b[1]-a[1])[0];

  const cards = [
    {
      title: "Ù…ØªÙˆØ³Ø· Ù‚ÙŠÙ…Ø© Ø§Ù„ÙØ§ØªÙˆØ±Ø©",
      value: avgTicket,
      suffix: "Ø±ÙŠØ§Ù„"
    },
    {
      title: "Ù…ØªÙˆØ³Ø· Ø¥Ù†ÙØ§Ù‚ Ø§Ù„Ø¹Ù…ÙŠÙ„",
      value: avgPerCustomer,
      suffix: "Ø±ÙŠØ§Ù„"
    },
    {
      title: "Ø£ÙƒØ«Ø± Ø®Ø¯Ù…Ø© Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‹Ø§",
      value: topService ? topService[0] : "â€”",
      suffix: topService ? `(${topService[1]} Ø²ÙŠØ§Ø±Ø©)` : ""
    },
    {
      title: "Ø£Ø¹Ù„Ù‰ Ù…ÙˆØ¸Ù Ø¹Ù…ÙˆÙ„Ø©",
      value: topEmployee ? topEmployee[0] : "â€”",
      suffix: topEmployee ? `${topEmployee[1]} Ø±ÙŠØ§Ù„` : ""
    }
  ];

  cards.forEach(c => {
    const div = document.createElement("div");
    div.className = "dash-card";
    div.innerHTML = `
      <div class="dash-card-title">${c.title}</div>
      <div class="dash-card-value">${c.value}</div>
      <div style="font-size:12px;color:var(--text-muted);">${c.suffix}</div>
    `;
    container.appendChild(div);
  });
}

function renderCharts(branchVisits) {
  const byDay = {};
  const byDayAmount = {};
  const byService = {};
  const byEmployee = {};

  branchVisits.forEach(v => {
    const d = formatDateOnly(v.date);
    const price = Number(v.price || 0);
    const s = v.service || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
    const e = v.employee || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";

    byDay[d] = (byDay[d] || 0) + 1;
    byDayAmount[d] = (byDayAmount[d] || 0) + price;
    byService[s] = (byService[s] || 0) + 1;
    byEmployee[e] = (byEmployee[e] || 0) + Number(v.commission || 0);
  });

  const days = Object.keys(byDay).sort();
  const visitsData = days.map(d => byDay[d]);
  const amountData = days.map(d => byDayAmount[d]);

  const services = Object.entries(byService).sort((a,b)=>b[1]-a[1]).slice(0,8);
  const servicesLabels = services.map(s=>s[0]);
  const servicesCounts = services.map(s=>s[1]);

  const employees = Object.entries(byEmployee).sort((a,b)=>b[1]-a[1]).slice(0,8);
  const employeesLabels = employees.map(e=>e[0]);
  const employeesAmounts = employees.map(e=>e[1]);

  const ctx1 = $("chartVisitsPerDay").getContext("2d");
  const ctx2 = $("chartAmountPerDay").getContext("2d");
  const ctx3 = $("chartServices").getContext("2d");
  const ctx4 = $("chartEmployees").getContext("2d");

  if (chartVisitsPerDay) chartVisitsPerDay.destroy();
  if (chartAmountPerDay) chartAmountPerDay.destroy();
  if (chartServices) chartServices.destroy();
  if (chartEmployees) chartEmployees.destroy();

  chartVisitsPerDay = new Chart(ctx1, {
    type: "line",
    data: {
      labels: days,
      datasets: [{
        label: "Ø¹Ø¯Ø¯ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª",
        data: visitsData,
        borderColor: "#2563eb",
        backgroundColor: "rgba(37,99,235,0.2)",
        tension: 0.3,
        fill: true
      }]
    },
    options: { responsive: true, plugins: { legend: { display: false } } }
  });

  chartAmountPerDay = new Chart(ctx2, {
    type: "bar",
    data: {
      labels: days,
      datasets: [{
        label: "Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª (Ø±ÙŠØ§Ù„)",
        data: amountData,
        backgroundColor: "#22c55e"
      }]
    },
    options: { responsive: true, plugins: { legend: { display: false } } }
  });

  chartServices = new Chart(ctx3, {
    type: "bar",
    data: {
      labels: servicesLabels,
      datasets: [{
        label: "Ø¹Ø¯Ø¯ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª",
        data: servicesCounts,
        backgroundColor: "#f59e0b"
      }]
    },
    options: { responsive: true, plugins: { legend: { display: false } } }
  });

  chartEmployees = new Chart(ctx4, {
    type: "bar",
    data: {
      labels: employeesLabels,
      datasets: [{
        label: "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©",
        data: employeesAmounts,
        backgroundColor: "#6366f1"
      }]
    },
    options: { responsive: true, plugins: { legend: { display: false } } }
  });
}

/* ========== Smart Customer Search ========== */
async function smartSearchCustomer(query) {
  if (query.startsWith("05") && query.length === 10) {
    const res = await apiGet({ action: "getByPhone", phone: query });
    if (!res.success) return null;
    return { customers: [res.customer], cars: res.cars || [] };
  }
  if (/^\d+$/.test(query)) {
    const res = await apiGet({ action: "getByMembership", membership: query });
    if (!res.success) return null;
    const cars = [];
    if (res.car) cars.push(res.car);
    return { customers: res.customer ? [res.customer] : [], cars };
  }
  return null;
}

/* ========== Customers Search ========== */
async function handleCustomerSearch() {
  const btn = $("custSearchBtn");
  const query = $("custSearchInput").value.trim();
  if (!query) return alert("Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© Ù„Ù„Ø¨Ø­Ø«");

  setLoading(btn, true);
  const data = await smartSearchCustomer(query);
  setLoading(btn, false);

  const container = $("custSearchResult");
  container.innerHTML = "";

  if (!data || !data.customers || data.customers.length === 0) {
    container.innerHTML = "<p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</p>";
    return;
  }

  const c = data.customers[0];

  const div = document.createElement("div");
  div.className = "card";
  div.innerHTML = `
    Ø§Ù„Ø§Ø³Ù…: ${c.name}<br>
    Ø§Ù„Ø¬ÙˆØ§Ù„: ${c.phone}<br>
    Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©: ${c.membership}<br>
    Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©: ${c.city || "â€”"}<br>
    Ø§Ù„Ù†Ù‚Ø§Ø·: ${c.points}<br>
    Ø§Ù„Ù…Ø³ØªÙˆÙ‰: ${c.level}<br>
    Ø¢Ø®Ø± Ø²ÙŠØ§Ø±Ø©: ${c.last_visit || "â€”"}<br>
    Ø¹Ø¯Ø¯ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª: ${c.visit_count || 0}
  `;
  container.appendChild(div);
}

/* ========== Visits (branch) ========== */
async function handleLoadVisits() {
  const btn = $("visitsLoadBtn");
  const from = $("visitsFrom").value.trim();
  const to = $("visitsTo").value.trim();
  const serviceFilter = $("visitsServiceFilter").value.trim();
  const employeeFilter = $("visitsEmployeeFilter").value.trim();

  setLoading(btn, true);

  let fromDate, toDate;
  if (!from && !to) {
    fromDate = "2000-01-01T00:00:00.000Z";
    toDate = "2100-01-01T23:59:59.000Z";
  } else {
    const f = from || to;
    const t = to || from;
    fromDate = new Date(f + "T00:00:00").toISOString();
    toDate = new Date(t + "T23:59:59").toISOString();
  }

  const res = await apiGet({
    action: "getVisitsByDate",
    from: fromDate,
    to: toDate
  });

  setLoading(btn, false);

  const list = $("visitsList");
  list.innerHTML = "";

  if (!res.visits || res.visits.length === 0) {
    list.innerHTML = "<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø²ÙŠØ§Ø±Ø§Øª</p>";
    return;
  }

  const branch = currentBranch;
  let filtered = res.visits.filter(v => v.branch === branch);

  if (serviceFilter) {
    filtered = filtered.filter(v => String(v.service).includes(serviceFilter));
  }
  if (employeeFilter) {
    filtered = filtered.filter(v => String(v.employee).includes(employeeFilter));
  }

  if (filtered.length === 0) {
    list.innerHTML = "<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø²ÙŠØ§Ø±Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„ÙÙ„ØªØ±</p>";
    return;
  }

  const header = document.createElement("div");
  header.className = "table-header";
  header.innerHTML = `
    <div>Ø§Ù„Ø¹Ù…ÙŠÙ„ / Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©</div>
    <div>Ø§Ù„Ø®Ø¯Ù…Ø©</div>
    <div>Ø§Ù„Ù…Ø¨Ù„Øº</div>
    <div>Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©</div>
    <div>Ø§Ù„Ù…ÙˆØ¸Ù</div>
    <div>Ø§Ù„ØªØ§Ø±ÙŠØ®</div>
    <div>Ø§Ù„ÙØ±Ø¹</div>
  `;
  list.appendChild(header);

  filtered.forEach(v => {
    const row = document.createElement("div");
    row.className = "table-row";
    row.innerHTML = `
      <div>${v.membership}</div>
      <div>${v.service}</div>
      <div>${v.price}</div>
      <div>${v.commission}</div>
      <div>${v.employee || "â€”"}</div>
      <div>${v.date}</div>
      <div>${v.branch || "â€”"}</div>
    `;
    list.appendChild(row);
  });
}

/* ========== Cars ========== */
async function handleLoadCars() {
  const btn = $("carsBtn");
  const phone = $("carsPhone").value.trim();
  if (!phone) return alert("Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„");

  setLoading(btn, true);
  const res = await apiGet({ action: "getCarsByPhone", phone });
  setLoading(btn, false);

  const list = $("carsList");
  list.innerHTML = "";

  if (!res.cars || res.cars.length === 0) {
    list.innerHTML = "<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³ÙŠØ§Ø±Ø§Øª</p>";
    return;
  }

  res.cars.forEach(c => {
    const div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `
      <b>${c.car}</b> â€” ${c.plate_letters} ${c.plate_numbers}<br>
      Ø§Ù„Ø­Ø¬Ù…: ${c.size}<br>
      Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©: ${c.city}<br>
      Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©: ${c.membership}
    `;
    list.appendChild(div);
  });
}

/* ========== Add Visit ========== */
let selectedMembership = null;
let selectedCarData = null;
let visitServices = {};
let employeesList = [];

async function loadVisitServices() {
  const res = await apiGet({ action: "getCommissions" });
  const select = $("vService");
  select.innerHTML = "";
  visitServices = {};
  res.commissions.forEach(s => {
    visitServices[s.service] = Number(s.price) || 0;
    const opt = document.createElement("option");
    opt.value = s.service;
    opt.textContent = s.service;
    select.appendChild(opt);
  });
  updateVisitPrice();
}

function updateVisitPrice() {
  const service = $("vService").value;
  const price = visitServices[service] || 0;
  $("vPrice").value = price;
  updateVisitPoints();
}

function updateVisitPoints() {
  const price = Number($("vPrice").value);
  $("vPoints").value = Math.floor(price / 5);
}

async function loadEmployees() {
  const res = await apiGet({ action: "getEmployees" });
  employeesList = res.employees || [];
  const select = $("vEmployee");
  select.innerHTML = "";
  employeesList.forEach(e => {
    const opt = document.createElement("option");
    opt.value = e.employee;
    opt.textContent = e.employee;
    select.appendChild(opt);
  });
}

async function handleSearchVisitCustomer() {
  const btn = $("visitSearchBtn");
  const query = $("visitSearch").value.trim();
  if (!query) return alert("Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø£Ùˆ Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©");

  setLoading(btn, true);
  const data = await smartSearchCustomer(query);
  setLoading(btn, false);

  const box = $("visitCarsBox");
  const list = $("visitCarsList");
  list.innerHTML = "";

  if (!data || !data.cars || data.cars.length === 0) {
    alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³ÙŠØ§Ø±Ø§Øª Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„");
    box.style.display = "none";
    $("visitForm").style.display = "none";
    return;
  }

  box.style.display = "block";
  data.cars.forEach(car => {
    const div = document.createElement("div");
    div.className = "card";
    div.style.cursor = "pointer";
    div.innerHTML = `
      <b>${car.car}</b> â€” ${car.plate_letters} ${car.plate_numbers}<br>
      Ø¹Ø¶ÙˆÙŠØ©: ${car.membership}<br>
      Ù…Ø¯ÙŠÙ†Ø©: ${car.city}
    `;
    div.onclick = () => selectVisitCar(car);
    list.appendChild(div);
  });
}

function selectVisitCar(car) {
  selectedMembership = car.membership;
  selectedCarData = car;
  const form = $("visitForm");
  form.style.display = "block";
  $("visitSelectedInfo").innerText =
    `Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©: ${car.membership} â€” Ø§Ù„Ø³ÙŠØ§Ø±Ø©: ${car.car} â€” Ø§Ù„Ù„ÙˆØ­Ø©: ${car.plate_letters} ${car.plate_numbers}`;
}

async function handleSubmitVisit() {
  if (!selectedMembership || !selectedCarData) return alert("Ø§Ø®ØªØ± Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ø£ÙˆÙ„Ø§Ù‹");

  const btn = $("addVisitBtn");
  setLoading(btn, true);

  const service = $("vService").value;
  const price = Number($("vPrice").value) || 0;
  const points = Number($("vPoints").value) || 0;
  const employee = $("vEmployee").value || "";
  const branch = currentBranch || "";

  const res = await apiPost({
    action: "addVisit",
    membership: selectedMembership,
    service,
    price,
    points,
    employee,
    branch
  });

  setLoading(btn, false);

  if (res.success) {
    $("addVisitStatus").innerText = "âœ” ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ø¨Ù†Ø¬Ø§Ø­";
    loadDashboard();
  } else {
    $("addVisitStatus").innerText = "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„";
  }
}

/* ========== Bookings (branch) ========== */
async function loadBookings() {
  const date = $("bookingsDate").value.trim();
  const res = await apiGet({ action: "getBookings", date });
  const list = $("bookingsList");
  list.innerHTML = "";

  if (!res.bookings || res.bookings.length === 0) {
    list.innerHTML = "<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª</p>";
    return;
  }

  const branch = currentBranch;
  // Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙØ±Ø¹ ÙÙŠ bookings Ù…Ø¨Ø§Ø´Ø±Ø©ØŒ Ù„ÙƒÙ† ÙŠÙ…ÙƒÙ† Ø±Ø¨Ø·Ù‡ Ø¨Ø§Ù„Ø®Ø¯Ù…Ø©/Ø§Ù„Ø¹Ø¶ÙˆÙŠØ© Ù„Ø§Ø­Ù‚Ù‹Ø§
  // Ø§Ù„Ø¢Ù† Ù†Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª (Ø£Ùˆ ÙŠÙ…ÙƒÙ† Ù„Ø§Ø­Ù‚Ù‹Ø§ Ø±Ø¨Ø·Ù‡Ø§ Ø¨Ø§Ù„ÙØ±Ø¹ Ù…Ù† Visits Ø£Ùˆ Branches)
  res.bookings.forEach(b => {
    const div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `
      Ø§Ù„Ø¬ÙˆØ§Ù„: ${b.phone}<br>
      Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©: ${b.membership}<br>
      Ø§Ù„Ø®Ø¯Ù…Ø©: ${b.service}<br>
      Ø§Ù„ØªØ§Ø±ÙŠØ®: ${b.date} ${b.time}<br>
      Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: <b>${b.status}</b><br><br>
      <button class="secondary" onclick="confirmBooking(this, ${b.row})">ØªØ£ÙƒÙŠØ¯</button>
      <button class="danger" onclick="cancelBooking(this, ${b.row})">Ø¥Ù„ØºØ§Ø¡</button>
    `;
    list.appendChild(div);
  });
}

async function confirmBooking(btn, row) {
  setLoading(btn, true);
  await apiPost({ action: "updateBookingStatus", row, status: "Approved" });
  setLoading(btn, false);
  loadBookings();
}

async function cancelBooking(btn, row) {
  setLoading(btn, true);
  await apiPost({ action: "updateBookingStatus", row, status: "Cancelled" });
  setLoading(btn, false);
  loadBookings();
}

/* ========== Reports (financial) ========== */
async function loadReports() {
  const btn = $("reportsBtn");
  const from = $("reportsFrom").value.trim();
  const to = $("reportsTo").value.trim();

  if (!from || !to) return alert("Ø§Ø®ØªØ± Ù…Ù† ÙˆØ¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®");

  setLoading(btn, true);

  const fromDate = new Date(from + "T00:00:00").toISOString();
  const toDate = new Date(to + "T23:59:59").toISOString();

  const res = await apiGet({
    action: "getVisitsByDate",
    from: fromDate,
    to: toDate
  });

  setLoading(btn, false);

  const list = $("reportsList");
  const summary = $("reportsSummary");
  list.innerHTML = "";
  summary.innerHTML = "";

  if (!res.visits || res.visits.length === 0) {
    list.innerHTML = "<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</p>";
    return;
  }

  const branch = currentBranch;
  const visits = res.visits.filter(v => v.branch === branch);

  if (!visits.length) {
    list.innerHTML = "<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„ÙØ±Ø¹ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©</p>";
    return;
  }

  // Summary
  const totalAmount = visits.reduce((s,v)=>s+Number(v.price||0),0);
  const totalCommission = visits.reduce((s,v)=>s+Number(v.commission||0),0);
  const totalVisits = visits.length;
  const customers = new Set(visits.map(v=>v.membership)).size;

  const cards = [
    { title: "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ø§Ù„Øº", value: totalAmount, suffix: "Ø±ÙŠØ§Ù„" },
    { title: "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…ÙˆÙ„Ø§Øª", value: totalCommission, suffix: "Ø±ÙŠØ§Ù„" },
    { title: "Ø¹Ø¯Ø¯ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª", value: totalVisits, suffix: "" },
    { title: "Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡", value: customers, suffix: "" }
  ];

  cards.forEach(c => {
    const div = document.createElement("div");
    div.className = "dash-card";
    div.innerHTML = `
      <div class="dash-card-title">${c.title}</div>
      <div class="dash-card-value">${c.value}</div>
      <div style="font-size:12px;color:var(--text-muted);">${c.suffix}</div>
    `;
    summary.appendChild(div);
  });

  const header = document.createElement("div");
  header.className = "table-header";
  header.innerHTML = `
    <div>Ø§Ù„Ø¹Ù…ÙŠÙ„ / Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©</div>
    <div>Ø§Ù„Ø®Ø¯Ù…Ø©</div>
    <div>Ø§Ù„Ù…Ø¨Ù„Øº</div>
    <div>Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©</div>
    <div>Ø§Ù„Ù…ÙˆØ¸Ù</div>
    <div>Ø§Ù„ØªØ§Ø±ÙŠØ®</div>
    <div>Ø§Ù„ÙØ±Ø¹</div>
  `;
  list.appendChild(header);

  visits.forEach(v => {
    const row = document.createElement("div");
    row.className = "table-row";
    row.innerHTML = `
      <div>${v.membership}</div>
      <div>${v.service}</div>
      <div>${v.price}</div>
      <div>${v.commission}</div>
      <div>${v.employee || "â€”"}</div>
      <div>${v.date}</div>
      <div>${v.branch || "â€”"}</div>
    `;
    list.appendChild(row);
  });
}

/* ========== Export Excel ========== */
function exportVisitsToExcel(visits, filename) {
  const data = visits.map(v => ({
    "Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©": v.membership,
    "Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„": "", // ÙŠÙ…ÙƒÙ† Ù„Ø§Ø­Ù‚Ù‹Ø§ Ø±Ø¨Ø·Ù‡ Ù…Ù† Customers
    "Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø©": "", // ÙŠÙ…ÙƒÙ† Ù„Ø§Ø­Ù‚Ù‹Ø§ Ø±Ø¨Ø·Ù‡ Ù…Ù† Cars
    "Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©": v.service,
    "Ø§Ù„Ù…Ø¨Ù„Øº": v.price,
    "Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©": v.commission,
    "Ø§Ù„Ù†Ù‚Ø§Ø·": v.points,
    "Ø§Ù„Ù…ÙˆØ¸Ù": v.employee || "",
    "Ø§Ù„ÙØ±Ø¹": v.branch || "",
    "Ø§Ù„ØªØ§Ø±ÙŠØ®": v.date
  }));

  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Visits");
  XLSX.writeFile(wb, filename);
}

async function handleExportDaily() {
  const date = $("exportDailyDate").value.trim();
  if (!date) return alert("Ø§Ø®ØªØ± ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ…");

  const fromDate = new Date(date + "T00:00:00").toISOString();
  const toDate = new Date(date + "T23:59:59").toISOString();

  const res = await apiGet({
    action: "getVisitsByDate",
    from: fromDate,
    to: toDate
  });

  const branch = currentBranch;
  const visits = (res.visits || []).filter(v => v.branch === branch);

  if (!visits.length) {
    alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø²ÙŠØ§Ø±Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ… ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙØ±Ø¹");
    return;
  }

  exportVisitsToExcel(visits, `Visits_${branch}_${date}.xlsx`);
}

async function handleExportMonthly() {
  const date = $("exportMonthlyDate").value.trim();
  if (!date) return alert("Ø§Ø®ØªØ± ØªØ§Ø±ÙŠØ® Ø¶Ù…Ù† Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ (Ù…Ø«Ù„Ø§Ù‹ Ø£ÙˆÙ„ ÙŠÙˆÙ…)");

  const d = new Date(date);
  const year = d.getFullYear();
  const month = d.getMonth(); // 0-based

  const first = new Date(year, month, 1);
  const last = new Date(year, month + 1, 0);

  const fromDate = new Date(first.toISOString().slice(0,10) + "T00:00:00").toISOString();
  const toDate = new Date(last.toISOString().slice(0,10) + "T23:59:59").toISOString();

  const res = await apiGet({
    action: "getVisitsByDate",
    from: fromDate,
    to: toDate
  });

  const branch = currentBranch;
  const visits = (res.visits || []).filter(v => v.branch === branch);

  if (!visits.length) {
    alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø²ÙŠØ§Ø±Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø± ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙØ±Ø¹");
    return;
  }

  const monthStr = `${year}-${String(month+1).padStart(2,"0")}`;
  exportVisitsToExcel(visits, `Visits_${branch}_${monthStr}.xlsx`);
}

/* ========== Events & Init ========== */
function initEvents() {
  $("custSearchBtn").onclick = handleCustomerSearch;
  $("visitsLoadBtn").onclick = handleLoadVisits;
  $("carsBtn").onclick = handleLoadCars;
  $("visitSearchBtn").onclick = handleSearchVisitCustomer;
  $("vService").onchange = updateVisitPrice;
  $("vPrice").oninput = updateVisitPoints;
  $("addVisitBtn").onclick = handleSubmitVisit;
  $("bookingsDate").onchange = loadBookings;
  $("reportsBtn").onclick = loadReports;
  $("exportDailyBtn").onclick = handleExportDaily;
  $("exportMonthlyBtn").onclick = handleExportMonthly;
}

(async function init() {
  await loadBranches();
  await loadVisitServices();
  await loadEmployees();
  initEvents();
  await loadDashboard();
  await loadBookings();
})();
</script>

</body>
</html>
