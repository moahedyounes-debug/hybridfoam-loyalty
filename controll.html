<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø´Ø±Ù - controll.html</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Date Picker -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

<!-- Icons (Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ù…Ø³ØªÙ‚Ø¨Ù„Ø§Ù‹) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/tabler-icons.min.css">

<style>
:root {
    --bg: #020617;
    --bg-soft: #020617;
    --card: #020617;
    --border: #1f2937;
    --accent: #2563eb;
    --accent-soft: #1d4ed8;
    --danger: #dc2626;
    --success: #16a34a;
    --warning: #f59e0b;
    --text-main: #f9fafb;
    --text-muted: #9ca3af;
    --radius-lg: 16px;
    --radius-md: 12px;
    --radius-sm: 8px;
    --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.7);
    --transition-fast: 0.15s ease-out;
}

*,
*::before,
*::after {
    box-sizing: border-box;
}

html, body {
    margin: 0;
    padding: 0;
    font-family: "Tajawal", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    background: radial-gradient(circle at top, #1e293b 0, #020617 45%, #000 100%);
    color: var(--text-main);
    direction: rtl;
}

/* Layout */
.layout {
    display: flex;
    min-height: 100vh;
}

/* Sidebar */
.sidebar {
    width: 260px;
    background: rgba(15, 23, 42, 0.98);
    border-left: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    padding: 18px 14px;
    gap: 10px;
}

.brand {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
}

.brand-logo {
    width: 40px;
    height: 40px;
    border-radius: 14px;
    background: conic-gradient(from 180deg, #2563eb, #4f46e5, #22c55e, #2563eb);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 18px;
    color: #e5e7eb;
}

.brand-text {
    font-size: 18px;
    font-weight: 600;
}

.nav-section-title {
    font-size: 11px;
    color: var(--text-muted);
    margin: 10px 4px 4px;
}

.nav {
    display: flex;
    flex-direction: column;
    gap: 6px;
    margin-bottom: 6px;
}

.nav-btn {
    width: 100%;
    text-align: right;
    padding: 9px 11px;
    border-radius: 10px;
    border: none;
    background: transparent;
    color: var(--text-muted);
    font-size: 14px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: space-between;
    transition: var(--transition-fast);
}

.nav-btn span {
    display: inline-flex;
    align-items: center;
    gap: 6px;
}

.nav-btn.active {
    background: rgba(37, 99, 235, 0.22);
    color: var(--text-main);
}

.nav-btn:hover {
    background: rgba(15, 23, 42, 0.9);
    color: var(--text-main);
}

/* Main */
.main {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-width: 0;
}

/* Topbar */
.topbar {
    padding: 12px 18px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: rgba(15, 23, 42, 0.9);
    backdrop-filter: blur(10px);
    position: sticky;
    top: 0;
    z-index: 10;
}

.topbar-left {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.topbar-title {
    font-size: 16px;
    font-weight: 500;
}

.topbar-sub {
    font-size: 12px;
    color: var(--text-muted);
}

.stats-bar {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    justify-content: flex-end;
}

.pill {
    padding: 4px 10px;
    border-radius: 999px;
    background: rgba(15, 23, 42, 0.9);
    border: 1px solid var(--border);
    font-size: 12px;
    color: var(--text-muted);
    display: inline-flex;
    align-items: center;
    gap: 4px;
}

/* Content */
.content {
    padding: 18px;
    display: flex;
    flex-direction: column;
    gap: 18px;
}

.section {
    display: none;
}
.section.active {
    display: block;
}

.card {
    background: var(--card);
    border-radius: var(--radius-lg);
    padding: 16px;
    border: 1px solid var(--border);
    box-shadow: var(--shadow-soft);
}

.card-header {
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 10px;
}

.card-header h2,
.card-header h3 {
    margin: 0;
    text-align: center;
}

h2, h3 {
    text-align: center;
    margin: 0 0 10px;
}

p {
    text-align: center;
}

/* Inputs */
label {
    display: block;
    font-size: 13px;
    color: var(--text-muted);
    margin-top: 8px;
    margin-bottom: 3px;
}

input, select, textarea {
    width: 100%;
    padding: 10px 11px;
    border-radius: var(--radius-md);
    border: 1px solid var(--border);
    background: #020617;
    color: var(--text-main);
    font-size: 14px;
    margin-bottom: 6px;
    outline: none;
    transition: var(--transition-fast);
}

input:focus,
select:focus,
textarea:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.4);
}

textarea {
    min-height: 90px;
    resize: vertical;
}

/* Buttons */
button {
    padding: 10px 12px;
    border-radius: var(--radius-md);
    border: none;
    background: var(--accent);
    color: white;
    font-size: 14px;
    cursor: pointer;
    margin-top: 8px;
    position: relative;
    transition: var(--transition-fast);
}

button.loading {
    color: transparent !important;
    cursor: not-allowed;
    background: #6b7280 !important;
}

button.loading::after {
    content: "";
    position: absolute;
    top: 50%;
    left: 50%;
    width: 20px;
    height: 20px;
    margin-top: -10px;
    margin-left: -10px;
    border: 3px solid white;
    border-top-color: transparent;
    border-radius: 50%;
    animation: spin 0.7s linear infinite;
}

button:active {
    transform: scale(0.97);
}

button.secondary {
    background: #111827;
    color: var(--text-main);
}

button.danger {
    background: var(--danger);
}

/* Loader keyframes */
@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Lists */
.list {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

/* Status text */
.status-text {
    font-size: 12px;
    color: var(--text-muted);
    margin-top: 6px;
    text-align: center;
}

/* Utility */
.row {
    display: flex;
    gap: 10px;
}
.row > * {
    flex: 1;
}

/* Responsive */
@media (max-width: 900px) {
    .layout {
        flex-direction: column;
    }
    .sidebar {
        width: 100%;
        flex-direction: row;
        overflow-x: auto;
        border-left: none;
        border-bottom: 1px solid var(--border);
    }
    .nav {
        flex-direction: row;
        flex-wrap: nowrap;
    }
    .nav-btn {
        white-space: nowrap;
    }
    .topbar {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
    }
    .stats-bar {
        justify-content: flex-start;
    }
}
</style>
</head>
<body>

<div class="layout">

    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="brand">
            <div class="brand-logo">CT</div>
            <div class="brand-text">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø´Ø±Ù</div>
        </div>

        <div class="nav-section-title">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
        <div class="nav">
            <button class="nav-btn active" data-target="dashboard">
                <span>Dashboard</span>
            </button>
        </div>

        <div class="nav-section-title">Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</div>
        <div class="nav">
            <button class="nav-btn" data-target="search">
                <span>Ø¨Ø­Ø« Ø¹Ù…ÙŠÙ„</span>
            </button>
            <button class="nav-btn" data-target="visits">
                <span>Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</span>
            </button>
            <button class="nav-btn" data-target="cars">
                <span>Ø³ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</span>
            </button>
            <button class="nav-btn" data-target="addVisit">
                <span>Ø¥Ø¶Ø§ÙØ© Ø²ÙŠØ§Ø±Ø©</span>
            </button>
        </div>

        <div class="nav-section-title">Ø§Ù„ØªÙØ§Ø¹Ù„ ÙˆØ§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</div>
        <div class="nav">
            <button class="nav-btn" data-target="notify">
                <span>Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±</span>
            </button>
            <button class="nav-btn" data-target="bookings">
                <span>Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</span>
            </button>
            <button class="nav-btn" data-target="reports">
                <span>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</span>
            </button>
        </div>
    </aside>

    <!-- Main -->
    <main class="main">
        <div class="topbar">
            <div class="topbar-left">
                <div class="topbar-title">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø´Ø±Ù</div>
                <div class="topbar-sub">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ØŒ Ø§Ù„Ø²ÙŠØ§Ø±Ø§ØªØŒ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ù…Ù† Ù…ÙƒØ§Ù† ÙˆØ§Ø­Ø¯</div>
            </div>
            <div class="stats-bar">
                <div class="pill">ğŸ‘¥ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡: <span id="sCustomers">0</span></div>
                <div class="pill">ğŸš— Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª: <span id="sCars">0</span></div>
                <div class="pill">ğŸ§¾ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª: <span id="sVisits">0</span></div>
                <div class="pill">ğŸ’° Ø§Ù„Ù…Ø¨Ø§Ù„Øº: <span id="sAmount">0</span></div>
            </div>
        </div>

        <div class="content">

            <!-- Dashboard -->
            <section id="dashboard" class="section active">
                <div class="card">
                    <div class="card-header">
                        <h2>Dashboard</h2>
                    </div>
                    <p id="stats">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
                </div>
            </section>

            <!-- Search Customer -->
            <section id="search" class="section">
                <div class="card">
                    <div class="card-header">
                        <h2>Ø¨Ø­Ø« Ø¹Ù† Ø¹Ù…ÙŠÙ„</h2>
                    </div>

                    <label>Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ / Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¶ÙˆÙŠØ© / Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø©</label>
                    <input id="searchPhone" placeholder="05xxxxxxxx Ø£Ùˆ 2026xxxx Ø£Ùˆ Ø£ Ø¨ Ø¬ 1234">

                    <button id="searchBtn">Ø¨Ø­Ø«</button>

                    <div id="searchResult" style="margin-top:10px;"></div>
                </div>
            </section>

            <!-- Customer Visits -->
            <section id="visits" class="section">
                <div class="card">
                    <div class="card-header">
                        <h2>Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</h2>
                    </div>

                    <label>Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</label>
                    <input id="visitsPhone" placeholder="05xxxxxxxx">

                    <label>Ø§Ø®ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ® (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                    <input id="visitsDate" class="datePicker" placeholder="YYYY-MM-DD">

                    <button id="visitsBtn">Ø¹Ø±Ø¶ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª</button>

                    <div id="visitsList" class="list" style="margin-top:10px;"></div>
                </div>
            </section>

            <!-- Customer Cars -->
            <section id="cars" class="section">
                <div class="card">
                    <div class="card-header">
                        <h2>Ø³ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</h2>
                    </div>

                    <label>Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</label>
                    <input id="carsPhone" placeholder="05xxxxxxxx">

                    <button id="carsBtn">Ø¹Ø±Ø¶ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</button>

                    <div id="carsList" class="list" style="margin-top:10px;"></div>
                </div>
            </section>

            <!-- Send Notification -->
            <section id="notify" class="section">
                <div class="card">
                    <div class="card-header">
                        <h2>Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±</h2>
                    </div>

                    <label>Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</label>
                    <input id="notifyPhone" placeholder="05xxxxxxxx">

                    <label>Ù†Øµ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±</label>
                    <textarea id="notifyMsg" placeholder="Ø§ÙƒØªØ¨ Ù†Øµ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ù‡Ù†Ø§..."></textarea>

                    <button id="notifyBtn">Ø¥Ø±Ø³Ø§Ù„</button>

                    <p id="notifyStatus" class="status-text"></p>
                </div>
            </section>

            <!-- Add Visit -->
            <section id="addVisit" class="section">
                <div class="card">
                    <div class="card-header">
                        <h2>Ø¥Ø¶Ø§ÙØ© Ø²ÙŠØ§Ø±Ø©</h2>
                    </div>

                    <!-- Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„ -->
                    <div class="card" style="background:#020617;margin-bottom:10px;">
                        <div class="card-header">
                            <h3>Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„</h3>
                        </div>

                        <label>Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ / Ø§Ù„Ø¹Ø¶ÙˆÙŠØ© / Ø§Ù„Ù„ÙˆØ­Ø©</label>
                        <input id="visitSearch" placeholder="05xxxxxxxx Ø£Ùˆ 2026xxxx Ø£Ùˆ Ø£ Ø¨ Ø¬ 1234">

                        <button id="visitSearchBtn">Ø¨Ø­Ø«</button>
                    </div>

                    <!-- Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø³ÙŠØ§Ø±Ø© -->
                    <div id="visitCarsBox" class="card" style="display:none;background:#020617;margin-bottom:10px;">
                        <div class="card-header">
                            <h3>Ø§Ø®ØªØ± Ø§Ù„Ø³ÙŠØ§Ø±Ø©</h3>
                        </div>
                        <div id="visitCarsList" class="list"></div>
                    </div>

                    <!-- Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø²ÙŠØ§Ø±Ø© -->
                    <div id="visitForm" class="card" style="display:none;background:#020617;">
                        <div class="card-header">
                            <h3>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø²ÙŠØ§Ø±Ø©</h3>
                        </div>

                        <p id="visitSelectedInfo" class="status-text"></p>

                        <label>Ø§Ù„Ø®Ø¯Ù…Ø©</label>
                        <select id="vService"></select>

                        <label>Ø§Ù„Ø³Ø¹Ø±</label>
                        <input type="number" id="vPrice">

                        <label>Ø§Ù„Ù†Ù‚Ø§Ø·</label>
                        <input type="number" id="vPoints" readonly>

                        <button id="addVisitBtn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø²ÙŠØ§Ø±Ø©</button>

                        <p id="addVisitStatus" class="status-text"></p>
                    </div>
                </div>
            </section>

            <!-- Bookings -->
            <section id="bookings" class="section">
                <div class="card">
                    <div class="card-header">
                        <h2>Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</h2>
                    </div>

                    <label>Ø§Ø®ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ® (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                    <input id="bookingsDate" class="datePicker" placeholder="YYYY-MM-DD">

                    <div id="bookingsList" class="list" style="margin-top:10px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
                </div>
            </section>

            <!-- Reports -->
            <section id="reports" class="section">
                <div class="card">
                    <div class="card-header">
                        <h2>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</h2>
                    </div>

                    <label>Ø§Ø®ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ® (Ø£Ùˆ Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºÙ‹Ø§ Ù„ÙƒÙ„ Ø§Ù„ÙØªØ±Ø§Øª)</label>
                    <input id="reportsDate" class="datePicker" placeholder="YYYY-MM-DD">

                    <button id="reportsBtn">Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>

                    <div id="reportsList" class="list" style="margin-top:10px;"></div>
                </div>
            </section>

        </div> <!-- /content -->
    </main>
</div> <!-- /layout -->

<!-- Ø³ÙƒØ±Ø¨ØªØ§Øª Ø®Ø§Ø±Ø¬ÙŠØ© -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="api.js?v=3"></script>

<!-- Ù‡Ù†Ø§ Ø³ÙŠÙƒÙˆÙ† Ø¬Ø²Ø¡ Ø§Ù„Ø¬Ø§ÙØ§Ø³ÙƒØ±Ø¨Øª Ø§Ù„ÙƒØ§Ù…Ù„ (Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø«Ø§Ù†ÙŠ) -->
<script>
/* ===========================
   Tabs
=========================== */
const sections = document.querySelectorAll(".section");
const navButtons = document.querySelectorAll(".nav-btn");

function initTabs() {
    navButtons.forEach(btn => {
        btn.addEventListener("click", () => {
            const target = btn.getAttribute("data-target");
            sections.forEach(s => s.classList.remove("active"));
            document.getElementById(target).classList.add("active");

            navButtons.forEach(b => b.classList.remove("active"));
            btn.classList.add("active");
        });
    });
}

/* ===========================
   Date Pickers
=========================== */
function initDatePickers() {
    const options = {
        dateFormat: "Y-m-d",
        allowInput: true
    };
    flatpickr("#visitsDate", options);
    flatpickr("#bookingsDate", options);
    flatpickr("#reportsDate", options);
}

/* ===========================
   Dashboard
=========================== */
async function loadDashboard() {
    const res = await apiGet({ action: "getOwnersDashboard" });

    document.getElementById("stats").innerHTML = `
        Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡: ${res.totals.customers}<br>
        Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª: ${res.totals.cars}<br>
        Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª: ${res.totals.visits}<br>
        Ø§Ù„Ù…Ø¨Ø§Ù„Øº: ${res.totals.amount}
    `;

    document.getElementById("sCustomers").innerText = res.totals.customers;
    document.getElementById("sCars").innerText = res.totals.cars;
    document.getElementById("sVisits").innerText = res.totals.visits;
    document.getElementById("sAmount").innerText = res.totals.amount;
}

/* ===========================
   Helper: Ø¨Ø­Ø« Ø°ÙƒÙŠ Ø¹Ù† Ø¹Ù…ÙŠÙ„
   - Ø¬ÙˆØ§Ù„ 05xxxxxxx  => getByPhone
   - Ø±Ù‚Ù… Ø¹Ø¶ÙˆÙŠØ© Ø±Ù‚Ù…ÙŠ  => getByMembership
=========================== */
async function smartSearchCustomer(query) {
    // Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„
    if (query.startsWith("05") && query.length === 10) {
        const res = await apiGet({ action: "getByPhone", phone: query });
        if (!res.success) return null;
        return {
            customers: [res.customer],
            cars: res.cars || []
        };
    }

    // Ø±Ù‚Ù… Ø¹Ø¶ÙˆÙŠØ©
    if (/^\d+$/.test(query)) {
        const res = await apiGet({ action: "getByMembership", membership: query });
        if (!res.success) return null;
        const cars = [];
        if (res.car) cars.push(res.car);
        return {
            customers: res.customer ? [res.customer] : [],
            cars
        };
    }

    // Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¯Ø¹Ù… Ø­Ù‚ÙŠÙ‚ÙŠ Ù„Ù„ÙˆØ­Ø© Ù…Ù† Ø§Ù„Ù€ API Ø§Ù„Ø­Ø§Ù„ÙŠ
    return null;
}

/* ===========================
   Search Customer
=========================== */
async function handleSearchCustomer() {
    const btn = document.getElementById("searchBtn");
    const query = document.getElementById("searchPhone").value.trim();

    if (!query) return alert("Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© Ù„Ù„Ø¨Ø­Ø«");

    btn.classList.add("loading");
    btn.disabled = true;

    const data = await smartSearchCustomer(query);

    btn.classList.remove("loading");
    btn.disabled = false;

    const container = document.getElementById("searchResult");
    container.innerHTML = "";

    if (!data || !data.customers || data.customers.length === 0) {
        container.innerHTML = "<p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</p>";
        return;
    }

    const c = data.customers[0];

    container.innerHTML = `
        <div class="card">
            Ø§Ù„Ø§Ø³Ù…: ${c.name}<br>
            Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©: ${c.membership}<br>
            Ø§Ù„Ù†Ù‚Ø§Ø·: ${c.points}<br>
            Ø§Ù„Ù…Ø³ØªÙˆÙ‰: ${c.level}
        </div>
    `;
}

/* ===========================
   Customer Visits
=========================== */
async function handleLoadCustomerVisits() {
    const btn = document.getElementById("visitsBtn");
    const phone = document.getElementById("visitsPhone").value.trim();
    const dateFilter = document.getElementById("visitsDate").value.trim();

    if (!phone) return alert("Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„");

    btn.classList.add("loading");
    btn.disabled = true;

    const res = await apiGet({
        action: "getVisitsByPhone",
        phone
    });

    btn.classList.remove("loading");
    btn.disabled = false;

    const list = document.getElementById("visitsList");
    list.innerHTML = "";

    if (!res.visits || res.visits.length === 0) {
        list.innerHTML = "<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø²ÙŠØ§Ø±Ø§Øª</p>";
        return;
    }

    // ÙÙ„ØªØ±Ø© Ø§Ù„ØªØ§Ø±ÙŠØ® ÙŠØ¯ÙˆÙŠÙ‹Ø§
    const filtered = dateFilter
        ? res.visits.filter(v => String(v.date).slice(0, 10) === dateFilter)
        : res.visits;

    if (filtered.length === 0) {
        list.innerHTML = "<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø²ÙŠØ§Ø±Ø§Øª ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ØªØ§Ø±ÙŠØ®</p>";
        return;
    }

    filtered.forEach(v => {
        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `
            Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©: ${v.membership}<br>
            Ø§Ù„Ø®Ø¯Ù…Ø©: ${v.service}<br>
            Ø§Ù„ØªØ§Ø±ÙŠØ®: ${v.date}<br>
            Ø§Ù„Ø³Ø¹Ø±: ${v.price}<br>
            Ø§Ù„Ù†Ù‚Ø§Ø·: ${v.points}<br>
            Ø§Ù„Ù…ÙˆØ¸Ù: ${v.employee || "-"}<br>
            Ø§Ù„ÙØ±Ø¹: ${v.branch || "-"}
        `;
        list.appendChild(div);
    });
}
/* ===========================
   Customer Cars
=========================== */
async function handleLoadCustomerCars() {
    const btn = document.getElementById("carsBtn");
    const phone = document.getElementById("carsPhone").value.trim();

    if (!phone) return alert("Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„");

    btn.classList.add("loading");
    btn.disabled = true;

    const res = await apiGet({ action: "getCarsByPhone", phone });

    btn.classList.remove("loading");
    btn.disabled = false;

    const list = document.getElementById("carsList");
    list.innerHTML = "";

    if (!res.cars || res.cars.length === 0) {
        list.innerHTML = "<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³ÙŠØ§Ø±Ø§Øª</p>";
        return;
    }

    res.cars.forEach(c => {
        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `
            ${c.car} - ${c.plate_letters} ${c.plate_numbers}<br>
            Ø§Ù„Ø­Ø¬Ù…: ${c.size}<br>
            Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©: ${c.city}<br>
            Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©: ${c.membership}
        `;
        list.appendChild(div);
    });
}

/* ===========================
   Send Notification
=========================== */
async function handleSendNotification() {
    const btn = document.getElementById("notifyBtn");
    const phone = document.getElementById("notifyPhone").value.trim();
    const msg = document.getElementById("notifyMsg").value.trim();

    if (!phone || !msg) return alert("Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ ÙˆÙ†Øµ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±");

    btn.classList.add("loading");
    btn.disabled = true;

    const resCustomer = await apiGet({ action: "getByPhone", phone });

    if (!resCustomer.success) {
        btn.classList.remove("loading");
        btn.disabled = false;
        document.getElementById("notifyStatus").innerText = "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙŠÙ„";
        return;
    }

    const membership = resCustomer.customer.membership;

    await apiPost({
        action: "addRating",
        membership,
        rating: 0,
        comment: msg
    });

    btn.classList.remove("loading");
    btn.disabled = false;

    document.getElementById("notifyStatus").innerText =
        "ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ø¹Ù…ÙŠÙ„ Ø±Ù‚Ù… Ø¹Ø¶ÙˆÙŠØ©: " + membership;
}

/* ===========================
   Add Visit
=========================== */
let selectedMembership = null;
let selectedCarData = null;
let visitServices = {};

async function handleSearchVisitCustomer() {
    const btn = document.getElementById("visitSearchBtn");
    const query = document.getElementById("visitSearch").value.trim();

    if (!query) return alert("Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø£Ùˆ Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©");

    btn.classList.add("loading");
    btn.disabled = true;

    const data = await smartSearchCustomer(query);

    btn.classList.remove("loading");
    btn.disabled = false;

    const box = document.getElementById("visitCarsBox");
    const list = document.getElementById("visitCarsList");
    list.innerHTML = "";

    if (!data || !data.cars || data.cars.length === 0) {
        alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³ÙŠØ§Ø±Ø§Øª Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„");
        box.style.display = "none";
        document.getElementById("visitForm").style.display = "none";
        return;
    }

    box.style.display = "block";

    data.cars.forEach(car => {
        const div = document.createElement("div");
        div.className = "card";
        div.style.cursor = "pointer";
        div.innerHTML = `
            <b>${car.car}</b> â€” ${car.plate_letters} ${car.plate_numbers}<br>
            Ø¹Ø¶ÙˆÙŠØ©: ${car.membership}<br>
            Ù…Ø¯ÙŠÙ†Ø©: ${car.city}
        `;
        div.onclick = () => selectVisitCar(car);
        list.appendChild(div);
    });
}

function selectVisitCar(car) {
    selectedMembership = car.membership;
    selectedCarData = car;

    const form = document.getElementById("visitForm");
    form.style.display = "block";

    document.getElementById("visitSelectedInfo").innerText =
        `Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©: ${car.membership} â€” Ø§Ù„Ø³ÙŠØ§Ø±Ø©: ${car.car} â€” Ø§Ù„Ù„ÙˆØ­Ø©: ${car.plate_letters} ${car.plate_numbers}`;
}

async function loadVisitServices() {
    const res = await apiGet({ action: "getCommissions" });

    const select = document.getElementById("vService");
    select.innerHTML = "";

    res.commissions.forEach(s => {
        visitServices[s.service] = Number(s.price) || 0;

        const opt = document.createElement("option");
        opt.value = s.service;
        opt.textContent = s.service;
        select.appendChild(opt);
    });

    updateVisitPrice();
}

function updateVisitPrice() {
    const service = document.getElementById("vService").value;
    const price = visitServices[service] || 0;
    document.getElementById("vPrice").value = price;
    updateVisitPoints();
}

function updateVisitPoints() {
    const price = Number(document.getElementById("vPrice").value);
    document.getElementById("vPoints").value = Math.floor(price / 5);
}

async function handleSubmitVisit() {
    if (!selectedMembership || !selectedCarData) return alert("Ø§Ø®ØªØ± Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ø£ÙˆÙ„Ø§Ù‹");

    const btn = document.getElementById("addVisitBtn");
    btn.classList.add("loading");
    btn.disabled = true;

    const service = document.getElementById("vService").value;
    const price = Number(document.getElementById("vPrice").value) || 0;
    const points = Number(document.getElementById("vPoints").value) || 0;

    // ÙŠÙ…ÙƒÙ† Ù…Ø³ØªÙ‚Ø¨Ù„Ø§Ù‹ Ø¥Ø¶Ø§ÙØ© employee / branch Ù…Ù† localStorage Ø£Ùˆ Ù…Ù† ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    const res = await apiPost({
        action: "addVisit",
        membership: selectedMembership,
        service,
        price,
        points,
        employee: "",
        branch: ""
    });

    btn.classList.remove("loading");
    btn.disabled = false;

    if (res.success) {
        document.getElementById("addVisitStatus").innerText =
            "âœ” ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ø¨Ù†Ø¬Ø§Ø­";
    } else {
        document.getElementById("addVisitStatus").innerText =
            "âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„";
    }
}

/* ===========================
   Bookings
=========================== */
async function loadBookings() {
    const date = document.getElementById("bookingsDate").value.trim();

    const res = await apiGet({
        action: "getBookings",
        date
    });

    const list = document.getElementById("bookingsList");
    list.innerHTML = "";

    if (!res.bookings || res.bookings.length === 0) {
        list.innerHTML = "<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª</p>";
        return;
    }

    res.bookings.forEach(b => {
        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `
            Ø§Ù„Ø®Ø¯Ù…Ø©: ${b.service} - ${b.date} ${b.time}<br>
            Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: <b>${b.status}</b><br><br>
            <button class="secondary" onclick="confirmBooking(this, ${b.row})">ØªØ£ÙƒÙŠØ¯</button>
            <button class="danger" onclick="cancelBooking(this, ${b.row})">Ø¥Ù„ØºØ§Ø¡</button>
        `;
        list.appendChild(div);
    });
}

async function confirmBooking(btn, row) {
    btn.classList.add("loading");
    btn.disabled = true;

    await apiPost({ action: "updateBookingStatus", row, status: "Approved" });

    btn.classList.remove("loading");
    btn.disabled = false;

    loadBookings();
}

async function cancelBooking(btn, row) {
    btn.classList.add("loading");
    btn.disabled = true;

    await apiPost({ action: "updateBookingStatus", row, status: "Cancelled" });

    btn.classList.remove("loading");
    btn.disabled = false;

    loadBookings();
}

/* ===========================
   Reports
=========================== */
async function loadReports() {
    const date = document.getElementById("reportsDate").value.trim();

    const from = date || "2000-01-01";
    const to = date || "2100-01-01";

    const res = await apiGet({
        action: "getVisitsByDate",
        from,
        to
    });

    const list = document.getElementById("reportsList");
    list.innerHTML = "";

    if (!res.visits || res.visits.length === 0) {
        list.innerHTML = "<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</p>";
        return;
    }

    res.visits.forEach(v => {
        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `
            Ø§Ù„ØªØ§Ø±ÙŠØ®: ${v.date}<br>
            Ø§Ù„Ø®Ø¯Ù…Ø©: ${v.service}<br>
            Ø§Ù„Ø³Ø¹Ø±: ${v.price}<br>
            Ø§Ù„Ù†Ù‚Ø§Ø·: ${v.points}<br>
            Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©: ${v.membership}<br>
            Ø§Ù„Ù…ÙˆØ¸Ù: ${v.employee || "-"}<br>
            Ø§Ù„ÙØ±Ø¹: ${v.branch || "-"}
        `;
        list.appendChild(div);
    });
}

/* ===========================
   Event Listeners
=========================== */
function initEvents() {
    document.getElementById("searchBtn").addEventListener("click", handleSearchCustomer);
    document.getElementById("visitsBtn").addEventListener("click", handleLoadCustomerVisits);
    document.getElementById("carsBtn").addEventListener("click", handleLoadCustomerCars);
    document.getElementById("notifyBtn").addEventListener("click", handleSendNotification);
    document.getElementById("visitSearchBtn").addEventListener("click", handleSearchVisitCustomer);
    document.getElementById("vService").addEventListener("change", updateVisitPrice);
    document.getElementById("vPrice").addEventListener("change", updateVisitPoints);
    document.getElementById("addVisitBtn").addEventListener("click", handleSubmitVisit);
    document.getElementById("bookingsDate").addEventListener("change", loadBookings);
    document.getElementById("reportsBtn").addEventListener("click", loadReports);
}

/* ===========================
   Initial Load
=========================== */
initTabs();
initDatePickers();
initEvents();
loadDashboard();
loadVisitServices();
loadBookings();
loadReports();
</script>
    
</body>
</html>
