<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© - Ø±ØºÙˆØ© Ø§Ù„Ù‡Ø¬ÙŠÙ†</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body{
      font-family:"Tajawal",sans-serif;
      background:#F4FAFF;
      color:#0D47A1;
      padding:20px;
      text-align:center;
    }

    .logo{
      width:160px;
      display:block;
      margin:0 auto 20px auto;
    }

    h2{
      margin-bottom:10px;
      font-size:26px;
      font-weight:700;
      color:#0D47A1;
    }

    .subtitle{
      color:#4FC3F7;
      font-size:15px;
      margin-bottom:20px;
    }

    .box{
      background:#FFFFFF;
      padding:22px;
      border-radius:18px;
      max-width:380px;
      margin:auto;
      box-shadow:0 4px 14px rgba(0,0,0,0.1);
      border:1px solid #E3F2FD;
    }

    input{
      width:100%;
      padding:12px;
      border-radius:10px;
      border:1px solid #DCEBFF;
      margin-bottom:12px;
      background:#F9FCFF;
      color:#0D47A1;
      font-size:15px;
      text-align:center;
    }

    input::placeholder{
      color:#90A4AE;
    }

    .btn{
      width:100%;
      padding:12px;
      border:none;
      border-radius:999px;
      background:#0D47A1;
      color:white;
      font-size:16px;
      cursor:pointer;
      margin-top:10px;
      transition:.3s;
    }

    .btn:disabled{
      opacity:.6;
      cursor:not-allowed;
    }

    .otp-box{
      background:#E3F2FD;
      padding:10px;
      border-radius:10px;
      margin-bottom:12px;
      font-size:18px;
      font-weight:700;
      color:#0D47A1;
      display:none;
    }

    /* Ø²Ø± ÙˆØ§ØªØ³Ø§Ø¨ Ø¹Ø§Ø¦Ù… */
    .whatsapp-float{
      position:fixed;
      bottom:25px;
      right:25px;
      background:#25D366;
      color:white;
      width:60px;
      height:60px;
      border-radius:50%;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:30px;
      cursor:pointer;
      box-shadow:0 4px 12px rgba(0,0,0,0.2);
      z-index:999;
    }
  </style>
</head>

<body>

<img src="logo.png" class="logo">

<h2>Ø±ØºÙˆØ© Ø§Ù„Ù‡Ø¬ÙŠÙ†</h2>
<div class="subtitle">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ â€” ÙØ¶Ù„Ø§Ù‹ Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„Ùƒ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©</div>

<div class="box">

  <input type="text" id="phone" placeholder="05XXXXXXXX"
         oninput="this.value=this.value.replace(/[^0-9]/g,'')">

  <!-- ÙƒÙˆØ¯ Ø§Ù„ØªØ­Ù‚Ù‚ -->
  <div id="otpBox" class="otp-box"></div>

  <input type="text" id="otpInput" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚" style="display:none;"
         oninput="this.value=this.value.replace(/[^0-9]/g,'')">

  <button id="loginBtn" class="btn" onclick="start()">Ù…ØªØ§Ø¨Ø¹Ø©</button>

</div>

<!-- Ø²Ø± ÙˆØ§ØªØ³Ø§Ø¨ Ø¹Ø§Ø¦Ù… -->
<div class="whatsapp-float" onclick="contactWhatsApp()">ğŸ’¬</div>

<script src="api.js"></script>
<script>

let isProcessing = false;
let generatedOTP = null;

// ===============================
// Ø²Ø± ÙˆØ§ØªØ³Ø§Ø¨ (Ø¨Ø¯ÙˆÙ† ØªØ­Ù‚Ù‚)
// ===============================
async function contactWhatsApp(){
  const phone = document.getElementById("phone").value.trim();

  let msg = "Ù…Ø±Ø­Ø¨Ø§Ù‹ Ù…ØºØ³Ù„Ø© Ø±ØºÙˆØ© Ø§Ù„Ù‡Ø¬ÙŠÙ†%0A";

  if(!phone){
    msg += "Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ ØºÙŠØ± Ù…ÙØ¯Ø®Ù„";
    window.location.href = "https://wa.me/966582007063?text=" + msg;
    return;
  }

  const res = await apiGetCustomerByPhone(phone);

  if(!res.success){
    msg += "Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„: " + phone;
    window.location.href = "https://wa.me/966582007063?text=" + msg;
    return;
  }

  const c = res.customer;

  // Ø¹Ø¯Ø¯ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª
  const carsRes = await apiGet({ action:"getAll", sheet:"Cars" });
  let carCount = 0;

  if(carsRes.success){
    carCount = carsRes.rows.filter(r => r[1] === phone).length;
  }

  msg += 
    "Ø§Ù„Ø§Ø³Ù…: " + c[0] + "%0A" +
    "Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©: " + c[8] + "%0A" +
    "Ø¹Ø¯Ø¯ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª: " + carCount;

  window.location.href = "https://wa.me/966582007063?text=" + msg;
}

// ===============================
// Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚ Ù„Ù„Ø¯Ø®ÙˆÙ„
// ===============================
async function start(){

  if(isProcessing) return;
  isProcessing = true;

  const btn = document.getElementById("loginBtn");
  const phone = document.getElementById("phone").value.trim();

  if(phone.length !== 10 || !phone.startsWith("05")){
    alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ ØµØ­ÙŠØ­");
    isProcessing = false;
    return;
  }

  // Ø¥Ø°Ø§ Ù…Ø§ ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ÙƒÙˆØ¯ ØªØ­Ù‚Ù‚ â†’ Ù†Ù†Ø´Ø¦Ù‡ Ø§Ù„Ø¢Ù†
  if(!generatedOTP){
    generatedOTP = Math.floor(1000 + Math.random() * 9000);

    document.getElementById("otpBox").style.display = "block";
    document.getElementById("otpInput").style.display = "block";

    document.getElementById("otpBox").innerText = "Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚: " + generatedOTP;

    btn.innerText = "ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø±Ù…Ø²";
    isProcessing = false;
    return;
  }

  // ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙƒÙˆØ¯
  const otpInput = document.getElementById("otpInput").value.trim();

  if(otpInput != generatedOTP){
    alert("Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ ØºÙŠØ± ØµØ­ÙŠØ­");
    isProcessing = false;
    return;
  }

  btn.disabled = true;
  btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...";

  const res = await apiGetCustomerByPhone(phone);

  localStorage.setItem("pendingPhone", phone);

  if(!res.success){
    window.location.href = "customer-register.html";
    return;
  }

  const c = res.customer;

  const CUSTOMER = {
    name: c[0],
    phone: c[1],
    car: c[2],
    size: c[3],
    city: c[4],
    plate_numbers: c[5],
    plate_letters: c[6],
    subscription: c[7],
    membership: c[8],
    last_visit: c[9],
    visit_count: c[10],
    points: c[11],
    level: c[12],
    free_wash: c[13]
  };

  localStorage.setItem("customer", JSON.stringify(CUSTOMER));

  window.location.href = "customer-dashboard.html";
}

</script>

</body>
</html>
