<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>حجز موعد</title>

<style>
    body {
        font-family: sans-serif;
        padding: 20px;
        background: #f5f5f5;
        max-width: 600px;
        margin: auto;
    }

    h2 {
        text-align: center;
        margin-bottom: 20px;
    }

    .box {
        background: white;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    label {
        display: block;
        margin-top: 10px;
        font-weight: bold;
    }

    select, input {
        width: 100%;
        padding: 12px;
        margin-top: 5px;
        border-radius: 8px;
        border: 1px solid #ccc;
        font-size: 15px;
    }

    button {
        width: 100%;
        padding: 14px;
        background: #000;
        color: white;
        border: none;
        margin-top: 20px;
        border-radius: 8px;
        font-size: 16px;
        cursor: pointer;
    }

    button.loading {
        background: #444;
        cursor: wait;
    }

    .time-slot {
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #ccc;
        margin-top: 8px;
        cursor: pointer;
        text-align: center;
        transition: 0.2s;
        background: #fafafa;
    }

    .time-slot:hover {
        background: #eee;
    }

    .time-slot.selected {
        background: #000;
        color: #fff;
        border-color: #000;
    }

    #timesBox {
        max-height: 260px;
        overflow-y: auto;
        margin-top: 10px;
    }

    #noTimes {
        text-align: center;
        color: #777;
        margin-top: 10px;
    }
</style>

<script src="api.js"></script>
</head>
<body>

<h2>حجز موعد</h2>

<div class="box">
    <label>السيارة</label>
    <select id="carSelect"></select>

    <label>الخدمة</label>
    <select id="serviceSelect" onchange="reloadTimes()"></select>

    <label>اليوم</label>
    <input type="date" id="dateInput" onchange="reloadTimes()">

    <div id="timesWrapper" style="margin-top:15px;">
        <label>الأوقات المتاحة</label>
        <div id="timesBox"></div>
        <div id="noTimes" style="display:none;">لا توجد أوقات متاحة في هذا اليوم</div>
    </div>

    <button onclick="confirmBooking()">تأكيد الحجز</button>
</div>

<script>
let selectedTime = null;
let phone = localStorage.getItem("customer_phone");

// -----------------------------
// تحميل سيارات العميل
// -----------------------------
async function loadCars() {
    if (!phone) {
        alert("لا يوجد رقم جوال محفوظ، يرجى تسجيل الدخول مرة أخرى");
        return;
    }

    const res = await apiGet({
        action: "getCarsByPhone",
        phone
    });

    const carSelect = document.getElementById("carSelect");
    carSelect.innerHTML = "";

    if (!res.success || res.cars.length === 0) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "لا توجد سيارات مسجلة";
        carSelect.appendChild(opt);
        return;
    }

    res.cars.forEach(car => {
        const opt = document.createElement("option");
        opt.value = car.membership;
        opt.textContent = `${car.car} — ${car.plate_letters} ${car.plate_numbers} (عضوية: ${car.membership})`;
        carSelect.appendChild(opt);
    });
}

// -----------------------------
// تحميل الخدمات من Commissions
// -----------------------------
let servicesData = {};

async function loadServices() {
    const res = await apiGet({ action: "getCommissions" });

    if (!res.success) {
        alert("خطأ في تحميل الخدمات");
        return;
    }

    const serviceSelect = document.getElementById("serviceSelect");
    serviceSelect.innerHTML = "";

    res.commissions.forEach(row => {
        const name = row.service;
        const price = Number(row.price || 0);
        const duration = Number(row.duration || row.D || 30); // احتياط لو أضفت مدة في العمود D

        servicesData[name] = { price, duration };

        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        serviceSelect.appendChild(opt);
    });
}

// -----------------------------
// تحميل الأوقات المتاحة من الـ API
// -----------------------------
async function reloadTimes() {
    selectedTime = null;

    const date = document.getElementById("dateInput").value;
    const service = document.getElementById("serviceSelect").value;

    if (!date || !service) return;

    const timesBox = document.getElementById("timesBox");
    const noTimes = document.getElementById("noTimes");

    timesBox.innerHTML = "جاري تحميل الأوقات المتاحة...";
    noTimes.style.display = "none";

    const res = await apiGet({
        action: "getAvailableTimes",
        date,
        service
    });

    timesBox.innerHTML = "";

    if (!res.success || !res.times || res.times.length === 0) {
        noTimes.style.display = "block";
        return;
    }

    res.times.forEach(t => {
        const div = document.createElement("div");
        div.className = "time-slot";
        div.textContent = t;
        div.onclick = () => selectTime(div, t);
        timesBox.appendChild(div);
    });
}

// -----------------------------
// اختيار وقت
// -----------------------------
function selectTime(element, time) {
    selectedTime = time;
    document.querySelectorAll(".time-slot").forEach(el => el.classList.remove("selected"));
    element.classList.add("selected");
}

// -----------------------------
// تأكيد الحجز
// -----------------------------
async function confirmBooking() {
    if (!phone) return alert("يرجى تسجيل الدخول أولاً");

    const membership = document.getElementById("carSelect").value;
    const service    = document.getElementById("serviceSelect").value;
    const date       = document.getElementById("dateInput").value;

    if (!membership) return alert("اختر السيارة");
    if (!service)    return alert("اختر الخدمة");
    if (!date)       return alert("اختر اليوم");
    if (!selectedTime) return alert("اختر الوقت");

    const res = await apiPost({
        action: "addBooking",
        phone,
        membership,
        service,
        date,
        time: selectedTime
    });

    if (res.success) {
        alert("تم حجز موعدك بنجاح");
        window.location.href = "customer-home.html";
    } else {
        alert("حدث خطأ أثناء الحجز");
    }
}

// -----------------------------
// تهيئة الصفحة
// -----------------------------
(function init() {
    const today = new Date().toISOString().split("T")[0];
    document.getElementById("dateInput").value = today;

    loadCars();
    loadServices().then(reloadTimes);
})();
</script>

</body>
</html>
